<script type="text/javascript" src="admin/view/javascript/jquery/jquery-2.1.1.min.js"></script>
<link type="text/css" href="/public/fonts/giga/iconfont.css?v={{ app_version }}" rel="stylesheet">
{#<script src="catalog/view/javascript/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>#}

{#<link href="admin/view/stylesheet/bootstrap.css" rel="stylesheet" media="screen"/>#}
{#<link type="text/css" href="admin/view/stylesheet/stylesheet.css?v={{ app_version }}" rel="stylesheet" media="screen"/>#}

{#<script src="catalog/view/javascript/common.js?v={{ app_version }}" type="text/javascript"></script>#}


<link href="/catalog/view/theme/yzcTheme/stylesheet/sales_order/tracking_detail.css" type="text/css" rel="stylesheet"/>

<div class="detail-dialog tracking-detail-dialog">
  <div class="swiper-container" id="swiper-container">
{#    <div id="trackingdetail-prebtn" class="swiper-button-prev">#}
{#      <div class="lefticon detailicon giga icon-V10_zuocejiantou"></div>#}
{#    </div>#}
    <!-- 阻止chrome左侧元素双击之后全选的问题 -->
    <p></p>
    <div class="swiper-wrapper" id="swiper-wrapper">

    </div>
{#    <div id="trackingdetail-nextbtn" class="swiper-button-next">#}
{#      <div class="righticon detailicon giga icon-V10_youjiantougengduo"></div>#}
{#    </div>#}
  </div>

</div>
<script>
  var block = {
    'blockUI': function () {
      var ele = $("#Modal-Mask-layer");
      if (!ele.length) {
        var html = "";
        html += '<div class="modal fade" id="Modal-Mask-layer" tabindex="-1" data-backdrop="static" role="dialog" aria-hidden="true" style="display: none;">';
        html += '  <div class="loader1" style="margin-top: 20%;margin-left: 50%">';
        html += '  <span></span>';
        html += '  <span></span>';
        html += '  <span></span>';
        html += '  <span></span>';
        html += '  <span></span>';
        html += '  </div>';
        html += '</div>';
        $('body').append(html);
      }
      $("#Modal-Mask-layer").show();
    },
    'unBlockUI': function () {
      $('#Modal-Mask-layer').hide();
    }
  };

  function loadOrderData(order_id, tracking_number, trackingShipSku) {
    block.blockUI();
    $.ajax({
      type: 'POST',
      dataType: 'json',
      contentType: 'application/json',
      data: JSON.stringify({
        'sales_order_id_list': order_id
      }),
      url: 'index.php?route=account/sales_order/tracking_search/search',
      success: function (json) {
        block.unBlockUI();
        let data = json.data;
        console.log(data);
        var trackObj = null;
        var orderObj = null;
        var itemObj = null;
        console.dir(data[0].itemList);
        for (let item of data[0].itemList) {
          for (let track of item.trackList) {
            if (trackingShipSku != null && trackingShipSku.trim()) {
              if (track.trackingNumber.trim() == tracking_number.trim() && item.subItemCode.trim() == trackingShipSku.trim()) {
                trackObj = track;
                itemObj = item;
                orderObj = data[0];
              }
            } else {
              if (track.trackingNumber.trim() == tracking_number.trim()) {
                trackObj = track;
                itemObj = item;
                orderObj = data[0];
              }
            }
          }
        }
        if (trackObj) {
          loadData(orderObj, itemObj, trackObj);
        }
      },
      error: function (xhr, ajaxOptions, thrownError) {
        alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        block.unBlockUI();
      }
    })
  }

  function loadData(order, item, track) {
    var dialogHtml = '';
    dialogHtml += `
      <div class="swiper-slide" id="slide-item">
    <div id="personal-information-container">
      <div class="personal-information">
        <div class="personal-information-list">
          <div class="sales-order">Sales Order:</div>`
    if(order.linkUrl != '') {
      dialogHtml += `<div class="sales-order-tel"><a href="${order.linkUrl}" target="_blank">${order.salesOrder}</a></div>`;
    } else {
      dialogHtml += `<div class="sales-order-tel">${order.salesOrder}</div>`;
    }
    dialogHtml += `
        </div>
        <div class="personal-information-list">
          <div class="sales-order">Recipient:</div>
          <div class="sales-order-tel">${order.recipient}</div>
        </div>
        <div class="personal-information-list">
          <div class="sales-order">Address:</div>
          <div class="sales-order-tel">${order.address}</div>
        </div>
      </div>
      <div class="commodity-information">
        <div class="commodity-information-list">
        </div>
        <div class="commodity-details">
          <div class="commodity-img">
            <img src="${item.itemCodeImg}" alt="">
          </div>
          <div class="commodity-content-container">
            <div class="detail-row">
                <div class="detail-title order-number"><span><a href="${item.linkUrl}" target="_blank">${item.itemCode}</a></span></div>
            </div>
            <div class="detail-row">
                <div class="detail-title">Carrier:</div>
                <div class="detail-content">
                     <div class="touch-tel">
                        <span class="touch-tel-fedex">${track.carrier}</span>`
    if (track.carrier.trim().toLowerCase() == 'ups') {
      dialogHtml += `<div class="red-phone">
                            <i class="giga icon-dianhua phone-display"></i>
                            <div class="phone-hover">
                                <div class="phone"><i class="giga icon-dianhua white-phone"></i></div>
                                <div class="phone-tel">Ask UPS: 1-800-742-5877</div>
                            </div>
                        </div>`
    } else if (track.carrier.trim().toLowerCase() == 'fedex') {
      dialogHtml += `<div class="red-phone">
                            <i class="giga icon-dianhua phone-display"></i>
                            <div class="phone-hover">
                                <div class="phone"><i class="giga icon-dianhua white-phone"></i></div>
                                <div class="phone-tel">Ask FedEx: 1-800-463-3339</div>
                            </div>
                        </div>`
    }
    dialogHtml += `</div>
                </div>
            </div>
            <div class="detail-row">
                <div class="detail-title">Tracking Number:</div>`
    if (track.linkUrl != '') {
                  dialogHtml += `<div class="detail-content"> <a href="${track.linkUrl}" target="_blank">${track.trackingNumber}</a></div>`;
                } else {
                  dialogHtml += `<div class="detail-content">${track.trackingNumber}</div>`;
                }
    dialogHtml += `</div>
          </div>
        </div>
        <div class="glt"></div>
      </div>
    </div>
    <div class="logistics">
      <div class="logistics-information">
        <ul class="logistics-information-ul">
`
    for (let status of track.statusList) {
      let statusObj = returnStatus(status.status);
      let addressArr=[];
      if(status.city){
        addressArr.push(status.city)
      }
      if(status.state){
        addressArr.push(status.state)
      }
      if(status.country){
        addressArr.push(status.country)
      }
      let addressstr=addressArr.join(',')
      dialogHtml += `
<!--                  <li><span>${status.create_time}</span><span class="order-status">${statusObj.name}</span></li>-->
                    <li>
                        <div class="flex-start">
                            <div class="logistics-date">${status.create_time}</div>
                            <div class="logistics-detail">
                                <p class="logistics-detail-status">${statusObj.name}</p>
                                <p class="logistics-detail-dec">${status.event_description}</p>
                                <p class="logistics-deyail-address">${addressstr}</p>
                            </div>
                        </div>
                    </li>
                `
    }
    dialogHtml += `
                      </ul>
                  </div>
                </div>
              </div>`
    $('#swiper-wrapper').append(dialogHtml);

    //动态设置状态列表的高度
    var height = $('.logistics').height();
    if(height > 180) {
      $('.logistics').height(180);
      $('.logistics').css("overflow-y", "scroll");
    }
  }


  //获取路由参数
  function getUrlParams(name) {
    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
    var r = window.location.search.substr(1).match(reg);
    if (r != null) return unescape(r[2]);
    return null;
  }

  $(document).ready(function () {
    var orderId = getUrlParams('order_id');
    var trackingNumber = getUrlParams('tracking_number');
    var trackingShipSku = getUrlParams('tracking_shipsku');

    loadOrderData(orderId, trackingNumber, trackingShipSku)
  });

  //返回运送单状态名称,图标，颜色
  function returnStatus(statusCode) {
    switch (statusCode) {
      case 1:
        return {
          'name': 'Label Created',
          'icon': 'icon-wuliuzhuangtai-shengchengbiaoqian',
          'color': '#fa6400'
        };
        break;
      case 2:
        return {
          'name': 'In Prep',
          'icon': 'icon-wuliuzhuangtai-yibeihuo',
          'color': '#fa6400'
        };
        break;
      case 3:
        return {
          'name': 'Shipped from warehouse',
          'icon': 'icon-wuliuzhuangtai-chuku',
          'color': '#fa6400'
        };
        break;
      case 4:
        return {
          'name': 'Picked Up',
          'icon': 'icon-wuliuzhuangtai-yiquhuo',
          'color': '#3a75dc'
        };
        break;
      case 5:
        return {
          'name': 'In Transit',
          'icon': 'icon-wuliuzhuangtai-yunshuzhong',
          'color': '#3a75dc'
        };
        break;
      case 6:
        return {
          'name': 'Delivered',
          'icon': 'icon-wuliuzhuangtai-songda',
          'color': '#65b017'
        };
        break;
      case 7:
        return {
          'name': 'Exception',
          'icon': 'icon-wuliuzhuangtai-chuxianyichang',
          'color': '#ff414d'
        };
        break;
      default:
        return;
    }
  }


  /**
   * 暂时不做Tracking的切换，如果要做，放开即可
   */

  // //禁用左右按钮
  // function forbidBtn(dom) {
  //   $(dom).css("opacity", ".5");
  //   $(dom).hover(function () {
  //     $(this).css("cursor", "not-allowed")
  //   });
  //   $(dom).unbind("click");
  // }
  //
  // //生效左右按钮
  // function activeBtn(dom) {
  //   $(dom).css("opacity", "1");
  //   $(dom).hover(function () {
  //     $(this).css("cursor", "pointer")
  //   });
  //   if (dom == "#trackingdetail-prebtn") {
  //     $(dom).unbind("click");
  //     $(dom).bind("click", prePage);
  //   } else if (dom == "#trackingdetail-nextbtn") {
  //     $(dom).unbind("click");
  //     $(dom).bind("click", nextPage);
  //   }
  // }
  //
  // //显示当前的index
  // function showCurrentDetail(index) {
  //   console.log(index);
  //   //slideIndex 为tracelist的长度
  //   $(".swiper-slide").hide();
  //   $(`#slide-item-${index}`).show();
  //   activeBtn("#trackingdetail-nextbtn");
  //   activeBtn("#trackingdetail-prebtn");
  //   if (index <= 0)
  //     forbidBtn("#trackingdetail-prebtn");
  //   else if (index >= slideIndex - 1)
  //     forbidBtn("#trackingdetail-nextbtn");
  // }
  //
  // //上一页切换
  // function prePage(e) {
  //   if (activeIndex > 0)
  //     activeIndex -= 1;
  //   showCurrentDetail(activeIndex);
  //   e.stopPropagation();
  // }
  //
  // //下一页切换
  // function nextPage(e) {
  //   if (activeIndex < slideIndex - 1)
  //     activeIndex += 1;
  //   showCurrentDetail(activeIndex);
  //   e.stopPropagation();
  // }
  //
  // $("#trackingdetail-prebtn").click(prePage);
  //
  // $("#trackingdetail-nextbtn").click(nextPage);
</script>
