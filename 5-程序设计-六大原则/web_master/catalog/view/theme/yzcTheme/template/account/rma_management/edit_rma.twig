{{ header }}
<style>
  .error_a {
    cursor: pointer;
  }

  .error_a:hover {
    color: #00a2d4;
  }
</style>
<style>
  #rma-details-panel-heading {
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    padding: 5px 10px 5px 20px;
  }

  .upload_warp_img_div_del {
    position: absolute;
    top: 6px;
    width: 16px;
    right: 4px;
  }

  .upload_warp_img_div_top {
    position: absolute;
    top: 0;
    width: 100%;
    height: 30px;
    background-color: rgba(0, 0, 0, 0.4);
    line-height: 30px;
    text-align: left;
    color: #fff;
    font-size: 12px;
    text-indent: 4px;
  }

  .upload_warp_img_div_text {
    white-space: nowrap;
    width: 80%;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .upload_warp_img_div img {
    max-width: 100%;
    max-height: 100%;
    vertical-align: middle;
  }

  .upload_warp_img_div {
    position: relative;
    height: 100px;
    width: 120px;
    border: 1px solid #ccc;
    margin: 0px 30px 10px 0px;
    float: left;
    line-height: 100px;
    display: table-cell;
    text-align: center;
    background-color: #eee;
    cursor: pointer;
  }

  .upload_warp_img {
    border-top: 1px solid #D2D2D2;
    padding: 14px 0 0 14px;
    overflow: hidden
  }

  .upload_warp_left img {
    margin-top: 35px;
  }

  .upload_warp {
    margin: 10px;
  }

  .upload {
    border: 1px solid #ccc;
    background-color: #fff;
    width: 100%;
    box-shadow: 0px 1px 0px #ccc;
    border-radius: 4px;
  }

  .hello {
    width: 100%;
    /*text-align: center;*/
  }

  .comments_textarea {
    resize: none;
    height: 140px !important;
  }

  .item_detail {
    /*color: #3c763d;*/
    color: #666;
    /*background-color: #dff0d8;*/
    padding: 10px;
    border: 1px double #c9d6e2;
    margin: 5px 0;
  }
  .error-border{
    border-color: #ff414d !important;
  }
</style>
<style>
  .rmaFG {
    margin-bottom: 0px;
  }

  .panel-body .prompt-tip {
    background-color: #ffecee;
    border: 1px solid #ff414d;
    color: #ff414d;
    padding: 10px;
    border-radius: 4px;
    margin: 5px;
  }
</style>
<script src="catalog/view/javascript/jquery/magnific/jquery.magnific-popup.min.js" type="text/javascript"></script>
<link href="catalog/view/javascript/jquery/magnific/magnific-popup.css" rel="stylesheet" type="text/css"/>
<script src="catalog/view/javascript/layer/layer.js" type="text/javascript"></script>
<div id="account-customer-order" class="container page-seller-portal">

  {% include 'giga/template/_parts/breadcrumb_simple.twig' %}

  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <h1>{{ text_edit_rma }}</h1>
      </div>
    </div>
    <div class="row mb-4">
      <div id="content" class="col-sm-12">
        <div id="page-rma-form" class="tab-content main">
          <div role="tabpanel" class="tab-pane active" id="tab-1">
            <div class="bg-white p-2">
              <div class="rma_customer_order_info">
                <table class="table main">
                  <thead>
                  <tr>
                    <th>{{ text_order_id }}</th>
                    <th>{{ text_order_from }}</th>
                    <th>{{ text_order_date }}</th>
                    <th>Order Status</th>
                    <th>{{ text_ship_to }}</th>
                    <th>{{ text_email }}</th>
                    <th>{{ text_phone }}</th>
                    <th style="width: 160px;">Address</th>
                  </tr>
                  </thead>
                  <tbody>
                  <tr>
                    <td>{{ order_id }}
                      <input type="text" id="customer_order_id" name="customer_order_id" value="{{ order_id }}" hidden/>
                      <input type="text" id="header_id" name="header_id" value="{{ sales_order_id }}" hidden/>
                    </td>
                    <td> {{ order_from }}
                      <input type="text" id="orderFrom" name="orderFrom" value="" hidden/></td>
                    <td>{{ order_date }}</td>
                    <td>{{ order_status }}</td>
                    <td>{{ ship_to }}</td>
                    <td>{{ email }}</td>
                    <td>{{ ship_phone }}</td>
                    <td>{{ address }}</td>
                    <input type="text" id="order_status" name="order_status" value="" hidden/>
                  </tr>
                  </tbody>
                </table>
              </div>
              <div id="customer-order-details-div">
                {% if customerOrder %}
                  {% for customerOrderLine in customerOrderLines %}
                    {#SKU#}
                    <div class="info-section mt-2 mb-4">
                      <div class="info-group">
                        <span class="title">{{ text_item_code }}</span>
                        <span>{{ customerOrderLine.item_code }}</span>
                      </div>
                      <div class="info-group">
                        <span class="title">{{ text_quantity }}</span>
                        <span>{{ customerOrderLine.qty }}</span>
                      </div>
                      <div class="info-group">
                        <span class="title">{{ text_item_status }}</span>
                        <span>
                          {% for order_status in customerOrderItemStatus %}
                            {% if customerOrderLine.item_status == order_status.DicKey %}
                              {{ order_status.DicValue }}
                            {% endif %}
                          {% endfor %}
                        </span>
                      </div>
                    </div>

                    {#Order#}
                    <table class="table main table-hover" id="orderInfo">
                      <thead>
                      <tr>
                        <th>Order ID</th>
                        <th>Store</th>
                        <th>Image</th>
                        <th>Product Name</th>
                        <th>Quantity</th>
                        {% if is_margin %}
                          <th>Deposit Per Unit</th>
                        {% endif %}
                        <th>Unit Price After Discount</th>
                        {% if isEurope %}
                          <th>Service Fee After Discount</th>
                        {% endif %}
                        <th>Fulfillment Per Unit</th>
                        {% if  customerOrderLine.coupon_and_campaign > 0 %}
                          <th>Savings</th>
                        {% endif %}
                        <th>Total</th>
                      </tr>
                      </thead>
                      <tbody>
                      {% for orderDetail in customerOrderLine.orderDetails %}
                        <tr>
                          <td>
                            <a href="{{ orderDetail.orderHistoryUrl }}" target="_blank">#{{ orderDetail.order_id }}
                              {% if (orderDetail.delivery_type==2) %}
                                <i class="giga icon-cwf" style="color: #1f5268;font-size: 15px;" data-toggle="tooltip" data-original-title="{{ cwf }}"></i>
                              {% endif %}
                            </a></td>
                          <td>
                            <a href="{{ orderDetail.contactSeller }}" target="_blank">{{ orderDetail.screenname }}</a>
                          </td>
                          <td class="text-center">
                            {% if orderDetail.image %}
                              <a class="thumbnail" style="margin-bottom: 0;width: 40px;height: 40px;padding: 0" href="{{ orderDetail.image }}" title='{{ orderDetail.name }}'>
                                <img style="height: 38px" src="{{ orderDetail.image }}"/>
                              </a>
                            {% else %}
                              <span class="img-thumbnail list">
                                <i class="fa fa-camera fa-2x"></i>
                              </span>
                            {% endif %}
                          </td>
                          <td>{{ orderDetail.name }}</td>
                          <td class="text-price">{{ orderDetail.qty }}</td>
                          {% if is_margin %}
                            <td class="text-price">{{ orderDetail.advance_unit_price }}</td>
                          {% endif %}
                          <td class="text-price">
                            {% if isEurope %}
                              <span>
                                <img data-toggle="tooltip" title="" style="width: 21.81px"
                                         src="/image/product/vat.png" data-original-title="Service Fee">
                              </span>
                            {% endif %}
                            {{ orderDetail.price_per }}
                          </td>
                          {% if isEurope %}
                            <td class="text-price">{{ orderDetail.service_fee_per }}</td>
                          {% endif %}
                          <td class="text-price">{{ orderDetail.freight }}
                            {% if orderDetail.freight_diff %}
                              <i class="glyphicon glyphicon-info-sign" data-toggle="tooltip"
                                 style="cursor: pointer;font-size: 12px"
                                 title="{{ orderDetail.tips_freight_difference_per }}"></i>
                            {% endif %}
                          </td>
                          {% if  customerOrderLine.coupon_and_campaign > 0 %}
                            <td class="text-price">{{ orderDetail.coupon_and_campaign_show }}</td>
                          {% endif %}
                          <td class="text-price">{{ orderDetail.total }}</td>
                        </tr>
                      {% endfor %}
                      </tbody>
                    </table>
                  {% endfor %}
                  <div id="error_msg_div"></div>
                        <!--RMA Details-->
                        <div class="section-title">
                          <h2>RMA Details</h2>
                        </div>
                        <form id="order_from" enctype="multipart/form-data" style="margin-bottom: 20px;">
                          <div class="item_detail form-wrapper" id="table_details">
                            <h5>RMA ID:{{ rma_order_id }}</h5>
                            <input name="rmaId" value="{{ rma_id }}" hidden>
                            <input name="rmaOrderId" value="{{ rma_order_id }}" hidden="true">
                            <table class="table">
                              <thead>
                              <th style="width: 20%"><span style="color: red">*</span>Item Code</th>
                              <th style="width: 20%"><span style="color: red">*</span>Purchase Order ID</th>
                              <th style="width: 20%"><span style="color: red">*</span>Store</th>
                              {% if customerOrder.lowOrderFrom == 'amazon' or customerOrder.lowOrderFrom == 'amazonshz' %}
                                <th style="width: 20%"><span style="color: red">*</span>ASIN</th>
                              {% endif %}
                              {#<th>Brand</th>#}
                              {% if customerOrder.order_status !=16 %}
                                <th style="width: 20%"><span style="color: red">*</span># of Defective Products
                                </th>
                              {% endif %}
                              </thead>
                              <tbody>

                              <td>
                                <div class="form-group rmaFG required">
                                  <select id="selectItemCode" name="itemCode" class="form-control">
                                  </select>
                                </div>
                              </td>
                              <td>
                                <div class="form-group rmaFG required">
                                  <select id="selectOrderId" name="orderId" class="form-control">
                                  </select>
                                </div>
                              </td>
                              <td>
                                <div class="form-group rmaFG required">
                                  <select id="selectSellers" name="sellers" class="form-control">
                                  </select>
                                </div>
                                <input id="transactionFee" name="transactionFee" type="hidden" value="{{ 11 }}"/>
                                <input id="totalPrice" name="totalPrice" type="hidden" value="{{ 11 }}"/>
                              </td>
                              {% if customerOrder.lowOrderFrom == 'amazon' or customerOrder.lowOrderFrom == 'amazonshz' %}
                                <td>
                                  <div class="form-group rmaFG required">
                                    <input type="text" id="asin" name="asin" class="form-control"/>
                                  </div>
                                </td>
                              {% endif %}
                              {#<td></td>#}
                              {% if customerOrder.order_status !=16 %}
                                <td>
                                  <div class="form-group rmaFG required">
                                    <input id="rmaQty" onchange="checkInputNumber(this)"
                                           name="rmaQty"
                                           onkeyup="value=value.replace(/\D/g,'')"
                                           class="form-control" type="number" min="0"/>
                                  </div>
                                </td>
                              {% else %}
                                <input id="rmaQty" onchange="checkInputNumber(this)" name="rmaQty"
                                       type="hidden" value="0"/>
                              {% endif %}
                              </tbody>
                            </table>
                            {#备注信息#}
                            <div class="form-group required">
                              <label for="reason"><span style="color: red">*</span>Reason:</label>
                              <select id="reason" name="reason" class="form-control">
                                <option value="">{{ text_select }}</option>
                                {% for r in rmaReason %}
                                  <option
                                    value="{{ r.reason_id }}" {% if rma_reason_id == r.reason_id %} selected {% endif %}>{{ r.reason }}</option>
                                {% endfor %}
                              </select>
                            </div>
                            <div class="form-group">
                              <label for="comments">Comments:</label>
                              <textarea class="form-control comments_textarea" id="comments"
                                        name="comments">{{ comments }}</textarea>
                            </div>
                            {#上传图片#}
                            <h4><span style="color: red">*</span>Image Upload<span class="wenhao"
                                                                                   data-toggle="tooltip"
                                                                                   title="{{ image_tip }}"><i class="giga icon-V10-wenhaotishi"></i></span>
                            </h4>
                            <div class="fileDiv">
                              <div id="appFile">
                                <div class="hello">
                                  <div class="upload">
                                    <div class="upload_warp">
                                      <a style="margin-right: 10px;" class="btn btn-success"
                                         @click="fileClick">Upload
                                        File</a>
                                      ${imgList.length}$ files are selected,
                                      ${bytesToSize(this.size)}$ in total.
                                    </div>
                                    <input @change="fileChange($event)" type="file" id="upload_file"
                                           name="upload_image" multiple
                                           style="display: none" accept="image/*"/>
                                    <div class="upload_warp_img">
                                      {% for image in imageResult %}
                                        <div class="upload_warp_img_div">
                                          <div class="upload_warp_img_div_top">
                                            <div class="upload_warp_img_div_text">
                                              {{ image.name }}
                                            </div>
                                            <img
                                              src="catalog/view/theme/yzcTheme/stylesheet/diyUpload/images/del.png"
                                              class="upload_warp_img_div_del"
                                              onclick="deleteImage(this,'{{ image.rmaId }}','{{ image.name }}','{{ image.id }}','{{ image.path }}')">
                                          </div>
                                          <img src="{{ image.path }}">
                                        </div>
                                      {% endfor %}
                                      <div class="upload_warp_img_div"
                                           v-for="(item,index) of imgList">
                                        <div class="upload_warp_img_div_top">
                                          <div class="upload_warp_img_div_text">
                                            ${item.file.name}$
                                          </div>
                                          <img
                                            src="catalog/view/theme/yzcTheme/stylesheet/diyUpload/images/del.png"
                                            class="upload_warp_img_div_del"
                                            @click="fileDel(index)">
                                        </div>
                                        <img :src="item.file.src">
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                            {#退返品类型#}
                            <div class="panel panel-default" style="margin-top: 15px;border: none">
                              <div class="panel-group" id="accordion">
                                <div class="panel panel-default">
                                  {% if customerOrder.order_status == 32 %}
                                    <div class="panel-heading">
                                      <h4 class="panel-title">
                                        <a data-parent="#accordion">
                                          <div class="rmaFG checkbox-plus-2">
                                            <label for="collapseOne">
                                              <input type='checkbox' id='collapseOne'
                                                     name="rma_type[]"
                                                     onClick='collapse(this)' value="1">
                                                <span class="icon"></span>
                                                <span>Reshipment</span>
                                              <span style="color: red;margin-left: 10px">*</span>
                                              <span style="font-size: 14px">Notice: Transaction fees are at the buyer's own expense.</span>
                                            </label>
                                          </div>
                                        </a>
                                      </h4>
                                    </div>
                                  {% endif %}
                                  <div class="panel-collapse collapse  collapseOne">
                                    <div class="panel-body">
                                      {% if reorder %}
                                        <div class="row">
                                          <div class="col-sm-6">
                                            <div class="form-group required rmaFG">
                                              {#收货人姓名#}
                                              <label class="control-label"
                                                     for="re_ship_to_name"><b>Ship-to
                                                  Name:</b></label>
                                              <input id="re_ship_to_name" name="re_ship_to_name"
                                                     value="{{ reorder.ship_name }}" class="form-control"
                                                     onkeyup="this.value=this.value.replace( /^\s*/, '');" >
                                            </div>
                                            <div class="form-group required rmaFG">
                                              {#收货人邮箱#}
                                              <label class="control-label" for="re_ship_to_email">
                                                <b>Ship-to Email:</b>
                                              </label>
                                              <input id="re_ship_to_email" name="re_ship_to_email" type="email"
                                                     value="{{ reorder.email }}" class="form-control"
                                                     onkeyup="this.value=this.value.replace( /^\s*/, '');" >
                                            </div>
                                            <div class="form-group required rmaFG">
                                              {#收货城市#}
                                              <label class="control-label" for="re_ship_to_city">
                                                <b>Ship-to City:</b></label>
                                              <input id="re_ship_to_city" name="re_ship_to_city"
                                                     value="{{ reorder.ship_city }}" class="form-control"
                                                     onkeyup="this.value=this.value.replace( /^\s*/, '');" >
                                            </div>
                                            <div class="form-group required rmaFG">
                                              {#收货邮编#}
                                              <label class="control-label" for="re_ship_to_postal_code">
                                                <b>Ship-to Postal Code:</b>
                                              </label>
                                              <input id="re_ship_to_postal_code" name="re_ship_to_postal_code"
                                                     value="{{ reorder.ship_zip_code }}" class="form-control"
                                                     onkeyup="this.value=this.value.replace( /^\s*/, '');">
                                            </div>
                                            {#数量#}
                                            <div class="form-group required rmaFG">
                                              <label class="control-label" for="re_ship_to_qty">
                                                <b>Reshipped Quantity:</b></label>
                                              <input type="number" onchange="checkInputNumber(this)"
                                                     id="re_ship_to_qty" min="0" name="re_ship_to_qty"
                                                     onkeyup="value=value.replace(/\D/g,'')"
                                                     value="{{ ship_qty }}" class="form-control">
                                            </div>
                                          </div>
                                          <div class="col-sm-6">
                                            <div class="form-group required rmaFG">
                                              {#收货人电话#}
                                              <label class="control-label" for="re_ship_to_phone">
                                                <b>Ship-to Phone:</b>
                                              </label>
                                              <input id="re_ship_to_phone" name="re_ship_to_phone"
                                                     value="{{ reorder.ship_phone }}" class="form-control"
                                                     onkeyup="this.value=this.value.replace( /^\s*/, '');">
                                            </div>
                                            <div class="form-group required rmaFG">
                                              {#收货地址#}
                                              <label class="control-label" for="re_ship_to_address">
                                                <b>Ship-to Address:</b>
                                              </label>
                                              <input id="re_ship_to_address" name="re_ship_to_address"
                                                     value="{{ reorder.ship_address }}" class="form-control"
                                                     onkeyup="this.value=this.value.replace( /^\s*/, '');">
                                            </div>
                                            <div class="form-group required required rmaFG">
                                              {#收货 州/地区#}
                                              <label class="control-label" for="re_ship_to_state">
                                                <b>Ship-to State:</b>
                                              </label>
                                              <input id="re_ship_to_state" name="re_ship_to_state"
                                                     value="{{ reorder.ship_state }}" class="form-control"
                                                     onkeyup="this.value=this.value.replace( /^\s*/, '');">
                                            </div>
                                            <div class="form-group required rmaFG">
                                              {#收货国家#}
                                              <label class="control-label" for="re_ship_to_country">
                                                <b>Ship-to Country:</b>
                                              </label>
                                              <input id="re_ship_to_country" name="re_ship_to_country"
                                                     value="{{ reorder.ship_country }}"
                                                     class="form-control" readonly style="cursor: not-allowed;">
                                            </div>
                                          </div>
                                        </div>
                                      {% elseif customerOrder %}
                                        <div class="row">
                                          <div class="col-sm-6">
                                            <div class="form-group required rmaFG">
                                              {#收货人姓名#}
                                              <label class="control-label" for="re_ship_to_name">
                                                <b>Ship-to Name:</b></label>
                                              <input id="re_ship_to_name" name="re_ship_to_name"
                                                     value="{{ customerOrder.ship_name }}" class="form-control"
                                                     onkeyup="this.value=this.value.replace( /^\s*/, '');">
                                            </div>
                                            <div class="form-group required rmaFG">
                                              {#收货人邮箱#}
                                              <label class="control-label" for="re_ship_to_email">
                                                <b>Ship-to Email:</b>
                                              </label>
                                              <input type="email" id="re_ship_to_email" name="re_ship_to_email"
                                                     value="{{ customerOrder.email }}" class="form-control"
                                                     onkeyup="this.value=this.value.replace( /^\s*/, '');">
                                            </div>
                                            <div class="form-group required rmaFG">
                                              {#收货城市#}
                                              <label class="control-label" for="re_ship_to_city">
                                                <b>Ship-to City:</b>
                                              </label>
                                              <input id="re_ship_to_city" name="re_ship_to_city"
                                                     value="{{ customerOrder.ship_city }}" class="form-control"
                                                     onkeyup="this.value=this.value.replace( /^\s*/, '');">
                                            </div>
                                            <div class="form-group required rmaFG">
                                              {#收货邮编#}
                                              <label class="control-label" for="re_ship_to_postal_code">
                                                <b>Ship-to Postal Code:</b>
                                              </label>
                                              <input id="re_ship_to_postal_code" name="re_ship_to_postal_code"
                                                     value="{{ customerOrder.ship_zip_code }}" class="form-control"
                                                     onkeyup="this.value=this.value.replace( /^\s*/, '');">
                                            </div>
                                            {#数量#}
                                            <div class="form-group required rmaFG">
                                              <label class="control-label" for="re_ship_to_qty">
                                                <b>Reshipped Quantity:</b>
                                              </label>
                                              <input type="number" onchange="checkInputNumber(this)"
                                                     id="re_ship_to_qty" min="0" name="re_ship_to_qty"
                                                     onkeyup="value=value.replace(/\D/g,'')" value="" class="form-control">
                                            </div>
                                          </div>
                                          <div class="col-sm-6">
                                            <div class="form-group required rmaFG">
                                              {#收货人电话#}
                                              <label class="control-label" for="re_ship_to_phone">
                                                <b>Ship-to Phone:</b></label>
                                              <input id="re_ship_to_phone" name="re_ship_to_phone"
                                                     value="{{ customerOrder.ship_phone }}" class="form-control"
                                                     onkeyup="this.value=this.value.replace( /^\s*/, '');">
                                            </div>
                                            <div class="form-group required rmaFG">
                                              {#收货地址#}
                                              <label class="control-label" for="re_ship_to_address">
                                                <b>Ship-to Address:</b></label>
                                              <input id="re_ship_to_address" name="re_ship_to_address"
                                                     value="{{ customer_order_ship_address }}" class="form-control"
                                                     onkeyup="this.value=this.value.replace( /^\s*/, '');">
                                            </div>
                                            <div class="form-group required required rmaFG">
                                              {#收货 州/地区#}
                                              <label class="control-label" for="re_ship_to_state">
                                                <b>Ship-to State:</b>
                                              </label>
                                              <input id="re_ship_to_state" name="re_ship_to_state"
                                                     value="{{ customerOrder.ship_state }}" class="form-control"
                                                     onkeyup="this.value=this.value.replace( /^\s*/, '');">
                                            </div>
                                            <div class="form-group required rmaFG">
                                              {#收货国家#}
                                              <label class="control-label" for="re_ship_to_country">
                                                <b>Ship-to Country:</b>
                                              </label>
                                              <input id="re_ship_to_country" name="re_ship_to_country"
                                                     value="{{ customerOrder.ship_country }}" class="form-control" readonly>
                                            </div>
                                          </div>
                                        </div>
                                      {% endif %}
                                    </div>
                                  </div>
                                  {% if customerOrder.order_status == 16 %}
                                    <div class="panel panel-default">
                                      <div class="panel-heading">
                                        <h4 class="panel-title">
                                          <a data-parent="#accordion">
                                            <div class="rmaFG checkbox-plus-2">
                                              <label for="collapseTwo">
                                                <input type='checkbox' id='collapseTwo'
                                                       name="rma_type[]"
                                                       onClick='collapse(this)' value="2"
                                                       checked>
                                                <span class="icon"></span>
                                                <span>Refund</span>
                                              </label>
                                            </div>
                                          </a>
                                        </h4>
                                      </div>
                                      <div class="panel-collapse collapse in collapseTwo">
                                        <div class="panel-body">
                                          <div class="form-group rmaFG">
                                            <label for="refund_amount"><span
                                                style="color: red">*</span><b>Amount
                                                ({{ currency }}):</b></label>
                                            <div style="display: flex">
                                              {% if  currency != "JPY" %}
                                                <input id="refund_amount{{ count }}" style="width: auto;" title=""
                                                       name="refund_amount{{ count }}" type="number"
                                                       value="{{ apply_refund_amount }}" class="form-control"
                                                       onchange="checkRefundAmount(this);"
                                                       onkeyup="this.value= this.value.match(/\d+(\.\d{0,2})?/) ? this.value.match(/\d+(\.\d{0,2})?/)[0] : ''"
                                                       min="0" step="1"/>
                                              {% else %}
                                                <input id="refund_amount{{ count }}" style="width: auto;" title=""
                                                       name="refund_amount{{ count }}"
                                                       type="number"
                                                       value="{{ apply_refund_amount }}"
                                                       class="form-control"
                                                       onchange="checkRefundAmount(this);"
                                                       onkeyup="this.value= this.value.match(/[0-9]*/) ? this.value.match(/[0-9]*/) : ''"
                                                       min="0"
                                                       step="1"/>
                                              {% endif %}
                                              <span id="refund_msg" style="line-height: 38px"></span>
                                            </div>
                                            <br>
                                            <span id="tip_refund" style="color: red"></span>
                                            <br>
                                            <span>
                                              Storage fees incurred before the seller agreed the RMA will be deducted by Marketplace after the seller agreed the RMA.
                                            </span>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            {% else %}
                              <div class="panel panel-default">
                                <div class="panel-heading">
                                  <h4 class="panel-title">
                                    <a data-parent="#accordion">
                                      <div class="rmaFG checkbox-plus-2">
                                        <label for="collapseTwo">
                                          <input type='checkbox' id='collapseTwo'
                                                 name="rma_type[]"
                                                 onClick='collapse(this)' value="2">
                                          <span class="icon"></span>
                                          <span>Refund</span>
                                        </label>
                                      </div>
                                    </a>
                                  </h4>
                                </div>
                                <div class="panel-collapse collapse collapseTwo">
                                  <div class="panel-body">
                                    {% if safeguard_bill_list is not empty %}
                                      <p class="prompt-tip">
                                        <i class="giga icon-tishii-01"></i>
                                        {% for bill in safeguard_bill_list  %}
                                          <span>{{ bill.safeguardConfig.title }}</span>
                                          {{ not loop.last ? ',' }}
                                        {% endfor %}
                                        Protection Service has been purchased for this product in the order. If you want to request an RMA due to problems within the coverage of Protection Service, Seller can reject the request.
                                      </p>
                                    {% endif %}
                                    <div class="form-group rmaFG">
                                      <label for="refund_amount"><span
                                            style="color: red">*</span><b>Amount
                                          ({{ currency }}):</b></label>
                                      <div style="display: flex">
                                        {% if  currency != "JPY" %}
                                          <input id="refund_amount{{ count }}" style="width: auto;"
                                                 name="refund_amount{{ count }}"
                                                 type="number"
                                                 value="{{ apply_refund_amount }}"
                                                 class="form-control"
                                                 onchange="checkRefundAmount(this);" onblur="fixedTwo(this)"
                                                 onkeyup="this.value= this.value.match(/\d+(\.\d{0,2})?/) ? this.value.match(/\d+(\.\d{0,2})?/)[0] : ''"
                                                 min="0"
                                                 step="1"/>
                                        {% else %}
                                          <input id="refund_amount{{ count }}" style="width: auto;"
                                                 name="refund_amount{{ count }}"
                                                 type="number"
                                                 value="{{ apply_refund_amount }}"
                                                 class="form-control"
                                                 onchange="checkRefundAmount(this);"
                                                 onkeyup="this.value= this.value.match(/[0-9]*/) ? this.value.match(/[0-9]*/) : ''"
                                                 min="0"
                                                 step="1"/>
                                        {% endif %}
                                        <span id="refund_msg" style="line-height: 38px"></span>
                                      </div>
                                      <span id="tip_refund" style="color: red"></span>
                                      <br>
                                      <span>
                                              Storage fees incurred before the seller agreed the RMA will be deducted by Marketplace after the seller agreed the RMA.
                                            </span>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                    </div>
                  </form>

                {% endif %}
              </div>
              <div class="buttons clearfix">
                <div class="text-center">
                  <a class="btn btn-primary btn1" id="editRMA">{{ button_submit }}</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


</div>

<script>
  var flag = true;
  var submitflag = true;
  var countArray = [];
  var salesOrderStatus = null;

  function orderDetailsDivEmpty() {
    $('#customer-order-details-div').empty();
    countArray = [];
    appFileArray = [];
    salesOrderStatus = null;
  }

  function submitRmaData(button) {
    submitflag = false;
    // 清除提示
    $("#error_msg_div").empty();
    $(".has-error").removeClass('has-error');
    $(".text-danger").remove();


    if ((typeof checkRefundAmount) == "function") {
      var isOK = true;
      $('input[id^="refund_amount"]').each(function (index, ele) {
        if (!checkRefundAmount(ele)) {
          isOK = false;
          return false;
        }
      });
      if (!isOK) {
        $('#editRMA').button('reset');
        return false;
      }
    }


    var formData = new FormData();
    var datas = $("#order_from").serializeArray();
    if (datas.length == 0) {
      layer.alert("Please add RMA detail!", {
        title: 'Message',
        btn: 'OK',
        skin: 'yzc_layer' //样式类名
        , closeBtn: 0
      });
      $('#editRMA').button('reset');
      return;
    }
    for (let i = 0; i < datas.length; i++) {
          let newVal = datas[i].value.trim();
          datas[i].value=newVal;
          formData.append(datas[i].name, datas[i].value);
        }

    for (var j = 0; j < appFile.imgList.length; j++) {
      formData.append('upload_imgs_' + j, appFile.imgList[j].file);
    }

    formData.append("index[]", 1);
    formData.append('sales_order_id', $("#header_id").val().trim());
    formData.append('customer_order_id', $("#customer_order_id").val().trim());
    formData.append('orderFrom', $("#orderFrom").val().trim());
    formData.append('orderStatus', $("#order_status").val().trim());
    if (!submitflag) {
      $.ajax({
        url: 'index.php?route=account/rma_management/editRmaRequest',
        type: 'post',
        data: formData,
        async: false,
        cache: false,
        contentType: false,
        processData: false,
        dataType: 'json',
        success: function (res) {
                  $('input').removeClass('error-border');
                    $("#editRMA").button('reset');
                    submitflag = true;
                  if (res.code == 200){
                    location.href = res.successUrl + "&filter_customer_order_id=" + encodeURIComponent($("#customer_order_id").val() );
                  }else if (res.code == -1){
                    var errorDiv = `<div class="alert alert-danger alert-dismissible" role="alert">
                                      <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                      <strong>Error Message!</strong><br/>
                                      <div>${res.msg.error}</div>
                                   </div>`
                    $("#error_msg_div").append(errorDiv);
                    // $("#"+res.msg.field_name).after('<div class="text-danger">' + res.msg.error + "</div>");
                    $('html, body').animate({
                      scrollTop: $("#error_msg_div").offset().top - 50
                    }, 500);
                    $("#"+res.msg.field_name).addClass('error-border');
                  }else{
                    layer.msg('Operation fail.');
                    return;
                  }
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    submitflag = true;
                    $("#editRMA").button('reset');
                    layer.alert(thrownError + "<br>" + xhr.statusText + "<br>" + xhr.responseText, {
                        title: 'Message',
                        btn : 'OK',
                        skin: 'yzc_layer' //样式类名
                        ,closeBtn: 0
                    });
                }
            });
        }
    }

  function scrollById(id) {
    var container = $('#rma-details-panel-body');
    var scrollTo = $("#" + id);
    $('#rma-details-panel-body').animate({
      scrollTop: scrollTo.offset().top - container.offset().top + container.scrollTop() - 5
    }, 500);
  }

  $("#editRMA").click(function () {
    $(this).button('loading');
    setTimeout(function () {
      submitRmaData(this)
    }, 500);
  });
</script>
<script>
  {% if selectItems %}
  var selectItems = {{ selectItems }};
  {% endif %}
  {% if hasReorder %}
  var hasReorder = {{ hasReorder }};
  {% endif %}
  {% if rmaInfo %}
  var rmaInfo = {{ rmaInfo }};
  {% endif %}
  $(document).ready(function () {
    $('.thumbnail').magnificPopup({
      type: 'image'
    });
  });

  function changeIcon(suffix) {
    if ($("#icon_down_" + suffix).css('display') == 'none') {
      $("#icon_down_" + suffix).css('display', 'block');
      $("#icon_up_" + suffix).css('display', 'none');
    } else {
      $("#icon_up_" + suffix).css('display', 'block');
      $("#icon_down_" + suffix).css('display', 'none');
    }
  }

  var index = 0;


  function arrayIndex(arr, val) {
    for (var i = 0; i < arr.length; i++) {
      if (arr[i] == val) return i;
    }
    return -1;
  }

  function arrayRemove(arr, val) {
    var i = arrayIndex(arr, val);
    if (i > -1) {
      arr.splice(i, 1);
    }
  }

  function deleteImage(e, rmaId, fileName, id, path) {
    $(e).parent().parent().hide();
    $.ajax({
      url: 'index.php?route=account/rma_management/deleteRMAImage',
      type: 'post',
      data: {'rmaId': rmaId, 'fileName': fileName, 'id': id, 'path': path}
    })
  }
</script>
<script>
  $(function () {
    for (var i = 0; i < selectItems.length; i++) {
      if (selectItems[i].itemCode.toLowerCase() == rmaInfo.item_code.toLowerCase()) {
        $("#selectItemCode").append("<option data-id=" + i + " value='" + selectItems[i].itemCode + "'selected >" + selectItems[i].itemCode + "</option>")
        var selectOrderIds = selectItems[i].items;

        for (var j = 0; j < selectOrderIds.length; j++) {
          if (selectOrderIds[j].orderId == rmaInfo.b2b_order_id) {
            $("#selectOrderId").append("<option data-id=" + j + " value='" + selectOrderIds[j].orderId + "' selected>#" + selectOrderIds[j].orderId + "</option>");
            var selectSellers = selectOrderIds[j].items;
            for (var z = 0; z < selectSellers.length; z++) {
              if (selectSellers[z].sellerId == rmaInfo.seller_id) {
                $("#selectSellers").append("<option data-id=" + z + " value='" + selectSellers[z].sellerId + "' selected>" + selectSellers[z].sellerName + "</option>");
                var transactionFeeTmp = selectSellers[z].transactionFee * 1000 / 1000;
                var totalPriceTmp = selectSellers[z].totalPrice * 1000 / 1000;
                $("#transactionFee").val(transactionFeeTmp);
                $("#totalPrice").val(totalPriceTmp);
              }
              if (selectSellers[z].orderStatus != 16) {
                $("#rmaQty").val(selectSellers[z].qty);
              }
              $("#rmaQty").attr("max", selectSellers[z].qty);
              if (!hasReorder) {
                $("#re_ship_to_qty").val(selectSellers[z].qty);
                $("#re_ship_to_qty").attr("max", selectSellers[z].qty);
              }
              $("#refund_msg").html(selectSellers[z].tip_rebate_refund);
              $("#tip_refund").html(selectSellers[z].msg_rebate_refund);
              // $("#re_ship_to_qty").val(selectSellers[z].qty);
              // $("#re_ship_to_qty").attr("max", selectSellers[z].qty);
              if (selectSellers[z].orderStatus == 16) {
                // $("#refund_amount").val(totalPriceTmp);
              }
            }
          } else {
            $("#selectOrderId").append("<option data-id=" + j + " value='" + selectOrderIds[j].orderId + "'>#" + selectOrderIds[j].orderId + "</option>");
          }
        }
      } else {
        $("#selectItemCode").append("<option data-id=" + i + " value='" + selectItems[i].itemCode + "' >" + selectItems[i].itemCode + "</option>")
      }
    }
    $('#asin').val(rmaInfo.asin);
    $('#rmaQty').val(rmaInfo.quantity);
    if (rmaInfo.rma_type == 1) {
      $('#collapseOne').attr('checked', true);
      $('.collapseOne').collapse('show');
    } else if (rmaInfo.rma_type == 2) {
      $('#collapseTwo').attr('checked', true);
      $('.collapseTwo').collapse('show');
    } else if (rmaInfo.rma_type == 3) {
      $('#collapseOne').attr('checked', true);
      $('#collapseTwo').attr('checked', true);
      $('.collapseOne').collapse('show');
      $('.collapseTwo').collapse('show');
    }
  });

  function checkInputNumber(input) {
    var max = $(input).attr('max');
    var min = $(input).attr('min');
    var value = $(input).val();
    if (value < min) {
      var tmplayer = layer.alert("Illegal input!", {
        title: 'Message',
        btn: 'OK',
        skin: 'yzc_layer' //样式类名
        , closeBtn: 0
      }, function () {
        layer.close(tmplayer);
        $(input).parent().addClass('has-error');
        $(input).focus();
      });
    } else if (value > max) {
      var tmplayer = layer.alert("Please enter again if the number of inputs is greater than the order quantity!", {
        title: 'Message',
        btn: 'OK',
        skin: 'yzc_layer' //样式类名
        , closeBtn: 0
      }, function () {
        layer.close(tmplayer);
        $(input).parent().addClass('has-error');
        $(input).focus();
      });
    } else if (value >= min && value <= max) {
      $(input).parent().removeClass('has-error');
    }
  }

  function checkRefundAmount(input) {
    var value = $(input).val();
    var totalPrice = $("#totalPrice").val() * 1000 / 1000;
    if (parseFloat(value) > parseFloat(totalPrice)) {
      var tmplayer = layer.alert("The amount entered exceeds the total amount of the order details!", {
        title: 'Message',
        btn: 'OK',
        skin: 'yzc_layer' //样式类名
        , closeBtn: 0
      }, function () {
        layer.close(tmplayer);
        $(input).parent().addClass('has-error');
        $(input).focus();
      });
      return false;
    }
    $(input).parent().removeClass('has-error');
    return true;
  }

  $("#selectItemCode").change(function () {
    // 清除后两个下拉框
    $('#selectOrderId').empty();
    $('#selectSellers').empty();
    var dataId = $(this).find('option:selected').attr("data-id");
    var selectOrderIds = selectItems[dataId].items;
    for (var j = 0; j < selectOrderIds.length; j++) {
      $("#selectOrderId").append("<option data-id=" + j + " value='" + selectOrderIds[j].orderId + "'>#" + selectOrderIds[j].orderId + "</option>");
      if (j == 0) {
        var selectSellers = selectOrderIds[j].items;
        for (var z = 0; z < selectSellers.length; z++) {
          $("#selectSellers").append("<option data-id=" + z + " value='" + selectSellers[z].sellerId + "'>" + selectSellers[z].sellerName + "</option>");
          $("#rmaQty").val(selectSellers[z].qty);
          $("#rmaQty").attr("max", selectSellers[z].qty);
          var transactionFeeTmp = selectSellers[z].transactionFee * 1000 / 1000;
          var totalPriceTmp = selectSellers[z].totalPrice * 1000 / 1000;
          $("#transactionFee").val(transactionFeeTmp);
          $("#totalPrice").val(totalPriceTmp);
          $("#re_ship_to_qty").val(selectSellers[z].qty);
          $("#re_ship_to_qty").attr("max", selectSellers[z].qty);
          $("#refund_msg{{ count }}").html(selectSellers[z].tip_rebate_refund);
          $("#tip_refund{{ count }}").html(selectSellers[z].msg_rebate_refund);
          if (selectSellers[z].orderStatus == 16) {
            $("#refund_amount").val(totalPriceTmp);
          }
        }
      }
    }
  });

  $("#selectOrderId").change(function () {
    // 清除后一个下拉框
    $('#selectSellers').empty();
    var dataId1 = $("#selectItemCode").find('option:selected').attr("data-id");
    var dataId2 = $(this).find('option:selected').attr("data-id");
    var selectOrderIds = selectItems[dataId1].items;
    var selectSellers = selectOrderIds[dataId2].items;
    for (var z = 0; z < selectSellers.length; z++) {
      $("#selectSellers").append("<option data-id=" + z + " value='" + selectSellers[z].sellerId + "'>" + selectSellers[z].sellerName + "</option>");
      $("#rmaQty").val(selectSellers[z].qty);
      $("#rmaQty").attr("max", selectSellers[z].qty);
      $("#totalPrice").val(selectSellers[z].totalPrice * 1000 / 1000);
      $("#re_ship_to_qty").val(selectSellers[z].qty);
      $("#re_ship_to_qty").attr("max", selectSellers[z].qty);
      $("#refund_msg{{ count }}").html(selectSellers[z].tip_rebate_refund);
      $("#tip_refund{{ count }}").html(selectSellers[z].msg_rebate_refund);
      var totalPriceTmp = selectSellers[z].totalPrice * 1000 / 1000;
      if (selectSellers[z].orderStatus == 16) {
        $("#refund_amount").val(totalPriceTmp);
      }
    }
  });

  function collapse(obj) {
    if ($(obj)[0].checked) {
      $('.' + $(obj)[0].id).collapse('show');
    } else {
      $('.' + $(obj)[0].id).collapse('hide');
    }
  }

  var appFile = new Vue({
    el: '#appFile',
    delimiters: ['${', '}$'],
    data() {
      return {
        imgList: [],
        size: 0
      }
    },
    methods: {
      fileClick() {
        document.getElementById('upload_file').click()
      },
      fileChange(el) {
        if (!el.target.files[0].size) return;
        this.fileList(el.target);
        el.target.value = ''
      },
      fileList(fileList) {
        let files = fileList.files;
        if ((this.imgList.length + files.length) > 20) {
          layer.alert("The number of uploaded files cannot exceed 20.", {
            title: 'Message',
            btn: 'OK',
            skin: 'yzc_layer' //样式类名
            , closeBtn: 0
          });
          return;
        }
        for (let i = 0; i < files.length; i++) {
          if (i == 20 || this.imgList.length == 20) {
            return;
          }
          //判断是否为文件夹
          if (files[i].type != '') {
            if (files[i].type.indexOf('image') == -1) {
              layer.alert("Please upload image type files!", {
                title: 'Message',
                btn: 'OK',
                skin: 'yzc_layer' //样式类名
                , closeBtn: 0
              });
            } else {
              if (this.imgList.length > 20) {
                layer.alert("The number of uploaded files cannot exceed 20.", {
                  title: 'Message',
                  btn: 'OK',
                  skin: 'yzc_layer' //样式类名
                  , closeBtn: 0
                });
              } else {
                this.fileAdd(files[i]);
              }
            }
          } else {
            //文件夹处理
            if (fileList.items == undefined) {
              layer.alert("Upload file type is incorrect!", {
                title: 'Message',
                btn: 'OK',
                skin: 'yzc_layer' //样式类名
                , closeBtn: 0
              });
            } else {
              if (this.imgList.length > 20) {
                layer.alert("The number of uploaded files cannot exceed 20.", {
                  title: 'Message',
                  btn: 'OK',
                  skin: 'yzc_layer' //样式类名
                  , closeBtn: 0
                });
              } else {
                this.folders(fileList.items[i]);
              }
            }
          }
        }
      },
      //文件夹处理
      folders(files) {
        let _this = this;
        //判断是否为原生file
        if (files.kind) {
          files = files.webkitGetAsEntry();
        }
        files.createReader().readEntries(function (file) {
          for (let i = 0; i < file.length; i++) {
            if (file[i].isFile) {
              _this.foldersAdd(file[i]);
            } else {
              _this.folders(file[i]);
            }
          }
        })
      },
      foldersAdd(entry) {
        let _this = this;
        entry.file(function (file) {
          _this.fileAdd(file)
        })
      },
      fileAdd(file) {
        //总大小
        this.size = this.size + file.size;
        //判断是否为图片文件
        if (file.type.indexOf('image') == -1) {
          file.src = 'catalog/view/theme/yzcTheme/stylesheet/diyUpload/images/wenjian.png';
          this.imgList.push({
            file
          });
        } else {
          let reader = new FileReader();
          reader.vue = this;
          reader.readAsDataURL(file);
          reader.onload = function () {
            file.src = this.result;
            this.vue.imgList.push({
              file
            });
          }
        }
      },
      fileDel(index) {
        this.size = this.size - this.imgList[index].file.size;//总大小
        this.imgList.splice(index, 1);
      },
      bytesToSize(bytes) {
        if (bytes === 0) return '0 B';
        let k = 1000, // or 1024
            sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'],
            i = Math.floor(Math.log(bytes) / Math.log(k));
        return (bytes / Math.pow(k, i)).toPrecision(3) + ' ' + sizes[i];
      },
      dragenter(el) {
        el.stopPropagation();
        el.preventDefault();
      },
      dragover(el) {
        el.stopPropagation();
        el.preventDefault();
      },
      drop(el) {
        el.stopPropagation();
        el.preventDefault();
        this.fileList(el.dataTransfer);
      }
    }
  });

  //保留两位
  function fixedTwo(that){
    let val = $(that).val();
    if (val){
      var len = val.split('.')[1]?val.split('.')[1].length:0;
      val = val==0?0:Number(val).toFixed(len);
      $(that).val(val);
    }
  }
</script>
{{ footer }}