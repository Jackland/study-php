{% trans_default_category 'catalog/view/account/message_center/common/detail/chat' %}

{% for style in styles %}
    <link href="{{ style }}" type="text/css" rel="stylesheet"/>
{% endfor %}
{% for script in scripts %}
    <script type="text/javascript" src="{{ script }}"></script>
{% endfor %}

{% set titleStr = '' %}
{% if prev_route == 'account/message_center/platform_secretary' %}
    {% set titleStr = 'Giga Help Desk' %}
{% elseif prev_route == 'account/message_center/seller' %}
    {% set titleStr = 'From Sellers' %}
{% endif %}

{{ this.title(titleStr) }}
  {{ this.params('breadcrumbs', [
      'home',
      {
          text: 'Message Center',
          href: 'javascript:void(0)',
      },
      {
          text: titleStr,
          href: url(prev_route),
      }
  ]) }}


{# 富文本引用 #}
{{ this.registerAssets(['App\\Assets\\Common\\SummernoteAsset']) }}

{{ css([
    'css/common/common.css',
    'css/common/common-ext.css',
    'static/message/message-common.css',
    'static/message/buyer-message-common.css',
    'static/message/detail/chat.css'
]) }}

<link rel="stylesheet" type="text/css" href="catalog/view/javascript/bootstrap-select18/bootstrap-select.min.css">
<link rel="stylesheet" type="text/css" href="catalog/view/javascript/jquery/datetimepicker/bootstrap-datetimepicker.min.css">
<script type="text/javascript" src="/catalog/view/javascript/bootstrap/js/bootstrap-paginator.min.js"></script>
<script type="text/javascript" src="catalog/view/javascript/layer/layer.js"></script>

{% if separate_view is defined and separate_view %}
<div class="container-fluid" id="content" style="margin-left: 235px">
    <ul class="breadcrumb">
        {% for breadcrumb in breadcrumbs %}
            <li><a href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a></li>
        {% endfor %}
    </ul>
    {% else %}
    <div class="container">
        {% endif %}
        <div class="row">{{ column_left }}
            {% if column_left and column_right %}
                {% set class = 'col-sm-6' %}
            {% elseif column_left or column_right %}
                {% set class = 'col-sm-9' %}
            {% else %}
                {% set class = 'col-sm-12' %}
            {% endif %}
            {% if separate_view == 0 %}
                {% set table_div_class = 'overflow: hidden;' %}
            {% endif %}
            <div ng-app="app" ng-cloak>
              <div id="content" class="{{ class }}">{{ content_top }}
                {{ message_column }}
                <div id="table_content" class="tab-content mymessage-content  msgcent msg-detail__container msg-h508" style="{{ table_div_class }}">
                  {#  面板  #}
                  <div id="page-chat">
                    <div>
                      <div class="msgcent msg-detail__header">
                        <div class="msgcent msg-detail__backbtn"><a href="{{ prev_url }}" data-toggle="tooltip" title="back"><i class="giga icon-V10_zuocejiantou"></i></a></div>
                        <div class="msgcent msg-detail__healer-title">
                            {{ header }}
                        </div>
                        <div class="msgcent msg-detail__header__btn-group">
                        </div>
                      </div>
                      <div class="talk-list msgcent msg-detaildialog__container">
                        {% for message in  body %}
                          <div class="talk clearfix msgcent msg-detaildialog__item">
                            <div class="msgcent msg-detaildialog__logo 
                                {% if  customer_id == message.sender_id %} msg-detaildialog-r {% else %} msg-detaildialog-l {% endif %}"
                                {% if customer_id != message.sender_id and message.sender_id == -1 %} style="background-color: #fff" {% endif %}>
                              {% if customer_id == message.sender_id %}
                                  <img src="{{ asset('image/icons/chat/default.png') }}" alt="">
                              {% else %}
                                  {% if message.sender_id == -1 %}
                                      <img src="{{ asset('image/icons/chat/gigi-help-desk.png') }}" alt="">
                                  {% else %}
                                      {% if chat_object_avatar %}
                                          <img src="{{ chat_object_avatar }}" alt="">
                                      {% else %}
                                          <img src="{{ asset('image/icons/chat/seller.png') }}" alt="">
                                      {% endif %}
                                  {% endif %}
                              {% endif %}
                            </div>
                            <div class="msgcent msg-detaildialog__card-container {% if customer_id == message.sender_id %} msg-detaildialog-r {% else %} msg-detaildialog-l {% endif %}">
                                <div class="msgcent msg-detaildialog__card">
                                    <div class="subject-content {% if customer_id == message.sender_id %} frbg {% else %}  flbg {% endif %} ">
                                        <label class="msg-detailldialog__label">Subject:</label>
                                        <p class="textd">{{ message.subject }}</p>
                                        <label class="msg-detailldialog__label mt-8">Messages:</label><br>
                                        <table class="tablep">{{ message.content }}</table>{# 数据中有缺失table结束标签的 #}
                                        <div class="attachment">
                                            {% if message.files %}
                                                {% for file in message.files %}
                                                    <a href="{{ file.url }}" target="_blank" class="attachment-link" style="display: block"><i class="giga icon-attachment" aria-hidden="true"></i>&nbsp;{{ file.name }}</a>
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>

                                    {% if (is_send_email and titleStr != 'Trash' and customer_id != message.sender_id) or (message.sender_id != -1 and message.sender_id != 0 and message.sender_id != customer_id) %}
                                    <div class="msg-detaildialog-form__operation">
                                            {% if is_send_email and titleStr != 'Trash' and customer_id != message.sender_id %}
                                            <i class="giga icon-fayoujian-01 msg-detaildialog__sendicon" 
                                                data-placement="right"
                                                data-toggle="tooltip" title="By clicking on this button, an alert email will be sent to your related mailbox"
                                                aria-hidden="true" onclick="sendEmail('{{ message.msg_id }}', '{{ message.receiver_id }}')"></i>
                                            {% endif %}
                                            {% if is_send_email and message.sender_id != -1 and message.sender_id != 0 and message.sender_id != customer_id %}
                                              {# 分割线 #}
                                              <div class="msg-oper-line"></div>
                                            {% endif %}
                                        {% if message.sender_id != -1 and message.sender_id != 0 and message.sender_id != customer_id %}
                                            {% if message.is_complained %}
                                                <i class="giga icon-jubao-01 msg-detaildialog__sendicon disabled complained-icon" 
                                                  data-id="{{ message.msg_id }}" data-seller_id="{{ message.sender_id }}"
                                                  data-toggle="tooltip" title="Complained" data-placement="right"
                                                  aria-hidden="true"></i>
                                            {% else %}
                                                <i class="giga icon-jubao-01 msg-detaildialog__sendicon" 
                                                  data-id="{{ message.msg_id }}" data-seller_id="{{ message.sender_id }}"
                                                  data-toggle="tooltip" title="Complaint" data-placement="right"
                                                  aria-hidden="true" onclick="handleComplaint(this)"></i>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="msgcent msg-detaildialog__cardtime">
                                    {{ message.post_time }}
                                    <span></span>
                                </div>
                            </div>
                          </div>
                        {% endfor %}
                      </div>
                      {% if not readonly and titleStr != 'Trash' %}
                          <div id="message_form" class="msgcent msg-detaildialog-form__container">
                              {% if not is_build_relation %}
                                  <form method="POST" ng-hide="!selection" enctype="multipart/form-data">
                                      <div id="seller-contact">
                                          <input type="hidden" value="{{ messages[0].message_id }}" name="parent_id">
                                          <input type="hidden" value="{{ receiver_id }}" name="receiver_id">
                                          <div id="subject-input-container">
                                              <div class="msgcent msg-form__label-sm"><span class="required-before"></span>Reply</div>
                                              <input type="text" name="subject" value="{{ subject }}" id="message-subject" maxlength="250" required class="oris-input reply-input msg-form"/>
                                              <div class="error-tip text-danger hidden">Subject can not be blank.</div>
                                          </div>
                                          <div class="msgcent msg-form__item mt-16">
                                            <div class="msgcent msg-form__label-sm">
                                                Content:
                                            </div>
                                            {% if words_type %}
                                                <div class="msgcent msg-form__label-sm common-words-label">
                                                    Specific Scenario Corpus:
                                                </div>
                                                <div class="common-words-container">
                                                    {% include 'yzcTheme/template/account/message_center/common/common_words/index.twig' %}
                                                </div>
                                            {% endif %}
                                            <div class="form-group msg-richtextarea" style="padding: 0;" id="content-textarea-container">
                                                <textarea class="content-textarea msg-form" id="content-textarea" data-toggle="summernote"></textarea>
                                                <div class="error-tip text-danger hidden">Content can not be blank.</div>
                                            </div>

                                            <div class="btn-container">
                                                {% include 'yzcTheme/template/account/message_center/common/file_upload/index.twig' %}
                                                <button type="button" class="oris-button oris-w120 oris-button-bigger" id="send-btn" onclick="sendMsg();">Send</button>
                                            </div>
                                          </div>

                                      </div>

                                      <div id="file-list-container" style="display:none"></div>

                                  </form>
                              {% else %}
                                  <div class="btn-container">
                                      <div class="btn-group">
                                          <button onclick="returnEstablishResult(1,{{ msg_id }})" class="oris-button btn-item width120">Agree</button>
                                          <button onclick="returnEstablishResult(0,{{ msg_id }})" class="oris-button btn-item oris-button-default width120">Rejected</button>
                                      </div>
                                  </div>

                                  {# <div style="text-align:center;margin-top:10px;">
                                    <div onclick="returnEstablishResult(1,{{ message_id }})" class="btn btn-light" style="margin-right: 10px;background: #4CB54C;color: #fff;">Agree</div>
                                    <div onclick="returnEstablishResult(0,{{ message_id }})" class="btn btn-primary" style="margin-right: 10px;background: #e24111;border: 0;">Rejected</div>
                                    <div onclick="goback()" class="btn btn-light" style="border: 1px solid #a0a0a0;">GO BACK</div>
                                  </div> #}
                              {% endif %}
                          </div>
                      {% endif %}
                    </div>
                    <div class="complaint-container" style="display:none">
                      <div class="oris-comments">
                        <textarea rows="4" class="oris-input complaint-content msg-form" id="complaint-content" placeholder="Please enter content..." style="height:230px;"></textarea>
                        <span class="letter-count"><span id="complaint-len" class="link-color">0</span>/500</span>
                      </div>
                      <div class="error-tip text-danger hidden">Content can not be blank.</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>


        </div>
    </div>
    {{ footer }}
</div>

<script src="catalog/view/javascript/jquery/datetimepicker/bootstrap-datetimepicker.min.js" type="text/javascript"></script>
<script type="text/javascript" src="catalog/view/javascript/bootstrap-select18/bootstrap-select.min.js"></script>

<script>
    console.log({{is_send_email | json_encode()}})
    var complainBtn = null;
    
    //计算word 数量
    $("#complaint-content").bind('input propertychange change', function () {
      calcComplaintContent();
    });

    //刷新投诉理由内容数据
    function calcComplaintContent() {
      var val = $("#complaint-content").val();
      var data = toolString.calcStringLength(val, 500);
      $("#complaint-content").val(data.fullStr);
      $("#complaint-len").text(data.len)
    }

    $(document).ready(function() {
      // 清除富文本编辑框默认换行
      $("#content-textarea").val("");
      // 默认滚动到底部
      $('.msg-detaildialog__container').scrollTop($('.msg-detaildialog__container')[0].scrollHeight);
    })

    function showMsg(isSuccess, msg) {
        $.toast({
            heading: false,
            text: msg,
            position: 'top-center',
            showHideTransition: 'fade',
            icon: isSuccess ? 'success' : 'error',
            hideAfter: 3000,
            allowToastClose: false,
            loader: false
        });
    }

    //输入时清空局部的错误提示
    $('#message-subject').on('input', function(){
      if ($('#message-subject').val().trim()) {
        toggleFormError(formValidateMap.subject, false);
      }
    })

    $("#content-textarea").on("summernote.change", function (e) {   // callback as jquery custom event 
      if ($("#content-textarea").val().trim()) {
        toggleFormError(formValidateMap.content, false, true);
      }
    });

    // 显示错误提示
    // @params isRich 是否是富文本
    // @params show 显示错误或者影藏错误
    function toggleFormError(el, show=true, isRich=false) {
      show ? $(el + " .error-tip").removeClass("hidden") : $(el + " .error-tip").addClass("hidden");
      let formRed = isRich ? el + " .note-frame" : el + " .msg-form";
      show ? $(formRed).addClass("error-input") : $(formRed).removeClass("error-input");
    }

    // 表单验证字段dom对应
    var formValidateMap = {
      subject: "#subject-input-container",
      content: "#content-textarea-container"
    }

    function resetFormValidate() {
      $('.error-tip').addClass('hidden');
      $('.note-frame').removeClass("error-input");
      $('.msg-form').removeClass("error-input");
    }

    function sendMsg() {
        resetFormValidate();

        let formData = new FormData();
        let content = $('#content-textarea').val();
        let hasError = false;

        // if (content.replace(/<.*?>/g,"") === '') {
        if (content.trim() === '') {
          toggleFormError(formValidateMap.content,true,true);
          hasError = true;
        }
        formData.append('content', content);

        let subject = $('#message-subject').val();
        if (!subject) {
          toggleFormError(formValidateMap.subject);
          hasError = true;
        }

        if(hasError) {
          return;
        }

        formData.append('subject', subject);
        formData.append('msg_id', '{{ msg_id }}');
        formData.append('receiver_id', '{{ receiver_id }}');

        let files =  getUploadFiles();
        for (let i=0; i < files.length; i++) {
            formData.append('files[]', files[i]);
        }

        block.blockUI();
        $("#send-btn").prop("disabled", true);
        $.ajax({
            url: "{{ url('account/message_center/message/reply') }}",
            type: "POST",
            data: formData,
            dataType:'json',
            contentType: false,
            processData: false,
            enctype: 'multipart/form-data',
            success: function(res) {
                block.unBlockUI();
                if (res.code == 200) {
                    $.toast({
                        heading: false,
                        text: 'Reply Successfully!',
                        position: 'top-center',
                        showHideTransition: 'fade',
                        icon: 'success',
                        hideAfter: 3000,
                        allowToastClose: false,
                        loader: false,
                    });
                    let titleStr = '{{ titleStr  }}';
                    if (titleStr === 'From Sellers') {
                        location.href = '{{ url('account/message_center/seller', {tab_type:'sent'}) }}'
                    } else if (titleStr === 'Giga Help Desk') {
                        location.href = '{{ url('account/message_center/platform_secretary', {tab:'sent'}) }}'
                    } else {
                        location.reload();
                    }
                } else {
                    showMsg(0, res.msg)
                    $("#send-btn").prop("disabled", false);
                }
            },
            error: function() {
                block.unBlockUI();
                layer.alert("Oop! Something went wrong and it wa probably our fault. Please try again later or report the problem to us!", {
                    closeBtn: 1,
                    btnAlign: 'c',
                    title: 'Message',
                    btn: ['OK'],
                    skin: 'oris-layer'
                });
                $("#send-btn").prop("disabled", false);
            }
        })
    }

    function goback() {
        window.location.href = '{{ url(prev_route) }}';
    }

    function returnEstablishResult(returnType, messageId) {
        let layer_area;
        if (returnType == 1) {
            change_invisible_display();
            //同意
            var title = 'Approve the application of {{ chat_username|e('js') }}({{ chat_user_number }})';
            var comment = 'Welcome to establish relationship with [{{ store_name|e('js') }}]. Look forward to future cooperation.'
            $(".set_group").show();
            layer_area = ['480px', '360px'];
        } else {
            var title = 'Reject the application of {{ chat_username|e('js') }}({{ chat_user_number }})';
            var comment = 'Sorry this store is not in business so far. It\'s currently not availble to be accessed.'
            $(".set_group").hide();
            layer_area = ['480px', 'auto'];
        }

        layer.open({
            type: 1,
            title: title,
            closeBtn: 0,
            skin: 'yzc_layer',
            shadeClose: false,
            area: layer_area,
            offset: 'auto',
            content: $("#returnEstablishModal"),
            btn: ['OK', 'Cancel'],
            btnAlign: 'center',
            resize: false,
            scrollbar: false,
            yes: function (index, layero) {
                var body = layero.find('textarea').val();
                let buyer_group_id = $("#input_buyer_group").val();
                layer.close(index);
                if (returnType == 1) {
                    isRefine = layer.confirm("Do you want to take refined management to the seller?", {
                        btn: ['Yes', 'No,with default settings'],
                        title: 'Message',
                        skin: 'yzc_layer',
                    }, function (index, layero) {
                        establishReply(returnType, messageId, 1, body, buyer_group_id);
                        layer.close(index);
                    }, function (index) {
                        establishReply(returnType, messageId, 0, body, buyer_group_id);
                        layer.close(index);
                    });
                } else {
                    establishReply(returnType, messageId, 0, body, buyer_group_id);
                }
            }
        });
    }

    function handleComplaint(el) {
        layer.open({
            type: 1,
            area: ['640px', '400px'],
            title: "Reasons for complaint",
            skin: 'oris-layer',
            scrollbar: false,
            content: $(".complaint-container"),
            btn: ['Submit', 'Cancel'],
            yes: function (layerIndex, layerObj) {
              if(!$("#complaint-content").val().trim()) {
                toggleFormError(".complaint-container");
                return false;
              }

              complainBtn = $("a.layui-layer-btn0");
              if(complainBtn.hasClass("layui-btn-disabled")){
                  return;
              }
              complainBtn.addClass("layui-btn-disabled"); 

              complain($(el).data('id'), $("#complaint-content").val(), $(el).data('seller_id'));
              calcComplaintContent();
            },
            btn2: function (index, layerObj) {
                $("#complaint-content").val("");
                calcComplaintContent();
                toggleFormError(".complaint-container", false);
            },
            cancel: function() {
                $("#complaint-content").val("");
                calcComplaintContent();
                toggleFormError(".complaint-container", false);
            }
        });
    }

    // 投诉
    function complain(msgId, reason, sellerId) {
        let data = {};
        data["msg_id"] = msgId;
        data["reason"] = reason;
        data["seller_id"] = sellerId;
        data["type"] = 1;
        $.ajax({
            url: "{{ url('account/message_center/address_book/complain') }}",
            type: 'post',
            dataType: 'json',
            data: data,
            beforeSend: function () {
            },
            success: function (json) {
                layer.closeAll();
                layer.alert("Your report has been sent to GIGA Marketplace, and we will feedback the processing result to you as soon as possible. Thank you for your support.", {
                  closeBtn: 0,
                  btnAlign: 'c',
                  title: 'Attention',
                  btn: ['I Know'],
                  skin: 'oris-layer'},
                function () {
                    layer.closeAll();
                    window.location.reload();
                });
                complainBtn.removeClass("layui-btn-disabled");            
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                complainBtn.removeClass("layui-btn-disabled");
            }
        });
    }

    $("#input_buyer_group").change(function () {
        change_invisible_display();
    });

    function change_invisible_display() {
        if ($("#input_buyer_group").val() == 0) {
            $(".invisible_product_group").hide();
            $(".invisible_product_group_num").hide();
            return;
        } else {
            $(".invisible_product_group").show();
            $(".invisible_product_group_num").show();
        }
        let option_selected = $("#input_buyer_group option:selected");
        let product_group = option_selected.data('product_group');
        let product_group_num = option_selected.data('product_group_num');
        $(".invisible_product_group").text(product_group ? product_group : ' -- None -- ');
        if (product_group_num <= 1) {
            $(".invisible_product_group_num").hide();
        } else {
            $(".invisible_product_group_num").show().text('+' + (product_group_num - 1));
        }
    }

    function sendEmail(msgId, receiverId) {
        $.ajax({
            url: '{{ url("account/message_center/message/sendEmail") }}',
            data: {msg_id: msgId, receiver_id: receiverId},
            dataType: 'json',
            type: "post",
            success: function (json) {
                if (json.code == 200) {
                    $.toast({
                        heading: false,
                        text: 'Email sent successfully.',
                        position: 'top-center',
                        showHideTransition: 'fade',
                        icon: 'success',
                        hideAfter: 3000,
                        allowToastClose: false,
                        loader: false,
                    });
                } else {
                    $.toast({
                        heading: false,
                        text: 'Email sent failed.',
                        position: 'top-center',
                        showHideTransition: 'fade',
                        icon: 'error',
                        hideAfter: 3000,
                        allowToastClose: false,
                        loader: false,
                    });
                }
            }
        });
    }
</script>

<style>
.complained-icon:hover {
  cursor: not-allowed;
}
</style>