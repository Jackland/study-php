{{ header }}
<style>
    .error_a {
        cursor: pointer;
    }
    .error_a:hover {
        color: #00a2d4;
    }
    .buttons{
      text-align: center;
    }
</style>
<script src="catalog/view/javascript/layer/layer.js" type="text/javascript"></script>
<div id="account-customer-order" class="container page-seller-portal">

  {% include 'giga/template/_parts/breadcrumb_simple.twig' %}


  <div class="container">

    <div class="row">
      <div class="col-md-12">
        <h1>{{ text_create_rma }}</h1>
      </div>
    </div>


    <div class="row mb-4">
        <div id="content" class="col-sm-12">
          <div id="page-rma-form" class="tab-content main">
            <div role="tabpanel" class="tab-pane active" id="tab-1">
              <div class="bg-white p-2">
                <div class="rma_customer_order_info">
                    <table class="table main">
                      <thead>
                      <tr>
                          <th>{{ text_order_id }}</th>
                          <th>{{ text_order_from }}</th>
                          <th>Creation Time</th>
                          <th>Order Status</th>
                          <th>{{ text_ship_to }}</th>
                          <th>{{ text_email }}</th>
                          <th>{{ text_phone }}</th>
                          <th style="width: 160px;">Address</th>
                      </tr>
                      </thead>
                      <tbody>
                      <tr>
                        <td><input id="customer_order_id" class="form-control" type="text"
                                   placeholder="{{ text_order_id }}"
                                   name="customer_order_id"
                                   value="{{ customer_order_id }}"/>
                          <input type="text" id="header_id" name="header_id" value="" hidden/></td>
                        <td><span id="customer_order_from" class="customer_order_info"></span>
                          <input type="text" id="orderFrom" name="orderFrom" value="" hidden/></td>
                        <td><span id="customer_order_date" class="customer_order_info"></span></td>
                        <td><span id="customer_order_status" class="customer_order_info"></span></td>
                        <td><span class="customer_order_info" id="customer_order_ship_to"></span></td>
                        <td><span class="customer_order_info" id="customer_order_email"></span></td>
                        <td><span class="customer_order_info" id="customer_order_phone"></span></td>
                        <td><span class="customer_order_info" id="customer_order_address"></span></td>
                        <input type="text" id="order_status" name="order_status" value="" hidden/>
                      </tr>
                      </tbody>
                    </table>
                </div>

                <div id="customer-order-details-div">

                </div>
                <div class="buttons">
                  <a class="btn btn-primary btn1" id="test1">{{ button_submit }}</a>
                  &emsp;<a onclick="backUrl()" class="btn btn-default">{{ button_back }}</a>
                </div>
              </div>
            </div>
          </div>
        </div>
    </div>

  </div>
</div>

<script>
    var flag = true;
    var submitflag = true;
    var countArray = [];
    var appFileArray = [];
    var salesOrderStatus = null;

    function backUrl() {
        window.history.back(-1);
    }

    function orderDetailsDivEmpty() {
        $('#customer-order-details-div').empty();
        countArray = [];
        appFileArray = [];
        salesOrderStatus = null;
    }

    function submitRmaData(button) {
       submitflag = false;
      // $(button).attr('disabled',true);
      //   $(button).button('loading');
        // 清除提示
        $("#error_msg_div").empty();
        $(".has-error").removeClass('has-error');
        $(".text-danger").remove();


        if ((typeof checkRefundAmount) == "function") {
            var isOK = true;
            $('input[id^="refund_amount"]').each(function (index, ele) {
                if (!checkRefundAmount(ele,index)) {
                    isOK = false;
                    return false;
                }
            });
            if (!isOK) {
                $('#test1').button('reset');
                return false;
            }
        }


        var formData = new FormData();
        var datas = $("#order_from").serializeArray();
        if (datas.length == 0) {
            layer.alert("Please add RMA detail!", {
                title: 'Message',
                btn : 'OK',
                skin: 'yzc_layer' //样式类名
                ,closeBtn: 0
            });
            $('#test1').button('reset');
            return;
        }
        for (var i = 0; i < datas.length; i++) {
            formData.append(datas[i].name, datas[i].value);
        }
        for (var i = 0; i < countArray.length; i++) {
            formData.append("index[]", countArray[i]);
            var fileList = [];
            for (var j = 0; j < appFileArray[countArray[i]].imgList.length; j++) {
                fileList.push(appFileArray[countArray[i]].imgList[j].file);
            }
            fileList.forEach(function (file) {
                formData.append('files' + countArray[i] + "[]", file, file.name);
            });
        }
        formData.append('sales_order_id', $("#header_id").val());
        formData.append('customer_order_id', $("#customer_order_id").val());
        formData.append('orderFrom', $("#orderFrom").val());
        formData.append('orderStatus', $("#order_status").val());
        if(!submitflag) {
          $.ajax({
            url: 'index.php?route=account/rma_management/saveRmaRequest',
            type: 'post',
            data: formData,
            async: false,
            cache: false,
            contentType: false,
            processData: false,
            dataType: 'json',
            success: function (json) {
              submitflag = true;
              console.log(json);
              if (json != null) {
                if (json.error != undefined) {
                  $('#test1').button('reset');
                  var errorDiv = "<div class=\"alert alert-danger alert-dismissible\" role=\"alert\">";
                  errorDiv += '<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'
                  errorDiv += "<strong>Error Message!</strong><br/>";
                  // var flag = true;
                  for (var i = 0; i < json.error.length; i++) {
                    if (json.error[i].displayType == 1) {
                      // 上面展示
                      errorDiv += "<u><a class='alert-link error_a' onclick=\"scrollById('" + json.error[i].href + "')\">" + json.error[i].errorMsg + "</a></u><br/>";
                    } else if (json.error[i].displayType == 2) {
                      // if (flag) {
                      //     errorDiv += "Please check the entry!" + "<br/>";
                      //     flag = false;
                      // }
                      errorDiv += "<u><a class='alert-link error_a' onclick=\"scrollById('" + json.error[i].href + "')\">" + json.error[i].errorMsg + "</a></u><br/>";
                      $("#" + json.error[i].id).parent(" .form-group").addClass('has-error');
                      $("#" + json.error[i].id).after('<div class="text-danger">' + json.error[i].errorMsg + "</div>");
                    }
                    if (Array.isArray(json.error[i].id)) {
                      for (var j = 0; j < json.error[i].id.length; j++) {
                        $("#" + json.error[i].id[j]).parent(" .form-group").addClass('has-error');
                      }
                    }
                  }
                  errorDiv += '</div>';
                  $("#error_msg_div").append(errorDiv);
                  $('html, body').animate({
                    scrollTop: $("#error_msg_div").offset().top - 50
                  }, 500);
                }
                if (json.status != null && json.status == "success") {
                  location.href = json.successUrl + "&filter_customer_order_id=" + encodeURIComponent($("#customer_order_id").val());
                }
              } else {
                console.log("No return data");
              }
            },
            error: function (xhr, ajaxOptions, thrownError) {
              submitflag = true;
              $("#test1").button('reset');
                layer.alert(thrownError + "<br>" + xhr.statusText + "<br>" + xhr.responseText, {
                    title: 'Message',
                    btn : 'OK',
                    skin: 'yzc_layer' //样式类名
                    ,closeBtn: 0
                });
            }
          });
        }
    }

    function scrollById(id) {
        var container = $('#rma-details-panel-body');
        var scrollTo = $("#" + id);
        $('#rma-details-panel-body').animate({
            scrollTop: scrollTo.offset().top - container.offset().top + container.scrollTop() - 5
        }, 500);
    }

    $('input[name=\'customer_order_id\']').autocomplete({
        'source': function (request, response) {
            $.ajax({
                url: 'index.php?route=account/rma_management/autocomplete&filter_order_id=' + encodeURIComponent(request),
                dataType: 'json',
                success: function (json) {
                    response($.map(json, function (item) {
                        return {
                            label: item['order_id'],
                            value: item['id'],
                            orders_from: item['orders_from'],
                            order_date: item['order_date'],
                            order_status: item['order_status'],
                            ship_to: item['ship_to'],
                            phone: item['phone'],
                            email: item['email'],
                            address: item['address']
                        }
                    }));
                }
            });
        },
        'select': function (item) {
            // 清空
            orderDetailsDivEmpty();
            $('input[name=\'customer_order_id\']').val(item['label']);
            $('#header_id').val(item['value']);
            $('#customer_order_from').text(item['orders_from']);
            $('#orderFrom').val(item['orders_from']);
            $('#customer_order_date').text(item['order_date']);
            {% for order_status in customer_order_status %}
            if (item['order_status'] == '{{ order_status.DicKey }}') {
                salesOrderStatus = item['order_status'];
                $('#customer_order_status').text('{{ order_status.DicValue }}');
                $('#order_status').val('{{ order_status.DicValue }}');
            }
            {% endfor %}
            $('#customer_order_ship_to').text(item['ship_to']);
            $('#customer_order_email').text(item['email']);
            $('#customer_order_phone').text(item['phone']);
            $('#customer_order_address').text(item['address']);
            flag = false;
            // 隐藏下拉面板
            $('.rma_customer_order_info ul.dropdown-menu').hide();
            // block.blockUI();
            $('#customer-order-details-div').load('index.php?route=account/rma_management/customerOrderDetails&customer_order_id=' + encodeURIComponent($('#customer_order_id').val()));
        }
    });
    $("#customer_order_id").blur(function () {
        if ($('#customer_order_id').val() == '') {
            $('.customer_order_info').text('');
            orderDetailsDivEmpty();
            return;
        } else {
            setTimeout(function () {
                // input的blur要比autocomplete的select先执行，故加一个flag延时判断有没有选择
                if (flag) {
                    $('.customer_order_info').text('');
                    $.ajax({
                        url: 'index.php?route=account/rma_management/loadCustomerOrderInfo&customer_order_id=' + encodeURIComponent($('#customer_order_id').val()),
                        dataType: 'json',
                        success: function (json) {
                            orderDetailsDivEmpty();
                            // if (json.length == 0) {
                            //     alert("Sales Order " + $('#customer_order_id').val() + " doesn’t exist!");
                            // }
                            $('#header_id').val(json['id']);
                            $('#customer_order_from').text(json['orders_from']);
                            $('#orderFrom').val(json['orders_from']);
                            $('#customer_order_date').text(json['order_date']);
                            {% for order_status in customer_order_status %}
                            if (json['order_status'] == '{{ order_status.DicKey }}') {
                                salesOrderStatus = json['order_status'];
                                $('#customer_order_status').text('{{ order_status.DicValue }}');
                                $('#order_status').val('{{ order_status.DicValue }}');
                            }
                            {% endfor %}
                            $('#customer_order_ship_to').text(json['ship_to']);
                            $('#customer_order_email').text(json['email']);
                            $('#customer_order_phone').text(json['phone']);
                            $('#customer_order_address').text(json['address']);
                            $('#customer-order-details-div').load('index.php?route=account/rma_management/customerOrderDetails&customer_order_id=' + encodeURIComponent($('#customer_order_id').val()));
                        }
                    });
                } else {
                    flag = true;
                }
            }, 500);
        }
    });
    $("#test1").click(function(){
        $(this).button('loading');
        setTimeout(function () {submitRmaData(this) },500);
      });
    var url = window.location.href;
    if(url.indexOf('sales_order_id')!=-1){
      var sales_order_id = url.split('sales_order_id=')[1];
      $('#customer_order_id').val(decodeURIComponent(sales_order_id));
          setTimeout(function () {
            // input的blur要比autocomplete的select先执行，故加一个flag延时判断有没有选择
            if (flag) {
              $('.customer_order_info').text('');
              $.ajax({
                url: 'index.php?route=account/rma_management/loadCustomerOrderInfo&customer_order_id=' + encodeURIComponent($('#customer_order_id').val()),
                dataType: 'json',
                success: function (json) {
                  orderDetailsDivEmpty();
                  // if (json.length == 0) {
                  //     alert("Sales Order " + $('#customer_order_id').val() + " doesn’t exist!");
                  // }
                  $('#header_id').val(json['id']);
                  $('#customer_order_from').text(json['orders_from']);
                  $('#orderFrom').val(json['orders_from']);
                  $('#customer_order_date').text(json['order_date']);
                  {% for order_status in customer_order_status %}
                  if (json['order_status'] == '{{ order_status.DicKey }}') {
                    salesOrderStatus = json['order_status'];
                    $('#customer_order_status').text('{{ order_status.DicValue }}');
                    $('#order_status').val('{{ order_status.DicValue }}');
                  }
                  {% endfor %}
                  $('#customer_order_ship_to').text(json['ship_to']);
                  $('#customer_order_email').text(json['email']);
                  $('#customer_order_phone').text(json['phone']);
                  $('#customer_order_address').text(json['address']);
                  $('#customer-order-details-div').load('index.php?route=account/rma_management/customerOrderDetails&customer_order_id=' + encodeURIComponent($('#customer_order_id').val()));
                }
              });
            } else {
              flag = true;
            }
          }, 500);
    }
</script>
{{ footer }}