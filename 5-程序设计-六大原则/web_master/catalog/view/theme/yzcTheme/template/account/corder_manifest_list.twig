
<link href="catalog/view/javascript/bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen"/>
<link href="catalog/view/theme/yzcTheme/stylesheet/font_demo/iconfont.css" rel="stylesheet" type="text/css">
<link type="text/css" href="/public/fonts/giga/iconfont.css?v={{ app_version }}" rel="stylesheet">{#B2B页面改版 图标字体#}
<script src="catalog/view/javascript/jquery/jquery-2.1.1.min.js" type="text/javascript"></script>
<script src="catalog/view/javascript/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
<script src="catalog/view/javascript/common.js?v={{ app_version }}" type="text/javascript"></script>
<style>
  *{
    color: #333;
    font-size: 14px;
  }
  .inner-container{
    padding: 10px;
    padding-bottom: 0;
  }
  .tip{
    padding: 10px;
    background-color: #fff5ef;
    color: #fa6400;
    border-radius: 4px;
    font-size:14px;
    margin-bottom: 10px;
  }
  .query-con{
    margin-bottom: 18px;
  }
  .query-btn{
    padding: 11px;
  }
  .query-btn span{
    color: #3A75DC;
  }
  .query-input{
    background: #f3f5f7;
    padding-right: 34px;
    height: 38px;
    border-radius: 4px 0 0 4px !important;
  }
  .input-deleted{
    color: #bbb;
    position: absolute;
    top: 14px;
    right: 50px;
    z-index: 99;
  }
  .input-deleted:hover{
    cursor: pointer;
    color: #3A75DC;
  }
  .form-control:focus {
    border-color: #3a75dc;
    box-shadow: none;
  }
  .think-con{
    width: 92.6%;
    position: absolute;
    z-index: 99;
    background: #fff;
  }
  .think-con ul{
    border: 1px solid #ccc;
    border-top: none;
    padding-left: 0px;
  }
  .think-con ul li{
    padding-left: 12px;
    list-style: none;
    line-height: 30px;
    color: #333;
  }
  .think-con ul li:hover{
    background: #eee;
    cursor: pointer;
  }
  .table-header,.table-item,.table-item .mf{
    display: flex;
    align-items: center;
  }
  .warehouse_code{
    width: 15%;
    padding: 8px 12px;
  }
  .rpd{
    width: 15%;
    padding: 8px 12px;
  }
  .cn{
    width: 20%;
    padding: 8px 12px;
  }
  .mf{
    width: 50%;
    padding: 8px 12px;
  }
  .table-label{
    font-weight: bolder;
  }
  .panel-default>.panel-heading {
    color: #333;
     background-color: transparent;
     border-color: transparent;
  }
  .panel-heading {
    padding: 0;
    border-bottom: 1px solid transparent;
    border-top-left-radius: 0;
    border-top-right-radius: 0;
  }
  .panel-default{
    border: none;
  }
  .table-header{
    border-bottom: 2px solid #ddd;
  }
  .inner-container .btn-primary{
    font-size: 12px;
    color: #fff;
    background-color: #3a75dc;
    border-color: #225cc1;
    padding: 6px 10px;
    font-size: 12px;
    box-shadow: 0px 2px 2px 0 #eee;
  }
  .inner-container .btn-primary.my-disabled,.inner-container .btn-primary.my-disabled:hover{
    cursor:not-allowed;
    background: #bbb;
    color: #fff;
    border-color: #bbb;;
  }
  .inner-container .btn-primary:hover {
    background-color: #225cc1;
  }
  .upload-btn{
    width: 20%;
  }
  .upload-file{
    width: 486px;
    word-wrap: break-word;
  }
  .trans-btn{
    width: 10%;
  }
  .coll-btn{
    display: inline-block;
    width: 30px;
    height: 30px;
    text-align: center;
    line-height: 30px;
    color: #000;
    background: #eee;
    font-size: 16px;
    border-radius: 4px;
  }
  .coll-btn:hover,.coll-btn:active,.coll-btn:focus{
    text-decoration: none;
    background: #000;
    color: #fff;
  }
  .file-deleted{
    color: #bbb;
  }
  .file-deleted:hover{
    cursor: pointer;
    color: #3A75DC;
  }
  .num,.status-newOrder{
    color: #FA6400;
  }
  .status-beingProcessed{
    color: #67C23A;
  }
  .status-common{
    color: grey;
  }
  .status-checkLabel{
    color: #F56C6C;
  }
  .table>tbody>tr>td{
    vertical-align: middle;
  }
  .item-img{
    display: inline-block;
    width: 35px;
    height: 35px;
  }
  .panel-group{
    height: calc(100% - 280px);
    overflow: auto;
    margin-bottom: 0;
  }
  .tbody {
    max-height: 200px;
    overflow-y: scroll;
  }
  .tbody::-webkit-scrollbar {
    display: none
  }
  .panel-body table tr th:nth-of-type(1),
  .panel-body table tr td:nth-of-type(1) {
    width: 10%;
  }

  .panel-body table tr th:nth-of-type(2),
  .panel-body table tr td:nth-of-type(2) {
    width: 20%;
  }

  .panel-body table tr th:nth-of-type(3),
  .panel-body table tr td:nth-of-type(3) {
    width: 20%;
  }

  .panel-body table tr th:nth-of-type(4),
  .panel-body table tr td:nth-of-type(4) {
    width: 10%;
  }

  .panel-body table tr th:nth-of-type(5),
  .panel-body table tr td:nth-of-type(5) {
    width: 30%;
  }
  .panel-body table tr th:nth-of-type(6),
  .panel-body table tr td:nth-of-type(6) {
    width: 10%;
  }
  .table{
    margin-bottom: 0;
  }
  .table>thead>tr>th{
    border-bottom: none;
  }
  .btn-con{
    padding-top: 12px;
    text-align: center;
    box-shadow: 0 -8px 10px #eee;
    position: relative;
  }
  .btn-primary.my-submit{
    font-size: 12px;
    background: #478BFF;
    border-color: #478BFF;
  }
  .btn-default.my-cancel{
    font-size: 12px;
    color: #478BFF;
    background-color: #fff;
    border-color: #ececec;
    font-weight: 700;
  }
  .inner-container .jump-records:hover {
    cursor: pointer;
  }
</style>
<div class="inner-container">
  <div class="tip">
    If you don't upload Manifest, the order status will still be Check Label which means it cannot be purchased or shipped.
  </div>
  <div class="tip">
    The list below only displays the relevant Manifest data that is needed to be uploaded or requires modification. If you wish to check the Manifests that have been uploaded and are unable to be modified, please see the Manifest Records.
    <a class="jump-records" onclick="top.open('{{ url('account/customer_order/getManifestHistoryList') }}', '_blank'); return false;">Manifest Records</a>
  </div>
  <div class="query-con">
    <div class="input-group">
      <span class="glyphicon glyphicon-remove-sign input-deleted" id="deleteInpt"></span>
      <input type="text" class="form-control query-input" placeholder="Sales Order ID" value="{{ order_id }}" id="query">
      <span class="input-group-btn">
        <button class="btn btn-default query-btn" type="button" onclick="searchOrder()"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
      </span>
    </div>
    {% if list  %}
    {% else %}
      <div style="color:red">
        The Sales Order ID was not found.
      </div>
    {% endif %}

  </div>
  {% if list %}
    <div class="table-con">
      <div class="table-header">
        <div class="warehouse_code"><span class="table-label">B2B Warehouse Code</span></div>
        <div class="rpd"><span class="table-label">Ready for Pickup Date</span></div>
        <div class="cn"><span class="table-label">Carrier Name</span></div>
        <div class="mf"><span class="table-label">Manifest</span></div>
      </div>
      <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
        {% for key,value in list %}
          <div class="panel panel-default">
            <div class="panel-heading" role="tab">
              <div class="table-item">
                <div class="rpd">
                  <span class="table-info">
                    {% if value.warehouse_name !='warehouse_code' %}
                          {{ value.warehouse_name }}
                    {% endif %}
                  </span></div>
                <div class="rpd"><span class="table-info">{{ value.order_date }}</span></div>
                <div class="cn"><span class="table-info">{{ value.carrier_name }}</span></div>
                <div class="mf">
                  {% if value.is_uploaded %}
                    {% if value.is_synchroed %}
                      <div class="upload-btn">
                        <button type="button"
{#                                disabled="disabled"#}
                                class="btn btn-primary my-disabled"
                                id='{{ value.order_id_all }}_div'
                                name="{{ value.order_id_all}}_div"
                                data-toggle="tooltip"
                                data-trigger = "hover"
                                title="This file has been synced to the shipping system and cannot be modified. If you would like to modify, please contact the customer service."
                        >
                          Modify
                        </button>
                      </div>
                      <div class="upload-file" id="{{ value.order_id_all}}_show">
                        <span onclick="getManifestPdf(this)" style="cursor:pointer;color:#23527c;text-decoration:underline;" mean="{{ value.deal_file_path }}" > {{ value.file_name }}</span>
    {#                    <i class="glyphicon glyphicon-remove-circle file-deleted" style="margin-left: 5px;cursor: pointer" onclick="cleanFile('{{ value.order_id_all}}')"></i>#}
                      </div>
                    {% else %}
                      <div class="upload-btn">
                        <button type="button"
                                class="btn btn-primary"
                                id='{{ value.order_id_all }}_div'
                                name="{{ value.order_id_all}}_div"
                        >
                          Modify
                        </button>
                        <input type="file" id="{{ value.order_id_all }}" name='{{ value.order_id_all }}' onchange="handleFiles(this.files,'{{ value.order_id_all }}','{{ value.is_uploaded }}')" style="display:none;">
                      </div>
                      <div class="upload-file" id="{{ value.order_id_all}}_show">
                        <span onclick="getManifestPdf(this)" style="cursor:pointer;color:#23527c;text-decoration:underline;" mean="{{ value.deal_file_path }}"> {{ value.file_name }}</span>
    {#                    <i class="glyphicon glyphicon-remove-circle file-deleted" style="margin-left: 5px;cursor: pointer" onclick="cleanFile('{{ value.order_id_all}}')"></i>#}
                      </div>
                    {% endif %}
                  {% else %}
                    <div class="upload-btn">
                      <button type="button"
                              class="btn btn-primary"
                              id='{{ value.order_id_all }}_div'
                              name="{{ value.order_id_all}}_div"
                      >
                        Upload
                      </button>
                      <input type="file" id="{{ value.order_id_all }}" name='{{ value.order_id_all }}' onchange="handleFiles(this.files,'{{ value.order_id_all }}','{{ value.is_uploaded }}')" style="display:none;">
                    </div>
                    <div class="upload-file" id="{{ value.order_id_all}}_show">

                    </div>
                  {% endif %}

                  <div class="trans-btn">
                      <a class="giga icon-action-stretch coll-btn" role="button" data-toggle="collapse" data-parent="#accordion" href="#sale{{ key }}" aria-expanded="false" aria-controls="sale{{ key }}"></a>
                  </div>
                </div>
              </div>
            </div>
            <div id="sale{{ key }}" class="panel-collapse collapse" role="tabpane{{ key }}" aria-labelledby="headingSale{{ key }}">
              <div class="panel-body">
                <div class="thead">
                  <table class="table">
                    <thead>
                    <tr>
                      <th>#</th>
                      <th>Sale Order ID(<span class="num">{{ value.order_amount }}</span>)</th>
                      <th>Status</th>
                      <th></th>
                      <th>B2B Item Code</th>
                      <th>Packages(<span class="num">{{ value.package_qty }}</span>)</th>
                    </tr>
                    </thead>
                  </table>
                </div>
                <div class="tbody">
                  <table class="table">
                    <tbody>
                    {% for ks,vs in value.list %}
                      {% for k,v in vs.line_list %}
                      <tr>
                        {% if v.is_show %}
                          <td rowspan="{{ v.row_span }}">{{ ks + 1 }}</td>
                          <td rowspan="{{ v.row_span }}">{{ vs.order_id }}</td>
                          <td rowspan="{{ v.row_span }}"
                              {% if vs.order_status == '129' %}
                                  class="status-checkLabel"
                              {% elseif vs.order_status == '1' %}
                                  class="status-newOrder"
                              {% elseif vs.order_status == '2' %}
                                  class="status-beingProcessed"
                              {% else %}
                                  class="staus-common"
                              {% endif %}
                          >{{ vs.order_status_name }}</td>
                        {% endif %}
                        <td><a href="{{ v.product_link }}" target="_blank"><img class="item-img" src="{{ v.image_show }}" alt=""></a></td>
                        <td>
                          {{ v.item_code }}
                          {% if v['tag_array'] is not empty %}
                            {% for tag in v['tag_array'] %}
                              &nbsp;{{ tag }}
                            {% endfor %}
                          {% endif %}
                        </td>
                        <td>{{ v.package_qty }}</td>
                      </tr>
                      {% endfor %}
                    {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}
</div>
{% if list %}
  <div class="btn-con">
  <button id='btnClose' class="btn btn-primary my-submit" onclick="checkInputInfo()" >SUBMIT</button>&nbsp;&nbsp;
  <button class="btn btn-default my-cancel" onclick="cancelConfirm()" >CANCEL</button>
</div>
{% endif %}
<script>
var manifest_common_label = [];
{% for key,value in list%}
    {% if value.is_synchroed  == '' %}
      var file_select_name = '{{ value.order_id_all }}' + '_div';
      var file_elem_name = '{{ value.order_id_all }}';
      var fileSelect_{{ key }}  = document.getElementById(file_select_name),
        fileElem_{{ key }} = document.getElementById(file_elem_name);

      fileSelect_{{ key }}.addEventListener("click", function (e) {

        if (fileElem_{{ key }}) {
          fileElem_{{ key }}.click();
        }
        e.preventDefault(); // prevent navigation to "#"
      }, false);
    {% endif %}

{% endfor %}
$(document).ready(function () {
  //气泡
  $('[data-toggle="tooltip"]').tooltip();
  parent.layer.closeAll('loading');
  //input 清除
  $("#deleteInpt").on("click",function () {
    $("#query").val("");
  });
  $('#query').autocomplete({
    'minLength':1,
    'source': function(request, response) {
      if(encodeURIComponent(request)){
        $.ajax({
          url: 'index.php?route=account/customer_order/getSalesOrderBySearch&order_id=' +  encodeURIComponent(request),
          dataType: 'json',
          success: function(json) {
            console.dir(json);
            response($.map(json.items, function(item) {
              return {
                label: item['order_id'],
                value: item['id']
              }
            }));
          }
        });
      }
    },
    'select': function(item) {
      $(this).val(item['label']);
    }

  });

  //点击其余某处联想框消失
  $("body").on("click",function (event) {
    if(event.target.className.indexOf("query-input")==-1){
      $('#think').hide();
    }
  })
  //切换伸缩
  $('body').on("click",'.coll-btn',function () {
    if($(this).attr('class').indexOf("icon-arrow-compress")!=-1){
      $(this).attr("class","giga icon-action-stretch coll-btn")
    }else{
      $(this).attr("class","giga icon-arrow-compress coll-btn")
    }
  })
});

  function getManifestPdf(obj) {
    var url = $(obj).attr('mean');
    var upload_info = 'Manifest';
    parent.layer.open({
      type: 2,
      offset: ['150px', '380px'],
      area: ['700px', '400px'],
      title: upload_info,
      fixed: false, //不固定Change
      maxmin: true,
      skin: 'yzc_layer',
      scrollbar: false,
      content: url,
    });
  }
  
  function cleanFile(container_id) {
    var del_url = '{{ dropship_file_unlink }}';
    $.ajax({
      url: del_url,
      type: 'post',
      dataType: 'json',
      //                async:false,
      data: {'container_id': container_id},
      beforeSend: function () {
        parent.layer.load(1,{shade: [0.3,'#000']});
      },
      success: function (res) {
        parent.layer.closeAll('loading');
        var container_id_div = '#' + container_id + '_div';
        $('#' + container_id).val('');
        $(container_id_div).removeClass('my-disabled');
        $(container_id_div).attr('disabled',false);
        var container_show = '#' + container_id + '_show';
        $(container_show).empty();
        manifest_common_label[container_id + '_label'] = '';
      }
    })
  
  }
  
  function handleFiles(files,container_id,is_uploaded){
    var formFile = new FormData();
    if(files[0]['type'] !== 'application/pdf'){
      layerMsg('Please upload a file in PDF format.');
      return false;
    }
    if(files[0]['size'] > 1024*1024){
      layerMsg('Please upload a PDF file not exceeding 1MB.');
      return false;
    }
    formFile.append("container_id", container_id);
    formFile.append("files", files[0]);
    var data = formFile;
    $.ajax({
      url: "/index.php?route=account/customer_order/wayfairUploadManifestDeal",
      data: data,
      type: "Post",
      dataType: "json",
      cache: false,//上传文件无需缓存
      processData: false,//用于对data参数进行序列化处理 这里必须false
      contentType: false, //必须
      beforeSend: function () {
        parent.layer.load(1,{shade: [0.3,'#000']});
      },
      success: function (result) {
        parent.layer.closeAll('loading');
        if(result.error === 0){
  
          var container_id_div = '#' + result.data.container_id + '_div';
          if(is_uploaded === '0'){
            $(container_id_div).addClass('my-disabled');
            $(container_id_div).attr('disabled',true);
            var info = '<span style="cursor:pointer;color:#23527c;text-decoration:underline;" onclick="getManifestPdf(this)" mean="' + result.data.deal_file_path + '" >' + result.data.file_name + '</span><i style="margin-left: 5px;cursor: pointer" onclick="cleanFile(' + "'" + result.data.container_id + "'" + ')" class="glyphicon glyphicon-remove-circle file-deleted"></i>';
          }else{
            var info = '<span style="cursor:pointer;color:#23527c;text-decoration:underline;" onclick="getManifestPdf(this)" mean="' + result.data.deal_file_path + '" >' + result.data.file_name + '</span>';
          }
          var container_show = '#' + result.data.container_id + '_show';
          $(container_show).empty();
          $(container_show).show();
  
          $(container_show).append(info);
          $('[data-toggle="tooltip"]').tooltip();
          manifest_common_label[result.data.container_id + '_label'] = result.data.file_name;
        }else{
          layerMsg(result.error,3000);
          manifest_common_label[result.data.container_id + '_label'] = '';
        }
      },
      error: function (xhr, ajaxOptions, thrownError) {
        parent.layer.closeAll('loading');
        layerMsg(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
      }
    })
  }

  function checkInputInfo() {
    $('#btnClose').attr('disabled', 'disabled');
    var temp_label = [];
    var file_str = '';
    for(let ks  in manifest_common_label){
      if(manifest_common_label){
        file_str += ks + ':' + manifest_common_label[ks] + ';';
        temp_label.push(manifest_common_label[ks])
      }
    }
    if(temp_label.length === 0){
      layerMsg("You have not uploaded any manifest files, if not, please click the 'CANCEL' button.");
      $('#btnClose').attr('disabled', false);
      return false;
    }else{
      $.ajax({
        url: '{{ europe_wayfair_manifest_management_preserved }}',
        type: 'post',
        dataType: 'json',
        //                async:false,
        data: {'manifest_common_label': file_str },
        beforeSend: function () {
          parent.layer.load(1,{shade: [0.3,'#000']});
        },
        success: function (res) {
          if(res.error === 0){
            parent.layer.closeAll('loading');
            layerMsg(res.msg,2000);
            parent.layer.load(1,{shade: [0.3,'#000']});
            var order_id = $('#query').val();
            var show_url ='index.php?route=account/customer_order/getManifestList&order_id=' +  encodeURIComponent(order_id);
            window.location.href = show_url;
          }else{
            parent.layer.closeAll('loading');
            layerMsg(res.msg,2000);
            $('#btnClose').attr('disabled', false);
          }
  
        },
        error: function () {
          layerMsg('Submit failed',3000);
          parent.layer.closeAll('loading');
          $('#btnClose').attr('disabled', false);
        }
      })
    }
  
  }

  function layerMsg(message, time = 2000) {
    parent.layer.msg(message, {time: time});
  }

  function cancelConfirm() {
    var index = parent.layer.getFrameIndex(window.name);
    parent.layer.close(index);
  }
  
  function searchOrder() {
    var order_id = $('#query').val().trim();
    var url_get ='index.php?route=account/customer_order/getManifestList&order_id=' +  encodeURIComponent(order_id);
    parent.layer.load(1,{shade: [0.3,'#000']});
    window.location.href = url_get;
  }

</script>