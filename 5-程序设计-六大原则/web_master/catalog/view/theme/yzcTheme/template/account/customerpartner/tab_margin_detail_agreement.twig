<div class="row">
  <div class="col-sm-12">
    <div class="label_blue"><h3>Agreement Details</h3></div>
    <div style="margin: 10px auto;overflow: hidden">
      <div class="col-sm-3 details">
        <p class="giga icon-summary-quote"></p>
        <p class="title">{{ column_agreement_id }}</p>
        <p class="txt">{{ agreement_detail.agreement_id }}<br>
          {# 协议bid的人 #}
            <p>
               <span class="user_portrait" data-user_customer_id="{{ agreement_detail.buyer_id }}" >
                {{ agreement_detail.nickname }}({{ agreement_detail.user_number }})
              </span>
              <span>
              <img data-toggle="tooltip" style="padding-left: 1px"
                   src="{{ agreement_detail.is_home_pickup ? asset('image/icons/HomePickup/home_pickup-15x15.png') : asset('image/icons/HomePickup/drop_shipping-15x15.png') }}"
                   data-original-title="{{ agreement_detail.is_home_pickup?tip_home_pickup_logo:tip_drop_shipping_logo }}">
              </span>
            </p>
          {#  其他共同履约人 #}
          {% for buy_0 in agreement_detail['buyer_list'][0]  %}
            <p>
              <span class="user_portrait" data-user_customer_id="{{ buy_0['buyer_id'] }}" >
              {{ buy_0['nickname'] }}({{ buy_0['user_number'] }})
              </span>
              <span>
              <img data-toggle="tooltip" style="padding-left: 1px"
                   src="{{ buy_0.is_home_pickup ? asset('image/icons/HomePickup/home_pickup-15x15.png') : asset('image/icons/HomePickup/drop_shipping-15x15.png') }}"
                   data-original-title="{{ buy_0.is_home_pickup?tip_home_pickup_logo:tip_drop_shipping_logo }}">
              </span>
              <span class="giga icon-seal_positive" data-toggle="tooltip" title="{{ tip_add_partner_approved }}" style="font-size: 15px;vertical-align: middle;color: #FA6400"></span>
            </p>
          {% endfor %}
          {% if agreement_detail.performer_apply %}
            <p>
              <span class="user_portrait" data-user_customer_id="{{ agreement_detail.performer_apply.performer_buyer_id }}" >
              {{ agreement_detail.performer_apply.nickname }}({{ agreement_detail.performer_apply.user_number }})
              </span>
              <span>
              <img data-toggle="tooltip" style="padding-left: 1px"
                   src="{{ agreement_detail.performer_apply.is_home_pickup ? asset('image/icons/HomePickup/home_pickup-15x15.png') : asset('image/icons/HomePickup/drop_shipping-15x15.png') }}"
                   data-original-title="{{ agreement_detail.performer_apply.is_home_pickup?tip_home_pickup_logo:tip_drop_shipping_logo }}">
              </span>
              {% if agreement_detail.performer_apply.check_result ==0 and (agreement_detail.performer_apply.seller_approval_status == 0 or agreement_detail.performer_apply.seller_approval_status == 1 )%}
                <span class="giga icon-seal_active" data-toggle="tooltip" title="{{ tip_add_partner_pending }}"  style="font-size: 15px;vertical-align: middle;color: #FA6400"></span>
              {% elseif agreement_detail.performer_apply.check_result ==1 %}
                <span class="giga icon-seal_positive" data-toggle="tooltip" title="{{ tip_add_partner_approved }}" style="font-size: 15px;vertical-align: middle;color: #FA6400"></span>
              {% elseif agreement_detail.performer_apply.check_result ==2 or agreement_detail.performer_apply.seller_approval_status  == 2 %}
                <span class="giga icon-seal_nagative" data-toggle="tooltip" title="{{ tip_add_partner_rejected }}" style="font-size: 15px;vertical-align: middle;color: #FA6400"></span>
              {% endif %}
            </p>
          {% endif %}
        </p>
      </div>
      <div class="col-sm-3 details">
        <p class="giga icon-summary-day"></p>
        <p class="title">{{ label_margin_validity }}Beginning</p>
        <p class="txt">{{ agreement_detail.effect_time }}</p>
      </div>
      <div class="col-sm-3 details">
        <p class="giga icon-summary-day"></p>
        <p class="title">{{ label_margin_validity }}Ending</p>
        <p class="txt">{{ agreement_detail.expire_time }}</p>
      </div>

      <div class="col-sm-3 details" style="border: none">
        <p class="giga icon-summary-po-id"></p>
        <p class="title">{{ column_item_code }}（{{ column_mpn }}）</p>
        <p class="txt">
          {{ agreement_detail.sku }}
            <a href="{% if margin_tpl %}{{ margin_tpl }}{% else %}javascript:void(0);{% endif %}" target="_blank">
              <i class="giga icon-V10-wenhaotishi" data-toggle="tooltip" data-html='true' title="<div style='word-wrap:normal'>{{ to_margin_template }}</div>"></i>
            </a>
        </p>
      </div>
    </div>
    {% if agreement_detail.effect_time %}
    {% endif %}
    <div>
    </div>
    <div class="table-responsive" style="margin-top: 30px">
      <table class="table table-hover" >
        <thead >
        <tr >
          <td>{{ column_mpn }}</td>
          <td>{{ column_item_code }}</td>
          <td>{{ column_qty }}</td>
          <td>{{ column_price }}</td>
          <td>{{ column_day }}</td>
          <td>{{ column_margin_amount_sum }}</td>
        </tr>
        </thead>

        {% if agreement_detail %}
          <tbody>
          <tr>
            <td>{{ agreement_detail.mpn }}</td>
            <td>
              <a class="a-link" target="_blank" href="/index.php?route=product/product&product_id={{ agreement_detail.product_id }}">
                <span>{{ agreement_detail.sku }}</span>&nbsp;
                <i class="giga -iconfont icon-table-link"></i>
              </a>
            </td>
            <td class="text-price" style="color: {{ agreement_detail.qty_color }}">{{ agreement_detail.num }}</td>
            <td class="text-price" style="color: {{ agreement_detail.other_color }}">{{ agreement_detail.unit_price }}</td>
            <td class="text-price" style="color: {{ agreement_detail.other_color }}">{{ agreement_detail.day }}</td>
            <td class="text-price" style="color: {{ agreement_detail.other_color }}">{{ agreement_detail.sum_price }}</td>
          </tr>
          </tbody>
        {% else %}
          <tbody>
          <tr>
            <td colspan="6" class="text-center">{{ text_no_results }} </td>
          </tr>
          </tbody>
        {% endif %}
      </table>
    </div>
    <div class="label_blue" style="margin-top: 10px">
      {{ label_messages }}
    </div>
    <div style="padding: 10px 10px 10px 10px">
      <label style="text-align: center;float: left;padding-top: 25px">
        <i style="color: red">*</i>
        Original Comments from Buyer
      </label>
      <textarea style="resize:none ;height: 70px;width: 85%" placeholder="" disabled >{{ first_message }}</textarea>
    </div>
    <div>
      <div style="padding: 10px 10px 10px 10px">
        <label>
          <i style="color: red">*</i>
          Message to Buyer
        </label>
        <div style="border: 1px solid #ddd; padding: 10px;{% if not messages %} width: 85%; {% endif %}">
          <div class="message-div conversational-message-wrapper message-section mt-2" id="agreement_message_history"  {% if not messages %} style="height: 30px;text-align: center;font-weight: 700;color: #183464;line-height: 30px;margin-bottom: 0px;" {% endif %} >
            {% if messages %}
              {% for msg in messages %}
                {% if msg.writer_id == 0 or msg.writer_id == -1 %}
                {#System#}
                  <div class="message-item incoming">
                    <div class="left">
                      <div style="width: 36px;height: 36px;border: 1px solid black;font-size: 12px;border-radius: 50%;">&nbsp;&nbsp;SYS<br>&nbsp;&nbsp;TEM</div>
                    </div>
                    <div class="right">
                      <div class="info">
                        <span style="text-align: right;padding-right: 3px;">{{ msg.name }}</span>
                        <span><i class="giga icon-Action-Time"></i>{{ msg.msg_date }}</span>
                      </div>
                      <div class="contents" style="word-break: break-word;">
                        {{ msg.message }}
                      </div>
                    </div>
                  </div>
                {% elseif msg.writer_id == customer_id %}
                  {#Seller#}
                  <div class="message-item outgoing">
                    <div class="left">
                      <div>
                        <span style="display: inline-block; height: 40px;width: 40px;border-radius: 20px;background-image: url('{{ self_store_pic }}');color: #fff;text-align: center;line-height: 40px;font-weight: bold;">
{#                           <img src="{{ self_store_pic }}"/>#}
                        </span>
                      </div>
                      {#<img src="//via.placeholder.com/40" alt="" class="avatar" style="width: 40px;">#}
{#                      <i class="giga icon-account-blue" style="font-size: 26px;"></i>#}
                    </div>
                    <div class="right">
                      <div class="info">
                        <span style="text-align: right;padding-right: 3px;">{{ msg.name }}</span>
                        <span><i class="giga icon-Action-Time"></i>{{ msg.msg_date }}</span>
                      </div>
                      <div class="contents" style="word-break: break-word;">
                        {{ msg.message }}
                      </div>
                    </div>
                  </div>
                {% else %}
                  {#Buyer#}
                  <div class="message-item incoming">
                    <div class="left">
                      <div>
                        <span style="display: inline-block; height: 40px;width: 40px;border-radius: 20px;background: #A1ACC0;color: #fff;text-align: center;line-height: 40px;font-weight: bold;">
                          BUYER
                        </span>
                      </div>
                      {#<img src="//via.placeholder.com/40" alt="" class="avatar" style="width: 40px;">#}
{#                      <i class="giga icon-account-blue" style="font-size: 26px;"></i>#}
                    </div>
                    <div class="right">
                      <div class="info">
                        <span style="text-align: right;padding-right: 3px;">{{ msg.name }}
                          {% if not is_partner %}
                            <img data-toggle="tooltip" style="padding:0 3px" src="{{ is_collection_from_domicile ? asset('image/icons/HomePickup/home_pickup-15x15.png') : asset('image/icons/HomePickup/drop_shipping-15x15.png') }}">
                          {% endif %}
                        </span>
                        <span><i class="giga icon-Action-Time"></i>{{ msg.msg_date }}</span>
                      </div>
                      <div class="contents" style="word-break: break-word;">
                        {{ msg.message }}
                      </div>
                    </div>
                  </div>
                {% endif %}
              {% endfor %}
            {% else %}
              No records.
            {% endif %}
          </div>
        </div>
        <div style="position: relative;overflow: hidden;margin-top: 20px;">
          {% if agreement_detail.status == 1 or agreement_detail.status == 2 %}
            <div style="{# border-bottom: 1px solid #ddd; #}padding-bottom: 15px">
              <div class="label_blue">{{ label_process_result }}</div>
              <label style="padding-left: 20px"><input type="radio" name="agreement_status" id="agreement_status_2"
                                                       value="2"/><span style="margin-left: 3px">{{ text_status_2 }}</span></label>
              <label style="padding-left: 20px"><input type="radio" name="agreement_status" id="agreement_status_3"
                                                       value="3"/><span  style="margin-left: 3px">{{ text_status_3 }}</span></label>
              <label style="padding-left: 20px"><input type="radio" name="agreement_status" id="agreement_status_4"
                                                       value="4"/><span  style="margin-left: 3px">{{ text_status_4 }}</span></label>
            </div>
          {% endif %}

          <input type="hidden" name="last_update_time" value="{{ agreement_detail.update_time }}">
          {% if agreement_detail.status == 1 or agreement_detail.status == 2 %}
            <div style="padding-bottom: 15px;overflow: hidden">
              <div style="overflow: hidden;float: left;width: 85%;">
                <label style="width: 100%">
                  <i style="color: red">*</i>
                  <span>Reply</span>
                  <span class="input-required" style="color:red; position: absolute; right: 15%;">REQUIRED</span>
                </label>
                <textarea id="contract_message" style="resize:none ;height: 70px;width: 100%;" placeholder="Type message to buyer."  onkeyup="computWordMarginTerminateReason(this)"></textarea>
                <p class="count-word"  style="color:gray;text-align: right">0/2000</p>
              </div>
              <div class="button-group" style="text-align: center;width: 15%;float: left;margin-top: 40px">
                <button class="btn btn-primary" id="send_message" type="button" onclick="sendMessage(this)" style="margin-top: 15px" disabled>
                  <span class="giga icon-action-send-message"></span>
                  SEND
                </button>
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  //计算word 数量
  function computWordMarginTerminateReason(_this) {
      let words = $(_this).val().trimLeft();
      $(_this).val(words);
      $(_this).next().text(words.length + "/2000");
      if (words.length > 2000) {
          $(_this).parent().find(".input-required").text("REASON can not be more than 2000 characters");
          $('#send_message').attr('disabled', true);
      } else if (words.length < 1) {
          $(_this).parent().find(".input-required").text("REASON can not be left blank");
          $('#send_message').attr('disabled', true);
      } else {
          $(_this).parent().find(".input-required").text("REQUIRED");
          $('#send_message').attr('disabled', false);
      }
  }

  function messageToEnd() {
    var message_div = $('#agreement_message_history');
    var h = $(document).height() - $(window).height();
    message_div.scrollTop(h);
  }

  $(document).ready(function () {
    var status = '{{ agreement_detail.status }}';
    var checkBox = $('#agreement_status_' + status);
    if(checkBox && checkBox.length === 1){
      checkBox.attr('checked', 'checked');
    }else{
      $('#agreement_status_2').attr('checked', 'checked');
    }
    messageToEnd();
  });

  let $notify = window.ELEMENT.Notification;

  function sendMessage(button) {
    $(button).button('loading');
    var msg = $('#contract_message').val().trim();
    $('#contract_message').val(msg);
    var contract_status = $('input[name=\'agreement_status\']:checked').val();
    var last_update_time = $('input[name=\'last_update_time\']').val();
    if (!msg) {
      layer.alert('{{ error_msg_empty }}',
        {
          title: 'Message',
          btn: 'OK',
          skin: 'yzc_layer',
          // icon: 2
        });
      $(button).button('reset');
      return;
    }
    if (msg && msg.length > 2000) {
      layer.alert('{{ error_msg_large }}', {
        title: 'Message',
        btn: 'OK',
        skin: 'yzc_layer',
      });
      $(button).button('reset');
      return;
    }
    var alertConfirm = function () {
      return new Promise(function (resolve, reject) {
         resolve();
      })
    };
    if (contract_status === '3') {
      alertConfirm = function () {
        return new Promise(function (resolve, reject) {
           if (confirm('{{ text_approve_confirm }}')){
             resolve();
           }
           reject();
        })
      }
    } else if (contract_status === '4') {
      alertConfirm = function (){
        return new Promise(function (resolve, reject) {
          if (confirm('{{ text_reject_confirm }}')){
            resolve();
          }
          reject();
        })
      }
    }
    let layer_alarm_price = ('{{ need_alarm }}') && (contract_status === '3') ? layerConfirm : alertConfirm;
    layer_alarm_price('{{ is_show_cwf_notice ? error_product_price_approve_cwf : error_product_price_approve }}')
      .then(function () {
        layer.closeAll();
        var param = {
          'message': msg,
          'agreement_id': '{{ agreement_detail.agreement_id }}',
          'contract_status': contract_status,
          'last_update_time': last_update_time
        };
        $.ajax({
          url: '{{ send_message_action }}',
          dataType: 'json',
          type: 'post',
          data: param,
          success: function (json) {
            $(button).button('reset');
            if (json['success']) {
              $notify.success({
                title: 'Success',
                message: json['success'],
                duration: 3000,
                onClose: function () {
                  location.href = '{{ refresh_action }}';
                }
              });
            } else if (json['error']) {
              $notify.error({
                title: 'Error',
                message: json['error'],
                duration: 3000,
                function() {
                  $(button).button('reset');
                }
              });
            }
          }
        });
      })
      .catch(function () {
        layer.closeAll();
        $(button).button('reset');
      })
  }
</script>
<style>
  .el-notification__content {
    text-align: left;
  }
  .details{
    text-align: center;
    border-right: 1px solid #ccc;
  }
  .details .giga{
    font-size: 20px;
    color: #183464;
  }
  .details .title{
    /*font-weight: bold;*/
    color: #ccc;
  }
  .details .txt{
    color: #000000;
  }
  .giga.icon-help-inactive{
    color: #b620e0;
    font-size: 17px;
    cursor: pointer;
  }
  .logo img{
    height: 40px;
    width: 40px;
    border-radius: 20px;
    background: #aaa;
    margin: 0 6px;
  }
  .logo span{
    display: inline-block;
    height: 40px;
    width: 40px;
    border-radius: 20px;
    background: #A1ACC0;
    color: #fff;
    text-align: center;
    line-height: 40px;
    font-weight: bold;
  }
</style>
