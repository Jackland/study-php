<script src="catalog/view/javascript/jquery/jquery-2.1.1.min.js" type="text/javascript"></script>
<link href="catalog/view/javascript/bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen"/>
<script src="catalog/view/javascript/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
<link href="catalog/view/javascript/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
<link href="catalog/view/theme/yzcTheme/stylesheet/font_demo/iconfont.css" rel="stylesheet" type="text/css"/>
<link href="catalog/view/theme/yzcTheme/stylesheet/fonts.googleapis.com_open+sans.css" rel="stylesheet"
      type="text/css"/>
<link type="text/css" href="/public/fonts/giga/iconfont.css?v={{ app_version }}" rel="stylesheet">{#B2B页面改版 图标字体#}
<link type="text/css" href="//at.alicdn.com/t/font_1474765_75h3uf0o4yb.css" rel="stylesheet">{#gigq图标字体 更新后删除#}
<link href="catalog/view/theme/yzcTheme/stylesheet/stylesheet.css" rel="stylesheet">
<link rel="icon" href="data:;base64,=">

 <script src="catalog/view/javascript/layer/layer.js" type="text/javascript"></script>
<script src="catalog/view/javascript/common.js?v={{ app_version }}" type="text/javascript"></script>
<link href="catalog/view/javascript/diyUpload/file_upload/css/iconfont.css" rel="stylesheet" type="text/css"/>
<link href="catalog/view/javascript/diyUpload/file_upload/css/otherFileUpload.css" rel="stylesheet" type="text/css">
<script type="text/javascript" src="catalog/view/javascript/diyUpload/file_upload/js/fileUploadOther.js"></script>
<link href="catalog/view/theme/yzcTheme/stylesheet/account/pickUpStyle.css" rel="stylesheet" type="text/css"/>
<link href="catalog/view/theme/yzcTheme/stylesheet/account/otherFileUpload.css" rel="stylesheet" type="text/css"/>
<link href="/catalog/view/javascript/layer/theme/yzc/layuiOris.css" rel="stylesheet" />
<style>
    body{
        min-width:auto !important;
        width: 100% !important;
    }
    .modal-body{
        padding: 10px 15px
    }
    .vertical-align-t{
      vertical-align: text-top;
    }
    .top-i-150 {
        top: 150px !important;
    }
</style>

<form enctype="multipart/form-data" id="form-upload">
    <div class="modal-body">
        <div class="user-notice">
            <i class="fa fa-info-circle text-warning mr-04"></i>User Notice
            <a id="iconSwitch" class="btn pull-right p-0" role="button" data-toggle="collapse" href="#collapseExample"
               aria-expanded="false"
               aria-controls="collapseExample">
                <i class="giga icon-icon-GIS_shouqi- text-warning text-size-normal"></i>
            </a>
            <div class="collapse in" id="collapseExample">
                <div class="well">
                    <ul>
                        <li> System only support 4"x6" (102mmx152mm) Thermal label format.</li>
                        <li style="padding-right: 5px"> Small Parcel shipment must upload shipping label and fill in the tracking number.
                            LTL shipment can upload shipping label or packing slip.
                            The packing slip is for information verification purposes only and will not be attached to the package.
                            A separate packing label will be generated by the system and pasted on the package.
                        </li>
                        <li>
                            If the product is a combo product, please upload the shipping label or packing slip for each sub-item.
                        </li>
                        <li>
                          Giga Cloud does not accept FedEx Express Overnight labels. Related service types include, but are not limited to: FedEx First Overnight, FedEx Priority Overnight, FedEx Standard Overnight etc.
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <input type="hidden" id="file_str" name="file_str" value="">
        <input type="hidden" id="file_num" name="file_num" value=0>
        <input type="hidden" id="edit_first" name="edit_first" value="">
        <input type="hidden" id="bol_str" name="bol_str" value="">
        <div class="order-list mt-1 text-smaller">
            {% for order in upload_file_info %}

                <div class="order-detail">
                    <div class="flex-layout order-msg height40 background-blue">
                        <input class="selected-order" type="checkbox" onclick="getCheckBoxNum()" name="{{ order.id }}"
                               id="{{ order.id }}">
                        <input type="hidden" id="order_id" name='order_id' value={{ order.id }}>
                        <div class="order-type mr-2 text-small">{{ order.orders_from }}</div>
                        <div class="orderId">
                            <span class="text-light">Sales Order ID: {{ order.order_id }}</span>
                            <span id="{{ order.id }}_span" class="">(0/{{ order.total_file_amount }})</span>
                        </div>

                        {% if order.bol_flag==1 %}
                            <div class="flex-layout">
                                <span>BOL: </span>
                                <div>
                                    <a id="{{ order.id }}_bol" class="fileUploadContent" style="width:auto;"></a>
                                </div>
                                <div class="upload-fileName" style=""
                                     id="{{ order.id }}_bol_show">
                                </div>
                            </div>
                        {% endif %}
                    </div>

                    {% for children in order.childrenList %}
                        {% if children.is_combo %}{#combol商品#}

                            <div class="item-list mt-02">
                                <div class="flex-layout item-detail background-warn height40 pl-4">
                                    <div class="item-code">
                                        Item Code: {{ children.item_code }}
                                        <img data-toggle="tooltip" class="{{ comboTag.class_style }} vertical-align-t" title="{{ comboTag.description }}" src="/image/{{ comboTag.icon }}" >
                                    </div>
                                    <div class="notes-qty">QTY: {{ children.qty }}</div>
                                    <div class="ship-method">Ship Method: {{ children.ship_method }}</div>
                                    <div class="carrier">Carrier: {{ children.carrier }}</div>
                                </div>

                                {% for detail in children.combo_info %}
                                    <div class="item-detail-list mt-02">
                                        <div class="flex-layout item-detail background-warn height40 pl-4">
                                            <div class="sub-code">Sub-item Code: {{ detail.sku }}</div>
                                            <div class="notes-qty">QTY: {{ detail.qty }}</div>
                                        </div>
                                        <div class="upload-list">
                                            <div class="upload-select">
                                                {% for line in detail.line %}
                                                    <div class="upload-normal{{ line.sort_key }}">
                                                        <div class="upload-detail flex-layout height40 flex-between">
                                                            <div class="flex-layout">
                                                                <div class="list-num">{{ line.sort_key }}</div>
                                                                <div class="flex-layout upload-file">
                                                                    <span class="label-name">Shipping Label: </span>
                                                                    <div class="label-content flex-layout">
                                                                        <div id="{{ line.container_id }}"
                                                                             class="fileUploadContent"
                                                                             style="width:auto;"></div>
                                                                        <div class="fileUploadName" style=""
                                                                             id="{{ line.container_id }}_pdf_show"></div>
                                                                    </div>
                                                                    <div class="packing-content none">
                                                                        <div id="{{ line.container_packing_slip_id }}"
                                                                             class="fileUploadContent"
                                                                             style="width:auto;"></div>
                                                                        <div class="fileUploadName" style=""
                                                                             id="{{ line.container_packing_slip_id }}_pdf_show"></div>
                                                                    </div>
                                                                    <div class="label-tip upload-tip flex-layout  alternate-style {{ line.container_id }}_label_template">
                                                                        {% if line.cut_type == ltl_label_cut %}
                                                                            <a class="link" href="{{ ltl_label_url }}">Label
                                                                                Sample</a>
                                                                            <span class="dividing-line"></span>
                                                                            <a class="link shipping-switch"
                                                                               data-id="{{ line.sort_key }}"> No
                                                                                shipping label?</a>
                                                                        {% else %}
                                                                            <a class="link" href="{{ label_url }}">Label
                                                                                Sample</a>
                                                                        {% endif %}
                                                                    </div>
                                                                    <div class="packing-tip upload-tip flex-layout alternate-style none {{ line.container_packing_slip_id }}_label_template">
                                                                        <a class="link"
                                                                           href="{{ packing_slip_label_url }}">Packing
                                                                            Slip Sample</a>
                                                                        <span class="dividing-line"></span>
                                                                        <a class="link shipping-switch"
                                                                           data-id="{{ line.sort_key }}">No packing
                                                                            slip?</a>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="flex-layout tracking-300">
                                                                <span class="label-shipping-tracking">Tracking Number: </span>
                                                                <span class="label-packing-tracking none"></span>
                                                                <input class="tracking-num focus label-shipping-tracking"
                                                                       id="{{ line.container_id }}_tracking_number"
                                                                       type="text"
                                                                       onblur="pushTrackingNumber(this)"
                                                                       name="{{ line.container_id }}_tracking_number"
                                                                       value="{{ line.tracking_id }}"
                                                                       placeholder="{% if line.cut_type == ltl_label_cut %}Optional{% else %}Required{% endif %}">
                                                                <input class="tracking-num focus label-packing-tracking none"
                                                                       id="{{ line.container_packing_slip_id }}_tracking_number"
                                                                       type="hidden"
                                                                       onblur="pushTrackingNumber(this)"
                                                                       name="{{ line.container_packing_slip_id }}_tracking_number"
                                                                       value="{{ line.tracking_id }}"
                                                                       placeholder="Optional">

                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}{#非combol商品#}
                            <div class="item-list mt-02">
                                <div class="flex-layout item-detail background-warn height40 pl-4">
                                    <div class="item-code">Item Code: {{ children.item_code }}</div>
                                    <div class="notes-qty">QTY: {{ children.qty }}</div>
                                    <div class="ship-method">Ship Method: {{ children.ship_method }}</div>
                                    <div class="carrier">Carrier: {{ children.carrier }}</div>
                                </div>
                                <div class="item-detail-list mt-02">
                                    <div class="upload-list">
                                        <div class="upload-select">
                                            {% for detail in children.combo_info %}
                                                <div class="upload-normal{{ detail.sort_key }}">
                                                    <div class="upload-detail flex-layout height40 flex-between">
                                                        <div class="flex-layout">
                                                            <div class="list-num">{{ detail.sort_key }}</div>
                                                            <div class="flex-layout upload-file">
                                                                <span class="label-name">Shipping Label: </span>
                                                                <div class="label-content flex-layout">
                                                                    <div id="{{ detail.container_id }}"
                                                                         class="fileUploadContent"
                                                                         style="width:auto;"></div>
                                                                    <div class="fileUploadName" style=""
                                                                         id="{{ detail.container_id }}_pdf_show"></div>
                                                                </div>
                                                                <div class="packing-content none">
                                                                    <div id="{{ detail.container_packing_slip_id }}"
                                                                         class="fileUploadContent"
                                                                         style="width:auto;"></div>
                                                                    <div class="fileUploadName" style=""
                                                                         id="{{ detail.container_packing_slip_id }}_pdf_show"></div>
                                                                </div>
                                                                <div class="label-tip upload-tip flex-layout alternate-style {{ detail.container_id }}_label_template">
                                                                    {% if detail.cut_type == ltl_label_cut %}
                                                                        <a class="link" href="{{ ltl_label_url }}">Label
                                                                            Sample</a>
                                                                        <span class="dividing-line"></span>
                                                                        <a class="link shipping-switch"
                                                                           data-id="{{ detail.sort_key }}"> No shipping
                                                                            label?</a>
                                                                    {% else %}
                                                                        <a class="link" href="{{ label_url }}">Label
                                                                            Sample</a>
                                                                    {% endif %}
                                                                </div>
                                                                <div class="packing-tip upload-tip flex-layout alternate-style none {{ detail.container_packing_slip_id }}_label_template">
                                                                    <a class="link" href="{{ packing_slip_label_url }}">Packing
                                                                        Slip Sample</a>
                                                                    <span class="dividing-line"></span>
                                                                    <a class="link shipping-switch"
                                                                       data-id="{{ detail.sort_key }}">No packing
                                                                        slip?</a>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="flex-layout tracking-300">
                                                            <span class="label-shipping-tracking">Tracking Number: </span>
                                                            <span class="label-packing-tracking none"></span>
                                                            <input class="tracking-num focus label-shipping-tracking"
                                                                   id="{{ detail.container_id }}_tracking_number"
                                                                   type="text"
                                                                   onblur="pushTrackingNumber(this)"
                                                                   name="{{ detail.container_id }}_tracking_number"
                                                                   value="{{ detail.tracking_id }}"
                                                                   placeholder="{% if detail.cut_type == ltl_label_cut %}Optional{% else %}Required{% endif %}">
                                                            <input class="tracking-num focus label-packing-tracking none"
                                                                   id="{{ detail.container_packing_slip_id }}_tracking_number"
                                                                   type="hidden"
                                                                   onblur="pushTrackingNumber(this)"
                                                                   name="{{ detail.container_packing_slip_id }}_tracking_number"
                                                                   value="{{ detail.tracking_id }}"
                                                                   placeholder="Optional">
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}

                </div>
            {% endfor %}
        </div>
        <div class="footer text-center relative mt-2">
            <div class="selected-num"><span id="checkboxNum">0</span> orders are selected</div>
            <button type="button" class="btn btn-deep" onclick="checkInputInfo()" name="sub" id="btnSubmit">SUBMIT
            </button>
            <button type="button" class="btn btn-anti-blue" onclick="cancelAction()" id="btnClose" data-dismiss="modal">
                CANCEL
            </button>
        </div>
        <div class="modal-footer-walmart">

        </div>
    </div>
</form>

<script>
    $("body").on('click', '.shipping-switch', function () {
        $list = $(this).parentsUntil('.upload-detail');
        if ($list.find('.packing-content').hasClass('none')) {
            $list.find('.packing-content').removeClass('none').addClass('flex-layout');
            $list.find('.packing-tip').removeClass('none').addClass('alternate-style');
            $list.parent().find('.label-packing-tracking').removeClass('none');
            $list.parent().find('.label-shipping-tracking').addClass('none');
            $list.find('.label-content').addClass('none').removeClass('flex-layout');
            $list.find('.label-tip').addClass('none').removeClass('alternate-style');
            $list.find('.label-name').text('Packing Slip: ');

        } else {
            $list.find('.label-content').removeClass('none').addClass('flex-layout');
            $list.find('.label-tip').removeClass('none').addClass('alternate-style');
            $list.parent().find('.label-shipping-tracking').removeClass('none');
            $list.parent().find('.label-packing-tracking').addClass('none');
            $list.find('.packing-content').addClass('none').removeClass('flex-layout');
            $list.find('.packing-tip').addClass('none').removeClass('alternate-style');
            $list.find('.label-name').text('Shipping Label: ');
            $list.find('.label-name').text('Shipping Label: ');

        }

        // $list.find('.upload-normal'+id).addClass('none');
        // $list.find('.upload-switch'+id).removeClass('none')
    });

</script>
<script>
    $(".order-list .selected-order").on('change click', function () {
        var len = $(".order-list .selected-order:checked").length;
        $("#checkboxNum").text(len)
    });

    var ltl_packing_cut = '{{ ltl_packing_slip_cut }}';
    var ltl_label_cut = '{{ ltl_label_cut }}';
    var bol_list = [];
    var submit_flag = 1;
    var common_label = [];
    var tracking_number = [];
    var js_auxiliary_information = '{{ js_auxiliary_information }}';
    var json = eval('(' + js_auxiliary_information + ')');

    $(function () {
        $(".btn i").click(function () {
            if (
                $(this).hasClass("fa-angle-double-down")) {
                $(this).removeClass("fa-angle-double-down");
                $(this).addClass("fa-angle-double-up")
            } else if (
                $(this).hasClass("fa-angle-double-up")) {
                $(this).removeClass("fa-angle-double-up");
                $(this).addClass("fa-angle-double-down")
            }
        });

        //label上传
        $.each(json.container_id_list.id_list, function (idx, obj) {
            var name = obj;
            //裁剪方式
            var cut_type = name.substring(name.lastIndexOf("_") + 1);
            tracking_number[name] = '';
            common_label[name] = '';
            let wfu = new WpFileUpload(name);
            var check_url = '{{ dropship_file_check_url }}' + '&container_id=' + name;
            var receive_url = '{{ us_other_file_deal_url }}' + '&container_id=' + name + '&cut_type=' + cut_type;
            wfu.initUpload({
                "uploadUrl": receive_url,//上传文件信息地址
                "progressUrl": check_url,//获取进度信息地址，可选，注意需要返回的data格式如下（{bytesRead: 102516060, contentLength: 102516060, items: 1, percent: 100, startTime: 1489223136317, useTime: 2767}）
                "scheduleStandard": true,
                "fileType": ['pdf'],
                "showProgressNum": true,
                "autoCommit": true,
                "showSummerProgress": true,
                "maxFileNumber": 1,
                "ismultiple": false,
                "size": 5 * 1024,
                //"uploadFileParam":'files',
                "showFileItemProgress": false, //"是否显示单文件进度条，默认显示"
                "beforeUpload": function (wfu) {// 在上传前面执行的回调函数
                    return getUploadFileByOrder(wfu);
                },
                "onUpload": function () {// 在上传之后
                    if (wfu.resultData.error == 0) {
                        let intervalId = setInterval(function () {
                            var percent = $('#' + wfu.uploadId + ' .progress').children().eq(0).html();
                            if (percent == '99%') {
                                clearInterval(intervalId);

                                if (wfu.resultData.data.tracking_number != '') {
                                    tracking_number[wfu.uploadId] = wfu.resultData.data.tracking_number;
                                    var tracking_number_id = wfu.uploadId + '_tracking_number';
                                    $('#' + tracking_number_id).val(wfu.resultData.data.tracking_number);

                                    //ltl 不需要校验重复
                                    if (cut_type == ltl_label_cut || cut_type == ltl_packing_cut) {
                                        var ret = false;
                                    } else {
                                        var ret = verifyTrackingNumber(wfu.uploadId);
                                    }
                                } else {
                                    tracking_number[wfu.uploadId] = '';
                                    $('#' + wfu.uploadId + '_tracking_number').val('');
                                    var ret = false;
                                }

                                if (ret == false) {
                                    var file_str = $('#file_str').val();
                                    var id = wfu.uploadId;
                                    var file_name = wfu.fileList[0].name;
                                    file_str += id + ':' + file_name + ';';
                                    $('#file_str').val(file_str);

                                    //上传文件展示
                                    var pdf_show = '#' + wfu.uploadId + '_pdf_show';
                                    $(pdf_show).empty();
                                    $(pdf_show).show();
                                    var info = '<a style="cursor:pointer;color:#169BD5;text-decoration:underline;"  title="' + wfu.resultData.data.file_name + '" onclick="getCommonLabelPdf(this)" mean="' + wfu.resultData.data.deal_file_path + '" >' + wfu.resultData.data.file_name + '</a>';
                                    $(pdf_show).append(info);

                                    // 更新
                                    calcOrderInfo(wfu.uploadId);
                                    common_label[wfu.uploadId] = wfu.fileList[0].name;

                                    let uploadId = wfu.uploadId;
                                    let subberProgress = $("#" + uploadId + " .subberProgress .progress>div");
                                    // 格式化数据
                                    percentNum = '100%';
                                    // 设置长度
                                    subberProgress.css("width", percentNum);
                                    // 是否显示值
                                    subberProgress.html(percentNum);
                                    //隐藏示例
                                    $('.' + wfu.uploadId + '_label_template').addClass('none');
                                } else {
                                    tracking_number[wfu.uploadId] = '';
                                    layerMsg('The selected orders contain repeat tracking numbers [' + ret + ']', 3000);
                                    $('#' + wfu.uploadId + ' .cleanFileBt').trigger('click');
                                    //显示示例
                                    $('.' + wfu.uploadId + '_label_template').removeClass('none');
                                }
                            }
                        }, 500);

                    } else {

                        let intervalId = setInterval(function () {
                            var percent = $('#' + wfu.uploadId + ' .progress').children().eq(0).html();
                            if (percent == '99%') {
                                clearInterval(intervalId);
                                layerMsg(wfu.resultData.msg);
                                $('#' + wfu.uploadId + ' .cleanFileBt').trigger('click');
                                //显示示例
                                $('.' + wfu.uploadId + '_label_template').removeClass('none');
                            }
                        }, 500);
                    }
                }

            });
        });


        // bol 上传
        if (json.bol) {
            $.each(json.bol, function (idx, obj) {
                var name = obj;
                bol_list[name] = '';
                let wfu = new WpFileUpload(name);
                //使用walmart裁剪上传方式
                var receive_url = '{{ walmart_bol_deal_url }}' + '&container_id=' + name;
                wfu.initUpload({
                    "uploadUrl": receive_url,//上传文件信息地址
                    "scheduleStandard": true,
                    "fileType": ['pdf'],
                    "showProgressNum": true,
                    "autoCommit": true,
                    "showSummerProgress": true,
                    "maxFileNumber": 1,
                    "ismultiple": false,
                    "size": 5 * 1024,
                    //"uploadFileParam":'files',
                    "showFileItemProgress": false, //"是否显示单文件进度条，默认显示"
                    "beforeUpload": function (wfu) {// 在上传前面执行的回调函数
                        //校验
                        return getUploadBolByOrder(wfu);
                    },
                    "onUpload": function () {// 在上传之后
                        if (wfu.resultData.error == 0) {//上传成功
                            let intervalId = setInterval(function () {
                                var percent = $('#' + wfu.uploadId + ' .progress').children().eq(0).html();
                                if (percent == '99%') {
                                    clearInterval(intervalId);
                                    let uploadId = wfu.uploadId;
                                    let subberProgress = $("#" + uploadId + " .subberProgress .progress>div");
                                    // 格式化数据
                                    percentNum = '100%';
                                    // 设置长度
                                    subberProgress.css("width", percentNum);
                                    // 是否显示值
                                    subberProgress.html(percentNum);
                                    var bol_show = '#' + uploadId + '_show';
                                    $(bol_show).empty();
                                    var info = '<a style="cursor:pointer;color:#169BD5;text-decoration:underline;"  title="' + wfu.resultData.data.file_name + '" href="' + wfu.resultData.data.deal_file_path + '" target="_blank" >' + wfu.resultData.data.file_name + '</a>';
                                    $(bol_show).append(info);
                                    //$(bol_show).append(delBtn);
                                    $(bol_show).show();
                                    bol_list[uploadId] = wfu.resultData.data.file_name;
                                    // 也需要验证是否可以勾选 checkbox
                                    calcOrderInfo(uploadId);
                                }

                            }, 500);
                        } else {//上传失败
                            let intervalId = setInterval(function () {
                                var percent = $('#' + wfu.uploadId + ' .progress').children().eq(0).html();
                                if (percent == '99%') {
                                    clearInterval(intervalId);
                                    layerMsg('{{ error_file_size }}');
                                    $('#' + wfu.uploadId + ' .cleanFileBt').trigger('click');
                                }
                            }, 500);
                        }
                    }
                });
            });
        }

    });

    /**
     * 文件上传的一些校验
     */
    function getUploadFileByOrder(wfu) {
        var file_str = $('#file_str').val();
        var id = wfu.uploadId;
        var file_name = wfu.fileList[0].name;
        var file_size = wfu.fileList[0].size;
        if (file_size == 0) {
            var size_err = '{{ error_file_size }}';
            alert(size_err);
            return false;
        }
        file_str += id + ':' + file_name + ';';
        var order_id = id.split('_')[0];

        var file_name = [];
        var file_arr = file_str.split(';');
        $.each(file_arr, function (idx, obj) {
            if (obj != null && obj != '') {
                var i = obj.split(':');
                file_name.push(i[1]);
            }
        });
        file_name_unique = [...new Set(file_name)];
        if (file_name.length != file_name_unique.length) {
            alert('{{ error_file_repeated }}');
            $('#' + wfu.uploadId + ' .fileItem').hide();
            return false;
        }
        //隐藏示例_label_template
        $('.' + wfu.uploadId + '_label_template').addClass('none');
    }

    /**
     * bol上传的一些校验
     * @param wfu 使用wfu.initUpload文件信息
     * @returns {boolean}  1检验通过  0检验失败
     */
    function getUploadBolByOrder(wfu) {
        //bol上传文件名
        var file_name = wfu.fileList[0].name;
        //bol上传大小
        var file_size = wfu.fileList[0].size;
        if (file_size == 0) {
            var size_err = '{{ error_file_size }}';
            layerMsg(size_err);
            return false;
        }
        var ret = 1;
        $.each(json.bol, function (idx, obj) {
            //判断是否上传重复的bol
            if (file_name == bol_list[obj]) {
                layerMsg('{{ error_bol_repeated }}');
                $('#' + wfu.uploadId + ' .fileItem').hide();
                ret = 0;
                return false;
            }
        });
        if (ret == 0) {
            return false;
        }
        return true;
    }

    /**
     * 清除（删除）文件上传
     */
    function getcleanFile(wfu) {
        //代表此pdf 删除
        //后端删除
        var uploadId = wfu.uploadId;
        var verify = uploadId.split('_')[1];
        if (verify == 'bol') { //bol上传文件删除
            var id = uploadId + '_show';
            //移除
            $('#' + id).empty();
            //后台软删除
            var del_url = '{{ dropship_file_unlink }}';
            var order_id = uploadId.split('_')[0];
            $.ajax({
                url: del_url,
                type: 'post',
                dataType: 'json',
                //                async:false,
                data: {'container_id': uploadId},
                success: function (res) {
                    bol_list[uploadId] = '';
                    //删除的情况下需要重新更新span 数量 和 checkbox
                    calcOrderInfo(uploadId);
                }
            });
        } else {  //删除其他上传文件
            var file_name = wfu.fileList[0].name;
            //tracking number清除
            var tracking_number_id = uploadId + '_tracking_number';
            $('#' + tracking_number_id).val(null);

            //上传的pdf清除
            var pdf_show = uploadId + '_pdf_show';
            $('#' + pdf_show).empty();

            //显示示例
            $('.' + wfu.uploadId + '_label_template').removeClass('none');

            var del_url = '{{ dropship_file_unlink }}';
            var order_id = uploadId.split('_')[0];
            var file_str = $('#file_str').val();
            var file_arr = file_str.split(';');
            $.each(file_arr, function (idx, obj) {
                if (obj != null && obj != '') {
                    var i = obj.split(':');
                    if (i[0] == uploadId) {
                        var key = obj + ';';
                        //ajax 软删除文件
                        $.ajax({
                            url: del_url,
                            type: 'post',
                            dataType: 'json',
                            //                async:false,
                            data: {'container_id': uploadId},
                            success: function (res) {
                                file_str = file_str.replace(key, '');

                                $('#file_str').val(file_str);
                                //判断是否可以check
                                calcOrderInfo(uploadId);
                                var order_id = uploadId.split('_')[0];
                                common_label[wfu.uploadId] = '';
                                tracking_number[wfu.uploadId] = '';
                            }
                        })
                    }
                }
            });
        }
    }

    /**
     * 订单文件上传数量、与选中等处理
     */
    function calcOrderInfo(uploadId) {
        //多少个订单被选中
        //已上传的文件个数
        //订单是否需要被选中
        var file_str = $('#file_str').val();
        var order_id = uploadId.split('_')[0];
        var count = 0;
        // label上传的部分
        var file_arr = file_str.split(';');
        $.each(file_arr, function (idx, obj) {
            if (obj != null && obj != '') {
                var i = obj.split(':');
                if (i[0].indexOf(order_id) == 0) {
                    count++;
                }
            }
        });
        var num = json['container_id_list'][order_id]['count'];
        // 计算bol部分
        var bol_id = order_id + '_bol';
        if (bol_list[bol_id]) {
            count++;
        }
        // 更改已上传文件显示数量
        var order_span = '#' + order_id + '_span';
        var span_str = '(' + count + '/' + num + ')';
        $(order_span).html(span_str);
        //上传的文件都已经上传完成，才能被checked
        if (count == num) {
            $('#' + order_id).prop("checked", true);
        } else {
            $('#' + order_id).prop("checked", false);
        }
        getCheckBoxNum();
    }

    /**
     * 复选框被选中的数量
     */
    function getCheckBoxNum() {
        var count_check_box = 0;
        $("input:checkbox").each(function () {
            if ($(this).prop("checked") == true) {
                count_check_box++;
            }
        });
        $('#checkboxNum').html(count_check_box);
    }

    /**
     * 提示信息
     * @param message 提示语
     * @param time 显示时间长度
     */
    function layerMsg(message, time = 2000) {
        parent.layer.msg(message, {time: time, skin: ''});
    }

    /**
     * 提交
     * @returns {boolean}
     */
    function checkInputInfo() {
        //提交按钮禁用
        $('#btnSubmit').attr('disabled', 'disabled');
        $('#btnClose').attr('disabled', 'disabled');
        var count_check_box = 0;
        var notice = '';
        //提交的个数
        $("input:checkbox").each(function () {
            count_check_box++;
        });
        var total_amount = count_check_box;
        var file_amount = $('#checkboxNum').html();
        file_amount = parseInt(file_amount);
        if (file_amount < total_amount) {
            var left = total_amount - file_amount;
            if (left != total_amount && left != 0) {
                notice = 'Are you sure to upload the labels of these ' + file_amount + ' order(s)?  The uploaded labels in unselected orders will be discarded.';
            } else {
                layerMsg('{{ error_order_no_choose }}');
                $('#btnSubmit').attr('disabled', false);
                $('#btnClose').attr('disabled', false);
                return false;
            }
        } else {
            notice = 'Are you sure to upload the labels of these ' + file_amount + ' order(s)?';
        }
        var btn = null;
        layer.confirm(notice, {
            title: 'Message',
            skin: 'yzc_layer top-i-150', //样式类名
            btn: ['Yes', 'No'],
            yes: function (index) {
                btn = $("a.layui-layer-btn0");
                if(btn.hasClass("layui-btn-disabled")){
                    return;
                }
                btn.addClass("layui-btn-disabled");

                var file_name = [];
                var file_str = $('#file_str').val();

                //验证是否有重复的label
                var temp_label = [];
                for (let ks in common_label) {
                    if (common_label[ks]) {
                        temp_label.push(common_label[ks])
                    }
                }
                var file_name_unique = [...new
                Set(temp_label)
                ];
                if (temp_label.length != file_name_unique.length) {
                    var repeat_label = duplicates(temp_label);
                    layerMsg('The label [' + repeat_label + '] uploaded is repeat with the other label,please upload again.');
                    $('#btnSubmit').attr('disabled', false);
                    $('#btnClose').attr('disabled', false);
                    return false;
                }
                //验证所有的提交的bol是否有重复的
                var bol_label = [];
                for (let ks in bol_list) {
                    if (bol_list[ks]) {
                        bol_label.push(bol_list[ks])
                    }
                }
                var file_name_unique = [...new
                Set(bol_label)
                ];
                if (bol_label.length != file_name_unique.length) {
                    var repeat_label = duplicates(bol_label);
                    layerMsg('The label [' + repeat_label + '] uploaded is repeat with the other label,please upload again.');
                    $('#btnSubmit').attr('disabled', false);
                    $('#btnClose').attr('disabled', false);
                    return false;
                }
                //验证所有提交的tracking 是否有重复的
                // 验证tracking是否重复
                var tmp = [];

                if (submit_flag == 0) {
                    $('#btnSubmit').attr('disabled', false);
                    $('#btnClose').attr('disabled', false);
                    submit_flag = 1;
                    btn && btn.removeClass("layui-btn-disabled");
                    return false;
                }
                //到具体每一个checkbox来做判断
                var bol_input_str = '';
                var store_input_str = '';
                var checkboxName = '';
                $("input:checkbox").each(function () {
                    var order_id = $(this).attr('id');
                    var child_list = json['container_id_list'][order_id]['child_list'];

                    if ($(this).prop("checked") == true) {
                        // bol
                        var bol_id = order_id + '_bol';
                        if ($('#' + bol_id).length > 0) {
                            if (bol_list[bol_id] == '') {
                                layerMsg('{{ error_bol_fill }}');
                                $('#btnSubmit').attr('disabled', false);
                                $('#btnClose').attr('disabled', false);
                                submit_flag = 0;
                                return false;
                            } else {
                                bol_input_str += bol_id + ':' + bol_list[bol_id] + ';';
                            }
                        }

                        // common label 每一个都提交了
                        checkboxName += order_id + ',';
                        for (var i = 0; i < child_list.length; i++) {
                            var cut_type = child_list[i].substring(child_list[i].lastIndexOf("_") + 1);
                            if ((cut_type != ltl_packing_cut && cut_type != ltl_label_cut)) {
                                //非ltl校验label是否上传
                                if (file_str.indexOf(child_list[i]) != -1) {
                                    //非ltl校验tracking number是否上传
                                    if (tracking_number[child_list[i]] == null || tracking_number[child_list[i]] == '') {
                                        layerMsg('{{ error_tracking_number_fill }}', 3000);
                                        $('#btnSubmit').attr('disabled', false);
                                        $('#btnClose').attr('disabled', false);
                                        submit_flag = 0;
                                        return false;
                                    } else {
                                        tmp.push(tracking_number[child_list[i]]);
                                    }
                                } else {
                                    layerMsg('{{ error_file_fill }}', 3000);
                                    $('#btnSubmit').attr('disabled', false);
                                    $('#btnClose').attr('disabled', false);
                                    submit_flag = 0;
                                    return false;
                                }
                            } else {
                              var container_temp_id = child_list[i].split('_');
                              container_temp_id = container_temp_id.slice(0, -1);
                              container_temp_id = container_temp_id.join('_');
                              //ltl tracking_number能为空 且不用校验是否重复,只需要校验文件
                              if (file_str.indexOf(container_temp_id + '_' + ltl_packing_cut) == -1
                                && file_str.indexOf(container_temp_id + '_' + ltl_label_cut) == -1
                              ) {
                                layerMsg('{{ error_file_fill }}');
                                $('#btnSubmit').attr('disabled', false);
                                $('#btnClose').attr('disabled', false);
                                submit_flag = 0;
                                return false;
                              }
                            }
                        }
                        if (submit_flag == 0) {
                            $('#btnSubmit').attr('disabled', false);
                            $('#btnClose').attr('disabled', false);
                            submit_flag = 1;
                            return false;
                        }
                    }
                });

                //获取重复的pdf名称
                var ret = duplicates(tmp);
                if (!$.isArray(ret)) {
                    layerMsg('The selected orders contain repeat tracking numbers [' + ret + ']', 3000);
                    $('#btnSubmit').attr('disabled', false);
                    $('#btnClose').attr('disabled', false);
                    submit_flag = 0;
                    btn && btn.removeClass("layui-btn-disabled");
                    return false;
                }
                if (submit_flag == 1) {
                    $.ajax({
                        url: '{{ walmart_verify_tracking }}',
                        type: 'post',
                        data: {'tracking_number_list': tmp},
                        async: false,
                        beforeSend: function () {
                        },
                        success: function (json) {
                            if (json.error == 1) {
                                var tracking_str = json.result.join(', ');
                                var tracking_error = 'The selected orders contain repeat tracking numbers [' + tracking_str + '], it cannot be submitted.';
                                layerMsg(tracking_error, 3000);
                                $('#btnSubmit').attr('disabled', false);
                                $('#btnClose').attr('disabled', false);
                                submit_flag = 0;
                                btn && btn.removeClass("layui-btn-disabled");
                            }
                        }
                    });
                }
                if (submit_flag == 0) {
                    $('#btnSubmit').attr('disabled', false);
                    $('#btnClose').attr('disabled', false);
                    submit_flag = 1;
                    btn && btn.removeClass("layui-btn-disabled");
                    return false;
                }
                //bol 也是要提交的
                //store label
                $('#bol_str').val(bol_input_str);
                //ajax 提交
                $.ajax({
                    url: '{{ dropship_file_submit }}',
                    type: 'post',
                    data: $('#form-upload').serializeArray(),
                    async: false,
                    beforeSend: function () {
                        parent.layer.load();
                    },
                    success: function (json) {
                        parent.layer.closeAll('loading');
                        layerMsg(json.msg, 2000);
                        setTimeout(function () {
                            //验证文件名是否相同
                            var index = parent.layer.getFrameIndex(window.name);
                            parent.layer.close(index);
                            //var url_redirct = '{{ dropship_order_purchase }}' + '&order_id=' + checkboxName;
                            // window.parent.uploadFinish(url_redirect);

                            // #24701 上门取货上传流程优化
                            var url_redirect = '{{ dropship_order_match }}';
                            console.log('url_redirect', url_redirect)
                            window.parent.inventoryMatchHandler(url_redirect, checkboxName);
                        }, 2 * 1000);

                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        var index = parent.layer.getFrameIndex(window.name);
                        parent.layer.close(index);
                        layerMsg(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                    }
                });
            },
            end: function () {
                $('#btnSubmit').attr('disabled', false);
                $('#btnClose').attr('disabled', false);
                btn && btn.removeClass("layui-btn-disabled");
                return false;
            }
        });

    }

    //获取重复的pdf的名称
    function duplicates(arr) {
        var result = [];
        for (var i = 0; i < arr.length; i++) {
            if ($.inArray(arr[i], result) == -1) {
                result.push(arr[i]);
            } else {
                return arr[i];
            }
        }
        return result;
    }

    //关闭弹窗
    function cancelAction() {
        var index = parent.layer.getFrameIndex(window.name);
        parent.layer.close(index);
        var url_purchase = '{{ dropship_order_purchase }}';
        var url_cancel = url_purchase.replace('orderPurchase', 'dropshipOrderState');
        window.parent.uploadFinish(url_cancel);
    }

    /**
     * 手动填写tracking number
     * @param obj
     */
    function pushTrackingNumber(obj) {
        var input_id = $(obj).attr('id');
        input_id = input_id.replace('_tracking_number', '');
        var order_id = input_id.split('_')[0];
        tracking_number[input_id] = $.trim($(obj).val());
        var tmp = [];
        $.each(json.container_id_list.id_list, function (idx, obj) {
            //ltl 的tracking number 不是必填，也不用校验重复
            var cut_type = obj.substring(obj.lastIndexOf("_") + 1);
            if (cut_type != ltl_packing_cut && cut_type != ltl_label_cut) {
                if (tracking_number[obj] != null && tracking_number[obj] != '') {
                    if (obj.indexOf(order_id) == 0) {
                        tmp.push(tracking_number[obj]);
                    }
                }
            }
        });
        var ret = duplicates(tmp);
        if (!$.isArray(ret)) {
            layerMsg('The selected orders contain repeat tracking numbers [' + ret + ']', 3000);
        }
    }

    /**
     * 查看label
     * @param obj
     */
    function getCommonLabelPdf(obj) {
        var url = $(obj).attr('mean');
        var upload_info = 'Common Label';
        parent.layer.open({
            type: 2,
            offset: ['150px', '380px'],
            area: ['700px', '400px'],
            title: upload_info,
            fixed: false, //不固定Change
            maxmin: true,
            skin: 'yzc_layer',
            scrollbar: false,
            content: url,
        });
    }

    /**
     * 校验tracking number
     * @param uploadId
     * @returns {boolean|[]}
     */
    function verifyTrackingNumber(uploadId) {
        var tmp = [];
        var order_id = uploadId.split('_')[0];
        $.each(json.container_id_list.id_list, function (idx, obj) {
            if (tracking_number[obj] != null && tracking_number[obj] != '') {
                if (obj.indexOf(order_id) == 0) {
                    tmp.push(tracking_number[obj]);
                }
            }
        });
        var ret = duplicates(tmp);
        if ($.isArray(ret)) {
            return false;

        }
        return ret;

    }

    $("#iconSwitch").on('click', function () {
        var $giga = $(this).children('.giga');
        if ($giga.hasClass('icon-icon-GIS_shouqi-')) {
            $giga.removeClass('icon-icon-GIS_shouqi-').addClass('icon-icon-GIS_shouqi--copy')
        } else {
            $giga.removeClass('icon-icon-GIS_shouqi--copy').addClass('icon-icon-GIS_shouqi-')
        }
    })
</script>

