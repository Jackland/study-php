{% set titleStr = '' %}
{% if msg_type == '107' %}
    {% set titleStr = 'Inventory' %}
{% elseif msg_type == '100' %}
    {% set titleStr = 'Product' %}
{% elseif msg_type == '300' %}
    {% set titleStr = 'Bid' %}
{% elseif msg_type == '400' %}
    {% set titleStr = 'Order' %}
{% elseif msg_type == '200' %}
    {% set titleStr = 'RMA' %}
{% else %}
    {% set titleStr = 'Other' %}
{% endif %}
{{ this.title(titleStr) }}
{{ this.params('breadcrumbs', [
    'home',
    {
        text: 'Message Center',
        href: url('account/message_center/seller'),
    },
    {
        text: titleStr,
        href: url(''),
    }
]) }}

{% for style in styles %}
    <link href="{{ style }}" type="text/css" rel="stylesheet"/>
{% endfor %}
{% for script in scripts %}
    <script type="text/javascript" src="{{ script }}"></script>
{% endfor %}

{{ js(['js/common/orisComponents.js']) }}

{{ css([
  'css/common/common.css',
  'css/common/common-ext.css',
  'static/message/message-common.css',
  'static/message/buyer-message-common.css',
  'static/customerpartner/message_center/my-message-common.css']) 
}}

{# 以下引入是日期范围选择器 #}
{{ js(['js/common/dateRangePicker.js']) }}
{{ css(['css/common/dateRangePicker.css']) }}

{{ js(['js/common/orisComponents.js']) }}

<link rel="stylesheet" type="text/css" href="catalog/view/javascript/bootstrap-select18/bootstrap-select.min.css">
<link rel="stylesheet" type="text/css" href="catalog/view/javascript/jquery/datetimepicker/bootstrap-datetimepicker.min.css">
<script type="text/javascript" src="/catalog/view/javascript/bootstrap/js/bootstrap-paginator.min.js"></script>
<script type="text/javascript" src="catalog/view/javascript/layer/layer.js"></script>

{% if separate_view is defined and separate_view %}
<div class="container-fluid" id="content" style="margin-left: 235px">
    <ul class="breadcrumb">
        {% for breadcrumb in breadcrumbs %}
            <li><a href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a></li>
        {% endfor %}
    </ul>
    {% else %}
    <div class="container ">
        {% endif %}
        <div class="row">{{ column_left }}
            {% if column_left and column_right %}
                {% set class = 'col-sm-6' %}
            {% elseif column_left or column_right %}
                {% set class = 'col-sm-9' %}
            {% else %}
                {% set class = 'col-sm-12' %}
            {% endif %}
            {% if separate_view == 0 %}
                {% set table_div_class = 'overflow: hidden;' %}
            {% endif %}
            <div ng-app="app" ng-cloak class="nav-oris msgcent-mymessage">
                <div id="content" class="{{ class }}">{{ content_top }}
                    {{ message_column }}
                    <div id="table_content" class="msgcent msg-card msg-h508" style="{{ table_div_class }}">
                        {#  面板  #}
                        <div class="msgb msg-card__title msgcent msg-detail__header">
                          {{ titleStr }}
                        </div>
                        <div class="msgcent msg-form__container">
                            <div id="message">
                                <div class="tab-pane active">
                                    <div>
                                        <div>
                                            <div class="oris-row msgcent msg-search__row msgb-search-row" style="margin-bottom: 0px;">
                                                <div class="oris-col-3 mymessage-col">
                                                    <label class="control-label mymessage-label" for="input-name">Subject</label>
                                                    <input type="text" name="filter_subject" value="{{ search.filter_subject }}" placeholder="Enter subject" id="filter_subject" class="oris-input"/>
                                                </div>
        
                                                <div class="oris-col-3 mymessage-col">
                                                    <label class="msgcent mymessage-label">Post Time</label>
                                                    <div class="oris-ingroup action-clear">
                                                    <input type="text" name="creation_time" readonly class="oris-input" id="creation_time"
                                                            placeholder="From ~ To"/>
                                                    <i class="giga icon-v10quxiao-01 oris-clear" data-action-range="1"></i>
                                                    </div>
                                                </div>

                                                {% if msg_type == 100 %}
                                                    <div class="oris-col-3 mymessage-col oris-select">
                                                        <label class="control-label mymessage-label">Type</label>
                                                        <select name="msg_type3" id="msg_type3" class="form-control" data-dropup-auto=false>
                                                            <option value="">All</option>
                                                            <option value="104" {% if '104' == search.filter_msg_type %}selected{% endif %} > Status</option>
                                                            <option value="105" {% if '105' == search.filter_msg_type %}selected{% endif %} > Stock-In</option>
                                                            <option value="106" {% if '106' == search.filter_msg_type %}selected{% endif %} > Price</option>
                                                            <option value="109" {% if '109' == search.filter_msg_type %}selected{% endif %} > New Arrivals</option>
                                                            <option value="199" {% if '199' == search.filter_msg_type %}selected{% endif %} > Other</option>
                                                        </select>
                                                    </div>
                                                {% elseif msg_type == 300 %}
                                                    <div class="oris-col-3 mymessage-col oris-select">
                                                        <label class="control-label mymessage-label">Type</label>
                                                        <select name="msg_type3" id="msg_type3" class="form-control" data-dropup-auto=false>
                                                            <option value="">All</option>
                                                            <option value="300" {% if '300' == search.filter_msg_type %}selected{% endif %} > Spot Price</option>
                                                            <option value="301" {% if '301' == search.filter_msg_type %}selected{% endif %} > Rebates</option>
                                                            <option value="302" {% if '302' == search.filter_msg_type %}selected{% endif %} > Margin</option>
                                                            <option value="303" {% if '303' == search.filter_msg_type %}selected{% endif %} > Futures</option>
                                                        </select>
                                                    </div>
                                                {% elseif msg_type == 400 %}
                                                    <div class="oris-col-3 mymessage-col oris-select">
                                                        <label class="control-label mymessage-label">Type</label>
                                                        <select name="msg_type3" id="msg_type3" class="form-control" data-dropup-auto=false>
                                                            <option value="">All</option>
                                                            <option value="403" {% if '403' == search.filter_msg_type %}selected{% endif %} > Purchase Order</option>
                                                            <option value="402" {% if '402' == search.filter_msg_type %}selected{% endif %} > Sales Order</option>
                                                        </select>
                                                    </div>
                                                {% endif %}


                                               {# {% if '' == msg_type %}
                                                    <div class="oris-col-3 mymessage-col oris-select">
                                                        <label class="control-label mymessage-label">Type</label>
                                                        <select name="msg_type2" id="msg_type2" class="form-control">
                                                            <option value="">All</option>
                                                            <option value="100" {% if '100' == search.filter_msg_type %}selected{% endif %} > Product</option>
                                                            <option value="200" {% if '200' == search.filter_msg_type %}selected{% endif %} > RMA</option>
                                                            <option value="300" {% if '300' == search.filter_msg_type %}selected{% endif %} > BID</option>
                                                            <option value="400" {% if '400' == search.filter_msg_type %}selected{% endif %} > Order</option>
                                                            <option value="600" {% if '600' == search.filter_msg_type %}selected{% endif %} > Invoice</option>
                                                            {% if is_usa_outer_account %}
                                                                <option value="700" {% if '700' == search.filter_msg_type %}selected{% endif %} > Incoming Shipment</option>
                                                            {% endif %}
                                                            <option value="500" {% if '500' == search.filter_msg_type %}selected{% endif %} > Other</option>
                                                        </select>
                                                    </div>#}
                                               {# {% elseif '300' == msg_type %}
                                                    <div class="oris-col-3 mymessage-col oris-select">
                                                        <label class="control-label mymessage-label">Type</label>
                                                        <select name="msg_type3" id="msg_type3" class="form-control">
                                                            <option value="">All</option>
                                                            <option value="300" {% if '300' == search.filter_msg_type %}selected{% endif %} > Spot Price</option>
                                                            <option value="301" {% if '301' == search.filter_msg_type %}selected{% endif %} > Rebates</option>
                                                            <option value="302" {% if '302' == search.filter_msg_type %}selected{% endif %} > Margin</option>
                                                            <option value="303" {% if '303' == search.filter_msg_type %}selected{% endif %} > Futures</option>
                                                        </select>
                                                    </div>
                                                {% endif %}#}

                                                <div class="oris-col-3 mymessage-col oris-select">
                                                    <label class="control-label mymessage-label">Status</label>
                                                    <select name="filter_status" id="filter_status" class="selectpicker" style="display: inline-flex" data-dropup-auto=false>
                                                        <option value="">All</option>
                                                        <option value="0" {% if '0' == search.filter_read_status %}selected{% endif %} > Unread</option>
                                                        <option value="1" {% if '1' == search.filter_read_status %}selected{% endif %} > Read</option>
                                                    </select>
                                                </div>

                                                <div class="oris-col-3 mymessage-col oris-select">
                                                    <label class="control-label mymessage-label">Marked</label>
                                                    <select name="filter_marked" id="filter_marked" class="selectpicker" data-dropup-auto=false>
                                                        <option value="">All</option>
                                                        <option value="0" {% if '0' == search.filter_mark_status %}selected{% endif %} >
                                                            <i class="fa fa-star"></i> Unmarked
                                                        </option>
                                                        <option value="1" {% if '1' == search.filter_mark_status %}selected{% endif %} >
                                                            <i class="fa fa-star-o" style="color: yellow"></i> Marked
                                                        </option>
                                                    </select>
                                                </div>

                                                <div class="oris-col-3 mymessage-col search-btn">
                                                    <button class="oris-button mymessage-a-btn oris-button-bigger width80" style="margin-top:24px"  onclick="filterMessage('{{ msg_type }}');">
                                                        <a data-toggle="tooltip" id="quote_filter_btn">Filter</a>
                                                    </button>
                                                    <button type="button" onclick="reset()" class="oris-button oris-button-default oris-button-bigger msg-w80">Reset</button>
                                                </div>
                                            </div>

                                            <div class="oris-row msgcent msg-markas__row mymessage-markas__row">
                                                <button class="oris-button oirs-button-default msgcent msg-search__btn" onclick="confirm_multiple_delete();return false;" disabled>Delete</button>
                                                <div class="oris-select msgcent msg-markas__select">
                                                    <select name="action_setup" id="action_setup" class="selectpicker" style="display: inline-flex" onchange="confirm_multiple()" title="Mark As" disabled data-dropup-auto=false>
                                                        <option value="1"
                                                                {% if msg_type=='' %}
                                                                    data-cnzz-event-extra="Message Center|MS_fromsystem_setup_type|Unread"
                                                                {% else %}
                                                                    data-cnzz-event-extra="Message Center|MS_fromsystem_kind_setup_type|Unread"
                                                                {% endif %}
                                                        > Unread</option>
                                                        <option value="2"
                                                                {% if msg_type=='' %}
                                                                    data-cnzz-event-extra="Message Center|MS_fromsystem_setup_type|Read"
                                                                {% else %}
                                                                    data-cnzz-event-extra="Message Center|MS_fromsystem_kind_setup_type|Read"
                                                                {% endif %}
                                                        > Read</option>
                                                        <option value="3"
                                                                {% if msg_type=='' %}
                                                                    data-cnzz-event-extra="Message Center|MS_fromsystem_setup_type|Unmarked"
                                                                {% else %}
                                                                    data-cnzz-event-extra="Message Center|MS_fromsystem_kind_setup_type|Unmarked"
                                                                {% endif %}
                                                        > Unmarked</option>
                                                        <option value="4"
                                                                {% if msg_type=='' %}
                                                                    data-cnzz-event-extra="Message Center|MS_fromsystem_setup_type|Marked"
                                                                {% else %}
                                                                    data-cnzz-event-extra="Message Center|MS_fromsystem_kind_setup_type|Marked"
                                                                {% endif %}
                                                        > Marked</option>
                                                    </select>
                                                </div>
                                            </div>

                                        </div>
                                    </div>

                                    <form  method="post" enctype="multipart/form-data" id="form-template" style="margin-top: 20px">
                                        <div class="table-responsive msgcent msg-table__container" id="input">
                                            <table class="oris-table oris-table-minicheck">
                                                <thead>
                                                <tr>
                                                    <th class="oris-w42 text-center">
                                                        <input type="checkbox" name="all_select" style="margin: 0" onclick="$('input[name*=\'selected\']').prop('checked', this.checked);"/>
                                                    </th>
                                                    <th class="text-left">Subject</th>
                                                    {% if msg_type != '107' and msg_type != 200 and msg_type != 500 %}
                                                        <th class="text-left">Type</th>
                                                    {% endif %}
                                                    <th class="text-left"  style="width: 60px">Sender</th>
                                                    <th class="text-center">Marked</th>
                                                    <th class="text-left"  style="width: 160px">Post Time</th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                {% if list %}
                                                    {% for message in list %}
                                                        <tr class="{{ message.is_read == 1 ? '' : ' msg-table__row-unanswered ' }}">
                                                            <td class="oris-w42 text-center">
                                                                <input type="checkbox" name="selected[]" style="margin: 0;" onclick="inputChecked()" value="{{ message.id }}"/>
                                                            </td>
                                                            <td class="text-left" style="word-break: break-all">
                                                                {% if message.is_read %}
                                                                    {# <i class="gcl gclxinfengxinjian" style="color: #ddd"></i> #}
                                                                    <a href="{{ url('account/message_center/message/detail', {msg_id: message.msg_id}) }}" class="read"
                                                                            {% if msg_type=='' %}
                                                                                data-cnzz-event="Message Center|MS_fromsystem_viewdetail"
                                                                            {% else %}
                                                                                data-cnzz-event="Message Center|MS_fromsystem_kind_viewdetail"
                                                                            {% endif %}
                                                                    ><span class="msg-subject-tdspan msg-clickable" title="{{ message.subject }}">{{ message.subject }}</span></a>
                                                                {% else %}
                                                                    {# <i class="gcl gclxinfeng" style="color: red"></i> #}
                                                                    <a href="{{ url('account/message_center/message/detail', {msg_id: message.msg_id}) }}" class="no-read"
                                                                            {% if msg_type=='' %}
                                                                                data-cnzz-event="Message Center|MS_fromsystem_viewdetail"
                                                                            {% else %}
                                                                                data-cnzz-event="Message Center|MS_fromsystem_kind_viewdetail"
                                                                            {% endif %}
                                                                    ><span class="msg-subject-tdspan msg-clickable" title="{{ message.subject }}">{{ message.subject }}</span></a>
                                                                {% endif %}

                                                            </td>
                                                            {% if msg_type != 107 and msg_type != 200 and msg_type != 500 %}
                                                                <td class="text-left">
                                                                    {{ message.msg_type_name }}
                                                                </td>
                                                            {% endif %}
                                                            <td class="text-left">
                                                                System
                                                            </td>
                                                            <td class="text-center">
                                                                <a onclick="marked(this, {{ message.id }})" style="color: #888"
                                                                        {% if msg_type=='' %}
                                                                            {% if message.is_marked %}
                                                                                data-cnzz-event="Message Center|MS_fromsystem_unmarked"
                                                                            {% else %}
                                                                                data-cnzz-event="Message Center|MS_fromsystem_marked"
                                                                            {% endif %}
                                                                        {% else %}
                                                                            {% if message.is_marked %}
                                                                                data-cnzz-event="Message Center|MS_fromsystem_kind_unmarked"
                                                                            {% else %}
                                                                                data-cnzz-event="Message Center|MS_fromsystem_kind_marked"
                                                                            {% endif %}
                                                                        {% endif %}
                                                                >
                                                                    {% if message.is_marked %}
                                                                        <i class="fa fa-star msg-markicon__active" id="marked_{{ message.id }}" style="color: #f3ab09d1" data="{{ message.is_marked }}"></i>
                                                                    {% else %}
                                                                        <i class="fa fa-star-o msg-markicon__default" id="marked_{{ message.id }}" data="{{ message.is_marked }}"></i>
                                                                    {% endif %}
                                                                </a>
                                                            </td>
                                                            <td class="text-left">
                                                                {{ message.post_time }}
                                                            </td>
                                                        </tr>

                                                    {% endfor %}
                                                    </tbody>
                                                </table>
                                                {% else %}
                                                    </tbody>
                                                </table>
                                                <div class="msg-empty">
                                                    <div class="msg-empty-container">
                                                    <div class="msg-empty-icon">
                                                        <img src="{{ asset("image/icons/empty.png") }}"></img>
                                                    </div>
                                                    <div class="msg-empty-title">No Records Found !</div>
                                                    </div>
                                                </div>
                                                {% endif %}
                                        </div>
                                    </form>
                                    {#  分页  #}
                                    <div class="oris-row oris-pagination">
                                        <ul id="bos_pagination"></ul>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>


        </div>
    </div>
    {{ footer }}
</div>

<script src="catalog/view/javascript/jquery/datetimepicker/bootstrap-datetimepicker.min.js" type="text/javascript"></script>
<script type="text/javascript" src="catalog/view/javascript/bootstrap-select18/bootstrap-select.min.js"></script>

<script type="text/javascript">
    const dateRangeto = ' ~ ';

    $(function(){
        //初始化下拉选择框
        $("#msg_type2").selectpicker();
        $("#msg_type3").selectpicker();
        $("#filter_status").selectpicker();
        $("#filter_marked").selectpicker();
        $("#action_setup").selectpicker();

        initTimePicker();
    })

    // 勾选框控制按钮是否禁用
    $("#content input[name='selected[]'] ,#content input[name='all_select']").on('change', function() {
      var length = $("#content input[name='selected[]']:checked").length;
      if(length <= 0) {
        $(".msg-markas__row button").attr('disabled', true);
        $(".msg-markas__row select").attr('disabled', true);
      } else {
        $(".msg-markas__row button").removeAttr('disabled')
        $(".msg-markas__row select").removeAttr('disabled')
      }
      $("#action_setup").selectpicker('refresh');
    });

    //初始化日期选择控件
    var startDate = moment().subtract(1, 'y').format('YYYY-MM-DD');
    var endDate = moment().format('YYYY-MM-DD');

    function initTimePicker() {
      var searchStartDateFrom = "{{ search.filter_post_time_from }}";
      var searchStartDateTo = "{{ search.filter_post_time_to }}";

      if (searchStartDateFrom && searchStartDateTo) {
        startDate = searchStartDateFrom.substr(0, 10);
        endDate = searchStartDateTo.substr(0, 10);
        // 初始化数据
        $('#creation_time').val(startDate + dateRangeto + endDate);
      }

      $('#creation_time').daterangepicker({
        separator: dateRangeto,
        startDate: startDate,
        endDate: endDate,
        format: 'YYYY-MM-DD'
      }, function (start, end, label) {
        orisComponents.triggerInputClear($('#creation_time'));
      });
    }

    function reset() {
        window.location = "{{ url('account/message_center/system') }}&msg_type=" + msg_type;
    }

    var msg_type = "{{ msg_type }}";
    function filterMessage(msg_type, page, page_info) {
        var subject = encodeURIComponent($("#filter_subject").val().trim());

        let dateArr = $('#creation_time').val().split(dateRangeto);
        let date_from = dateArr[0] ? encodeURIComponent(dateArr[0] + ' 00:00:00') : '';
        let date_to = dateArr[1] ? encodeURIComponent(dateArr[1] + ' 23:59:59') : '';
        
        var status = $("#filter_status").val();
        var marked = $("#filter_marked").val();
        var msg_type2 = $("#msg_type2").val();
        var msg_type3 = $("#msg_type3").val();

        var url = "{{ url('account/message_center/system') }}&msg_type=" + msg_type;
        if (msg_type3  != undefined) {
            url += "&filter_msg_type=" + msg_type3;
        } else if (msg_type2 != undefined) {
            url += "&filter_msg_type=" + msg_type2;
        } else {
            url += "&filter_msg_type=" + msg_type;
        }

        if (subject) {
            url += "&filter_subject=" + subject;
        }
        if (date_from) {
            url += "&filter_post_time_from=" + date_from;
        }
        if (date_to) {
            url += "&filter_post_time_to=" + date_to;
        }
        if (status != '' && status != undefined) {
            url += "&filter_read_status=" + status;
        }
        if (marked != '' && marked != undefined) {
            url += "&filter_mark_status=" + marked;
        }
        if (page) {
            url += "&page=" + page;
        }
        if (page_info) {
            for (let i in page_info) {
                url += "&" + i + "=" + page_info[i];
            }
        }

        location.href = url;
    }

    function tab_toggle(msg_type) {
        window.location = "{{ url('account/message_center/system') }}&msg_type=" + msg_type;
    }

    //分页
    $('#bos_pagination').bootstrapPaginator({
        /*当前使用的是3版本的bootstrap*/
        bootstrapMajorVersion: 3,
        /*配置的字体大小是小号*/
        size: 'normal',
        /*当前页*/
        currentPage: {{ paginator.getPage() }},
        /*一共多少页*/
        totalPages: {{ max(paginator.getPageCount(), 1) }},
        /*页面上最多显示几个含数字的分页按钮*/
        numberOfPages: 5,
        pageRange: [10, 20, 30, 50, 100],
        total: {{ paginator.getTotalCount()  }},
        rowsOfPage: {{ paginator.getPageSize() }},
        onPageClicked: function (event, originalEvent, type, page) {
            let page_info = originalEvent['page_info'] || {};
            filterMessage('{{ msg_type }}', page, page_info);
        }
    });

    function marked(domEle, message_id) {

        var is_marked = $("#marked_" + message_id).attr('data');
        var param = {tab_type: 'inbox', ids: message_id, is_marked: is_marked == 0 ? 1 : 0};
        $.ajax({
            url: '{{ url('account/message_center/message/handleMarked') }}',
            type: 'post',
            data: param,
            dataType: 'json',
            success: function (json) {
                if (json.code == 200) {
                    if (0 == is_marked) {
                        $("#marked_" + message_id).attr('data', 1).attr('class', 'fa fa-star msg-markicon__active').attr('style', 'color: #f3ab09d1');
                        if (msg_type == "") {
                            $(domEle).attr("data-cnzz-event", "Message Center|MS_fromsystem_unmarked");
                        } else {
                            $(domEle).attr("data-cnzz-event", "Message Center|MS_fromsystem_kind_unmarked");
                        }
                    } else {
                        $("#marked_" + message_id).attr('data', 0).attr('class', 'fa fa-star-o msg-markicon__default').attr('style', 'color: none');
                        if (msg_type == "") {
                            $(domEle).attr("data-cnzz-event", "Message Center|MS_fromsystem_marked");
                        } else {
                            $(domEle).attr("data-cnzz-event", "Message Center|MS_fromsystem_kind_marked");
                        }
                    }

                } else {
                    $.toast({
                        heading: false,
                        text: 'Please try again later',
                        position: 'top-center',
                        showHideTransition: 'fade',
                        icon: 'error',
                        hideAfter: 3000,
                        allowToastClose: false,
                        loader: false,
                    });
                }
            }
        });

    }

    function confirm_multiple_delete() {
        var length = $("input[name='selected[]']:checked").length;
        if (length <= 0) {
            layer.alert('Please select at least one message.', {
                title: 'Message',
                btn : 'OK',
                skin: 'oris-layer', //样式类名
                closeBtn: 0
            });
        } else {

            var ids = '';
            $("input[name='selected[]']:checked").each(function () {
                ids += Number($(this).val()) + ',';
            });

            var tip = "Are you sure you want to delete these messages?";
            layer.confirm(tip, {
                    title: 'Message',
                    skin: 'oris-layer', //样式类名
                    btn: ['Yes', 'No']
                }, //按钮
                function () {
                    layer.closeAll();
                    $.ajax({
                        url: "{{ url('account/message_center/message/handleDeleted') }}",
                        type: 'post',
                        data: {tab_type: 'inbox', ids:ids, delete_status: 1},
                        dataType: 'json',
                        success: function (json) {
                            if (json.code == 200) {
                                $.toast({
                                    heading: false,
                                    text: 'Delete successfully.',
                                    position: 'top-center',
                                    showHideTransition: 'fade',
                                    icon: 'success',
                                    hideAfter: 3000,
                                    allowToastClose: false,
                                    loader: false,
                                });
                                filterMessage('{{ msg_type }}');
                            } else {
                                $.toast({
                                    heading: false,
                                    text: 'Please try again later!',
                                    position: 'top-center',
                                    showHideTransition: 'fade',
                                    icon: 'error',
                                    hideAfter: 3000,
                                    allowToastClose: false,
                                    loader: false,
                                });
                            }
                        }
                    });
                });
        }
    }

    function batchRead(param) {
        $.ajax({
            url: "{{ url('account/message_center/message/handleRead') }}",
            type: 'post',
            data: param,
            dataType: 'json',
            success: function (json) {
                if (json.code == 200) {
                    $.toast({
                        heading: false,
                        text: param.is_read == 1 ? 'Read successfully' : 'Unread successfully',
                        position: 'top-center',
                        showHideTransition: 'fade',
                        icon: 'success',
                        hideAfter: 3000,
                        allowToastClose: false,
                        loader: false,
                    });
                    filterMessage('{{ msg_type }}');
                } else {
                    $.toast({
                        heading: false,
                        text: 'Please try again later!',
                        position: 'top-center',
                        showHideTransition: 'fade',
                        icon: 'error',
                        hideAfter: 3000,
                        allowToastClose: false,
                        loader: false,
                    });
                }
            }
        });
    }

    function batchMarked(param) {
        $.ajax({
            url: "{{ url('account/message_center/message/handleMarked') }}",
            type: 'post',
            data: param,
            dataType: 'json',
            success: function (json) {
                if (json.code == 200) {
                    $.toast({
                        heading: false,
                        text: param.is_marked == 1 ? 'Marked successfully' : 'Unmarked successfully',
                        position: 'top-center',
                        showHideTransition: 'fade',
                        icon: 'success',
                        hideAfter: 3000,
                        allowToastClose: false,
                        loader: false,
                    });
                    filterMessage('{{ msg_type }}');
                } else {
                    $.toast({
                        heading: false,
                        text: 'Please try again later!',
                        position: 'top-center',
                        showHideTransition: 'fade',
                        icon: 'error',
                        hideAfter: 3000,
                        allowToastClose: false,
                        loader: false,
                    });
                }
            }
        });
    }

    function setupSuccessMsg(status) {
        switch (status) {
            case '1':
                return 'Unread successfully';
            case '2':
                return 'Read successfully';
            case '3':
                return 'Unmarked successfully';
            case '4':
                return 'Marked successfully';
        }
    }

    function batchSetUpCurrentMsg(setup_type, exclude_ids = '') {
        if (setup_type == 0) {
            return ;
        }
        var subject = encodeURIComponent($("#filter_subject").val());
        let dateArr = $('#creation_time').val().split(dateRangeto);
        let post_date_from = dateArr[0] ? encodeURIComponent(dateArr[0] + ' 00:00:00') : '';
        let post_date_to = dateArr[1] ? encodeURIComponent(dateArr[1] + ' 23:59:59') : '';
        var status = $("#filter_status").val();
        var marked = $("#filter_marked").val();
        var msg_type2 = $("#msg_type2").val();
        var msg_type3 = $("#msg_type3").val();

        var url = "{{ url('account/message_center/message/handleAllData') }}&msg_type=" + msg_type;
        if (msg_type3  != undefined) {
            url += "&filter_msg_type=" + msg_type3;
        } else if (msg_type2 != undefined) {
            url += "&filter_msg_type=" + msg_type2;
        } else {
            url += "&filter_msg_type=" + msg_type;
        }
        if (subject) {
            url += "&filter_subject=" + subject;
        }
        if (post_date_from) {
            url += "&filter_post_time_from=" + post_date_from;
        }
        if (post_date_to) {
            url += "&filter_post_time_to=" + post_date_to;
        }
        if (status != '' && status != undefined) {
            url += "&filter_read_status=" + status;
        }
        if (marked != '' && marked != undefined) {
            url += "&filter_mark_status=" + marked;
        }

        $.ajax({
            url: url,
            type: 'post',
            data: {
                tab_type: 'inbox',
                setup_type: setup_type,
                exclude_ids: exclude_ids,
                user_type: 3,
            },
            dataType: 'json',
            success: function (json) {
                if (json.code == 200) {
                    $.toast({
                        heading: false,
                        text: setupSuccessMsg(setup_type),
                        position: 'top-center',
                        showHideTransition: 'fade',
                        icon: 'success',
                        hideAfter: 3000,
                        allowToastClose: false,
                        loader: false,
                    });
                    filterMessage('{{ msg_type }}');
                } else {
                    $.toast({
                        heading: false,
                        text: 'Please try again later!',
                        position: 'top-center',
                        showHideTransition: 'fade',
                        icon: 'error',
                        hideAfter: 3000,
                        allowToastClose: false,
                        loader: false,
                    });
                }
            }
        });
    }


    function confirm_multiple() {

        var status = $("#action_setup").val();
        var length = $("input[name='selected[]']:checked").length;

        if (length <= 0) {
            layer.alert('Please select at least one message.', {
                title: 'Message',
                btn : 'OK',
                skin: 'oris-layer', //样式类名
                closeBtn: 0
            });
            $("#action_setup").val('');

        } else {
            let eventInfo = $("#action_setup option:selected").attr('data-cnzz-event-extra');
            let eventArr = (typeof eventInfo =="string") ? eventInfo.split('|') : [];
            if(window.CNZZ && eventArr.length >=2){
                window.CNZZ.triggerEvent(eventArr[0], eventArr[1], eventArr[2]);
            }
            var ids = '';
            $("input[name='selected[]']:checked").each(function () {
                ids += Number($(this).val()) + ',';
            });

           /* let is_all_select = $('input[name=all_select]').is(':checked') ? 1 : 0;
            if (is_all_select) {
                batchSetUpCurrentMsg(status)
                return;
            }*/

            switch (status) {
                case '1':
                    batchRead({tab_type: 'inbox', ids: ids, is_read: 0})
                    break;
                case '2':
                    batchRead({tab_type: 'inbox', ids: ids, is_read: 1})
                    break;
                case '3':
                    batchMarked({tab_type: 'inbox', ids: ids, is_marked: 0})
                    break;
                case '4':
                    batchMarked({tab_type: 'inbox', ids: ids, is_marked: 1})
                    break;
            }
        }

    }
    function inputChecked() {
        if ($('input[name="selected[]"]').length == $('input[name="selected[]"]:checked').length) {
            $('input[name=all_select]').prop('checked', true);
        } else {
            $('input[name=all_select]').prop('checked', false);
        }
    }

</script>