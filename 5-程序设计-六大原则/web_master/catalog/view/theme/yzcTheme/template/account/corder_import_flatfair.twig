<form class="form-horizontal" id="form-import-flatfair">
    <div class="panel panel-default">
        <div class="panel-heading">
            <h4 class="panel-title">
                {{ text_upload_customer_orders_file }}
            </h4>
        </div>
        <div class="panel-body">
            <div class="form-group required">
                <label class="col-sm-2 control-label" for="button-upload"><span data-toggle="tooltip"
                                                                                title="{{ help_upload }}">{{ entry_upload }}<i class="giga icon-V10-wenhaotishi"></i></span></label>
                <div class="col-sm-7">
                    <button type="button" id="button-upload" class="btn btn-primary">
                        <i class="fa fa-upload"></i> {{ button_upload }}</button>
                </div>
                <div class="col-sm-3" style="height: 34px;">
                    <a class="text-right" href="{{ downloadTemplateHref }}"
                       style="text-decoration: underline;cursor: pointer; position: absolute; bottom: 1px">
                        {{ text_download_template_file }}</a>
                </div>
            </div>
        </div>
    </div>
    <div class="panel panel-default">
        <div class="panel-heading">
            <h4 class="panel-title">
                {{ text_choose_pickup_method }}
            </h4>
        </div>
        <div class="panel-body">
            <div class="radio">
                <label>
                    <input type="radio" name="pickup_method" value="pickupAtBuyer" checked="checked" />
                    {{ radio_pickup_buyer }}
                </label>
            </div>
            <div class="radio">
                <label>
                    <input type="radio" name="pickup_method" value="pickupAtSeller"/>
                    {{ radio_pickup_seller }}
                </label>
            </div>
        </div>
    </div>
    <div class="panel panel-default">
        <div class="panel-heading">
            <h4 class="panel-title">
                {{ text_improve_pickup_info }}
            </h4>
        </div>
        <div class="panel-body">
            <div id="pickup_at_buyer_info_panel">
                {% if addresses %}
                    <div class="radio">
                        <label>
                            <input type="radio" name="pickup_address" value="existing" checked="checked" />
                            {{ text_use_existing_address }}
                        </label>
                    </div>
                    <div id="pickup-existing">
                        <select name="address_id" class="form-control">
                            {% for address in addresses %}
                                {% if address['address_id'] == address_id %}
                                    <option value="{{ address.address_id }}" selected="selected">{{ address.firstname }} {{ address.lastname }}, {{ address.address_1 }}, {{ address.city }}, {{ address.zone }}, {{ address.country }}</option>
                                {% else %}
                                    <option value="{{ address.address_id }}">{{ address.firstname }} {{ address.lastname }}, {{ address.address_1 }}, {{ address.city }}, {{ address.zone }}, {{ address.country }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="radio">
                        <label>
                            <input type="radio" name="pickup_address" value="new" />
                            {{ text_use_new_address }}
                        </label>
                    </div>
                {% else %}
                    <div class="radio">
                        <label>
                            <input type="radio" name="pickup_address" checked="checked" value="new" />
                            {{ text_use_new_address }}
                        </label>
                    </div>
                {% endif %}

                <div id="shipping-new" style="display: {% if addresses %}none{% else %}block{% endif %};">
                    {#Contact Name#}
                    <div class="form-group required">
                        <label class="col-sm-2 control-label" for="input-contactName">{{ entry_contact_name }}</label>
                        <div class="col-sm-10">
                            <input type="text" name="contactName" value="" placeholder="{{ entry_contact_name }}" id="input-contactName" class="form-control" />
                        </div>
                    </div>
                    {#Street Address#}
                    <div class="form-group required">
                        <label class="col-sm-2 control-label" for="input-streetAddress">{{ entry_street_address }}</label>
                        <div class="col-sm-10">
                            <input type="text" name="streetAddress" value="" placeholder="{{ entry_street_address }}" id="input-streetAddress" class="form-control" />
                        </div>
                    </div>
                    {#City/Town#}
                    <div class="form-group required">
                        <label class="col-sm-2 control-label" for="input-cityTown">{{ entry_city_town }}</label>
                        <div class="col-sm-10">
                            <input type="text" name="cityTown" value="" placeholder="{{ entry_city_town }}" id="input-cityTown" class="form-control" />
                        </div>
                    </div>
                    {#Zip/Postal Code#}
                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="input-zipCode">{{ entry_zip_code }}</label>
                        <div class="col-sm-10">
                            <input type="text" name="zipCode" value="" placeholder="{{ entry_zip_code }}" id="input-zipCode" class="form-control" />
                        </div>
                    </div>
                    {#Country#}
                    <div class="form-group required">
                        <label class="col-sm-2 control-label" for="input-country">{{ entry_country }}</label>
                        <div class="col-sm-10">
                            <select name="country_id" id="input-country" class="form-control">
                                <option value="">{{ __('请选择', {}, 'common') }}</option>
                                {% for country in countries %}
                                    {% if country.country_id == country_id %}
                                        <option value="{{ country.country_id }}" selected="selected">{{ country.name }}</option>
                                    {% else %}
                                        <option value="{{ country.country_id }}">{{ country.name }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    {#State/Region/Province#}
                    <div class="form-group required">
                        <label class="col-sm-2 control-label" for="input-zone">{{ entry_zone }}</label>
                        <div class="col-sm-10">
                            <select name="zone_id" id="input-zone" class="form-control">
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div id="pickup_at_seller_info_panel" style="display: none;">
                <table id="sellerInfoTab" class="table table-striped table-bordered table-hover">
                    <thead>
                        <tr>
                            <td>
                                <span style="color: #F00; font-weight: bold; margin-right: 10px;">*</span>Seller Name
                            </td>
                            <td>
                                <span style="color: #F00; font-weight: bold; margin-right: 10px;">*</span>Seller's Order Number
                            </td>
                            <td>
                                <span style="color: #F00; font-weight: bold; margin-right: 10px;">*</span>
                                <span class="control-label" data-toggle="tooltip" title="" data-original-title="demo">
                                    Upload Pickup Vouchers
                                </span>
                            </td>
                            <td></td>
                        </tr>
                    </thead>
                    <tbody></tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3"></td>
                            <td class="text-left"><button type="button" onclick="addSellerInfo();" data-toggle="tooltip" title="Add Seller Info" class="btn btn-primary"><i class="fa fa-plus-circle"></i></button></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
    <fieldset>
        <legend>{{ text_progress }}</legend>
        <div class="form-group">
            <label class="col-sm-2 control-label">{{ entry_progress }}</label>
            <div class="col-sm-10">
                <div class="progress">
                    <div id="progress-bar" class="progress-bar" style="width: 0%;"></div>
                </div>
                <div id="progress-text"></div>
            </div>
        </div>
    </fieldset>
    <a id="button-submit" onclick="submitData()" data-loading-text="{{ text_loading }}" class="btn btn-primary">Submit</a>
</form>
<br/>
<fieldset>
    <legend>{{ text_history }}</legend>
    <div id="history"></div>
</fieldset>

<script type="text/javascript"><!--

    function submitData() {
        $.ajax({
            url: 'index.php?route=account/customer_order/uploadOfFlatfairMode',
            type: 'post',
            dataType: 'json',
            data: new FormData($('#form-import-flatfair')[0]),
            cache: false,
            contentType: false,
            processData: false,
            beforeSend: function () {
                // 移除全部的text-danger样式元素
                $(".text-danger").remove();
                $('#button-submit').button('loading');
            },
            complete: function () {
                // $('#button-submit').button('reset');
            },
            success: function(json) {
                $('.has-error').removeClass('has-error');
                if (json['error']) {
                    if (json['error']['msg']) {
                        $('#progress-bar').addClass('progress-bar-danger');
                        $('#progress-text').html('<div class="text-danger">' + json['error']['msg'] + '</div>');
                    }
                    if (json['error']['customer_order_file']) {
                        var element = $('#button-upload');
                        $(element).after('<div class="text-danger">' + json['error']['customer_order_file'] + '</div>');
                    }
                    if (json['error']['orderNumber'] || json['error']['orderFile']) {
                        for (var i = 0 ; i < json['error']['orderNumber'].length; i++) {
                            var element = $('input[name=\'seller_order_number[' + json['error']['orderNumber'][i] + ']\']');
                            $(element).after('<div class="text-danger">' + '{{ error_not_null }}' + '</div>');
                        }
                        for (var i = 0 ; i < json['error']['orderFile'].length; i++) {
                            var element = $('#button-upload' + json['error']['orderFile'][i]);
                            $(element).after('<div class="text-danger">' + '{{ error_no_file }}' + '</div>');
                        }
                    }
                    if (json['error']['newAddress']) {
                        json['error']['newAddress'].forEach(function (currentValue, index, arr) {
                            var element = $("#input-" + currentValue['key']);
                            $(element).after('<div class="text-danger">' + currentValue['value'] + '</div>');
                        })
                    }
                    // Highlight any found errors
                    $('.text-danger').parent().addClass('has-error');
                }

                if (json['text']) {
                    $('#progress-bar').css('width', '30%');
                    $('#progress-text').html(json['text']);
                }

                if (json['next']) {
                    next(json['next'], 1);
                }
            },
            error: function(xhr, ajaxOptions, thrownError) {
                alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
            }
        });
    }

    function next(url, i) {
        i = i + 1;

        $.ajax({
            url: url,
            dataType: 'json',
            success: function (json) {
                $('#progress-bar').css('width', (i * 30) + '%');

                if (json['error']) {
                    $('#progress-bar').addClass('progress-bar-danger');
                    $('#progress-text').html('<div class="text-danger">' + json['error'] + '</div>');
                }

                if (json['success']) {
                    $('#progress-bar').css('width', '100%');
                    $('#progress-bar').addClass('progress-bar-success');
                    $('#progress-text').html('<span class="text-success">' + json['success'] + '</span>');

                    {#$('#history').load('index.php?route=marketplace/installer/history&user_token={{ user_token }}');#}
                }

                if (json['text']) {
                    $('#progress-text').html(json['text']);
                }

                if (json['next']) {
                    next(json['next'], i);
                }
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
            }
        });
    }

    /**
     * 订单上传按钮触发事件
     */
    $('#button-upload').on('click', function () {
        var customerOrderFileInput = $("#customerOrderFile");
        if (customerOrderFileInput.length == 0) {
            $('#button-upload').parent().prepend('<input type="file" style="display: none" id="customerOrderFile" onchange="changeButtonText(null,' + true + ')" name="customerOrderFile" />');
        }
        $("#customerOrderFile").trigger('click');
    });

    // 行数初始化
    var seller_row = 0;
    function addSellerInfo() {
        html  = '<tr id="seller-row' + seller_row + '">';
        html += '  <td class="text-left"><select name="seller[' + seller_row + ']" class="form-control">';
        {% if sellers %}
            {% for seller in sellers %}
                html += '<option value="{{ seller.customer_id }}">{{ seller.seller_name }}</option>';
            {% endfor %}
        {% endif %}
        html += '  </select></td>';
        html += '  <td class="text-left"><div><input type="text" name="seller_order_number[' + seller_row + ']" value="" placeholder="{{ text_order_number }}" class="form-control" /></div></td>';
        html += '  <td class="text-center"><button type="button" onclick="selectPickUpVouchersFile(this,' + seller_row + ')" id="button-upload' + seller_row + '" class="btn btn-primary"><i class="fa fa-upload"></i> Select File </button></td>';
        html += '  <td class="text-left"><button type="button" onclick="$(\'#seller-row' + seller_row  + '\').remove();" data-toggle="tooltip" title="remove" class="btn btn-danger"><i class="fa fa-minus-circle"></i></button></td>';
        html += '</tr>';
        $('#sellerInfoTab' + ' tbody').append(html);
        seller_row++;
    }

    function selectPickUpVouchersFile(button, sellerRow) {
        var inputElement = $('input[name=\'file[' + sellerRow + ']\']');
        if (inputElement.length == 0) {
            $(button).parent().prepend('<input type="file" style="display: none" class="sellerFile" onchange="changeButtonText(' + sellerRow + ');" name="file[' + sellerRow + ']"/>');
        }
        $('input[name=\'file[' + sellerRow + ']\']').trigger('click');
    }

    function changeButtonText(sellerRow, flag = false) {
        if (flag) {
            var fileName = $("#customerOrderFile").val();
            if (fileName != '') {
                $('#button-upload').html("<i class=\"fa fa-upload\"></i>" + getFileName(fileName));
            } else {
                $('#button-upload').html("<i class=\"fa fa-upload\"></i> {{ button_upload }} ");
            }
        } else {
            var fileName = $('input[name=\'file[' + sellerRow + ']\']').val();
            if (fileName != '') {
                $("#button-upload" + sellerRow).html("<i class=\"fa fa-upload\"></i>" + getFileName(fileName));
            } else {
                $("#button-upload" + sellerRow).html("<i class=\"fa fa-upload\"></i> Select File ");
            }
        }
    }

    function getFileName(str){
        var pos = str.lastIndexOf("\\");
        var filename = str.substring(pos+1);
        if (filename.length > 20) {
            filename = filename.substring(0, 10) + "..." + filename.substring(filename.length-10);
        }
        return filename;
    }

    /**
     * Choose pickup method
     */
    $('input[name=\'pickup_address\']').on('change', function() {
        if (this.value == 'new') {
            $('#pickup-existing').hide();
            $('#shipping-new').show();
        } else {
            $('#pickup-existing').show();
            $('#shipping-new').hide();
        }
    });

    /**
     * Improve pickup information
     */
    $('input[name=\'pickup_method\']').on('change', function() {
        if (this.value == 'pickupAtBuyer') {
            $('#pickup_at_seller_info_panel').hide();
            $('#pickup_at_buyer_info_panel').show();
        } else {
            $('#pickup_at_seller_info_panel').show();
            $('#pickup_at_buyer_info_panel').hide();
        }
    });

    $('#input-country').on('change', function() {
        $.ajax({
            url: 'index.php?route=checkout/checkout/country&country_id=' + this.value,
            dataType: 'json',
            beforeSend: function() {
                $('#input-country').prop('disabled', true);
            },
            complete: function() {
                $('#input-country').prop('disabled', false);
            },
            success: function(json) {
                if (json['postcode_required'] == '1') {
                    $('#postcode').parent().parent().addClass('required');
                } else {
                    $('#postcode').parent().parent().removeClass('required');
                }

                html = '<option value="">{{ text_select }}</option>';

                if (json['zone'] && json['zone'] != '') {
                    for (i = 0; i < json['zone'].length; i++) {
                        html += '<option value="' + json['zone'][i]['zone_id'] + '"';

                        if (json['zone'][i]['zone_id'] == '{{ zone_id }}') {
                            html += ' selected="selected"';
                        }

                        html += '>' + json['zone'][i]['name'] + '</option>';
                    }
                } else {
                    html += '<option value="0" selected="selected">{{ text_none }}</option>';
                }

                $('#input-zone').html(html);
            },
            error: function(xhr, ajaxOptions, thrownError) {
                alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
            }
        });
    });

    $('#input-shipping-country').trigger('change');
//--></script>
