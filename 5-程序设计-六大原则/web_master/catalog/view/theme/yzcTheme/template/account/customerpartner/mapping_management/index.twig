{{ header }}{{ separate_column_left }}
<script type="text/javascript" src="/catalog/view/javascript/bootstrap/js/bootstrap-paginator.min.js"></script>
<style>
  .layer-panel-box {
    color: #000;
    font-size: 14px;
  }
  .nav-tabs {
    border-bottom: 0 solid white;
  }
  .my-download.mr-1 {
    text-transform: none;
  }
  .tab-content-sty {
    background-color: white;
  }

  .col-sm-3 {
    width: 26%;
    margin: 0 5px;
  }
  .col-sm-10 {
    width: 16%;
    float: right;
  }
  .filter-wrapper {
    margin: 10px 0;
  }
  .option-group {
    margin: 0 5px;
  }
  .alert-danger {
    background-color: #f5c1bb;
    border-color: #f3b5ad;
    color: #c72f1d;
    border-radius: 5px;
    margin-bottom: 13px;
  }
  .sub-title2 {
    margin-top: 20px;
    color: red;
  }
  #show-mapping_item_code_list thead>tr>th {
    padding: 5px;
  }
  input[type=checkbox]{
    -webkit-appearance: button;
  }
</style>
<div class="container-fluid giga-content" id="content" style="margin-left: 15%">
  <ul class="breadcrumb">
    {% for breadcrumb in breadcrumbs %}
      <li><a href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a></li>
    {% endfor %}
  </ul>
  <div class="row">
    <div class="col-md-12">
      <h1>{{ text_mapping_index }}</h1>
      <div class="row">
        <div class="col-md-12">
          {#Togglable tabs#}
          <ul class="nav nav-tabs main" role="tablist">
            <li id="mapping_item_code_list" class="active"><a data-href="{{ item_code_url }}" data-toggle="tab"
                                                              style="cursor:pointer;">{{ text_sales_order }}</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  {#tab页对应内容#}
  <div id="box-shadow">
    <div class="tab-content tab-content-sty">
      <div class="tab-pane active" id="tab-mapping-item-code">
        <fieldset>
          <div id="show-mapping_item_code_list"></div>
        </fieldset>
      </div>
    </div>
  </div>
</div>
</div>
<script type="text/javascript">
  let page_num = 1;
  $('#show-mapping_item_code_list').load('{{ item_code_list }}&page=' + page_num);

  function handleFiles(files) {
    $('#btn_import_sku').button('loading');
    let formFile = new FormData();
    let index = files[0]['name'].lastIndexOf(".");
    let suffix = files[0]['name'].substr(index + 1);
    if (suffix !== 'xls' && suffix !== 'xlsx') {
      layerMsg('Required file format: .xls or .xlsx');
      $('#btn_import_file').val('');
      $('#btn_import_sku').button('reset');
      return false;
    }

    formFile.append("file", files[0]);
    let data = formFile;
    $.ajax({
      url: "{{ itemCodeMappingImport }}",
      data: data,
      type: "Post",
      dataType: "json",
      cache: false,//上传文件无需缓存
      processData: false,//用于对data参数进行序列化处理 这里必须false
      contentType: false, //必须
      beforeSend: function () {
        layer.load(1, {shade: [0.3, '#000']});
      },
      success: function (json) {
        layer.closeAll('loading');
        $('#btn_import_file').val('');
        $('#btn_import_sku').button('reset');
        layerMsg(json.msg);
        if (!json.error) {
          filterItemCodeMapping();
        }
      },
      error: function (xhr, ajaxOptions, thrownError) {
        layer.closeAll('loading');
        $('#btn_import_file').val('');
        $('#btn_import_sku').button('reset');
        layerMsg(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
      }
    })
  }

  function refreshMappingItemCodeList() {
    $('#show-mapping_item_code_list').load('index.php?route=account/customerpartner/mapping_management/list');
  }

  function platformSkuCheck() {
    let mapping_item_code_id = $("#myModalItemCodeMapping #mapping_item_code_id").val();
    let platform_id = $("#myModalItemCodeMapping #platform_id").val();
    let platform_sku = $.trim($("#platform_sku").val());
    let platform_sku_store = $.trim($("#platform_sku_store").val());
    let platform_name = $("#myModalItemCodeMapping #platform_id").find("option:selected").text();
    let url = '{{ urlPlatformSKUCheckOnly }}';

    let sendData = {
      mapping_item_code_id: mapping_item_code_id,
      platform_id: platform_id,
      platform_sku: platform_sku,
      platform_sku_store: platform_sku_store,
      platform_name: platform_name
    };
    $.ajax({
      type: 'POST',
      dataType: 'json',
      data: sendData,
      url: url,
      success: function (result) {
        if (0 == result.ret) {
          let tip = result.msg;
          $("#myModalItemCodeMapping #ic_tip").val(tip).text(tip);
          $("#myModalItemCodeMapping .my-tip").show();
        } else {
          $("#myModalItemCodeMapping .my-tip").hide();
        }
      }
    });
  }

  function beforeSubmitItemCodeMappingCheck() {
    //let mapping_item_code_id = $("#myModalItemCodeMapping #mapping_item_code_id").val();
    let platform_id = $("#myModalItemCodeMapping #platform_id").val();
    let platform_sku = $.trim($("#platform_sku").val());
    let platform_sku_store = $.trim($("#platform_sku_store").val());
    let b2b_sku = $.trim($("#b2b_sku").val());
    let tip = '';

    $("#myModalItemCodeMapping .form-group").removeClass("has-error");
    if (platform_id < 1) {
      tip = 'Platform can not be blank.';
      $("#myModalItemCodeMapping #ic_tip").val(tip).text(tip);
      $("#myModalItemCodeMapping .my-tip").show();
      $("#myModalItemCodeMapping #platform_id").focus().addClass('has-error');
      return false;
    }
    if (platform_sku_store.length < 1) {
      tip = 'Platform Store Name can not be blank.';
      $("#myModalItemCodeMapping #ic_tip").val(tip).text(tip);
      $("#myModalItemCodeMapping .my-tip").show();
      $("#platform_sku_store").focus().addClass('has-error');
      $("#platform_sku_store").css('border', '1px solid #ccc');
      $("#myModalItemCodeMapping #platform_id").removeClass('has-error');
      return false;
    }
    if (platform_sku.length < 1) {
      tip = 'Platform SKU can not be blank.';
      $("#myModalItemCodeMapping #ic_tip").val(tip).text(tip);
      $("#myModalItemCodeMapping .my-tip").show();
      $("#platform_sku").focus().addClass('has-error');
      $("#myModalItemCodeMapping #platform_id").removeClass('has-error');
      $("#platform_sku_store").removeClass('has-error');
      return false;
    }
    if (platform_sku.length > 40) {
      tip = 'Platform SKU can not be more than 40 characters.';
      $("#myModalItemCodeMapping #ic_tip").val(tip).text(tip);
      $("#myModalItemCodeMapping .my-tip").show();
      $("#platform_sku").focus().addClass('has-error');
      $("#myModalItemCodeMapping #platform_id").removeClass('has-error');
      $("#platform_sku_store").removeClass('has-error');
      return false;
    }
    if (b2b_sku.length < 1) {
      tip = 'B2B Item Code can not be blank.';
      $("#myModalItemCodeMapping #ic_tip").val(tip).text(tip);
      $("#myModalItemCodeMapping .my-tip").show();
      $("#myModalItemCodeMapping #b2b_sku").focus().addClass('has-error');
      //$("#myModalItemCodeMapping #b2b_sku").css('border', '1px solid #ccc');
      $("#myModalItemCodeMapping #platform_id").removeClass('has-error');
      $("#platform_sku_store").removeClass('has-error');
      $("#platform_sku").removeClass('has-error');
      return false;
    }
    $("#myModalItemCodeMapping .my-tip").hide();
    $("#myModalItemCodeMapping #platform_id").removeClass('has-error');
    $("#platform_sku_store").removeClass('has-error');
    $("#platform_sku").removeClass('has-error');
    $("#myModalItemCodeMapping #b2b_sku").removeClass('has-error');
    return true;
  }

  function submitItemCodeAdd() {
    let platform_id = $("#myModalItemCodeMapping #platform_id").val();
    let platform_sku = $.trim($("#platform_sku").val());
    let platform_sku_store = $.trim($("#platform_sku_store").val());
    let b2b_sku = $.trim($("#b2b_sku").val());
    let platform_name = $("#myModalItemCodeMapping #platform_id").find("option:selected").text();
    let lockded = false;

    let str = '<div style="text-align: left">' +
      '<p class="sub-title1">Do you confirm to submit the Item code mapping  <br>[ '
      + [platform_name, platform_sku_store, platform_sku, b2b_sku].join(' - ')
      + ' ] ? </p>';
    layer.confirm(str, {
      time: 60000,
      title: 'Confirm',
      btn: ['Yes', 'No'],
      area: '20%',
      skin: 'yzc_layer',
      yes: function (index) {
        let sendData = $("#myModalItemCodeMapping").find("form").serialize();
        let url = $("#myModalItemCodeMappingSubmit").attr("url");
        sendData += '&platform_name=' + platform_name;
        if (!lockded) {
          lockded = true;
          $.ajax({
            type: 'POST',
            dataType: 'json',
            data: sendData,
            url: url,
            beforeSend: function () {
              $('#myModalItemCodeMappingSubmit').button('loading');
            },
            complete: function (xhr, status) {
              lockded = false;
              $('#myModalItemCodeMappingSubmit').button('reset');
            },
            success: function (result, status, xhr) {
              if (result.ret) {
                layer.msg(result.msg);
                $("#myModalItemCodeMapping").modal("hide");
                refreshMappingItemCodeList();
              } else {
                let tip = result.msg;
                $("#myModalItemCodeMapping #ic_tip").val(tip).text(tip);
                $("#myModalItemCodeMapping .my-tip").show();

              }
            }
          });
          layer.close(index);
        }
      }
    })
  }

  function submitItemCodeEdit() {
    let mapping_item_code_id = $("#mapping_item_code_id").val();
    let platform_id = $.trim($("#myModalItemCodeMapping #platform_id").val());
    let platform_sku = $.trim($("#platform_sku").val());
    let platform_sku_store = $.trim($("#platform_sku_store").val());
    let platform_sku_store_old = $.trim($("#platform_sku_store_old").val());
    let b2b_sku = $("#b2b_sku").val();
    let platform_name = $("#myModalItemCodeMapping #platform_id").find("option:selected").text();
    let b2b_sku_old = $("#b2b_sku_old").val();
    let platform_sku_old = $("#platform_sku_old").val();
    let platform_name_old = $("#platform_name_old").val();

    let x = 0;//x值为该Buyer系统中使用了该Platform SKU的状态为New Order/Check label 的 Dropship销售订单数量
    let content = '<div style="text-align: left">' +
      '<p class="sub-title1">Do you confirm to change this item code mapping <br/>['
      + platform_name_old + ' - ' + platform_sku_store_old + ' - ' + platform_sku_old + ' - ' + b2b_sku_old + '] <br/>to [<br/>'
      + platform_name + ' - ' + platform_sku_store + ' - ' + platform_sku + ' - ' + b2b_sku + '] ?</p>' +
      '<p class="sub-title2">Changing this mapping will not affect the imported sales orders</p><div>';
    //checkOrderNumByPlatformSku
    $.ajax({
      async: false,
      type: 'GET',
      dataType: 'json',
      data: {id: mapping_item_code_id},
      url: 'index.php?route=account/mapping_item_code/checkOrderNumByPlatformSku',
      beforeSend: function () {
        $('#myModalItemCodeMappingSubmit').button('loading');
      },
      complete: function (xhr, status) {
        $('#myModalItemCodeMappingSubmit').button('reset');
      },
      success: function (result, status, xhr) {
        if (result.ret && result.num > 0) {
          x = result.num
        }
      }
    });

    if (x > 0) {
      content += '<font color="red">' + x + ' new orders contain this Item Code ['
        + b2b_sku_old + '], please cancel those orders and import again if you want to modify.</font>';
    }
    confirmMsg(content, submitDataSKUEdit);
  }

  function submitDataSKUEdit() {
    let sendData = {};
    sendData.mapping_item_code_id = $("#myModalItemCodeMapping").find("#mapping_item_code_id").val();
    sendData.b2b_sku = $("#myModalItemCodeMapping").find("#b2b_sku").val();
    sendData.platform_id = $("#myModalItemCodeMapping #platform_id").val();
    sendData.platform_sku = $("#myModalItemCodeMapping").find("#platform_sku").val();
    sendData.platform_sku_store = $("#myModalItemCodeMapping").find("#platform_sku_store").val();
    sendData.platform_name = $("#myModalItemCodeMapping #platform_id").find("option:selected").text();

    let url = $("#myModalItemCodeMappingSubmit").attr("url");
    $.ajax({
      type: 'POST',
      dataType: 'json',
      data: sendData,
      url: url,
      beforeSend: function () {
        $('#myModalItemCodeMappingSubmit').button('loading');
      },
      complete: function (xhr, status) {
        $('#myModalItemCodeMappingSubmit').button('reset');
      },
      success: function (result, status, xhr) {
        if (result.ret) {
          refreshMappingItemCodeList();
          layer.msg(result.msg);
        } else {
          let tip = result.msg;
          $("#myModalItemCodeMapping #ic_tip").val(tip).text(tip);
          $("#myModalItemCodeMapping .my-tip").show();
        }
        $(".modal-backdrop").hide();
      }
    });
  }

  function filterItemCodeMapping(button) {
    block.blockUI();
    let url = getUrlForFilter();
    $(button).button('loading');
    //console.log(url)
    $('#show-mapping_item_code_list').load(url);
  }

  function clrFilterItemCodeMapping(button) {
    block.blockUI();
    $("#input-platform_id").val("");
    $("#input-search_sku").val("");
    $("#input-search_sku_store").val("");
    let url = getUrlForFilter();
    $(button).button('loading');
    $('#show-mapping_item_code_list').load(url);
  }

  function getUrlForFilter() {
    let url = 'index.php?route=account/customerpartner/mapping_management/list';
    let filter_platform_id = $("#input-platform_id").val();
    if (filter_platform_id) {
      url += '&filter_platform_id=' + encodeURIComponent(filter_platform_id);
    }
    let filter_search_sku = $("#input-search_sku").val();
    if (filter_search_sku) {
      url += '&filter_search_sku=' + encodeURIComponent(filter_search_sku);
    }
    let filter_search_sku_store = $("#input-search_sku_store").val();
    if (filter_search_sku_store) {
      url += '&filter_search_sku_store=' + encodeURIComponent(filter_search_sku_store);
    }
    return url;
  }

  function handlePage(event, originalEvent, type, page) {
    let url = getUrlForFilter();
    //console.log(url + '&' + type + '=' + page)
    $('#show-mapping_item_code_list').load(url + '&page=' + page);
  }

  function downloadItemCodeMapping() {
    let url = 'index.php?route=account/customerpartner/mapping_management/filterByCsv';
    let filter_platform_id = $("#input-platform_id").val();
    if (filter_platform_id) {
      url += '&filter_platform_id=' + encodeURIComponent(filter_platform_id);
    }
    let filter_search_sku = $("#input-search_sku").val();
    if (filter_search_sku) {
      url += '&filter_search_sku=' + encodeURIComponent(filter_search_sku);
    }
    let filter_search_sku_store = $("#input-search_sku_store").val();
    if (filter_search_sku_store) {
      url += '&filter_search_sku_store=' + encodeURIComponent(filter_search_sku_store);
    }
    window.location.href = url;
  }

  function toDelete(id, platform, platform_sku, sku) {
    if (id != '') {
      //二次提示
      let str = '<div style="text-align: left">' +
        '<p class="sub-title1">Do you confirm to delete this Item code mapping [' + platform + ' - ' + platform_sku + ' - ' + sku + ']?</p>' +
        '<p class="sub-title2">Deleting this mapping will not affect the imported sales orders.</p><div>';
      confirmMsg(str, function () {
        $.ajax({
          type: 'POST',
          dataType: 'json',
          data: {ids: id},
          url: '{{ urlBatchDelete }}',
          success: function (json) {
            if (json['ret']) {
              if (id) {
                layer.msg(json['msg']);
                $("#tr_" + id).hide();
                refreshMappingItemCodeList();
              }
            }
          }
        });
      });
    }
  }

  function sortItemCodeMapping(sort, order) {
    let url = getUrlForFilter();
    url += '&sort=' + encodeURIComponent(sort);
    if (order) {
      url += '&order=' + encodeURIComponent(order);
    }
    url += "&page_num=" + page_num;
    block.blockUI();
    $('#show-mapping_item_code_list').load(url);
  }

  //全选
  function selectAll(ele) {
    if ($(ele).prop('checked')) {
      $(".checkboxes").prop("checked", true);
    } else {
      $(".checkboxes").prop("checked", false);
    }
  }

  //批量删除
  function checkboxDelete() {
    let checkChoose = $(".checkboxes:checked");
    if (checkChoose === null || checkChoose.length === 0) {
      layer.alert("Please select at least one mapping.", {
        title: 'Message',
        btn: 'OK',
        skin: 'yzc_layer' //样式类名
      });
    } else {
      let chooseValue = [];
      $.each(checkChoose, function (i, item) {
        chooseValue.push($(item).attr("value"))
      });
      //需要删除的value值
      let chooseValueStr = chooseValue.join(',');
      let tipStr = '';
      if (chooseValue.length == 1) {
        let id = chooseValue[0];
        let obj = $("button[data-id='" + id + "']");
        let platform_name = obj.attr('data-platform_name');
        let platform_sku_store = obj.attr('data-platform_sku_store');
        let platform_sku = obj.attr('data-platform_sku');
        let b2b_sku = obj.attr('data-b2b_sku');
        tipStr = '<div style="text-align: left">' +
          '<p class="sub-title1">Do you confirm to delete this Item code mapping [ ' + platform_name + ' - ' + platform_sku_store
          + ' - ' + platform_sku + ' - ' + b2b_sku + ' ]?</p>'
          + '<p class="sub-title2">Deleting this mapping will not affect the imported sales orders.</p><div>'
      } else {
        tipStr = '<div style="text-align: left">' +
          '<p class="sub-title1">Do you confirm to delete these item code mappings?</p>' +
          '<p class="sub-title2">Deleting these mappings will not affect the imported sales orders.</p><div>';
      }
      confirmMsg(tipStr, function () {
        //删除逻辑
        $.ajax({
          type: 'POST',
          dataType: 'json',
          data: {ids: chooseValueStr},
          url: '{{ urlBatchDelete }}',
          success: function (json) {
            layer.msg(json['msg']);
            if (json['ret']) {
              filterItemCodeMapping();
            }
          }
        });
      });
    }
  }

  function layerMsg(message) {
    let msg = layer.msg(message, {
      time: 60000,
      title: 'Message',
      skin: 'yzc_layer',
      btn: ['OK']
    }, function () {
      layer.close(msg);
    });
  }

  //确认弹窗
  function confirmMsg(msg, callback) {
    if ($("#myModalItemCodeConfirm").length > 0) {
      //固定弹窗
      $("#myModalItemCodeConfirmBody").html(msg);
      $("#myModalItemCodeConfirm").modal('show');

      $("#myModalItemCodeConfirmSubmit").off("click").on("click", function () {
        $("#myModalItemCodeConfirm").modal('hide');
        (callback && typeof (callback) === "function") && callback();
      });
      $("#myModalItemCodeConfirmCancel").off("click").on("click", function () {
        $("#myModalItemCodeConfirm").modal('hide');
      });
    } else {
      let message = layer.confirm(msg, {
        time: 60000,
        width: 400,
        title: 'Confirm',
        skin: 'yzc_layer',
        btn: ['Yes', 'No'],
        closeBtn: 1
      }, function () {
        layer.close(message);
        (callback && typeof (callback) === "function") && callback();
      });
    }
  }


</script>
{{ footer }}