{{ header }}{{ separate_column_left }}
{% if separate_view is defined and separate_view %}
<div class="container-fluid" id="content" style="margin-left: 15%">
  {% else %}
  <div class="container">
    {% endif %}
    <ul class="breadcrumb">
      {% for breadcrumb in breadcrumbs %}
        <li><a href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a></li>
      {% endfor %}
    </ul>
    {% if error_warning %}
      <div class="alert alert-danger"><i class="fa fa-exclamation-circle"></i>{{ error_warning }}</div>
    {% endif %}
    {% if success %}
      <div class="alert alert-success"><i class="fa fa-check-circle"> </i> {{ success }}</div>
    {% endif %}

    <div class="row">
      {{ column_left }}
      {% if column_left and column_right %}
        {% set class = 'col-sm-6' %}
      {% elseif column_left or column_right %}
        {% set class = 'col-sm-9' %}
      {% else %}
        {% set class = 'col-sm-12' %}
      {% endif %}

      <div id="content" class="{{ class }}">
        {{ content_top }}
        <fieldset>
          <div style="padding-bottom: 5px;margin-bottom:15px;overflow: hidden">
            <div class="pull-left">
              <h1 style="margin-top: 12px;margin-bottom: 0!important; padding-left: 20px;">Attribute Management : "{{ option_name }}"</h1>
            </div>
            <div class="pull-right">
              <button id="submit_button" type="button" data-toggle="tooltip" title="{{ button_save }}"
                      class="btn btn-primary">
                <i class="fa fa-save"></i>
              </button>
              <a href="{{ back_action }}" data-toggle="tooltip" title="{{ button_go_back }}" class="btn btn-default">
                <i class="fa fa-reply"></i>
              </a>
            </div>
          </div>
          <div id="box-shadow" style="margin-top: 0">
            <div class="table-responsive" style="width: 100%">
              <form action="{{ save_action }}" method="post" enctype="multipart/form-data" id="form-option"
                    class="form-horizontal">
                <table id="option-value" class="table table-hover">
                  <thead>
                  <tr>
                    <td class="text-center ">No.</td>
                    <td class="text-left required">{{ entry_option_value }}</td>
                    <td class="text-left">{{ entry_sort_order }}</td>
                    <td></td>
                  </tr>
                  </thead>
                  <tbody>

                  {% set option_value_row = 0 %}
                  {% for option_key,option_value in option_values %}
                    <tr id="option-value-row{{ option_value_row }}">
                      <td class="text-center">{{ option_key+1 }}</td>
                      <td class="text-center"><input type="hidden"
                                                     name="option_value[{{ option_value_row }}][option_value_id]"
                                                     value="{{ option_value.option_value_id }}"/>
                        {% for language in languages %}
                          {% set error_class = '' %}
                          {% if error_option_value[option_value_row][language.language_id] %}
                            {% set error_class = 'has-error' %}
                          {% endif %}
                          <div class="input-group {{ error_class }}">
                            {#<span class="input-group-addon">#}
                            {#<img#}
                            {#src="catalog/language/{{ language.code }}/{{ language.code }}.png"#}
                            {#title="{{ language.name }}"/>#}
                            {#</span>#}
                            <input type="text"
                                   name="option_value[{{ option_value_row }}][option_value_description][{{ language.language_id }}][name]"
                                   value="{{ option_value.option_value_description[language.language_id] ? option_value.option_value_description[language.language_id].name }}"
                                   placeholder="{{ entry_option_value }}"
                                   class="form-control attribute_input "/>
                          </div>
                          {% if error_option_value[option_value_row][language.language_id] %}
                            <div
                              class="text-danger text-left">{{ error_option_value[option_value_row][language.language_id] }}</div>
                          {% endif %}
                        {% endfor %}</td>
                      <td class="text-center" style="display: none">
                        <a
                          href=""
                          id="thumb-image{{ option_value_row }}"
                          data-toggle="image"
                          class="img-thumbnail">
                          <img src="{{ option_value.thumb }}" alt="" title="" data-placeholder="{{ placeholder }}">
                        </a>
                        <input type="hidden" name="option_value[{{ option_value_row }}][image]"
                               value="{{ option_value.image }}" id="input-image{{ option_value_row }}"/>
                      </td>
                      <td class="text-right"><input type="number"
                                                    name="option_value[{{ option_value_row }}][sort_order]"
                                                    value="{{ option_value.sort_order }}" class="form-control"/></td>
                      <td class="text-right">
                        <button type="button" onclick="removeRow('option-value-row{{ option_value_row }}');"
                                data-toggle="tooltip" title="{{ button_delete }}" class="btn btn-danger"><i
                            class="fa fa-trash"></i></button>
                      </td>
                    </tr>
                    {% set option_value_row = option_value_row + 1 %}
                  {% endfor %}
                  </tbody>

                  <tfoot>
                  <tr>
                    <td colspan="3"></td>
                    <td class="text-right">
                      <button type="button" onclick="addOptionValue();" data-toggle="tooltip"
                              title="{{ button_add }}" class="btn btn-primary"><i
                          class="fa fa-plus-circle"></i></button>
                    </td>
                  </tr>
                  </tfoot>
                </table>
              </form>
            </div>
          </div>
        </fieldset>
        {{ content_bottom }}
      </div>
      {{ column_right }}
    </div>
  </div>
</div>
<script>
  var option_id = {{ option_id }};

  function removeRow(rowId) {
    if (!rowId) return;
    var selectItem = $("#" + rowId);
    var item = selectItem.find("td:eq(1)").find('input');
    var option_value_id = item.val();
    if (!option_value_id) {
      selectItem.remove();
      return;
    }
    $.post('{{ delete_action }}', {o_id: option_id, v_id: option_value_id}, function (data) {
      if (Array.isArray(data) && data.length <= 0) {
        layer.confirm('{{ option_relate_msg }}', {
          title: 'Message',
          btn: ['Yes', 'No'],
          btnAlign: 'c',
          skin: 'yzc_layer',
          yes: function () {
            selectItem.remove();
            layer.closeAll();
          },
          btn2: function () {
            layer.closeAll();
          }
        });
        return;
      }
      layer.msg('{{ option_not_relate_msg }}');
    });
  }
</script>
<script type="text/javascript">
  $('select[name=\'type\']').on('change', function () {
    if (this.value == 'select' || this.value == 'radio' || this.value == 'checkbox' || this.value == 'image') {
      $('#option-value').parent().show();
    } else {
      $('#option-value').parent().hide();
    }
  });
  $('select[name=\'type\']').trigger('change');
  var option_value_row = {{ option_value_row }};

  function addOptionValue() {
    html = '<tr id="option-value-row' + option_value_row + '">';
    html += '<td class="text-center">' + (option_value_row + 1) + '</td>';
    html += '  <td class="text-left"><input type="hidden" name="option_value[' + option_value_row + '][option_value_id]" value="" />';
    {% for language in languages %}
    html += '    <div class="input-group">';
    // html += '      <span class="input-group-addon"><img src="catalog/language/{{ language.code }}/{{ language.code }}.png" title="{{ language.name }}" /></span><input type="text" name="option_value[' + option_value_row + '][option_value_description][{{ language.language_id }}][name]" value="" placeholder="{{ entry_option_value }}" class="form-control attribute_input" />';
    html += '     <input type="text" name="option_value[' + option_value_row + '][option_value_description][{{ language.language_id }}][name]" value="" placeholder="{{ entry_option_value }}" class="form-control attribute_input" />';
    html += '    </div>';
    {% endfor %}
    html += '  </td>';
    html += '  <td class="text-center" style="display:none;"><a href="" id="thumb-image' + option_value_row + '" data-toggle="image" class="img-thumbnail"><img src="{{ placeholder }}" alt="" title="" data-placeholder="{{ placeholder }}" /></a><input type="hidden" name="option_value[' + option_value_row + '][image]" value="" id="input-image' + option_value_row + '" /></td>';
    html += '  <td class="text-right"><input type="number" name="option_value[' + option_value_row + '][sort_order]" value="" placeholder="{{ entry_sort_order }}" class="form-control " /></td>';
    html += '  <td class="text-right"><button type="button" onclick="removeRow(\'option-value-row' + option_value_row + '\');" data-toggle="tooltip" title="{{ button_remove }}" class="btn btn-danger"><i class="fa fa-trash"></i></button></td>';
    html += '</tr>';
    $('#option-value tbody').append(html);
    addAutoCompleteFunction();
    option_value_row++;
  }

  function addAutoCompleteFunction() {
    $('.attribute_input').autocomplete({
      source: function (request, response) {
        $.ajax({
          url: 'index.php?route=account/customerpartner/productoptions/autoOptionComplete',
          data: {filter_name: encodeURIComponent(request)},
          dataType: 'json',
          success: function (json) {
            response($.map(json, function (item) {
              return {
                label: item['color'],
                value: item['id']
              }
            }));
          }
        });
      },
      select: function (item) {
        var selectItem = $(this).parents('tr');
        var selectItemId = selectItem.attr('id');
        var allTrList = $('#option-value').find('tbody').find('tr');
        var flag = true;
        allTrList.each(function (key, val) {
          val = $(val);
          if (val.attr('id') != selectItemId) {
            var thisVal = val.find("td:eq(1)").find('input').val();
            if (thisVal == item.value) {
              flag = false
            }
          }
        });
        // select the same color is not allowed here！
        if (!flag) {
          layer.msg('{{ same_attribute_msg }}');
          return;
        }
        selectItem.find("td:eq(1)").find('input').val(item.value);
        $(this).val(item.label);
      }
    });
  }

  addAutoCompleteFunction();

  $('#submit_button').on('click', function () {
    $(this).button('loading');
    $('#form-option').submit();
  })

</script>
{{ footer }}
