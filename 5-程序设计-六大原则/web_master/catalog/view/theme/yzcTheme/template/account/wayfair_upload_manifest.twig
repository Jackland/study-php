
<link href="catalog/view/javascript/bootstrap/css/bootstrap.min.css" rel="stylesheet" media="screen"/>
<link href="catalog/view/theme/yzcTheme/stylesheet/font_demo/iconfont.css" rel="stylesheet" type="text/css">
<link type="text/css" href="/public/fonts/giga/iconfont.css?v={{ app_version }}" rel="stylesheet">{#B2B页面改版 图标字体#}
<script src="catalog/view/javascript/jquery/jquery-2.1.1.min.js" type="text/javascript"></script>
<script src="catalog/view/javascript/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
<style>
  *{
    color: #333;
    font-size: 14px;
  }
  .inner-container{
    padding: 10px;
    padding-bottom: 0;
  }
  .tip{
    padding: 5px 20px 5px 20px;
    background-color: #fff5ef;
    color: #fa6400;
    border-radius: 4px;
    font-size:14px;
    margin-bottom: 10px;
  }


  .think-con ul{
    border: 1px solid #ccc;
    border-top: none;
    padding-left: 0px;
  }
  .think-con ul li{
    padding-left: 12px;
    list-style: none;
    line-height: 30px;
    color: #333;
  }
  .think-con ul li:hover{
    background: #eee;
    cursor: pointer;
  }


  .panel-default>.panel-heading {
    color: #333;
     background-color: transparent;
     border-color: transparent;
  }

  .panel-default{
    border: none;
  }
  .inner-container .btn-primary{
    font-size: 12px;
    color: #fff;
    background-color: #3a75dc;
    border-color: #225cc1;
    padding: 6px 10px;
    font-size: 12px;
    box-shadow: 0px 2px 2px 0 #eee;
  }
  .inner-container .btn-primary.my-disabled,.inner-container .btn-primary.my-disabled:hover{
    cursor:not-allowed;
    background: #bbb;
    color: #fff;
    border-color: #bbb;;
  }
  .inner-container .btn-primary:hover {
    background-color: #225cc1;
  }





  .num,.status-newOrder{
    color: #FA6400;
  }
  .status-beingProcessed{
    color: #67C23A;
  }

  .table>tbody>tr>td{
    vertical-align: middle;
  }
  .item-img{
    display: inline-block;
    width: 35px;
    height: 35px;
  }
  .panel-group{
    /*height: 70%;*/
    overflow: auto;
    margin-bottom: 0;
  }
  .tbody {
    /*height: 200px;*/
    /*overflow-y: scroll;*/
  }
  .tbody::-webkit-scrollbar {
    display: none
  }
  .panel-body table tr th:nth-of-type(1),
  .panel-body table tr td:nth-of-type(1) {
    width: 10%;
  }

  .panel-body table tr th:nth-of-type(2),
  .panel-body table tr td:nth-of-type(2) {
    width: 20%;
  }

  .panel-body table tr th:nth-of-type(3),
  .panel-body table tr td:nth-of-type(3) {
    width: 15%;
  }

  .panel-body table tr th:nth-of-type(4),
  .panel-body table tr td:nth-of-type(4) {
    width: 15%;
  }

  .panel-body table tr th:nth-of-type(5),
  .panel-body table tr td:nth-of-type(5) {
    width: 30%;
  }
  .panel-body table tr th:nth-of-type(6),
  .panel-body table tr td:nth-of-type(6) {
    width: 10%;
  }
  .table{
    margin-bottom: 0;
  }
  .table>thead>tr>th{
    border-bottom: none;
  }
  .btn-con{
    padding-top: 6px;
    text-align: center;
    box-shadow: 0 -6px 10px #eee;
    position: relative;
  }
  .btn-primary.my-submit{
    font-size: 12px;
    background: #478BFF;
    border-color: #478BFF;
  }
  .btn-default.my-cancel{
    font-size: 12px;
    color: #478BFF;
    background-color: #fff;
    border-color: #ececec;
    font-weight: 700;
  }
</style>
<div class="inner-container">
  <div style="font-weight: bold;margin-bottom: 10px;padding-left: 15px;">
    Please review the Item Code mapping and upload Manifest to each shipment method.
  </div>
  <div style="height:560px;overflow-y: scroll">
  {% for key,value in list %}
    <div class="table-con"  style="margin-top: 20px;">
    <span class="tip" style="border: 1px solid #fa6400;margin-left: 15px">
      {{ value.order_date }}
    </span>
    <span class="tip" style="border: 1px solid #fa6400;margin-left: 20px;">
      {{ value.carrier_name }}
    </span>
      <span class="tip" style="border: 1px solid #fa6400;margin-left: 20px;">
      {{ value.warehouse_name }}
    </span>
    <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
      <div class="panel-default">
        <div>
          <div class="panel-body">
            <div class="thead">
              <table class="table">
                <thead>
                <tr>
                  <th>#</th>
                  <th>Sale Order ID(<span class="num">{{ value.order_amount }}</span>)</th>
                  <th></th>
                  <th>B2B Item Code</th>
                  <th>Wayfair Item Number</th>
                  <th>Packages(<span class="num">{{ value.package_qty }}</span>)</th>
                </tr>
                </thead>
                <tbody>
                {% for ks,vs in value.list %}
                  {% for k,v in vs.line_list %}
                  <tr style="border-bottom: 1px solid #ddd">
                    {% if v.is_show %}
                      <td rowspan="{{ v.row_span }}">{{ ks + 1 }}</td>
                      <td rowspan="{{ v.row_span }}">{{ vs.order_id }}</td>
                    {% endif %}
                    <td><a href="{{ v.product_link }}" target="_blank"><img class="item-img" src="{{ v.image_show }}" alt=""></a></td>
                    <td>
                      {{ v.item_code }}
                      {% if v['tag_array'] is not empty %}
                        {% for tag in v['tag_array'] %}
                          &nbsp;{{ tag }}
                        {% endfor %}
                      {% endif %}
                    </td>
                    <td>{{ v.t_item_code }}</td>
                    <td>{{ v.package_qty }}</td>
                  </tr>
                  {% endfor %}
                {% endfor %}
                </tbody>
              </table>
            </div>
            <div style="margin: 10px 0 10px 0;padding-bottom:20px;border-bottom: 1px solid #ddd">
{#              <button class="btn btn-primary my-disabled" >Upload Manifest</button>&nbsp;&nbsp;#}
{#              <span class="upload-file">#}
{#                <a href="#">CS2183912903864-123-Manifest.pdf</a>#}
{#                <i class="glyphicon glyphicon-remove-circle file-deleted"></i>#}
{#              </span>#}

              <button class="btn btn-primary"
                      data-toggle="tooltip"
                      data-trigger = "hover"
                      title="Please upload the manifest file for the {{ value.order_amount }} orders to be picked up by
                      [ {{ value.carrier_name }} ] in [{{ value.warehouse_name }}] on [ {{ value.pickup_date }} ], which should contain all the order IDs in the table above."
                      id='{{ value.order_id_all }}_div'
                      name="{{ value.order_id_all}}_div">
                Upload Manifest</button>
              <input type="file" id="{{ value.order_id_all }}" name='{{ value.order_id_all }}' onchange="handleFiles(this.files,'{{ value.order_id_all }}')" style="display:none;">
              <span class="upload-file" style="margin-left: 10px;" id="{{ value.order_id_all }}_show">
              </span>
            </div>

          </div>
        </div>
      </div>

    </div>
  </div>
  {% endfor %}
  </div>
</div>
<div class="btn-con">
  <button id='btnClose' class="btn btn-primary my-submit" onclick="checkInputInfo()" >SUBMIT</button>&nbsp;&nbsp;
  <button class="btn btn-default my-cancel" onclick="cancelConfirm()">UPLOAD LATER</button>
</div>
<script>
  var manifest_common_label = [];
  {% for key,value in list%}
    var file_select_name = '{{ value.order_id_all }}' + '_div';
    var file_elem_name = '{{ value.order_id_all }}';
    manifest_common_label[file_elem_name + '_label'] = '';
    var fileSelect_{{ key }} = document.getElementById(file_select_name),
      fileElem_{{ key }} = document.getElementById(file_elem_name);

    fileSelect_{{ key }}.addEventListener("click", function (e) {
    if (fileElem_{{ key }}) {
      fileElem_{{ key }}.click();
    }
    e.preventDefault(); // prevent navigation to "#"
  }, false);
  {% endfor %}

  $(document).ready(function () {
    //气泡
    $('[data-toggle="tooltip"]').tooltip();

  });
  function handleFiles(files,container_id){
    var formFile = new FormData();
    if(files[0]['type'] !== 'application/pdf'){
      layerMsg('Please upload a file in PDF format.');
      return false;
    }
    if(files[0]['size'] > 1024*1024){
      layerMsg('Please upload a PDF file not exceeding 1MB.');
      return false;
    }
    formFile.append("container_id", container_id);
    formFile.append("files", files[0]);
    var data = formFile;
    $.ajax({
      url: "/index.php?route=account/customer_order/wayfairUploadManifestDeal",
      data: data,
      type: "Post",
      dataType: "json",
      cache: false,//上传文件无需缓存
      processData: false,//用于对data参数进行序列化处理 这里必须false
      contentType: false, //必须
      beforeSend: function () {
        parent.layer.load(1);
      },
      success: function (result) {
        parent.layer.closeAll('loading');
        if(result.error === 0){
          var container_id_div = '#' + result.data.container_id + '_div';
          $(container_id_div).addClass('my-disabled');
          $(container_id_div).attr('disabled',true);
          var container_show = '#' + result.data.container_id + '_show';
          $(container_show).empty();
          $(container_show).show();
          var info = '<a style="cursor:pointer;color:#23527c;text-decoration:underline;" data-toggle="tooltip" title="' + result.data.file_name + '" onclick="getManifestPdf(this)" mean="' + result.data.deal_file_path + '" >' + result.data.file_name + '</a><i style="margin-left: 5px;cursor: pointer" onclick="cleanFile(' + "'" + result.data.container_id + "'" + ')" class="glyphicon glyphicon-remove-circle file-deleted"></i>';
          $(container_show).append(info);
          $('[data-toggle="tooltip"]').tooltip();
          manifest_common_label[result.data.container_id + '_label'] = result.data.file_name;
        }else{
          layerMsg(result.error,3000);
          manifest_common_label[result.data.container_id + '_label'] = '';
        }
      },
      error: function (xhr, ajaxOptions, thrownError) {
        parent.layer.closeAll('loading');
        layerMsg(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
      }
    })
  }

  function cleanFile(container_id) {
    var del_url = '{{ dropship_file_unlink }}';
    $.ajax({
      url: del_url,
      type: 'post',
      dataType: 'json',
      //                async:false,
      data: {'container_id': container_id},
      beforeSend: function () {
        parent.layer.load(1);
      },
      success: function (res) {
        parent.layer.closeAll('loading');
        var container_id_div = '#' + container_id + '_div';
        $('#' + container_id).val('');
        $(container_id_div).removeClass('my-disabled');
        $(container_id_div).attr('disabled',false);
        var container_show = '#' + container_id + '_show';
        $(container_show).empty();
        manifest_common_label[container_id + '_label'] = '';
      }
    })

  }

  function layerMsg(message, time = 2000) {
    parent.layer.msg(message, {time: time});
  }

  function getManifestPdf(obj) {
    var url = $(obj).attr('mean');
    var upload_info = 'Manifest';
    parent.layer.open({
      type: 2,
      offset: ['150px', '380px'],
      area: ['700px', '400px'],
      title: upload_info,
      fixed: false, //不固定Change
      maxmin: true,
      skin: 'yzc_layer',
      scrollbar: false,
      content: url,
    });
  }
  
  function checkInputInfo() {
    $('#btnClose').attr('disabled', 'disabled');
    var temp_label = [];
    var file_str = '';
    for(let ks  in manifest_common_label){
      if(manifest_common_label[ks]){
        file_str += ks + ':' + manifest_common_label[ks] + ';';
        temp_label.push(manifest_common_label[ks])
      }
    }
    if(temp_label.length === 0){
      layerMsg("You have not uploaded any manifest files, if not, please click the 'UPLOAD LATER' button.");
      $('#btnClose').attr('disabled', false);
      return false;
    }else{
      $.ajax({
        url: '{{ europe_wayfair_manifest_preserved }}',
        type: 'post',
        dataType: 'json',
        //                async:false,
        data: {'manifest_common_label': file_str },
        beforeSend: function () {
          parent.layer.load(1);
        },
        success: function (res) {
          if(res.error === 0){
            parent.layer.closeAll();

            var index = parent.layer.getFrameIndex(window.name);
            parent.layer.close(index);
            window.parent.getLayUrl(res.show_url);
            layerMsg(res.msg,2000);
          }

        },
        error: function () {
          layerMsg('Submit failed',3000);
          $('#btnClose').attr('disabled', false);
        }
      })
    }

  }
  
  function cancelConfirm() {
    var notice = 'System will skip the Manifest file you uploaded. Please click Manifest Management in sales order to upload the file later. Or, it may impact your shipment.';
    var show_url = '{{ show_url }}';
    parent.layer.confirm(notice, {
      title: 'Attention',
      skin: 'yzc_layer', //样式类名
      btn: ['CONFIRM', 'CANCEL'],
      yes: function (index) {
        parent.layer.closeAll();
        window.parent.getLayUrl(show_url);
      },

    });

  }
</script>