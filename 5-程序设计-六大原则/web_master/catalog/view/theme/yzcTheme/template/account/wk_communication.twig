{{header}}{{ separate_column_left }}
<script type="text/javascript" src="catalog/view/javascript/bootstrap/js/bootstrap-paginator.min.js"></script>
{% if separate_view is defined and separate_view %}
<div class="container-fluid" id="content" style="margin-left: 18%">
    {% else %}
  <div class="container">
      {% endif %}
  <ul class="breadcrumb">
    {% for breadcrumb in breadcrumbs %}
      <li><a href="{{breadcrumb.href}}">{{breadcrumb.text}}</a></li>
    {% endfor %}
  </ul>
  <div class="row">{{column_left}}
    {% if column_left and column_right %}
    {% set class = 'col-sm-6' %}
    {% elseif column_left or column_right %}
    {% set class = 'col-sm-9' %}
    {% else %}
    {% set class = 'col-sm-12' %}
    {% endif %}
    <div ng-app="app" ng-cloak>
      <div id="content" class="{{class}}">{{content_top}}
        <h1>{{title_communication}}</h1>
        {% if error_warning %}
          <div class="alert alert-danger">
            <i class="fa fa-exclamation-circle"></i>
           {{error_warning}}
          </div>
        {% endif %}
        <div ng-controller="messageController">
          <div class="row">
            <div class="col-sm-7">
              <!-- Communication Tabs -->
                <ul class="nav nav-tabs communication">
                  <li  ng-class="{'active inbox':active=='inbox'}">
                    <a id="tab-inbox" ng-init="initQuery('inbox')" ng-click="initQuery('inbox')" data-toggle="tab">
                      <i class="fa fa-inbox"></i>
                      <span class="tab_space">{{text_inbox}}</span>
                      <span class="badge">{{ '{{total.inbox}}' }}</span>
                    </a>
                  </li>
                  <li ng-class="{'active sent':active=='sent'}">
                    <a id="tab-sent" ng-click="initQuery('sent')" data-toggle="tab">
                      <i class="fa fa-level-up"></i>
                      <span class="tab_space">{{text_sent}}</span>
                      <span class="badge">{{ '{{total.sent}}' }}</span>
                    </a>
                  </li>
                  <li ng-class="{'active trash':active=='trash'}">
                    <a id="tab-trash" ng-click="initQuery('trash')" data-toggle="tab">
                      <i class="fa fa-trash" aria-hidden="true"></i>
                      <span class="tab_space">{{text_trash}}</span>
                      <span class="badge">{{ '{{total.trash}}' }}</span>
                    </a>
                  </li>
                </ul>
            </div>
            <div class="col-sm-5">
              <!-- Search box -->
              <div class="col-sm-6 pull-left" ng-show="!selection">
                <div class="input-group">
                  <input type="text" ng-model="keyword" id="searchInput" class="form-control"  placeholder="Subject">
                  <span class="input-group-btn">
                    <button ng-click="searchQuery()"   type="button" class="btn btn-default"></button>
                  </span>
                </div>
              </div>
              <!-- Delete + Back-->
                <div class="col-sm-6 text-right pull-right">
                  <button class="btn btn-primary"  data-toggle="tooltip" data-original-title="Mark as read"
                        ng-show="active == 'inbox' && !selection"
                        ng-click="readAll()" >
                          <i class="fa fa-envelope-open"></i>
                  </button>
                  <button type="button" class="btn btn-default"
                          onclick="$('.active [data-toggle=tab]').click();">
                      <i class="fa fa-reply"></i>
                  </button>
              </div>
          </div>
        </div>

        <!-- Loder -->
          <div ng-show="loading" aria-hidden="true">
            <i class="fa fa-cog fa-spin fa-3x fa-fw spinner"></i>
          </div>

          <div id="message" ng-show="!selection">
            <table class="table table-hover table-bordered table-striped" name="message" ng-show="!loading" style="table-layout:fixed;">
              <thead>
                <tr>
                  <td  style="text-align: center;width: 3%;"/><input type="checkbox" onclick="$('input[name=\'selectedMessages\']').prop('checked', this.checked);" /></td>
                    <td class="text-left col-sm-5" >
                      <a ng-click="order('message_subject')">{{text_subject}}</a>
                    </td>
                <td class="text-left col-sm-2">
                  {% if isPartner is defined and isPartner %}
                    <a ng-click="order('user_name')">{{text_nickname}}</a>
                  {% else %}
                    <a ng-click="order('user_name')">{{text_store_name}}</a>
                  {% endif %}
                </td>
                <td class="text-left col-sm-2">
                  <a ng-click="order('message_date')">{{text_date}}</a>
                </td>
                <td class="text-left col-sm-2">{{ text_action_ano }}</td>
              </tr>
            </thead>
            <tr ng-repeat="message in messages ">
              <td style="text-align: center;width: 3%;"><input type="checkbox" value="{{ '{{message.message_id }}' }}" name="selectedMessages" ng-model="checkboxes[message.message_id].isChecked"></td>
              <td class="text-left col-sm-5 suspension-points"  title="{{'{{message.message_subject}}'}}">
                <span ng-if="active=='inbox' &&message.is_read==0" class="msg-dot"></span>
                   {{'{{message.message_subject}}'}}
                    <input type="hidden" ng-value="message.message_subject">
              </td>
              <td class="text-left col-sm-2" title="{{'{{message.user_name}}'}}">
                <span ng-if="message.seller_link != undefined">
                  <a href="{{ '{{ message.seller_link }}' }}">{{ '{{ message.user_name }}' }}</a>
                </span>
                <span ng-if="message.seller_link == undefined">
                  {{ '{{ message.user_name }}' }}
                </span>
                <input type="hidden" ng-value="message.user_name">
              </td>
              <td class="text-left col-sm-2">{{'{{message.message_date}}'}}&nbsp;&nbsp;&nbsp;&nbsp;<span class="badge badge-lg badge-default">{{ '{{ message.reply}}' }}
                 {{text_replies}}</span>
              </td>
              <td class="text-center col-sm-1">
                <button type="button" ng-model="selection" ng-click="route(message.message_id)" data-toggle="tooltip" title="" class="btn btn-primary" data-original-title="View">
                  <i class="fa fa-eye" aria-hidden="true"></i>
                </button>
                <button ng-if="message.placeholder_id == 1 && message.show_flag == 100"
                        ng-click="returnEstablishResult(1,message.message_id,message.user_name)"
                        type="button" ng-model="selection"   data-toggle="tooltip" title="" class="btn btn-success" data-original-title="Agree">
                  <i class="fa fa-check" aria-hidden="true"></i>
                </button>
                <button ng-if=" message.placeholder_id == 1 && message.show_flag == 100"
                        ng-click="returnEstablishResult(0,message.message_id,message.user_name)"
                        type="button" ng-model="selection"  data-toggle="tooltip" title="" class="btn btn-danger" data-original-title="Disagree">
                  <i class="fa fa-close" aria-hidden="true"></i>
                </button>
              </td>
            </tr>
            <tr ng-if="messages.length==0">
              <td colspan="5" class="text-center">{{text_no_records}}</td>
            </tr>
          </table>

            <div class="row">
              <div class="col-sm-12">
                <div class="pull-left">

                  {#左侧删除#}
                  <div class="table-bottom-action">
                    <div class="bottom-action-left">
                      <i class="fa fa-right-angle"></i>
                      <button class="btn btn-danger" data-toggle="tooltip" data-original-title="{{text_delete}}"
                              ng-show="!selection"
                              ng-click="delete()">
                        <i class="fa fa-trash-o"></i> </button>
                      <span class="bottom-action-detail"></span>
                    </div>
                  </div>
                </div>

                <div class="pull-right">
                  <div id="pagination_results" style="display: inline-block;position: relative;top: -10px;">{{ results}}</div>
                  <ul id="bos_pagination">
                    <!--里面什么都不用写-->
                  </ul></div>
                </div>
              </div>
            </div>


        </div>
        <div id="messageinfo" ng-hide="!selection" ng-include="'catalog/view/theme/yzcTheme/template/account/wk_messageinfo.twig'"></div>
        <div id="message_form">
          <form method="POST" id="messageform" name="replyform" ng-hide="!selection" enctype="multipart/form-data">
            <div id="seller-contact">
              <input type="hidden" value="" name="to" id="to">
              <input type="hidden" value="" name="message_to_id" id="message_to_id">
              <input type="hidden" value="" name="parent_message" ng-model="parent" id="parent">
              <div class="form-group">
                <span style="color: red">*</span>
                <label>
                 {{text_subject}}
                </label>
                <input type="text" id="subject" maxlength="500" name="subject" value="Re :{{message_info.message_subject}}" class="form-control"/>
              </div>
              <div class="form-group">
                <textarea id="body" name="message"></textarea>
              </div>
              <div class="form-group">
                <div class="form-group fileDiv" style="display:inline-block">
                  <label class="attach-file pointer" name="upload_files[]">
                    <i class="fa fa-upload" style="margin-top: 37%;"></i>
                    <input type="file" name='file[]' id="files" style="display:none" onchange="validate_fileupload(this);">
                    <i class="fa fa-times remove-file pointer" ></i>
                  </label>
                </div>
                  <a id="addFile" class="label-right pointer">+ {{text_attach}} </a>
              </div>
            </div>
            <div class="pull-right">
              <button type="Submit" id="submit" ng-click="submitQuery()" class="btn btn-primary">Reply</button>
            </div>
          </form>
        </div>
      </div>
     {{content_bottom}}
    </div>
   {{column_right}}
  </div>
</div>
</div>
  <div id="returnEstablishModal" style="display: none; ">
    <div class="form-group required">
      <label class="col-sm-12 control-label" for="returnEstablishComment">Comments</label>
      <div class="col-sm-12">
        <textarea id="returnEstablishComment" maxlength="200" style="resize:none;width:385px;height:110px;" onkeyup="this.value=this.value.substring(0, 200)"></textarea>
        <span id="returnEstablishCount"></span>/200
      </div>
    </div>
    <div class="form-group required set_group" style="display: none">
      <label class="col-sm-12 control-label" for="input_buyer_group">Set buyer group</label>
      <div class="col-sm-12">
        <select name="input_buyer_group" id="input_buyer_group" class="form-control">
          <option value="0" data-product_group="No Group" data-product_group_num="0"> {{ text_null_group }} </option>
          {% if buyer_groups %}
              {% for buyer_group in buyer_groups %}
                <option data-product_group="{{ buyer_group.product_group_name }}"
                        data-product_group_num="{{ buyer_group.product_group_num }}" value="{{ buyer_group.buyer_group_id }}">
                    {{ buyer_group.name ~ (buyer_group.is_default?'(Default)':'') }}</option>
              {% endfor %}
          {% endif %}
        </select>
      </div>
    </div>
    <div class="form-group set_group" style="display: none">
      <label class="col-sm-12 control-label">Invisible products to the buyer</label>
      <div class="col-sm-12">
        <span class="invisible_product_group invisible-background"> No Group </span>
        <span style="margin-left: 15px;margin-bottom: 15px" class="invisible_product_group_num invisible-background">0</span>
      </div>
    </div>
  </div>
{{footer}}
<script type="text/javascript">
$(document).ready(function() {
  $('#body').summernote({
    height: 300,
    callbacks: {
      onImageUpload: function(files, editor, welEditable) {
        sendFile(this,files[0]);
      }
    }
  });

    document.getElementById('returnEstablishComment').onkeyup = function () {
        document.getElementById('returnEstablishCount').innerHTML = this.value.length;
    }

});

function sendFile(el,file) {
  data = new FormData();
  data.append("file", file);
  $.ajax({
    data: data,
    type: "POST",
    url: "index.php?route=customerpartner/profile/upload",
    cache: false,
    contentType: false,
    processData: false,
    success: function(data) {
      if(data.error){
        alert(data.error);
      }
      if(data.success){
        $(el).summernote('editor.insertImage', data.url);
      }
    }
  });
}
</script>
<style type="text/css">
label.attach-file {
  display: inline-block;
  width: 65px;
  height: 65px;
  background: #F1F1F1;
  border: 1px dashed #DDD;
  border-radius: 5px;
  text-align: center;
  line-height: 50px;
  overflow: hidden;
  /*background-image: url('');*/
  background-size: cover;
  background-position: center;
  cursor: pointer;
}
.label-right {
  display: inline-block;
  text-align: center;
  vertical-align: top;
  margin: 22px 10px;
  color: #325896;
  font-weight: 600;
}
#body {
  display: none;
}
#attachment {
  margin-left: 70%;
}
#messageinfo,
.left-panel {
  margin-top: 6%;
}
.communication > li {
  float: left;
  height: 40px;
  line-height: 37px;
  text-align: center;
  cursor: pointer;
  font-weight: 600;
  color: #434a54;
}
.communication > li.active {
  border-bottom: 0;
  background: none;
  line-height: 33px;
  cursor: pointer;

}
.inbox {
  border-top: 3px solid #337ab7;
}
.sent {
  border-top: 3px solid #F1BB52;
}
.trash {
  border-top: 3px solid #D9534F;
}
.drafts {
  border-top: 3px solid #58C7AB;
}
.nav-tabs > li > a {
  margin-right: 0;
  border: 1px solid #bbb;
  border-radius: 0;
}
.communication li.active .badge {
  background-color: #3bafda;
}
#message .badge-default {
  padding: 6px 12px;
  border: 1px dashed #888F99;
  line-height: 12px;
  margin-right: 2px;
}
/*#message .badge {*/
  /*background-color: none;*/
/*}*/
.remove-file {
  margin-left: 10px;
  position: absolute;
  display: none;
}
.tab_space {
  margin-left: 13px;
  margin-right: 13px;
}
.spinner {
  font-size: 60px;
  margin-left: 39%;
  margin-top: 15%;
}

</style>
<script type="text/javascript">
var storeName = '{{ storeName }}';
var active = "inbox";
let is_default_buyer_group = '{{ is_default_buyer_group }}';
$('#addFile').unbind('click').bind('click',function(){
  var maxNum = {{max}};
  if($('.attach-file').length>=maxNum){
    alert("{{ error_max_file_num }}" + maxNum);
    return;
  }
  var html='<label class="attach-file pointer attach"  style="margin-left: 5px; margin-right: 5px;"><i class="fa fa-upload"></i><input type="file" name="file[]"  class="files" style="display:none"  onchange="validate_fileupload(this);"><i class="fa fa-times remove-file pointer"></i></label>';
  $(this).prev().append(html);
});

$(document.body).on('click', '.remove-file', function(event) {
  event.preventDefault();
  $(this).parent().remove();
});
$(document.body).on('mouseenter','.attach-file',function(){
  $(this).find('.remove-file').css("display","inline-block");
});
$(document.body).on('mouseleave','.attach-file',function(){
  $(this).find('.remove-file').css("display","none");
});

function validate_fileupload(_this) {
  if(!validate(_this)){
      $(_this).parent().replaceWith('<label class="attach-file pointer attach"  style="margin-left: 5px; margin-right: 5px;"><i class="fa fa-upload"></i><input type="file" name="file[]"  class="files" style="display:none"  onchange="validate_fileupload(this);"><i class="fa fa-times remove-file pointer"></i></label>');
    return false;
  }else {
    var getImagePath = URL.createObjectURL(_this.files[0]);
    var file_extension = _this.value.split('.').pop();
    $(_this).parent().css('background-image', 'url(' + getImagePath + ')');
    $(_this).parent().find('.ex').remove();
    $(_this).parent().append('<span class="ex">' + file_extension + '</span>');
    return true;
  }
}
function validate(_this){
  if(!_this.value){
    return false;
  }
  var maxSize ={{size}};
  var allowed_extensions ={{ extension|json_encode() }};
  if (_this.type != 'file') {
    alert("{{ error_only_support_file_type }}" + allowed_extensions.join(','));
    return false;
  }
  var fileName = _this.value;
  var file_extension = fileName.split('.').pop();
  if (!allowed_extensions.includes(file_extension)) {
    alert("{{ error_only_support_file_type }}" + allowed_extensions.join(','));
    return false;
  }

  if ( _this.files[0].size > maxSize * 1024) {
    alert("{{ error_max_file_size }}{{ size_mb }}");
    return false;
  }
  return true;
}

if (is_default_buyer_group) {
    $("#input_buyer_group").val(is_default_buyer_group);
    change_invisible_display();
}
$("#input_buyer_group").change(function () {
    change_invisible_display();
});

function change_invisible_display() {
    if ($("#input_buyer_group").val() == 0) {
        $(".invisible_product_group").hide();
        $(".invisible_product_group_num").hide();
        return;
    }else{
        $(".invisible_product_group").show();
        $(".invisible_product_group_num").show();
    }
    let option_selected = $("#input_buyer_group option:selected");
    let product_group = option_selected.data('product_group');
    let product_group_num = option_selected.data('product_group_num');
    $(".invisible_product_group").text(product_group?product_group:' -- None -- ');
    if (product_group_num < 1) {
        $(".invisible_product_group_num").hide();
    } else {
        $(".invisible_product_group_num").show().text('+' + product_group_num);
    }
}

</script>
<style>
  .msg-dot {
    position: relative;
    display: inline-block;
    font-size: 12px;
    text-align: center;
    background-color: #FF5722;
    color: #fff;
    width: 6px;
    height: 6px;
    padding: 0;
    border-radius: 50%;
    /*position: absolute;*/
    top: -5px;
    margin: -7px 3px 0;
  }
  .read_all{
    margin-left: 5px;
    width: 20%;
    font-size: 15px
  }
  .invisible-background {
    color: #4476a7;
    background-color: #eaf0f7;
    padding: 3px 5px;
  }
</style>
</div>