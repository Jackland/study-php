{#已弃用#}
<script type="text/javascript" src="catalog/view/javascript/bootstrap/js/bootstrap-paginator.min.js"></script>
<script src="catalog/view/javascript/jquery/magnific/jquery.magnific-popup.min.js" type="text/javascript"></script>
<link href="catalog/view/javascript/jquery/magnific/magnific-popup.css" type="text/css" rel="stylesheet"/>
<style>
  .quick-filter{
    text-align: center;
    margin-bottom: 30px;
  }
  .quick-title{
    display: inline-block;
    height: 45px;
    line-height: 45px;
    padding: 0 30px;
  }
  .my-border-right{
    border-right: 1px solid #aaa;
  }
  .wait-number{
    font-style: normal;
    font-weight: bolder;
  }
  .quick-title.active {
    background: #F3F5F7;
    color: #183464;
  }
  .quick-title.active .wait-number{
    color: #FA6400;
  }
  .quick-title:hover{
    cursor: pointer;
    background: #F3F5F7;
    color: #183464;
  }
  .quick-title:hover .wait-number{
    color: #FA6400;
  }
  .mr4{
    margin-right: 4px;
  }
  .layui-layer-dialog .layui-layer-content{
    word-break: break-word;
  }
  .success{
    display: flex;
    align-items: center;
    justify-content: left;
    padding: 8px 30px;
    text-align: left;
  }
  .success i{
    color: #2e9b01;
    font-size: 36px;
    margin-right: 10px;
  }
  .page-seller-portal table.table.main .action-group a{
    margin-right: 0;
  }
  .margin-hot-map{
    width: 24%;
  }
</style>
<div role="tabpanel" class="tab-pane active" id="futures-bid">
  <div class="bg-white p-2">
    <div class="filter-wrapper form-wrapper mt-3 mb-3">
      <div class="row">
        <div class="col-sm-4">
          <div class="form-group">
            <label class="control-label" for="input_futures_agreement_no">{{ column_agreement_no }}</label>
            <input type="number" name="filter_futures_agreement_no" value="{{ agreement_no }}"
                   placeholder="Agreement ID " id="input_futures_agreement_no" class="form-control"/>
          </div>
          <div class="form-group">
            <label class="control-label" for="input_futures_item_code">{{ column_item_code }}</label>
            <input type="text" name="filter_futures_item_code" value="{{ sku }}" placeholder="Item Code"
                   id="input_futures_item_code" class="form-control"/>
          </div>
        </div>
        <div class="col-sm-4">
          <div class="form-group">
            <label class="control-label" for="input_futures_agreement_status">{{ column_agreement_status }}</label>
            <select name="filter_futures_agreement_status" id="input_futures_agreement_status" class="form-control"
                    onchange="selectStatus()" {% if delivery_status > 0 %} disabled {% endif %}>
              <option value="0">--- {{ __('请选择', {}, 'common') }} ---</option>
              {% for k,v in agreement_status_list %}
              <option value="{{ k }}" {% if k == agreement_status %} selected {% endif %}> {{ v.name }} </option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label class="control-label" for="input_futures_store">{{ column_store }}</label>
            <input type="text" name="filter_futures_store" value="{{ store_name }}" placeholder="Store"
                   id="input_futures_store" class="form-control"/>
          </div>
        </div>
        <div class="col-sm-4">
          <div class="form-group">
            <label class="control-label" for="input_futures_delivery_status">{{ column_delivery_status }}</label>
            <select name="filter_futures_delivery_status" id="input_futures_delivery_status" class="form-control"
                    onchange="selectStatus()" {% if agreement_status in [1,2,3,4,5,6,8] %} disabled {% endif %}>
              <option value="0">--- {{ __('请选择', {}, 'common') }} ---</option>
              {% for k,v in delivery_status_list %}
                <option value="{{ k }}" {% if k == delivery_status %} selected {% endif %}> {{ v.name }} </option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="">{{ column_date_from_to }}</label>
            <div class="datetimepicker-range">
              <div class="datetimepicker">
                <input type="text" name="filter_futures_date_from" value="{{ date_from}}" placeholder="Pick a date..."
                       id="input_futures_date_from" class="form-control"/>
                <span class="title">From</span>
                <span class="icon"><i class="giga icon-date-icon"></i></span>
              </div>
              <div class="datetimepicker">
                <input type="text" name="filter_futures_date_to" value="{{ date_to}}" placeholder="Pick a date..."
                       id="input_futures_date_to" class="form-control"/>
                <span class="title">To</span>
                <span class="icon"><i class="giga icon-date-icon"></i></span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-sm-12">
          <div class="form-group pull-right" style="margin-bottom: 0">
            <div>
              <a onclick="filterFutures(this);" class="btn btn-primary" data-toggle="tooltip"
                 title="Filter" id="quote_futures_filter_btn">{{ button_filter }} </a>
              <a onclick="cleanFilterFutures(this);" class="btn btn-default"
                 data-toggle="tooltip" title="Reset">Reset</a>
              <button type="button" onclick="downloadList()" class="btn btn-default" data-toggle="tooltip" title="Download"><i class="fa fa-download"></i></button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="quick-filter">
      <div class="row" style="text-align: center;">
        <div class="margin-hot-map  {% if 1 == status %} active {% endif %}"  onclick="filterFutures('', 1)">
          <div class="hot-map-status">{{ text_to_be_processed }}<i class="giga icon-V10-wenhaotishi" data-toggle="tooltip" data-html='true' title="<div style='word-wrap:normal'>{{ tip_text_to_be_processed_buyer }}</div>"></i></div>
          <div class="hot-map-num">{{ to_be_processed_count }}</div>
        </div>
        <div class="margin-hot-map {% if 2 == status %} active {% endif %}" onclick="filterFutures('', 2)">
          <div class="hot-map-status">{{text_to_be_delivered}}<i class="giga icon-V10-wenhaotishi" data-toggle="tooltip" data-html='true' title="<div style='word-wrap:normal'>{{tip_text_to_be_delivered}}</div>"></i></div>
          <div class="hot-map-num">{{ to_be_delivered_count }}</div>
        </div>
        <div class="margin-hot-map {% if 3 == status %} active {% endif %}" onclick="filterFutures('', 3)">
          <div class="hot-map-status">{{text_for_the_delivery}}<i class="giga icon-V10-wenhaotishi" data-toggle="tooltip" data-html='true' title="<div style='word-wrap:normal'>{{tip_text_for_the_delivery}}</div>"></i></div>
          <div class="hot-map-num">{{ for_the_delivery_count }}</div>
        </div>
        <div class="margin-hot-map {% if 4 == status %} active {% endif %}" onclick="filterFutures('', 4)">
          <div class="hot-map-status">{{text_to_be_paid}}<i class="giga icon-V10-wenhaotishi" data-toggle="tooltip" data-html='true' title="<div style='word-wrap:normal'>{{tip_text_to_be_paid}}</div>"></i></div>
          <div class="hot-map-num">{{ to_be_paid_count }}</div>
        </div>
      </div>
    </div>
    <form action="{{ action }}" method="post" enctype="multipart/form-data" id="form-futures">
      <div class="table-responsive">
        <table class="table main table-hover">
          <thead>
          <tr>
            <th class="text-center">{{ column_agreement_no }}</th>
            <th class="text-center">{{ column_store }}</th>
            <th class="text-center">{{ column_item_code }}</th>
            <th class="text-center">{{ column_qty_of_agreement }}</th>
            <th class="text-center">{{ column_unit_price }}</th>
            <th class="text-center">{{ column_amount_of_agreement }}</th>
            <th class="text-center">
              <a onclick="filterFutures('',0,'delivery_date', '{{ order }}')"
                {% if 'delivery_date' == sort %} class="{{ order|lower }}" {% endif %}>
                {{ column_delivery_date }}</a>
              <i class="giga icon-V10-wenhaotishi" data-toggle="tooltip" style="cursor: pointer" title="" data-original-title="{{ tip_delivery_date }}"></i>
            </th>
            <th class="text-center">{{ column_delivery_type }}
              <i class="giga icon-V10-wenhaotishi" data-toggle="tooltip" style="cursor: pointer" title="" data-original-title="{{ tip_delivery_type }}"></i>
            </th>
            <th class="text-center">
              <a onclick="filterFutures('',0,'update_time', '{{ order }}')"
                {% if 'update_time' == sort %} class="{{ order|lower }}" {% endif %}>
                {{ column_last_modified }}</a>
            </th>
            <th class="text-center">{{ column_status }}</th>
            <th class="text-center" style="width: 110px">Action</th>
          </tr>
          </thead>
          <tbody>
          {% if agreement_list %}
          {% for item in agreement_list %}
            <tr>
              <td class="text-center">{{ item.agreement_no }}</td>
              <td class="text-center">{{ item.screenname }}</td>
              <td class="text-right">
                <a href="{{ product_detail_url }}{{ item.product_id }}" target="_blank" class="no-wrap">{{ item.sku }}
                  <i class="giga icon-table-link"></i></a>
              </td>
              <td class="text-center">{{ item.num }}</td>
              <td class="text-center text-price" >{{ item.unit_price_str }}</td>
              <td class="text-center text-price">{{ item.amount_str }}</td>
              <td class="text-center">
                {% if item.delivery_date %}
                {{ item.delivery_date }}
              {% else %}N/A{% endif %}
                {% if item.delivery_status==1  and item.days_tip %}
                  <i class="giga icon-V10-wenhaotishi" data-toggle="tooltip" style="cursor: pointer" title="" data-original-title="{{ item.days_tip }}"></i>
                {% endif %}
              </td>
              <td class="text-center">{{ item.delivery_type_name }}</td>
              <td class="text-center text-price">{{ item.update_time }}</td>
              <td class="text-center" style="color: {{ item.status_color }}">
                {% if 7 == item.delivery_status  %}
                <i class="fa fa-exclamation-circle" data-toggle="tooltip" style="color: sandybrown"></i>
                {% endif %}
                {{ item.status_name }}
              </td>
              <td class="text-right">
                 <div class="action-group">
                   {% if item.add_to_cart %}
                     <a data-toggle="tooltip" title="Add to Cart"
                        data-agreement_id="{{ item.id }}"
                        data-advance_product_id="{{ item.advance_product_id }}"
                        data-product_id="{{ item.product_id }}"
                        data-last_purchase_num="{{ item.last_purchase_num }}"
                        onclick="futuresCartAdd(this, '{{ item.add_to_cart }}', '{{ item.delivery_type }}')"、
                        data-cnzz-event="Bid List|BL_AddtoCart|Future Goods Bids">
                       <i class="giga icon-cart-add"></i>
                     </a>
                   {% endif %}
                   {% if (1 == item.agreement_status or 3 == item.agreement_status) and not item.delivery_status %}
                     <a class="" data-toggle="tooltip" style="cursor: pointer;" data-original-title="Cancel"
                        onclick="cancelAction('{{ item.id }}')">
                       <i class="giga icon-sidebar-clear" style="font-weight: bold"></i>
                     </a>
                   {% endif %}
                   {% if item.agreement_status in [4,6] and not item.delivery_status %}
                     <a href="{{ agreement_detail }}&id={{ item.id }}" target="_blank" class="" data-toggle="tooltip" title="Reapplied">
                       <i class="giga icon-action-refresh-reload"></i>
                     </a>
                   {%  endif %}
                   {% if (item.agreement_status in [4,6] and not item.delivery_status)
                     or (2 == item.delivery_status and not item.ignore) %}
                     <a class="" data-toggle="tooltip" title="Ignore" onclick="ignoreAction('{{ item.id }}')">
                       <i class="giga icon-action-remove"></i>
                     </a>
                   {%  endif %}

                   {% if item.delivery_status in [3,7] %}
                     <a class="" href="{{ agreement_detail }}&id={{ item.id }}" target="_blank" data-toggle="tooltip" title="Select settlement methods" >
                       <i style="font-size: 16px;font-weight: bolder" class="fa fa-hand-pointer-o"></i>
                     </a>
                     <a class="" data-toggle="tooltip" title="Terminate" onclick="terminatedAction('{{ item.id }}')">
                       <i style="font-size: 16px;font-weight: bolder" class="fa fa-ban"></i>
                     </a>
                   {% endif %}

                   <a href="{{ agreement_detail }}&id={{ item.id }}" target="_blank" data-toggle="tooltip" title="View">
                     <i  class="giga icon-action-preview"></i>
                   </a>
                 </div>
              </td>
            </tr>
          {% endfor %}
          {% else %}
          <tr>
            <td colspan="11" class="text-center">{{ text_empty }}</td>
          </tr>
          {% endif %}
          </tbody>
        </table>
      </div>
    </form>
    <div class="row" style="margin-right: 0">
      <div class="col-sm-12 text-right">
        <ul id="bos_pagination_futures"></ul>
      </div>
    </div>
  </div>
</div>
<script>
  $('#input_futures_date_from').datetimepicker({
    pickDate: true,
    pickTime: false,
    format: 'YYYY-MM-DD 00:00:00'
  });
  $('#input_futures_date_to').datetimepicker({
    pickDate: true,
    pickTime: false,
    format: 'YYYY-MM-DD 23:59:59'
  });

  var to_be_processed_count = '{{ to_be_processed_count }}';
  var to_be_delivered_count = '{{ to_be_delivered_count }}';
  var to_be_paid_count= '{{ to_be_paid_count }}';
  var due_soon_count = '{{ due_soon_count }}';
  var futures_tab_mark_count = Number(to_be_processed_count) + Number(to_be_delivered_count) + Number(to_be_paid_count) + Number(due_soon_count);

  $(function () {
    block.unBlockUI();
    initFutures();
    if (0 == futures_tab_mark_count){
      $("#futures_tab_mark_count").hide();
    }else {
      $("#futures_tab_mark_count").text(futures_tab_mark_count).show();
    }
  });

  function initFutures() {
    //分页链接
    paginationFutures();
  }

  function paginationFutures() {
    if ({{ total_pages }}) {
      //total_pages
      $('#bos_pagination_futures').bootstrapPaginator({
        /*当前使用的是3版本的bootstrap*/
        bootstrapMajorVersion: 3,
        /*配置的字体大小是小号*/
        size: 'normal',
        /*当前页*/
        currentPage: {{ page_num }},
        /*一共多少页*/
        totalPages: {{ total_pages }},
        /*页面上最多显示几个含数字的分页按钮*/
        numberOfPages: 5,
        total: {{ total }},
        rowsOfPage: {{ page_limit | default(15) }},

        onPageClicked: function (event, originalEvent, type, page) {
          block.blockUI();
          let url = getUrlForFutures(page, '{{ status }}');
          $('#bid-futures').load(url);
        }
      });
    }
  }
  //切换热区状态
  $(".quick-title").click(function () {
    $(".quick-title").removeClass('active');
    $(this).addClass("active");
  });

  function selectStatus() {
    var agreement_status = $.trim($("#input_futures_agreement_status").val());
    var delivery_status = $.trim($("#input_futures_delivery_status").val());
    if (agreement_status != 0 && agreement_status != 7 ){
        $("#input_futures_delivery_status").attr("disabled",true)
    }else {
      $("#input_futures_delivery_status").removeAttr("disabled");
    }

    if (delivery_status != 0 ){
      $("#input_futures_agreement_status").attr("disabled",true)
    }else {
      $("#input_futures_agreement_status").removeAttr("disabled");
    }

  }

  {# 页码，快捷搜索状态，是否用于下载，排序项，排序方式#}
  function getUrlForFutures(page,status,download,sort,order) {
    let url = "{{ url('account/product_quotes/futures/tab_futures') }}";
    if (download){
      url = "{{ url('account/product_quotes/futures/downloadAgreementList') }}";
    }

    let filter_futures_agreement_no = $.trim($("#input_futures_agreement_no").val());
    let filter_futures_item_code = $.trim($("#input_futures_item_code").val());
    let filter_futures_agreement_status = $.trim($("#input_futures_agreement_status").val());
    let filter_futures_delivery_status = $.trim($("#input_futures_delivery_status").val());
    let filter_futures_store = $.trim($("#input_futures_store").val());
    let filter_futures_date_from = $.trim($("#input_futures_date_from").val());
    let filter_futures_date_to = $.trim($("#input_futures_date_to").val());

    if( status && status != 0){
      url += "&status="+status;
    }else {

      if( filter_futures_agreement_no ){
        url += "&agreement_no="+encodeURIComponent(filter_futures_agreement_no);
      }
      if( filter_futures_item_code ){
        url += "&item_code="+encodeURIComponent(filter_futures_item_code);
      }
      if( filter_futures_agreement_status ){
        url += "&agreement_status="+encodeURIComponent(filter_futures_agreement_status);
      }
      if( filter_futures_delivery_status ){
        url += "&delivery_status="+encodeURIComponent(filter_futures_delivery_status);
      }
      if( filter_futures_store ){
        url += "&store_name="+encodeURIComponent(filter_futures_store);
      }
      if( filter_futures_date_from ){
        url += "&date_from="+encodeURIComponent(filter_futures_date_from);
      }
      if( filter_futures_date_to ){
        url += "&date_to="+encodeURIComponent(filter_futures_date_to);
      }
      if( sort ){
          url += "&sort="+encodeURIComponent(sort);
          if (order == 'DESC'){
              order = 'ASC';
          }else {
            order = 'DESC';
          }
          url += "&order=" + order;
      }
    }

    if (page) {
      url += "&page_num=" + page;
    }
    return url;
  }

  function filterFutures(button, status, sort, order) {
    block.blockUI();
    var url = getUrlForFutures(1,status,0,sort, order);
    $('#bid-futures').load(url);
    $(button).button('loading');
  }

  function cleanFilterFutures(button) {
    $("#input_futures_agreement_no").val("");
    $("#input_futures_item_code").val("");
    $("#input_futures_agreement_status").val(0);
    $("#input_futures_delivery_status").val(0);
    $("#input_futures_store").val("");
    $("#input_futures_date_from").val("");
    $("#input_futures_date_to").val("");

    block.blockUI();
    var url = getUrlForFutures();
    $('#bid-futures').load(url);
    $(button).button('loading');
  }

  function downloadList() {
    let url = getUrlForFutures(1, '{{ status }}', true);

    location.href = url;
  }

  //取消
  function cancelAction(id){
    var tmplayer = layer.confirm('{{ tip_cancel }}',{
      title: 'Message',
      btn: ['Yes','No'],
      skin: 'yzc_layer' //样式类名
      , closeBtn: 0
    }, function () {

      $.ajax({
        url: "{{ url('account/product_quotes/futures/cancelAgreement') }}",
        type: 'post',
        data: {agreement_id:id},
        dataType: 'json',
        success: function(json) {
          layer.close(tmplayer);
          var msgDiv='<div class="success"><i class="giga icon-complete"></i>'+ json['msg'] +'<div>';

          if (json['code']) {
            layer.msg(msgDiv,{
              offset:'rt',
              skin: 'yzc_layer'
            });

          }else {
            msgDiv='<div class="failed"><i class="giga icon-complete"></i>'+ json['msg'] +'<div>';
            layer.msg(msgDiv,{
              offset:'rt',
              skin: 'yzc_layer'
            });
          }

          var url = getUrlForFutures();
          $('#bid-futures').load(url);
        }
      });
    }, function () {
      layer.close(tmplayer);
    });
  }

  //忽略
  function ignoreAction(id){
    var tmplayer = layer.confirm('{{ tip_ignore }}',{
      title: 'Message',
      btn: ['Yes','No'],
      skin: 'yzc_layer' //样式类名
      , closeBtn: 0
    }, function () {

      $.ajax({
        url: "{{ url('account/product_quotes/futures/ignoreAgreement') }}",
        type: 'post',
        data: {agreement_id:id},
        dataType: 'json',
        success: function(json) {
          layer.close(tmplayer);
          var msgDiv='<div class="success"><i class="giga icon-complete"></i>'+ json['msg'] +'<div>';
          if (json['code']) {
            layer.msg(msgDiv,{
              offset:'rt',
              skin: 'yzc_layer'
            });

          }else {
            msgDiv='<div class="failed"><i class="giga icon-complete"></i>'+ json['msg'] +'<div>';
            layer.msg(msgDiv,{
              offset:'rt',
              skin: 'yzc_layer'
            });
          }

          var url = getUrlForFutures();
          $('#bid-futures').load(url);
        }
      });
    }, function () {
      layer.close(tmplayer);
    });
  }

  //拒绝履约
  function terminatedAction(id){
    var tmplayer = layer.confirm('{{ tip_terminated }}',{
      title: 'Message',
      btn: ['Yes','No'],
      skin: 'yzc_layer' //样式类名
      , closeBtn: 0
    }, function () {

      $.ajax({
        url: "{{ url('account/product_quotes/futures/terminated') }}",
        type: 'post',
        data: {agreement_id:id},
        dataType: 'json',
        success: function(json) {
          layer.close(tmplayer);
          var msgDiv='<div class="success"><i class="giga icon-complete"></i>'+ json['msg'] +'<div>';
          if (json['code']) {
            layer.msg(msgDiv,{
              offset:'rt',
              skin: 'yzc_layer'
            });

          }else {
            msgDiv='<div class="failed"><i class="giga icon-complete"></i>'+ json['msg'] +'<div>';
            layer.msg(msgDiv,{
              offset:'rt',
              skin: 'yzc_layer'
            });
          }

          var url = getUrlForFutures();
          $('#bid-futures').load(url);
        }
      });
    }, function () {
      layer.close(tmplayer);
    });
  }

  //type:1期货头款，2期货尾款(可能包含现货头款补足款+期货尾款)
  function futuresCartAdd(_this,type,deliveryType) {
    var agreement_id = $(_this).data('agreement_id');
    var advance_product_id = $(_this).data('advance_product_id');
    let product_id = $(_this).data('product_id');
    var advance_quantity = 1;
    let last_purchase_num = $(_this).data('last_purchase_num');

    if (1 == type){
       cartAdd(advance_product_id, advance_quantity, agreement_id, 3);//futures头款
    }else if (2 == type){
      if(2 != deliveryType){
        if (2 != deliveryType && last_purchase_num){
          cartAdd(product_id, last_purchase_num, agreement_id, 3);//futures尾款
        }
        if (1 != deliveryType && advance_product_id){
          cartAdd(advance_product_id, advance_quantity);//margin头款
        }
      }else {//全部转现货
        cartAdd(advance_product_id, advance_quantity);//margin头款
      }
    }
  }


  //加入购物车
  function cartAdd(product_id, quantity, agreement_id,transaction_type) {

    quantity = typeof(quantity) != 'undefined' ? quantity : 1;
    let transaction = '';
    if (agreement_id && transaction_type){
      transaction = agreement_id +'_'+transaction_type;
    }
    $.ajax({
      url: 'index.php?route=checkout/cart/add',
      type: 'post',
      data: 'product_id=' + product_id + '&quantity=' + quantity + '&transaction_type=' + transaction,
      dataType: 'json',
      success: function(json) {
        $('.alert-dismissible, .text-danger').remove();
        $('.form-group').removeClass('has-error');
        if (json['error']) {
          var errMsg;
          if (json['error']['recurring']) {
            errMsg = json['error']['recurring'];
          }else if (json['error']['transaction_type']) {
            errMsg = json['error']['transaction_type'];
          }
          layer.alert(errMsg, {
            title: 'Message',
            btn : 'OK',
            skin: 'yzc_layer', //样式类名
            closeBtn: 0
          });
        }
        if (json['success']) {
          $('#menu-wrapper').after('<div class="alert alert-success alert-dismissible container"><i class="fa fa-check-circle"></i> ' + json['success'] + ' <button type="button" class="close" data-dismiss="alert">&times;</button></div>');
          $('html, body').animate({scrollTop: 0}, 'slow');
          $('#cart').load('index.php?route=common/cart/info');
        }
      },
      error: function(xhr, ajaxOptions, thrownError) {
        layer.alert(thrownError + "<br>" + xhr.statusText + "<br>" + xhr.responseText, {
          title: 'Message',
          btn: 'OK',
          skin: 'yzc_layer' //样式类名
          , closeBtn: 0
        });
      },
      complete:function(){
      }
    });
  }
</script>