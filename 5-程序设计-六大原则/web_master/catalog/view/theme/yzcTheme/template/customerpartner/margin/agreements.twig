{# {{cssOrigin(['/catalog/view/javascript/bootstrap-select18/bootstrap-select.min.css','/catalog/view/javascript/jquery/datetimepicker/bootstrap-datetimepicker.min.css']) }} #}
{{ js(['js/common/orisComponents.js']) }}
<link rel="stylesheet" type="text/css" href="catalog/view/javascript/bootstrap-select18/bootstrap-select.min.css">
<link rel="stylesheet" type="text/css" href="catalog/view/javascript/jquery/datetimepicker/bootstrap-datetimepicker.min.css">
<div>
  <div>
    <div class="oris-row">
            <div class="oris-col-3">
              <label class="text-weight-normal" for="margin_input-id">{{ column_agreement_id }} </label>
                <input type="text" name="margin_filter_id" value="{{ search.filter_agreement_no }}" placeholder="{{ __('Please Input') }}" id="margin_input-id" class="oris-input" autocomplete="off" />
            </div>
            <div class="oris-col-3 oris-select">
                <label class="text-weight-normal" for="margin_input-status">{{ __('Agreement Status') }} </label>
                <select name="margin_filter_status" class="selectpicker" id="input_margin_status">
                  <option value="">--- {{ __('请选择', {}, 'common') }} ---</option>
                  {% if marginStatusList %}
                    {% for item in marginStatusList %}
                      <option value="{{ item.margin_agreement_status_id }}"  {% if item.margin_agreement_status_id ==search.filter_status  %}selected{% endif %} >{{ item.name }}</option>
                    {% endfor %}
                  {% endif %}
                </select>
            </div>
            <div class="oris-col-3">
                <label class="text-weight-normal" for="margin_input_buyer_name">{{ column_buyer_name }} </label>
                <input type="text" name="margin_filter_buyer_name" value="{{ search.filter_buyer_name }}"
                       placeholder="{{ __('Please Input') }}" id="margin_input_buyer_name" class="oris-input" autocomplete="off"/>
            </div>
            <div class="oris-col-3">
                <label class="text-weight-normal" for="margin_input-sku_mpn">{{ column_sku_mpn }} </label>
                <input type="text" name="margin_filter_sku_mpn" value="{{ search.filter_sku_mpn }}"
                       placeholder="{{ __('Please Input') }}" id="margin_input-sku_mpn" class="oris-input" autocomplete="off"/>
            </div>
    </div>
    <div class="oris-row p14-tb flex-fend">
            <div class="oris-col-3">
                <label class="text-weight-normal" for="margin_input-date_from">{{ __('Margin Validity') }}</label>
                <div class="oris-ingroup action-clear">
                  <input type="text" name="margin_filter_date_from" id="margin_input-date_from" class="oris-input"
                         value="{{ search.filter_date_from }}" placeholder="{{ __('From') }}" autocomplete="off" readonly/>
                  <i class="giga icon-v10quxiao-01 oris-clear"></i>
                  <span class="oris-ingroup-date">
                    <i class="fa fa-calendar"></i>
                  </span>
                </div>
            </div>
            <div class="oris-col-3">
                <div class="oris-ingroup action-clear">
                  <input type="text" name="margin_filter_date_to" id="margin_input-date_to" class="oris-input"
                         value="{{ search.filter_date_to }}" placeholder="{{ __('To') }}" autocomplete="off" readonly/>
                  <i class="giga icon-v10quxiao-01 oris-clear"></i>
                  <span class="oris-ingroup-date">
                    <i class="fa fa-calendar"></i>
                  </span>
                </div>
            </div>
            <div class="oris-col-3 search-btn">
                {# filter #}
                <button onclick="filterSellerMargin(this);" class="oris-button oris-button-bigger width80" data-toggle="tooltip"
                   title="{{ btn_filter }}" id="margin-filter-btn">
                  {{ btn_filter }} </button>
                {# download #}
                <button type="button" onclick="downloadMarginBid()" class="oris-button oris-button-default" data-toggle="tooltip" title="Download">
                  <i class="giga icon-xiazai1"></i>
                </button>
            </div>
    </div>
  </div>
  <input id="filter_margin_hot_map" name="filter_margin_hot_map" type="hidden" value="{{ search.filter_margin_hot_map }}">
  <div class="oris-tabs" id="margin-stat">
      <div class="oris-tab-pane {% if search.filter_margin_hot_map == '' %} oris-pane-active{% endif %}" onclick="doSearchMargin(this, 'all')" data-hot_map_type="all">{{__('All')}}</div>
      <div class="oris-tab-pane {% if search.filter_margin_hot_map == 'to_be_processed' %} oris-pane-active{% endif %}" onclick="doSearchMargin(this, 'to_be_processed')">
        <span data-toggle="tooltip" data-original-title="{{ __('Waiting to be reviewed.') }}">
          {{__('To be processed')}}<span class="oris-tab-num">{{ statAgreementIds['to_be_processed']|length }}</span>
        </span>
      </div>
      <div class="oris-tab-pane {% if search.filter_margin_hot_map == 'margin_deposit_to_be_paid' %} oris-pane-active{% endif %}" onclick="doSearchMargin(this, 'margin_deposit_to_be_paid')">
        <span data-toggle="tooltip" data-original-title="{{ __('Waiting for Margin Deposit payment.') }}">
          {{__('Margin deposit to be paid')}}<span class="oris-tab-num">{{ statAgreementIds['margin_deposit_to_be_paid']|length }}</span>
        </span>
      </div>
      <div class="oris-tab-pane {% if search.filter_margin_hot_map == 'due_payment_to_paid' %} oris-pane-active{% endif %}" onclick="doSearchMargin(this, 'due_payment_to_paid')">
        <span data-toggle="tooltip" data-original-title="{{ __('Buyer needs to pay the amount due for the agreement.') }}">
          {{__('Due payment to be paid')}}<span class="oris-tab-num">{{ statAgreementIds['due_payment_to_paid']|length }}</span>
        </span>
      </div>
      <div class="oris-tab-pane {% if search.filter_margin_hot_map == 'to_be_expired' %} oris-pane-active{% endif %}" onclick="doSearchMargin(this, 'to_be_expired')" data-hot_map_type="due_soon">
        <span data-toggle="tooltip" data-original-title="{{ __('The agreement is due in 7days.') }}">
          {{__('To be expired')}}<span class="oris-tab-num">{{ statAgreementIds['to_be_expired']|length }}</span>
        </span>
      </div>
  </div>
  <div class="overflow-visible">
    <table class="oris-table">
      <thead>
      <tr>
        <th class="text-left oris-w130">
          {{ column_agreement_id }}
        </th>
        <th class="text-left p12-l oris-w180">{{ column_buyer_name }} </th>
        <th class="text-left oris-w200">{{ column_item_code }}&nbsp;/&nbsp;{{ column_mpn }}</th>
        <th class="oris-w90">{{ __('Agreed Days') }} </th>
        <th class="oris-w180 pointer" onclick="columnSortMargin('{{ sort.createUrl('effect_time', sort.getAttributeSortDirection('effect_time') == 'desc' ? 'asc' : 'desc') }}')">{{__('Margin Validity')}}
              <span class="sort-order {{ sort.getAttributeSortDirection('effect_time') == 'desc' ? ' desc-active' : '' }} {{ sort.getAttributeSortDirection('effect_time') == 'asc' ? ' asc-active' : '' }}"></span>
        </th>
        <th class="oris-w180">{{ __('Purchased QTY / Total QTY') }} </th>
        <th class="text-left oris-w100">{{ __('Agreement Status') }}</th>
        <th class="text-left oris-w100 pointer" onclick="columnSortMargin('{{ sort.createUrl('last_modified', sort.getAttributeSortDirection('last_modified') == 'desc' ? 'asc' : 'desc') }}')">{{ __('Last Modified') }}
            <span class="sort-order {{ sort.getAttributeSortDirection('last_modified') == 'desc' ? ' desc-active' : '' }} {{ sort.getAttributeSortDirection('last_modified') == 'asc' ? ' asc-active' : '' }}"></span>
        </th>
        <th class="text-left oris-w90">{{ __('Actions') }}</th>
      </tr>
      </thead>
      <tbody>
      {% if agreements|length > 0 %}
        {% for agreement in agreements %}
          <tr>
            <td class="text-left pos-rela">
              {{ agreement.agreement_id }}
              {% if agreement.futureDelivery.margin_agreement_id %}
                </br><a class="oris-mark-futures" href="{{ url('account/product_quotes/futures/sellerBidDetail', {id: agreement.futureDelivery.agreement_id }) }}"
                   target="_blank" data-toggle="tooltip" data-placement="bottom" data-original-title="{{ __('This Margin Agreement has been transferred from a Future Goods Agreement. Click to view the original Future Goods Agreement') }}">F</a>
              {% endif %}
              {% if agreement.status == 6 and agreement.is_can_performer_audit %}
              {#  有共同履约人  需要Seller审批 #}
                <i class="giga giga icon-seller_jiahaoyou icon-partner"></i>
              {% endif %}
            </td>
            <td class="text-left oris-popover">
              <div class="action-userinfo pointer d-inline" data-user_customer_id="{{ agreement.buyer_id }}" data-toggle="popover" data-placement="top" data-content="" data-html="true"  data-trigger="manual" data-container="body">
                  <span class="name-color max-line1" title="{{ agreement.nickname }}">{{ agreement.nickname }}</span>
                  <span>{{ agreement.user_number }}</span>
                  {% if agreement.is_home_pickup %}
                    <span class="account-type atype-wc">{{__('Will Call')}}</span>
                  {% else %}
                    <span class="account-type atype-ds">{{__('Drop Shipping')}}</span>
                  {% endif %}
                </div>
              {{ agreement.ex_vat }}
            </td>
            <td class="text-left">
              <a class="oris-link image-td"  target="_blank" href="{{ url('product/product', {product_id: agreement.product_id}) }}">
                    <img class="pro-image" src="{{ agreement.product_info.image }}"/>
                    <div>
                        <span class="tags-image">
                          <text class="max-line1" title="{{ agreement.product_info.sku }}">{{ agreement.product_info.sku }}</text>{{ agreement.product_info.tags|join('') }}</span>
                        <span class="max-line2" title="{{ agreement.product_info.mpn }}">{{ agreement.product_info.mpn }}</span>
                    </div>
              </a>
            </td>
            <td>
              {{ agreement.day }}
              {% if agreement.days_left.is_show and agreement.days_left.days <= agreement.day %}
                <br><span style="color: red; text-transform: none">{{ agreement.days_left.days }} {{ agreement.days_left.days > 1 ? 'days left' : 'day left' }}</span>
              {% endif %}
            </td>
            <td>
              {% if agreement.effect_time and agreement.expire_time %}
                {{ agreement.effect_time|formatZone(country,null,'Y-m-d') ~ '&nbsp;-&nbsp;' ~ agreement.expire_time|formatZone(country,null,'Y-m-d') }}
              {% else %}
              --
              {% endif %}
            </td>
            <td>
                <span class="link-color">{{ agreement.sell_qty }}</span>&nbsp;/&nbsp;{{ agreement.num }}
            </td>
            <td class="text-left">
              <span style="color: {{ agreement.marginStatus.color }}" class="text-bold">{{ agreement.marginStatus.name }}</span>
              {#                倒计时#}
              {% if agreement.count_down.is_show %}
                </br>
                <span data-toggle="tooltip" data-original-title="{{ text_count_down }}" style="color: {{ result.status_color }}" data-id="{{ agreement.agreement_id }}" id="timer{{ agreement.agreement_id }}" data-min="{{ agreement.count_down.minute }}" data-second="{{ agreement.count_down.second }}" class="count-time-flag text-danger">
                  <i class="giga icon-naozhong"></i>
                  <i name="minute">{{ agreement.count_down.minute }}</i>:<i name="second">{{ agreement.count_down.second }}</i></span>
              {% endif %}
          </td>
            <td class="text-left">{{ agreement.update_time }} </td>
            <td class="text-left">
              <a href="{{ url('account/product_quotes/margin_contract/view', {agreement_id: agreement.agreement_id}) }}" target="_blank" class="btn-text">
                <i class="giga icon-V10_chakan" data-toggle="tooltip" title="View"></i>
              </a>
              {% if agreement.is_can_performer_audit %}
                <a onclick="marginPerformerContract('{{ agreement.performer_apply_id }}','{{ agreement.id }}','{{ agreement.agreement_id }}','{{ url('account/product_quotes/margin_contract/auditPerformerRequest') }}',this)" class="btn-text">
                  <i class="giga icon-V10_xianhuobaozhengjin-quchuli-01" data-toggle="tooltip" data-html='true' title="<div style='word-wrap:normal'>{{ __('Approval of Partner') }}</div>"></i>
                </a>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      {% else %}
        <tr class="no-records">
            <td colspan="9">{{ text_no_results }}</td>
        </tr>
      {% endif %}
      </tbody>
    </table>
  </div>
  <div class="oris-row oris-pagination">
    <ul id="seller_margin_pagination"></ul>
  </div>
</div>

<style>
  .margin-hot-map{
    width: 20%;
    border-right: 1px solid #e1e1e1;
    display: inline-block;
    text-align: center;
    padding: 10px 0;
  }
  .margin-hot-map:last-child{
    border: 0;
  }
  .margin-hot-map.active, .margin-hot-map:hover{
    background-color: #1834640c;
  }
  .margin-hot-map:hover{
    cursor: pointer;
  }
  .margin-hot-map:hover .hot-map-status{
    color: #183464;
  }
  .margin-hot-map:hover .hot-map-num{
    color: #FA6400;
  }
  .hot-map-status{
    font-weight: bold;
    font-size: 14px;
    padding: 6px 0;
    color: #677999;
  }
  .margin-hot-map.active .hot-map-status{
    color: #183464;
  }
  .giga.icon-help-inactive{
    color: #b620e0;
  }
  .hot-map-num{
    font-size: 16px;
  }
  .margin-hot-map.active .hot-map-num{
    font-weight: bold;
    color: #FA6400;
  }
  .table tbody tr td .btn-group-outer .btn{
    border: 1px solid #eee;
    line-height: 30px;
    padding: 0;
    background-color: #f3f5f7;
    /*box-shadow: none;*/
    /*margin-right: 5px;*/
    box-shadow: 1px 1px 4px #b5b5b5;
  }
  .table tbody tr td .btn-group-outer .btn:hover{
    background-color: #fa6400;
    border: 1px solid #fa6400;
  }
  .table tbody tr td .btn-group-outer .btn i{
    font-size: 14px !important;
  }
  textarea.modalMarginReason:focus{
    outline: none;
  }
  .a-link:hover{
    text-decoration: underline;
  }
  .icon-partner,
  .icon-partner:before,
  .icon-partner:after {
    position: absolute;
    top: 0;
    left: 0;
    color: #FF6600;
  }
  .icon-partner:before {
    content: '';
    border-top: 30px solid #FFEFE4;
    border-right: 38px solid transparent;
  }
  .icon-partner:after {
    font-family: 'giga';
    content: "\e715";
    left: 2px;
  }
  .popover-content p {
    margin: 0 4px 10px 4px !important;
  }
  .popover-content p:last-child {
    max-width: 420px;
    word-break: normal;
    margin-bottom: 0;
  }
  .popover-content p span {
    font-weight: normal !important;
  }
  table td i.icon-naozhong {
    position: relative;
    top: 1px;
  }
  .oris-ingroup .oris-clear {
    right: 40px;
  }
</style>

<script src="catalog/view/javascript/jquery/datetimepicker/bootstrap-datetimepicker.min.js" type="text/javascript"></script>
<script type="text/javascript" src="catalog/view/javascript/bootstrap-select18/bootstrap-select.min.js"></script>
<script type="text/javascript">
  $(function () {
    let margin_tab_mark_count = Number({{ stat_total }});
    if (margin_tab_mark_count > 0) {
      $("#margin_tab_mark_count").text(margin_tab_mark_count > 99 ? ' 99+' : ' '+margin_tab_mark_count).show();
    } else {
      $("#margin_tab_mark_count").text(margin_tab_mark_count).hide();
    }
  })

  $('#margin_input-date_from').datetimepicker({
    pickDate: true,
    pickTime: false,
    format: 'YYYY-MM-DD 00:00:00'
  });
  $('#margin_input-date_to').datetimepicker({
    pickDate: true,
    pickTime: false,
    format: 'YYYY-MM-DD 23:59:59'
  });
  $('#input_margin_status').selectpicker();
  var timerIDArr=new Array();
  $(function () {
    margin_pagination();
    block.unBlockUI();
    $('#margin-filter-btn').button('reset');
    // 倒计时
    let countTimeArr=$(".count-time-flag");
    let countTimeInitArr=[];
    countTimeArr.each((i,item)=>{
      let min=Number($(item).attr("data-min"));
      let second=Number($(item).attr("data-second"));
      let totalTime=min*60+second;
      let currentOrderId=$(item).attr("data-id");
      countTimeInitArr.push({
        "currentOrderId":currentOrderId,
        "totalTime":totalTime
      })
    })
    for ( let i = 0; i < countTimeInitArr.length; i++ ) {
      (function (i) {
        let obj = 'timer' + countTimeInitArr[i].currentOrderId;
        countDown( i,countTimeInitArr[i].totalTime,function( msg ) {
          let currentMinutes=msg.split(":")[0];
          let currentSeconds=msg.split(":")[1];
          if(currentMinutes<10){
            currentMinutes="0"+currentMinutes
          }
          if(currentSeconds<10){
            currentSeconds="0"+currentSeconds
          }
          $("#"+obj).find("i[name='minute']").html(currentMinutes);
          $("#"+obj).find("i[name='second']").html(currentSeconds);
        })
      })(i)
    }
    //倒计时
  });

  function columnSortMargin(url) {
    if (url.length < 1) {
      return false;
    }
    clearTimer();
    block.blockUI();
    $('#bid-margin').load(url, 'page_limit={{ paginator.getPageSize() }}');
  }

  function downloadMarginBid() {
    window.location.href = '{{ url('account/product_quotes/margin_contract/margin_download') }}' + getFilter();
  }

  function margin_pagination() {
    $('#seller_margin_pagination').bootstrapPaginator({
      /*当前使用的是3版本的bootstrap*/
      bootstrapMajorVersion: 3,
      /*配置的字体大小是小号*/
      size: 'normal',
      /*当前页*/
      currentPage: {{ paginator.getPage() }},
      /*一共多少页*/
      totalPages: {{ max(paginator.getPageCount(), 1) }},
      /*页面上最多显示几个含数字的分页按钮*/
      numberOfPages: 5,
      pageRange: [10, 20, 30, 50, 100],
      rowsOfPage: {{ paginator.getPageSize() }},
      total: {{ paginator.getTotalCount() }},
      onPageClicked: function (event, originalEvent, type, page) {
        clearTimer();
        block.blockUI();
        $('#bid-margin').load('{{ paginator.getUrlWithNoPage() }}&page=' + page);
      }
    });
  }

  function getFilter() {
    let url = '';
    let filter_id = $('input[name=\'margin_filter_id\']').val();
    if (filter_id) {
      url += '&filter_agreement_no=' + encodeURIComponent(filter_id);
    }

    let filter_buyer_name = $('input[name=\'margin_filter_buyer_name\']').val();
    if (filter_buyer_name) {
      url += '&filter_buyer_name=' + encodeURIComponent(filter_buyer_name);
    }

    let filter_sku_mpn = $('input[name=\'margin_filter_sku_mpn\']').val();
    if (filter_sku_mpn) {
      url += '&filter_sku_mpn=' + encodeURIComponent(filter_sku_mpn);
    }

    let filter_status = $('select[name=\'margin_filter_status\']').val();
    if (filter_status != '') {
      url += '&filter_status=' + encodeURIComponent(filter_status);
    }

    let filter_date_from = $('input[name=\'margin_filter_date_from\']').val();
    if (filter_date_from) {
      url += '&filter_date_from=' + encodeURIComponent(filter_date_from);
    }

    let filter_date_to = $('input[name=\'margin_filter_date_to\']').val();
    if (filter_date_to) {
      url += '&filter_date_to=' + encodeURIComponent(filter_date_to);
    }

    //热区
    let filter_hot_map=$("#filter_margin_hot_map").val();
    if(filter_hot_map){
      url += '&filter_margin_hot_map=' + encodeURIComponent(filter_hot_map);
    }

    return url;
  }

  function filterSellerMargin(button) {
    clearTimer();
    block.blockUI();

    let url = '{{ url('account/product_quotes/margin_contract') }}' + getFilter();

    $('#bid-margin').load(url, 'page_limit={{ paginator.getPageSize() }}');
    $(button).button('loading');
  }

  function doSearchMargin(dom, _condition) {
    $('#margin-stat').find('.oris-pane-active').removeClass('oris-pane-active');

    $("#filter_margin_hot_map").val(_condition);
    $(dom).addClass('oris-pane-active');

    filterSellerMargin($('#margin-filter-btn'));
  }

  //审批共同履约人弹窗---START
  var lock_margin_performer_id=0;//阻止重复提交
  function marginPerformerContract(performerApplyId,marginId,agreementId,url,obj) {
    if (lock_margin_performer_id == performerApplyId) {
      return false;
    }
    lock_margin_performer_id = performerApplyId;

    var content =
      '<div style="text-align: left;">' +
      '<div> Buyer has submitted an Add a Partner request for Agreement ID ' + agreementId + '. Please approve or deny.</div>' +
      '</div>';
    let sendData = {};
    sendData.performer_apply_id = performerApplyId;
    sendData.margin_id = marginId;
    layer.confirm(content, {
      title: 'Confirm',
      skin: 'oris-layer',
      btn: ['Approve', 'Deny'],
      area: ['480px'],
      scrollbar: false
      ,cancel:function(index, layero){
        lock_margin_performer_id = 0;
      }
    }, function (lay_index) {
      layer.closeAll();
      sendData.process = 1;
      doPerformer(sendData, url,obj);
    }, function (lay_index) {
      layer.closeAll();
      sendData.process = 2;
      doPerformer(sendData, url,obj);
    });
  }

  function doPerformer(sendData,url,obj) {
    $.ajax({
      url: url,
      type: 'post',
      data: sendData,
      dataType: 'json',
      beforeSend: function () {
        block.blockUI();
      },
      success: function (json) {
        lock_margin_performer_id = 0;
        block.unBlockUI();
        if (json['code'] == 200) {
          $.toast({
            heading: false,
            text: json['msg'],
            position: 'top-center',
            showHideTransition: 'fade',
            icon: 'success',
            hideAfter: 3000,
            allowToastClose: false,
            loader: false,
            afterHidden: function () {
              block.blockUI();
              $('#bid-margin').load('{{ paginator.getUrlWithNoPage() }}&page=' + '{{ paginator.getPage() }}', 'page_limit={{ paginator.getPageSize() }}');
            }
          });
        } else {
          $.toast({
            heading: false,
            text: json['msg'],
            position: 'top-center',
            showHideTransition: 'fade',
            icon: 'error',
            hideAfter: 3000,
            allowToastClose: false,
            loader: false,
          });
        }
      },
      complete: function (XMLHttpRequest, textStatus) {
        block.unBlockUI();
      }
    });
  }
  //审批共同履约人弹窗---END

  // 倒计时
  function countDown( i,maxtime,fn ) {
    let timer = setInterval(function() {
      if( !!maxtime ){
        var day = Math.floor(maxtime / 86400),
          hour = Math.floor((maxtime % 86400) / 3600),
          minutes = Math.floor((maxtime % 3600) / 60),
          seconds = Math.floor(maxtime%60),
          msg = minutes+":"+seconds;
        fn( msg );
        --maxtime;
      } else {
        clearInterval( timer );
        // 处理结束
        fn("0:0");
      }
    }, 1000);
    timerIDArr.push(timer);
  }
  function clearTimer() {
    for(let i=0;i<timerIDArr.length;i++){
      clearInterval(timerIDArr[i]);
    }
    timerIDArr.splice(0, timerIDArr.length)
  }
</script>