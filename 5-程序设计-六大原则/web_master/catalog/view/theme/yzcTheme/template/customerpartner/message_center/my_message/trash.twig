{% trans_default_category 'catalog/view/customerpartner/message_center/my_message/trash' %}

{{ this.title('Trash') }}
{{ this.params('breadcrumbs', [
  {
    text: 'Message Center',
    href: 'javascript:void(0)',
  },
  {
    text: 'My Messages',
    href: 'javascript:void(0)',
  },
  'current'
]) }}

{{
this.params('pageTitle', {
  show: true,
  title: 'My Messages',
  backUrl: '',
  buttons: []
})
}}

{{ css([
  'css/common/common-ext.css',
  'static/message/message-common.css',
  'static/customerpartner/message_center/my-message-common.css'
]) }}

<link rel="stylesheet" type="text/css" href="catalog/view/javascript/bootstrap-select18/bootstrap-select.min.css">
<link rel="stylesheet" type="text/css" href="catalog/view/javascript/jquery/datetimepicker/bootstrap-datetimepicker.min.css">
<script type="text/javascript" src="/catalog/view/javascript/bootstrap/js/bootstrap-paginator.min.js"></script>
<script type="text/javascript" src="catalog/view/javascript/layer/layer.js"></script>

<div id="page-trash" class="msgcent-mymessage msgcent">
  {{ message_column }}
  <div id="table_content" class="mymessage-content pt-16">
    <div>
      <div id="message">
        <div class="tab-content">
          <div class="tab-pane active">
            <div class="form-wrapper" >
              <div class="oris-row msgb-search-row">
                <div class="oris-col-3 mymessage-col">
                  <label class="control-label mymessage-label" for="input-name">Subject</label>
                  <input type="text" name="filter_subject" value="{{ search.filter_subject }}"
                         placeholder="Enter subject" id="filter_subject" class="form-control oris-input"/>
                </div>

                <div class="oris-col-3 mymessage-col">
                  <label class="msgcent mymessage-label">Post Time</label>
                  <div class="oris-ingroup action-clear">
                    <input type="text" name="trash_creation_time" readonly class="oris-input" id="trash_creation_time"
                          placeholder="From ~ To"/>
                    <i class="giga icon-v10quxiao-01 oris-clear" data-action-range="1"></i>
                  </div>
                </div>

                <div class="oris-col-3 mymessage-col search-btn">
                  <button onclick="filterTrash()" class="oris-button mymessage-a-btn oris-button-bigger width80" style="margin-top:24px">
                    <a style="text-transform:capitalize">Filter</a>
                  </button>
                  <button type="button" onclick="reset()" class="oris-button oris-button-default oris-button-bigger msg-w80">Reset</button>
               
                </div>
              </div>

              <div class="oris-row msgcent msg-markas__row mymessage-markas__row">
                <button class="oris-button oirs-button-default msgcent msg-search__btn" onclick="recovery();return false;" disabled>Restore</button>
              </div>
            </div>
            <div class="table-responsive msgcent msg-table__container" style="margin-top: 20px">
              <table class="table oris-table oris-table-minicheck" id="input" style="table-layout: fixed">
                <thead>
                <tr>
                  <td class="oris-w42 text-center"><input type="checkbox" style="margin: 0" name="all_select" onclick="$('input[name*=\'selected\']').prop('checked', this.checked);"/>
                  </td>
                  <td colspan="6" class="text-left pl-24">Subject</td>
                  <td class="text-left" style="width: 150px">From / To</td>
                  <td class="text-left" style="width: 150px">Post Time</td>
                  <td class="text-left" style="width: 100px">Action</td>
                </tr>
                </thead>
                <tbody>
                {% if list %}
                  {% for message in list %}
                    <tr>
                      <td class="oris-w42 text-center" style="padding-left: 14px;">
                        <input type="checkbox" name="selected[]" style="margin: 0" value="{{ message.type }},{{ message.primary_key_id }}"/>
                      </td>
                      <td colspan="6" class="text-left col-sm-6 pl-24" style="word-break: break-all">
                        {% if message.make_sure_status and message.p_make_sure_status != 1 %}
                          {#102075需要确认且没有确认的显示#}
                          <i class='giga icon-suoding' style="font: normal normal normal 13px/1 FontAwesome;color: #FB873A" data-toggle="tooltip" title="Confirm you have fully read and agree to the above Marketplace notification. Click to view details." ></i>
                        {% endif %}
                        <a href="{{ message.detail_url }}" {% if message.is_read %} class="read" {% else %} class="no-read" {% endif %}>
                          <span class="msg-subject-tdspan msg-clickable" title="{{ message.title }}">{{ message.title }}</span>
                        </a></td>
                      <td class="text-left">{{ message.customer_name }}</td>
                      <td class="text-left">{{ message.post_time }}</td>
                      <td class="text-left">
                        <button class="oris-button recovery-td-btn" style="width: 30px;height: 30px;line-height: 30px;text-align: center;padding: 0;"
                                onclick="recovery('{{ message.type }},{{ message.primary_key_id }}')"><i class='giga icon-huifu-011' style="font-size: 14px"></i></button>
                      </td>
                    </tr>
                  {% endfor %}
                    </tbody>
                  </table>
                {% else %}
                    </tbody>
                  </table>
                  <div class="msg-empty">
                    <div class="msg-empty-container">
                      <div class="msg-empty-icon">
                        <img src="{{ asset("image/icons/empty.png") }}"></img>
                      </div>
                      <div class="msg-empty-title">No Records Found !</div>
                    </div>
                  </div>
                {% endif %}
            </div>
            {# <div class="row" style="display: flex;align-items: center;justify-content: center;"id="padding20">
              <div class="table-bottom-action my-height" style="width: 18%">
                <div class="bottom-action-left">
                  <i class="giga icon-tables-selected-rows-action"></i>
                  <a data-toggle="tooltip" data-original-title="Restore" class="btn btn-submit" style="margin-left: 5px;font-weight: unset;border: unset" onclick="recovery();return false;">
                    <i style="display: block" class="giga icon-shifangdingdan"></i>
                  </a>
                  <span class="bottom-action-detail" style="color:#3A75DC" data-title="Selected"></span>
                </div>
              </div>
              <div class="text-right my-height" style="width: 82%;display: flex;justify-content: flex-end">
                <ul id="trash_pagination" class="pagination">
                  <!--里面什么都不用写-->
                </ul>
              </div>
            </div> #}
            <div class="oris-row oris-pagination">
              <ul id="trash_pagination"></ul>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script src="catalog/view/javascript/jquery/datetimepicker/bootstrap-datetimepicker.min.js" type="text/javascript"></script>
<script type="text/javascript" src="catalog/view/javascript/bootstrap-select18/bootstrap-select.min.js"></script>

<script>
  //分页
  $('#trash_pagination').bootstrapPaginator({
    /*当前使用的是3版本的bootstrap*/
    bootstrapMajorVersion: 3,
    /*配置的字体大小是小号*/
    size: 'normal',
    /*当前页*/
    currentPage: {{ paginator.getPage() }},
    /*一共多少页*/
    totalPages: {{ max(paginator.getPageCount(), 1) }},
    /*页面上最多显示几个含数字的分页按钮*/
    numberOfPages: 5,
    pageRange: [10, 20, 30, 50, 100],
    total: {{ paginator.getTotalCount() }},
    rowsOfPage: {{ paginator.getPageSize() }},
    onPageClicked: function (event, originalEvent, type, page) {
      filterTrash(page,  originalEvent['page_info'] || {});
    }
  });

  $('#trash_date_from').datetimepicker({
    pickDate: true,
    pickTime: false,
    format: 'YYYY-MM-DD'
  });
  $('#trash_date_to').datetimepicker({
    pickDate: true,
    pickTime: false,
    format: 'YYYY-MM-DD'
  });
</script>
<script>
  const dateRangeto = '   To   ';
  $(function(){
    initTimePicker();
  })

  //初始化日期选择控件
  var startDate = moment().subtract(1, 'y').format('YYYY-MM-DD');
  var endDate = moment().format('YYYY-MM-DD');
  var searchStartDateFrom = "{{ search.filter_post_time_from }}";
  var searchStartDateTo = "{{ search.filter_post_time_to }}";
  function initTimePicker() {
    if (searchStartDateFrom && searchStartDateTo) {
      startDate = searchStartDateFrom.substr(0, 10);
      endDate = searchStartDateTo.substr(0, 10);
      // 初始化数据
      $('#trash_creation_time').val(startDate + dateRangeto + endDate)
    }

    $('#trash_creation_time').daterangepicker({
      separator: dateRangeto,
      startDate: startDate,
      endDate: endDate,
      format: 'YYYY-MM-DD'
    }, function (start, end, label) {
      orisComponents.triggerInputClear($('#trash_creation_time'));
    });
  }

  //勾选框控制按钮是否禁用
  $("#page-trash input[name='selected[]'] ,#page-trash input[name='all_select']").on('change', function() {
    var length = $("#page-trash input[name='selected[]']:checked").length;
    if(length <= 0) {
      $(".msg-markas__row button").attr('disabled', true);
      $(".msg-markas__row select").attr('disabled', true);
    } else {
      $(".msg-markas__row button").removeAttr('disabled')
      $(".msg-markas__row select").removeAttr('disabled')
    }
  });

  function reset() {
    var url = "{{ url('customerpartner/message_center/my_message/trash') }}";
    window.location.href = url;
  }

  function filterTrash(page, page_info) {
    var subject = encodeURIComponent($("#filter_subject").val().trim());
    
    let dateArr = $('#trash_creation_time').val().split(dateRangeto);
    let date_from = dateArr[0] ? encodeURIComponent(dateArr[0] + ' 00:00:00') : '';
    let date_to = dateArr[1] ? encodeURIComponent(dateArr[1] + ' 23:59:59') : '';

    var url = "{{ url('customerpartner/message_center/my_message/trash') }}";
    if (subject && subject!='undefined') {
      url += "&filter_subject=" + subject;
    }
    if (date_from) {
      url += "&filter_post_time_from=" + date_from;
    }
    if (date_to) {
      url += "&filter_post_time_to=" + date_to;
    }
    if (page) {
      url += "&page=" + page;
    }
    if (page_info) {
      for (let i in page_info) {
        url += "&" + i + "=" + page_info[i];
      }
    }
    location.href = url;
  }

  $(".recovery-td-btn").tooltip({
    trigger: 'hover',
    animation: true,
    title: 'Restore'
  });

  function recovery(trash_id) {
    var trashIdArray = [];
    if (trash_id) {
      trashIdArray.push(trash_id);
    } else {
      $("input[name='selected[]']:checked").each(
        function () {
          trashIdArray.push($(this).val());
        }
      );
    }

    var length = trashIdArray.length;
    var isSubmit = true;//是否可以提交
    var tip;
    if (length <= 0) {
      tip = "Please select the deleted messages that need to be restored.";
      isSubmit = false;
    } else {
      tip = "Are you sure you would like to restore this deleted message?";
      if (length > 1) {
        tip = "Are you sure you want to restore these deleted messages?";
      }
    }
    layer.confirm(tip, {
        title: 'Confirm',
        skin: 'oris-layer', //样式类名
        btn: ['OK', 'Cancel']
      }, //按钮
      function (index) {
        if (isSubmit) {
          layer.close(index);
          $.ajax({
            url: "{{ url('customerpartner/message_center/message/handleRecover') }}",
            type: 'post',
            data: {'trash_list': trashIdArray},
            dataType: 'json',
            success: function (json) {
              if (json.code == 200) {
                $.toast({
                  heading: false,
                  text: 'Recover successfully',
                  position: 'top-center',
                  showHideTransition: 'fade',
                  icon: 'success',
                  hideAfter: 3000,
                  allowToastClose: false,
                  loader: false,
                  afterHidden: function () {
                    filterTrash();
                  }
                });
              } else {
                $.toast({
                  heading: false,
                  text: 'Please try again later!',
                  position: 'top-center',
                  showHideTransition: 'fade',
                  icon: 'error',
                  hideAfter: 3000,
                  allowToastClose: false,
                  loader: false,
                });
              }
            }
          });
        } else {
          //不提交直接关闭
          layer.close(index);
        }
      });
  }
</script>
<style>
  .recovery-btn{
    color: #3A75DC;
    background-color: #FBFBFB;
    background-repeat: repeat-x;
    border-color: #E3E3E3;
  }
  .recovery-td-btn{
    color: #515151;
    background-color: #EEEEEE;
    background-repeat: repeat-x;
    border-color: #E3E3E3;
  }
</style>
