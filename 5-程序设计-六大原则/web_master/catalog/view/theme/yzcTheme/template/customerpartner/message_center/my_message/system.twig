{% trans_default_category 'catalog/view/customerpartner/message_center/my_message/system' %}

{{ this.title('System Alerts') }}
{{ this.params('breadcrumbs', [
  {
    text: 'Message Center',
    href: 'javascript:void(0)',
  },
  {
    text: 'My Messages',
    href: 'javascript:void(0)',
  },
  'current'
]) }}

{{
this.params('pageTitle', {
  show: true,
  title: 'My Messages',
  backUrl: '',
  buttons: []
})
}}

{{ css([
  'css/common/common-ext.css',
  'static/message/message-common.css',
  'static/customerpartner/message_center/my-message-common.css'
]) }}

<link rel="stylesheet" type="text/css" href="catalog/view/javascript/bootstrap-select18/bootstrap-select.min.css">
<link rel="stylesheet" type="text/css" href="catalog/view/javascript/jquery/datetimepicker/bootstrap-datetimepicker.min.css">
<script type="text/javascript" src="/catalog/view/javascript/bootstrap/js/bootstrap-paginator.min.js"></script>
<script type="text/javascript" src="catalog/view/javascript/layer/layer.js"></script>


<div id="page-system" class="msgcent-mymessage msgcent">
  {{ message_column }}
  <div id="table_content" class="tab-content mymessage-content pt-16" style="{{ table_div_class }}">
    {# 子菜单 #}
    <div class="seller-tabs">
      <ul class="oris-tabs">
        <li class="oris-tab-pane {% if '' == msg_type %} oris-pane-active {% endif %}" >
          <a onclick="tab_toggle('')" id="tab_tab-all" data-toggle="tab">
            All
            {% if unread_types_count['000'] > 99 %}<span class="oris-tab-num">99+</span>
            {% elseif unread_types_count['000'] %}<span class="oris-tab-num">{{ unread_types_count['000'] }}</span>
            {% endif %}
          </a>
        </li>
        <li class="oris-tab-pane {% if '100' == msg_type %} oris-pane-active {% endif %}">
          <a onclick="tab_toggle('100')" id="tab_tab-product" data-toggle="tab">
            Product
            {% if unread_types_count['100'] > 99 %}<span class="oris-tab-num">99+</span>
            {% elseif unread_types_count['100'] %}<span class="oris-tab-num">{{ unread_types_count['100'] }}</span>
            {% endif %}
          </a>
        </li>
        <li class="oris-tab-pane {% if '200' == msg_type %} oris-pane-active {% endif %}">
          <a onclick="tab_toggle('200')" id="tab_tab-rma" data-toggle="tab">
            RMA
            {% if unread_types_count['200'] > 99 %}<span class="oris-tab-num">99+</span>
            {% elseif unread_types_count['200'] %}<span class="oris-tab-num">{{ unread_types_count['200'] }}</span>
            {% endif %}
          </a>
        </li>
        <li class="oris-tab-pane {% if '300' == msg_type %} oris-pane-active {% endif %}">
          <a onclick="tab_toggle('300')" id="tab_tab-bid" data-toggle="tab">
            Bid
            {% if unread_types_count['300'] > 99 %}<span class="oris-tab-num">99+</span>
            {% elseif unread_types_count['300'] %}<span class="oris-tab-num">{{ unread_types_count['300'] }}</span>
            {% endif %}
          </a>
        </li>
        <li class="oris-tab-pane {% if '400' == msg_type %} oris-pane-active {% endif %}">
          <a onclick="tab_toggle('400')" id="tab_tab-order" data-toggle="tab">
            Order
            {% if unread_types_count['400'] > 99 %}<span class="oris-tab-num">99+</span>
            {% elseif unread_types_count['400'] %}<span class="oris-tab-num">{{ unread_types_count['400'] }}</span>
            {% endif %}
          </a>
        </li>
        <li class="oris-tab-pane {% if '600' == msg_type %} oris-pane-active {% endif %}">
          <a onclick="tab_toggle('600')" id="tab_tab-other" data-toggle="tab">
            Invoice
            {% if unread_types_count['600'] > 99 %}<span class="oris-tab-num">99+</span>
            {% elseif unread_types_count['600'] %}<span class="oris-tab-num">{{ unread_types_count['600'] }}</span>
            {% endif %}
          </a>
        </li>
        {% if is_usa_outer_account %}
        <li class="oris-tab-pane {% if '700' == msg_type %} oris-pane-active {% endif %}">
          <a onclick="tab_toggle('700')" id="tab_tab-other" data-toggle="tab">
            Incoming Shipment
            {% if unread_types_count['700'] > 99 %}<span class="oris-tab-num">99+</span>
            {% elseif unread_types_count['700'] %}<span class="oris-tab-num">{{ unread_types_count['700'] }}</span>
            {% endif %}
          </a>
        </li>
        {% endif %}
        <li class="oris-tab-pane {% if '500' == msg_type %} oris-pane-active {% endif %}">
          <a onclick="tab_toggle('500')" id="tab_tab-other" data-toggle="tab">
            Other
            {% if unread_types_count['500'] > 99 %}<span class="oris-tab-num">99+</span>
            {% elseif unread_types_count['500'] %}<span class="oris-tab-num">{{ unread_types_count['500'] }}</span>
            {% endif %}
          </a>
        </li>
      </ul>
    </div>
    {#  面板  #}
    <div>
      <div id="message">
        <div class="tab-pane active">
          <div class="tab-content">
            <div>
              <div class="oris-row msgb-search-row">
                <div class="oris-col-3 mymessage-col">
                  <label class="control-label mymessage-label" for="input-name">Subject</label>
                  <input type="text" name="filter_subject" value="{{ search.filter_subject }}" placeholder="Enter subject" id="filter_subject" class="oris-input"/>
                </div>

                {# <div class="oris-col-3 mymessage-col">
                  <label class="control-label mymessage-label" for="filter_post_time">Creation Time</label>
                  <div class="datetimepicker-range">
                    <div class="oris-ingroup datetimepicker" style="margin-left: unset">
                      <input type="text" name="date_from" id="date_from"
                              class="date oris-input"  data-date-format="YYYY-MM-DD 00:00:00" placeholder="Pick a date..."
                              value="{{ search.filter_post_time_from }}"/>
                      <span class="title">From</span>
                      <span class="oris-ingroup-date">
                        <i class="fa fa-calendar"></i>
                      </span>
                    </div>
                  </div>
                </div>

                <div class="oris-col-3 mymessage-col">
                  <label class="control-label mymessage-label" for="filter_post_time">&nbsp;</label>
                  <div class="datetimepicker-range">
                    <div class="oris-ingroup datetimepicker">
                      <input type="text" name="date_to" id="date_to"
                              class="date oris-input" data-date-format="YYYY-MM-DD 23:59:59" placeholder="Pick a date..."
                              value="{{ search.filter_post_time_to }}"/>
                      <span class="title">To</span>
                      <span class="oris-ingroup-date">
                        <i class="fa fa-calendar"></i>
                      </span>
                    </div>
                  </div>
                </div> #}

                <div class="oris-col-3 mymessage-col">
                  <label class="msgcent mymessage-label">Post Time</label>
                  <div class="oris-ingroup action-clear">
                    <input type="text" name="system_creation_time" readonly class="oris-input" id="system_creation_time"
                          placeholder="From ~ To"/>
                    <i class="giga icon-v10quxiao-01 oris-clear" data-action-range="1"></i>
                  </div>
                </div>

                {% if '' == msg_type %}
                  <div class="oris-col-3 mymessage-col oris-select">
                    <label class="control-label mymessage-label">Type</label>
                    <select name="msg_type2" id="msg_type2" class="form-control">
                      <option value="">All</option>
                      <option value="100" {% if '100' == search.filter_msg_type %}selected{% endif %} > Product</option>
                      <option value="200" {% if '200' == search.filter_msg_type %}selected{% endif %} > RMA</option>
                      <option value="300" {% if '300' == search.filter_msg_type %}selected{% endif %} > BID</option>
                      <option value="400" {% if '400' == search.filter_msg_type %}selected{% endif %} > Order</option>
                      <option value="600" {% if '600' == search.filter_msg_type %}selected{% endif %} > Invoice</option>
                      {% if is_usa_outer_account %}
                      <option value="700" {% if '700' == search.filter_msg_type %}selected{% endif %} > Incoming Shipment</option>
                      {% endif %}
                      <option value="500" {% if '500' == search.filter_msg_type %}selected{% endif %} > Other</option>
                    </select>
                  </div>
                {% elseif '300' == msg_type %}
                  <div class="oris-col-3 mymessage-col oris-select">
                    <label class="control-label mymessage-label">Type</label>
                    <select name="msg_type3" id="msg_type3" class="form-control">
                      <option value="">All</option>
                      <option value="300" {% if '300' == search.filter_msg_type %}selected{% endif %} > Spot Price</option>
                      <option value="301" {% if '301' == search.filter_msg_type %}selected{% endif %} > Rebates</option>
                      <option value="302" {% if '302' == search.filter_msg_type %}selected{% endif %} > Margin</option>
                      <option value="303" {% if '303' == search.filter_msg_type %}selected{% endif %} > Futures</option>
                    </select>
                  </div>
                {% endif %}

                <div class="oris-col-3 mymessage-col oris-select">
                  <label class="control-label mymessage-label">Status</label>
                  <select name="filter_status" id="filter_status" class="selectpicker" style="display: inline-flex">
                    <option value="">All</option>
                    <option value="0" {% if '0' == search.filter_read_status %}selected{% endif %} > Unread</option>
                    <option value="1" {% if '1' == search.filter_read_status %}selected{% endif %} > Read</option>
                  </select>
                </div>

                <div class="oris-col-3 mymessage-col oris-select">
                  <label class="control-label mymessage-label">Marked</label>
                  <select name="filter_marked" id="filter_marked" class="selectpicker">
                    <option value="">All</option>
                    <option value="0" {% if '0' == search.filter_mark_status %}selected{% endif %} >
                      <i class="fa fa-star"></i> Unmarked
                    </option>
                    <option value="1" {% if '1' == search.filter_mark_status %}selected{% endif %} >
                      <i class="fa fa-star-o" style="color: yellow"></i> Marked
                    </option>
                  </select>
                </div>

                <div class="oris-col-3 mymessage-col search-btn">
                  <button onclick="filterMessage('{{ msg_type }}');" class="oris-button mymessage-a-btn oris-button-bigger width80" style="margin-top:24px">
                    <a data-toggle="tooltip" id="quote_filter_btn">Filter</a>
                  </button>
                  <button type="button" onclick="reset('{{ msg_type }}')" class="oris-button oris-button-default oris-button-bigger msg-w80">Reset</button>
                </div>
              </div>

              <div class="oris-row msgcent msg-markas__row mymessage-markas__row">
                <button class="oris-button oirs-button-default msgcent msg-search__btn" onclick="confirm_multiple_delete();return false;" disabled>Delete</button>
                <div class="oris-select msgcent msg-markas__select">
                  <select name="action_setup" id="action_setup" class="selectpicker" style="display: inline-flex" onchange="confirm_multiple()" title="Mark As" disabled>
                    <option value="1"
                      {% if msg_type=='' %}
                        data-cnzz-event-extra="Message Center|MS_fromsystem_setup_type|Unread"
                      {% else %}
                        data-cnzz-event-extra="Message Center|MS_fromsystem_kind_setup_type|Unread"
                      {% endif %}
                    > Unread</option>
                    <option value="2"
                      {% if msg_type=='' %}
                        data-cnzz-event-extra="Message Center|MS_fromsystem_setup_type|Read"
                      {% else %}
                        data-cnzz-event-extra="Message Center|MS_fromsystem_kind_setup_type|Read"
                      {% endif %}
                    > Read</option>
                    <option value="3"
                      {% if msg_type=='' %}
                        data-cnzz-event-extra="Message Center|MS_fromsystem_setup_type|Unmarked"
                      {% else %}
                        data-cnzz-event-extra="Message Center|MS_fromsystem_kind_setup_type|Unmarked"
                      {% endif %}
                    > Unmarked</option>
                    <option value="4"
                      {% if msg_type=='' %}
                        data-cnzz-event-extra="Message Center|MS_fromsystem_setup_type|Marked"
                      {% else %}
                        data-cnzz-event-extra="Message Center|MS_fromsystem_kind_setup_type|Marked"
                      {% endif %}
                    > Marked</option>
                  </select>
                </div>
              </div>

            </div>
          </div>

          <form  method="post" enctype="multipart/form-data" id="form-template" style="margin-top: 20px">
            <div class="table-responsive msgcent msg-table__container" id="input">
              <table class="oris-table oris-table-minicheck">
                <thead>
                <tr>
                  <th class="oris-w42 text-center">
                    <input type="checkbox" name="all_select" style="margin: 0" onclick="$('input[name*=\'selected\']').prop('checked', this.checked);"/>
                  </th>
                  <th class="text-left">Subject</th>
                  {% if '' == msg_type or msg_type == '300' %}
                    <th class="text-left">Type</th>
                  {% endif %}
                  <th class="text-left">Sender</th>
                  <th class="text-center">Marked</th>
                  <th class="text-left">Post Time</th>
                </tr>
                </thead>
                <tbody>
                {% if list %}
                  {% for message in list %}
                    <tr class="{{ message.is_read == 1 ? '' : ' msg-table__row-unanswered ' }}">
                      <td class="oris-w42 text-center">
                        <input type="checkbox" name="selected[]" style="margin: 0;" onclick="inputChecked()" value="{{ message.id }}"/>
                      </td>
                      <td class="text-left col-sm-6 pl-24" style="word-break: break-all">
                        {% if message.is_read %}
                          {# <i class="gcl gclxinfengxinjian" style="color: #ddd"></i> #}
                          <a href="{{ url('customerpartner/message_center/message/detail', {msg_id: message.msg_id}) }}" class="read"
                            {% if msg_type=='' %}
                              data-cnzz-event="Message Center|MS_fromsystem_viewdetail"
                            {% else %}
                              data-cnzz-event="Message Center|MS_fromsystem_kind_viewdetail"
                            {% endif %}
                          ><span class="msg-subject-tdspan msg-clickable" title="{{ message.subject }}">{{ message.subject }}</span></a>
                        {% else %}
                          {# <i class="gcl gclxinfeng" style="color: red"></i> #}
                          <a href="{{ url('customerpartner/message_center/message/detail', {msg_id: message.msg_id}) }}" class="no-read"
                            {% if msg_type=='' %}
                              data-cnzz-event="Message Center|MS_fromsystem_viewdetail"
                            {% else %}
                              data-cnzz-event="Message Center|MS_fromsystem_kind_viewdetail"
                            {% endif %}
                          ><span class="msg-subject-tdspan msg-clickable" title="{{ message.subject }}">{{ message.subject }}</span></a>
                        {% endif %}
                      </td>
                      {% if '' == msg_type or msg_type == '300' %}
                        <td class="text-left">
                          {% if msg_type == '' %}
                            {{ message.msg_type_main_name }}
                          {% elseif msg_type == '300' %}
                            {{ message.msg_type_name }}
                          {% endif %}
                        </td>
                      {% endif %}
                      <td class="text-left">
                        System
                      </td>
                      <td class="text-center">
                        <a onclick="marked(this, {{ message.id }})" style="color: #888"
                          {% if msg_type=='' %}
                            {% if message.is_marked %}
                              data-cnzz-event="Message Center|MS_fromsystem_unmarked"
                            {% else %}
                              data-cnzz-event="Message Center|MS_fromsystem_marked"
                            {% endif %}
                          {% else %}
                            {% if message.is_marked %}
                              data-cnzz-event="Message Center|MS_fromsystem_kind_unmarked"
                            {% else %}
                              data-cnzz-event="Message Center|MS_fromsystem_kind_marked"
                            {% endif %}
                          {% endif %}
                        >
                          {% if message.is_marked %}
                            <i class="fa fa-star msg-markicon__active" id="marked_{{ message.id }}" style="color: #f3ab09d1" data="{{ message.is_marked }}"></i>
                          {% else %}
                            <i class="fa fa-star-o msg-markicon__default" id="marked_{{ message.id }}" data="{{ message.is_marked }}"></i>
                          {% endif %}
                        </a>
                      </td>
                      <td class="text-left">
                        {{ message.post_time }}
                      </td>
                    </tr>

                  {% endfor %}
                  </tbody>
                </table>
                {% else %}
                    </tbody>
                  </table>
                  <div class="msg-empty">
                    <div class="msg-empty-container">
                      <div class="msg-empty-icon">
                        <img src="{{ asset("image/icons/empty.png") }}"></img>
                      </div>
                      <div class="msg-empty-title">No Records Found !</div>
                    </div>
                  </div>
                {% endif %}
            </div>
          </form>
          {#  分页  #}
          <div class="oris-row oris-pagination">
            <ul id="bos_pagination"></ul>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<script src="catalog/view/javascript/jquery/datetimepicker/bootstrap-datetimepicker.min.js" type="text/javascript"></script>
<script type="text/javascript" src="catalog/view/javascript/bootstrap-select18/bootstrap-select.min.js"></script>

<script type="text/javascript">
  const dateRangeto = '   To   ';
  $(function(){
    //初始化下拉选择框
    $("#msg_type2").selectpicker();
    $("#msg_type3").selectpicker();
    $("#filter_status").selectpicker();
    $("#filter_marked").selectpicker();
    $("#action_setup").selectpicker();

    initTimePicker();
  })

  //勾选框控制按钮是否禁用
  $("#page-system input[name='selected[]'] ,#page-system input[name='all_select']").on('change', function() {
    var length = $("#page-system input[name='selected[]']:checked").length;
    if(length <= 0) {
      $(".msg-markas__row button").attr('disabled', true);
      $(".msg-markas__row select").attr('disabled', true);
    } else {
      $(".msg-markas__row button").removeAttr('disabled')
      $(".msg-markas__row select").removeAttr('disabled')
    }
    $("#action_setup").selectpicker('refresh');
  });

  //初始化日期选择控件
  var startDate = moment().subtract(1, 'y').format('YYYY-MM-DD');
  var endDate = moment().format('YYYY-MM-DD');
  var searchStartDateFrom = "{{ search.filter_post_time_from }}";
  var searchStartDateTo = "{{ search.filter_post_time_to }}";
  function initTimePicker() {
    if (searchStartDateFrom && searchStartDateTo) {
      startDate = searchStartDateFrom.substr(0, 10);
      endDate = searchStartDateTo.substr(0, 10);
      // 初始化数据
      $('#system_creation_time').val(startDate + dateRangeto + endDate)
    }

    $('#system_creation_time').daterangepicker({
      separator: dateRangeto,
      startDate: startDate,
      endDate: endDate,
      format: 'YYYY-MM-DD'
    }, function (start, end, label) {
      orisComponents.triggerInputClear($('#system_creation_time'));
    });
  }

  function reset(types) {
    var url = "{{ url('customerpartner/message_center/my_message/system') }}&msg_type=" + types;  
    window.location.href = url;
  }

  var msg_type = "{{ msg_type }}";
  function filterMessage(msg_type, page, page_info) {
    var subject = encodeURIComponent($("#filter_subject").val().trim());

    let dateArr = $('#system_creation_time').val().split(dateRangeto);
    let date_from = dateArr[0] ? encodeURIComponent(dateArr[0] + ' 00:00:00') : '';
    let date_to = dateArr[1] ? encodeURIComponent(dateArr[1] + ' 23:59:59') : '';

    //var date_from = $("#date_from").val();
    //var date_to = $("#date_to").val();
    var status = $("#filter_status").val();
    var marked = $("#filter_marked").val();
    var msg_type2 = $("#msg_type2").val();
    var msg_type3 = $("#msg_type3").val();

    var url = "{{ url('customerpartner/message_center/my_message/system') }}&msg_type=" + msg_type;
    if (msg_type3  != undefined) {
      url += "&filter_msg_type=" + msg_type3;
    } else if (msg_type2 != undefined) {
      url += "&filter_msg_type=" + msg_type2;
    } else {
      url += "&filter_msg_type=" + msg_type;
    }

    if (subject) {
      url += "&filter_subject=" + subject;
    }
    if (date_from) {
      url += "&filter_post_time_from=" + date_from;
    }
    if (date_to) {
      url += "&filter_post_time_to=" + date_to;
    }
    if (status != '' && status != undefined) {
      url += "&filter_read_status=" + status;
    }
    if (marked != '' && marked != undefined) {
      url += "&filter_mark_status=" + marked;
    }
    if (page) {
      url += "&page=" + page;
    }
    if (page_info) {
      for (let i in page_info) {
        url += "&" + i + "=" + page_info[i];
      }
    }

    location.href = url;
  }

  function tab_toggle(msg_type) {
    window.location = "{{ url('customerpartner/message_center/my_message/system') }}&msg_type=" + msg_type;
  }

  //分页
  $('#bos_pagination').bootstrapPaginator({
    /*当前使用的是3版本的bootstrap*/
    bootstrapMajorVersion: 3,
    /*配置的字体大小是小号*/
    size: 'normal',
    /*当前页*/
    currentPage: {{ paginator.getPage() }},
    /*一共多少页*/
    totalPages: {{ max(paginator.getPageCount(), 1) }},
    /*页面上最多显示几个含数字的分页按钮*/
    numberOfPages: 5,
    pageRange: [10, 20, 30, 50, 100],
    total: {{ paginator.getTotalCount()  }},
    rowsOfPage: {{ paginator.getPageSize() }},
    onPageClicked: function (event, originalEvent, type, page) {
      let page_info = originalEvent['page_info'] || {};
      filterMessage('{{ msg_type }}', page, page_info);
    }
  });

  function marked(domEle, message_id) {

    var is_marked = $("#marked_" + message_id).attr('data');
    var param = {tab_type: 'inbox', ids: message_id, is_marked: is_marked == 0 ? 1 : 0};
    $.ajax({
      url: '{{ url('customerpartner/message_center/message/handleMarked') }}',
      type: 'post',
      data: param,
      dataType: 'json',
      success: function (json) {
        if (json.code == 200) {
          if (0 == is_marked) {
            $("#marked_" + message_id).attr('data', 1).attr('class', 'fa fa-star msg-markicon__active').attr('style', 'color: #f3ab09d1');
            if (msg_type == "") {
              $(domEle).attr("data-cnzz-event", "Message Center|MS_fromsystem_unmarked");
            } else {
              $(domEle).attr("data-cnzz-event", "Message Center|MS_fromsystem_kind_unmarked");
            }
          } else {
            $("#marked_" + message_id).attr('data', 0).attr('class', 'fa fa-star-o msg-markicon__default').attr('style', 'color: none');
            if (msg_type == "") {
              $(domEle).attr("data-cnzz-event", "Message Center|MS_fromsystem_marked");
            } else {
              $(domEle).attr("data-cnzz-event", "Message Center|MS_fromsystem_kind_marked");
            }
          }

        } else {
          $.toast({
            heading: false,
            text: 'Please try again later',
            position: 'top-center',
            showHideTransition: 'fade',
            icon: 'error',
            hideAfter: 3000,
            allowToastClose: false,
            loader: false,
          });
        }
      }
    });

  }


  $('#date_from').datetimepicker({
    pickDate: true,
    pickTime: false,
    format: 'YYYY-MM-DD'
  });
  $('#date_to').datetimepicker({
    pickDate: true,
    pickTime: false,
    format: 'YYYY-MM-DD'
  });

  function confirm_multiple_delete() {
    var length = $("input[name='selected[]']:checked").length;
    if (length <= 0) {
      layer.alert('Please select at least one message.', {
        title: 'Message',
        btn : 'OK',
        skin: 'oris-layer', //样式类名
        closeBtn: 0
      });
    } else {

      var ids = '';
      $("input[name='selected[]']:checked").each(function () {
        ids += Number($(this).val()) + ',';
      });

      var tip = "Are you sure you want to delete these messages?";
      layer.confirm(tip, {
          title: 'Message',
          skin: 'oris-layer', //样式类名
          btn: ['Yes', 'No']
        }, //按钮
        function (index) {
          layer.close(index);
          $.ajax({
            url: "{{ url('customerpartner/message_center/message/handleDeleted') }}",
            type: 'post',
            data: {tab_type: 'inbox', ids:ids, delete_status: 1},
            dataType: 'json',
            success: function (json) {
              if (json.code == 200) {
                $.toast({
                  heading: false,
                  text: 'Delete successfully.',
                  position: 'top-center',
                  showHideTransition: 'fade',
                  icon: 'success',
                  hideAfter: 3000,
                  allowToastClose: false,
                  loader: false,
                  afterHidden: function () {
                    //window.location.reload();
                    filterMessage('{{msg_type}}');
                  }
                });
              } else {
                $.toast({
                  heading: false,
                  text: 'Please try again later!',
                  position: 'top-center',
                  showHideTransition: 'fade',
                  icon: 'error',
                  hideAfter: 3000,
                  allowToastClose: false,
                  loader: false,
                });
              }
            }
          });
        });
    }
  }

  function batchRead(param) {
    $.ajax({
      url: "{{ url('customerpartner/message_center/message/handleRead') }}",
      type: 'post',
      data: param,
      dataType: 'json',
      success: function (json) {
        if (json.code == 200) {
          $.toast({
            heading: false,
            text: param.is_read == 1 ? 'Read successfully' : 'Unread successfully',
            position: 'top-center',
            showHideTransition: 'fade',
            icon: 'success',
            hideAfter: 3000,
            allowToastClose: false,
            loader: false,
            afterHidden: function () {
              filterMessage('{{msg_type}}');
            }
          });
        } else {
          $.toast({
            heading: false,
            text: 'Please try again later!',
            position: 'top-center',
            showHideTransition: 'fade',
            icon: 'error',
            hideAfter: 3000,
            allowToastClose: false,
            loader: false,
          });
        }
      }
    });
  }

  function batchMarked(param) {
    $.ajax({
      url: "{{ url('customerpartner/message_center/message/handleMarked') }}",
      type: 'post',
      data: param,
      dataType: 'json',
      success: function (json) {
        if (json.code == 200) {
          $.toast({
            heading: false,
            text: param.is_marked == 1 ? 'Marked successfully' : 'Unmarked successfully',
            position: 'top-center',
            showHideTransition: 'fade',
            icon: 'success',
            hideAfter: 3000,
            allowToastClose: false,
            loader: false,
            afterHidden: function () {
              filterMessage('{{msg_type}}');
            }
          });
        } else {
          $.toast({
            heading: false,
            text: 'Please try again later!',
            position: 'top-center',
            showHideTransition: 'fade',
            icon: 'error',
            hideAfter: 3000,
            allowToastClose: false,
            loader: false,
          });
        }
      }
    });
  }

  function setupSuccessMsg(status) {
    switch (status) {
      case '1':
        return 'Unread successfully';
      case '2':
        return 'Read successfully';
      case '3':
        return 'Unmarked successfully';
      case '4':
        return 'Marked successfully';
    }
  }

  function batchSetUpCurrentMsg(setup_type, exclude_ids = '') {
    if (setup_type == 0) {
      return ;
    }
    var subject = encodeURIComponent($("#filter_subject").val());
    var post_date_from = $("#date_from").val();
    var post_date_to = $("#date_to").val();
    var status = $("#filter_status").val();
    var marked = $("#filter_marked").val();
    var msg_type2 = $("#msg_type2").val();
    var msg_type3 = $("#msg_type3").val();

    var url = "{{ url('customerpartner/message_center/message/handleAllData') }}&msg_type=" + msg_type;
    if (msg_type3  != undefined) {
      url += "&filter_msg_type=" + msg_type3;
    } else if (msg_type2 != undefined) {
      url += "&filter_msg_type=" + msg_type2;
    } else {
      url += "&filter_msg_type=" + msg_type;
    }
    if (subject) {
      url += "&filter_subject=" + subject;
    }
    if (post_date_from) {
      url += "&filter_post_time_from=" + post_date_from;
    }
    if (post_date_to) {
      url += "&filter_post_time_to=" + post_date_to;
    }
    if (status != '' && status != undefined) {
      url += "&filter_read_status=" + status;
    }
    if (marked != '' && marked != undefined) {
      url += "&filter_mark_status=" + marked;
    }

    $.ajax({
      url: url,
      type: 'post',
      data: {
        tab_type: 'inbox',
        setup_type: setup_type,
        exclude_ids: exclude_ids,
        user_type: 3,
      },
      dataType: 'json',
      success: function (json) {
        if (json.code == 200) {
          $.toast({
            heading: false,
            text: setupSuccessMsg(setup_type),
            position: 'top-center',
            showHideTransition: 'fade',
            icon: 'success',
            hideAfter: 3000,
            allowToastClose: false,
            loader: false,
            afterHidden: function () {
              filterMessage('{{msg_type}}');
            }
          });
        } else {
          $.toast({
            heading: false,
            text: 'Please try again later!',
            position: 'top-center',
            showHideTransition: 'fade',
            icon: 'error',
            hideAfter: 3000,
            allowToastClose: false,
            loader: false,
          });
        }
      }
    });
  }


  function confirm_multiple() {

    var status = $("#action_setup").val();
    var length = $("input[name='selected[]']:checked").length;

    if (length <= 0) {
      layer.alert('Please select at least one message.', {
        title: 'Message',
        btn : 'OK',
        skin: 'oris-layer', //样式类名
        closeBtn: 0
      });
      $("#action_setup").val('');

    } else {
      let eventInfo = $("#action_setup option:selected").attr('data-cnzz-event-extra');
      let eventArr = (typeof eventInfo =="string") ? eventInfo.split('|') : [];
      if(window.CNZZ && eventArr.length >=2){
        window.CNZZ.triggerEvent(eventArr[0], eventArr[1], eventArr[2]);
      }
      var ids = '';
      $("input[name='selected[]']:checked").each(function () {
        ids += Number($(this).val()) + ',';
      });

      // #6774 中去除去所有用户的全选
      // let is_all_select = $('input[name=all_select]').is(':checked') ? 1 : 0;
      // if (is_all_select) {
      //   batchSetUpCurrentMsg(status)
      //   return;
      // }

      switch (status) {
        case '1':
          batchRead({tab_type: 'inbox', ids: ids, is_read: 0})
          break;
        case '2':
          batchRead({tab_type: 'inbox', ids: ids, is_read: 1})
          break;
        case '3':
          batchMarked({tab_type: 'inbox', ids: ids, is_marked: 0})
          break;
        case '4':
          batchMarked({tab_type: 'inbox', ids: ids, is_marked: 1})
          break;
      }
    }

  }
  function inputChecked() {
    if ($('input[name="selected[]"]').length == $('input[name="selected[]"]:checked').length) {
      $('input[name=all_select]').prop('checked', true);
    } else {
      $('input[name=all_select]').prop('checked', false);
    }
  }

</script>

