
{% if error is not null %}
<div class="alert alert-danger">{{ error }}</div>
{% endif %}

{% if testmode is not null  %}
<div class="alert alert-info">{{ text_testmode }}</div>
{% endif %}

<form action="{{ action }}" id="form_{{ classname }}" method="{{ form_method }}" class="form-horizontal">
  {% if need_pay %}
    <fieldset id="payment">
        <legend>{{ text_legend }}</legend>

        {% for field in fields %}

        {% if not field['no_open'] %}
        <div class="form-group{% if field['required'] is not null %} required{% endif %}">
            {% endif %}
            {% if not field['no_open']%}
            <label class="col-sm-2 control-label" for='{{field['name']}}'>{{ field['entry']}}</label>

            <div class="col-sm-10">
                {% endif %}

                {% if field['type'] == 'select'  %}
                <select name="{{ field['name']}}" id="{{field['name']}}" {{ field['multiple'] ? 'multiple="multiple"' : '' }} {{  field['param'] ? field['param'] : '' }} {{field['size'] ? 'size="'~field['size']~'"': ''}} validate="{{ field['validate'] ? field['validate'] : '' }}" class="form-control">
                    {% for key,value in field['options']%}
                    <option value="{{ key }}"{% if key in field['value'] or field['value'] == key %} selected="selected"{% endif %}>{{ value }}</option>
                    {% endfor %}
                </select>
                {% elseif  field['type'] == 'radio'%}
                {% for key,value in  field['options']%}
                <input type="radio" name="{{ field['name'] }}" id="{{ field['name'] }}" value="{{ key }}"{% if field['value'] == key %} checked="checked"{% endif %} {{ field['param'] ? field['param'] : '' }} validate="{{ field['validate'] ? field['validate'] : '' }}" class="form-control" /><label for="{{ field['name'] }}">{{ value }}</label>
                {% endfor %}
                {% elseif  field['type'] == 'text'%}
                <input type="text" name="{{  field['name']  }}" value="{{ field['value'] }}" placeholder="{{ field['placeholder'] }}" {{ field['param'] ? field['param'] : '' }} req="{{ field['required'] }}" validate="{{ field['validate'] }}" id="{{field['name']}}" size="{{ field['size']}}"  maxlength="{{  field['maxlength']}}"  class="form-control" />
                {% elseif  field['type'] == 'password'%}
                <input type="password" name="{{field['name']}}" value="{{ field['value'] }}" placeholder="{{ field['placeholder'] is not null ? field['placeholder'] : '' }}" {{ field['param'] ? field['param'] : '' }} req="{{ field['required'] ? field['required'] : '' }}" validate="{{ field['validate'] ? field['validate'] : '' }}" id="{{field['name']}}" {{  field['size'] ? 'size="'~field['size']~'"' : '' }} {{  field['maxlength'] ? "maxlength=\""~field['maxlength']~"\"" : '' }} class="form-control" />
                {% elseif  field['type'] == 'checkbox'%}
                <input type="checkbox"  {% if field['value'] %}checked="checked"{% endif %} class="checkbox"   onchange="checkboxEvent(this)" for="{{ field['name'] }}"/>
                <input type="hidden" name="{{ field['name'] }}" value="{{ field['value'] }}" req="{{ field['required'] ? field['required'] : '' }}" validate="{{ field['validate'] ? field['validate'] : '' }}" id="{{ field['name'] }}" {{ field['param'] ? field['param'] : '' }} />
                {% elseif  field['type'] == 'hidden'%}
                <input type="hidden" name="{{ field['name'] }}" value="{{ field['value'] }}" id="{{ field['name'] }}" {{ field['param'] ? field['param'] : '' }} />
                {% elseif  field['type'] == 'textarea'%}
                <textarea name="{{ field['name'] }}" req="{{ field['required'] ? field['required'] : '' }}" validate="{{ field['validate'] ? field['validate'] : '' }}" {{ field['param'] ? field['param'] : '' }} id="{{ field['name'] }}" cols="{{ field['cols'] }}" rows="{{ field['rows'] }}" class="form-control">{{ field['value'] }}</textarea>
                {% elseif  field['type'] == 'label'%}
                <label id="{{ field['name'] }}" class="form-control" {{ field['param'] ? field['param'] : '' }}>{{ field['value'] }}</label>
                {% elseif  field['type'] == 'file'%}
                <input req="{{ field['required'] ? field['required'] : '' }}" type="file" name="{{ field['name'] }}" {{ field['param'] ? field['param'] : '' }} />
                {% endif %}

                {% if field['help'] is not null  %}
                <span class="help-block" style="display:inline-block;">{{ field['help'] }}</span>
                {% endif %}

                {% if not field['no_close'] or not field['no_close']  %}
            </div>
        </div>
        {% endif %}

        {% endfor %}
    </fieldset>
 {% endif %}
    <div class="text-center mt-5">
      <input type="submit" value="{{ button_continue }}" id="button-confirm"
             data-loading-text="{{ text_loading }}"
             class="btn btn-primary"/>
    </div>

</form>


<script type="text/javascript"><!--
    function check(){
        var result = {};
        var $items = $('#payment').find('[name]');
        $items.each(function (i, e) {
            var name = $(e).attr('name');
            if(name=='card_year'){
                name = 'card_mon';
            }
           var itemTitle = $('label[for='+name+']').html().replace(':','')
            if($(e).attr('req')==1 && $(e).val().length<=0){
                result['error'] = itemTitle+' is required!';
                return false;
            }
        })
        return result;
    }
    $('form#form_{{ classname }}').submit(function(e) {

        var error = false;

        e.preventDefault();
      {% if need_pay %}
        var checkResult = check();
        if(checkResult['error']){
            alert(checkResult['error']);
            return;
        }
      {% endif %}
        // Validate Card first
        $.ajax({
            type: 'POST',
            url: 'index.php?route=extension/payment/{{ classname }}/send',
            data: $('form :input'),
            dataType: 'json',
            beforeSend: function() {
                $('#cpf-error').remove();
                $('#payment_message_error').remove();
                $('#button-confirm').attr('disabled', true);
                $('form#{{ classname }}').before('<div id="payment_message_wait" class="attention alert alert-info"><i class="fa fa-info-circle"></i> {{ text_wait }}</div>');
            },
            complete: function() {
                $('#button-confirm').attr('disabled', false);
                $('#payment_message_wait').remove();
            },
            success: function(json) {
                if(json['status']==5){
                  window.location.href='{{ toSuccessUrl }}';
                  return;
                }
                if (json['html']) {
                    $(document.body).append(json['html']);
                }

                // if 3ds redirect instruction
                if (json['ACSURL']) {
                    $('#3dauth').remove();

                    html  = '<form action="' + json['ACSURL'] + '" method="post" id="3dauth">';
                    html += '  <input type="hidden" name="MD" value="' + json['MD'] + '" />';
                    html += '  <input type="hidden" name="PaReq" value="' + json['PaReq'] + '" />';
                    html += '  <input type="hidden" name="TermUrl" value="' + json['TermUrl'] + '" />';
                    html += '</form>';

                    $('form#{{ classname }}').after(html);

                    $('#3dauth').submit();
                }

                // if error
                if (json['error']) {
                    $('form#form_{{ classname }}').before('<div id="payment_message_error" class="warning alert alert-warning"><i class="fa fa-info-circle"></i> '+json['error']+'</div>');
                }

                // if success
                if (json['success']) {
                    location = json['success'];
                }
                if(json['status'] == 4){
                  if (confirm(json['msg'])) {
                    location = json['redirect'];
                  }
                }
            },
            error: function(xhr, ajaxOptions, thrownError) {
                alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
            }
        });

    });

    $('select[name=card_type]').change(function(){
        if ($(this).val() == 'maestro' || $(this).val() == 'solo') {
            $('#solo').show();
        } else {
            $('#solo').hide();
        }
    });

    function country(element) {
        $.ajax({
            url: 'index.php?route=extension/payment/cybersource_sop/country&code=' + element.value,
            dataType: 'json',
            beforeSend: function() {
                $('select[name=bill_to_address_country]').prop('disabled', true);
            },
            complete: function() {
                $('select[name=bill_to_address_country]').prop('disabled', false);
            },
            success: function(json) {
                // if (json['postcode_required'] == '1') {
                //     $('input[name=bill_to_address_postal_code]').parent().parent().addClass('required');
                // } else {
                //     $('input[name=bill_to_address_postal_code]').parent().parent().removeClass('required');
                // }

                var html = '<option value="">{{ text_select }}</option>';

                if (json['zone'] && json['zone'] != '') {
                    for (var i = 0; i < json['zone'].length; i++) {
                        html += '<option value="' + json['zone'][i]['code'] + '"';
                        if (json['zone'][i]['code'] == '{{ selected_state }}') {
                            html += ' selected="selected"';
                        }
                        html += '>' + json['zone'][i]['name'] + '</option>';
                    }
                } else {
                    html += '<option value="0">{{ text_none }}</option>';
                }

                $('select[name=bill_to_address_state]').html(html);
            },
            error: function(xhr, ajaxOptions, thrownError) {
                alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
            }
        });
    }
    $('select[name$=bill_to_address_country]').trigger('change');

    function checkboxEvent(obj) {
        var forName = $(obj).attr('for');
        $('input[name='+forName+']').val($(obj).prop('checked')? 1:0);

    }
    //# sourceURL=payment_dynamic.js
    //--></script>

{% if merchid is not null  %}
<script type="text/javascript" src="https://h.online-metrix.net/fp/check.js?org_id={{ orgid }}&session_id={{ merchid }}{{ dfid }}"></script>
{% endif %}