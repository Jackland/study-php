{{header}}{{column_left}}
<div id="content">
  <div class="page-header">
    <div class="container-fluid">
      <h1>{{heading_title}}</h1>
      <ul class="breadcrumb">
        {% for breadcrumb in breadcrumbs %}
        <li><a href="{{breadcrumb.href}}">{{breadcrumb.text}}</a></li>
        {% endfor %}
      </ul>
      <div class="pull-right">
        <a href="{{cancel}}" class="btn btn-default" title="Back"><i class="fa fa-reply"></i></a>
      </div>
    </div>
  </div>
   <div class="container-fluid">
     {% if errors is defined and errors %}
      {% for error in errors %}
        <div class="alert alert-danger">{{error}}<button type="button" data-dismiss="alert" class="close">&times;</button></div>
      {% endfor %}
     {% endif %}
     <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title"><i class="fa fa-puzzle-piece"></i>{{text_history}}</h3>
        </div>
      <div class="panel-body">
          <div class="panel panel-primary">
              <div class="panel-heading" id="message">
              <label>
                  <b>{{from}}</b>
              </label> &nbsp;&nbsp;&nbsp;{{message_info.message_from}}
               <br><label><b>{{subject}}</b></label>&nbsp;&nbsp;&nbsp;{{message_info.message_subject}}
              <label class="pull-right"><b>{{date}}</b>&nbsp;&nbsp;&nbsp;{{message_info.message_date}}</label>
              </div>
            <div id="message_body" >
           <p>{{message_info.message_body}}</p>
            </div>
            <div id="attachment">
              <ul>
              {% for attachment in attachments %}
               <li style="list-style: outside none none; height:50px;"><i class="fa fa-paperclip" aria-hidden="true"  onclick="download({{attachment.attachment_id}})"></i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{attachment.maskname}}
               </li>
               {% endfor %}
              </ul>
          </div>
          </div>
          {% for threa in  thread_info %}
          <div class="panel panel-primary">
            <div class="panel-heading" id="message">
            <label><b>{{from}}</b></label> &nbsp;&nbsp;&nbsp;{{threa.message_from}}
             <br><label><b>{{subject}}</b></label>&nbsp;&nbsp;&nbsp;{{threa.message_subject}}
            <label class="pull-right"><b>{{date}}</b>&nbsp;&nbsp;&nbsp;{{threa.message_date}}</label>
            </div>
            <div id="message_body" >
            <p>{{threa.message_body}}</p>
            </div>
            <div id="attachment">
              <ul>
              {% if attachments_info and  attachments_info[loop.index0]%}
                  {% for attachment in attachments_info[loop.index0] %}
               <li style="list-style: outside none none; height:50px;"><i class="fa fa-paperclip" aria-hidden="true" onclick="download({{attachment.attachment_id}})"></i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{attachment.maskname}}
               </li>
               {% endfor %}{% endif %}
              </ul>
          </div>
          </div>
          {% endfor %}
      <div id="message_form" class="col-sm-9">
        <form method="POST"  ng-hide="!selection" enctype="multipart/form-data">
        <div id="seller-contact">
            <div class="form-group">
              <label>{{to}}</label>
              <select class="form-control" name="message_to_id">
                <option value="{{ reply.message_from_id }}">{{reply.from}}</option>
                <option value="{{ reply.message_to_id }}">{{reply.to}}</option>
              </select>
            </div>
            <input type="hidden" value="{{message_info.message_id}}" name="parent_message" id="parent">
              <div class="form-group">
                          <label> {{subject}}  </label>
                          <input type="text"  name="subject" value="" class="form-control" />
              </div>
              <div class="form-group">
            <textarea id="body" data-toggle="summernote" name="message">
            </textarea>
          </div>
          <div class="form-group">
          <div class="form-group" style="display:inline-block">

          <label class="attach-file pointer" name="upload_files[]">
            <i class="fa fa-upload"></i>
            <input type="file" name='file[]' id="files" style="display:none"  onchange="validate_fileupload(this);"><i class="fa fa-times remove-file pointer"></i>
          </label>
          </div>
           <span id="addFile" class="label-right pointer">+ {{text_attach_another}}</span>
          </div>
        </div>
        <div class="pull-right">
        <div onclick="sendMail()" class="btn btn-primary">{{send}}</div>
        </div>
      </form>
      </div>
         </div>
        </div>
      </div>
{{footer}}
<script type="text/javascript" src="view/javascript/summernote/summernote.js"></script>
<link href="view/javascript/summernote/summernote.css" rel="stylesheet" />
<script type="text/javascript" src="view/javascript/summernote/summernote-image-attributes.js"></script>
<script type="text/javascript" src="view/javascript/summernote/opencart.js"></script>
<script type="text/javascript">
    $(document).ready(function () {
        $('#body').summernote({
            height: 300,
            callbacks: {
                onImageUpload: function (files, editor, welEditable) {
                    sendFile(files[0], this);
                }
            }
        });
});
    $('#addFile').unbind('click').bind('click',function(){
        var maxNum = {{max}};
        if($('.attach-file').length>=maxNum){
            alert("{{ error_max_file_num }}" + maxNum);
            return;
        }
        var html='<label class="attach-file pointer attach"  style="margin-left: 5px; margin-right: 5px;"><i class="fa fa-upload"></i><input type="file" name="file[]"  class="files" style="display:none"  onchange="validate_fileupload(this);"><i class="fa fa-times remove-file pointer"></i></label>';
        $(this).prev().append(html);
    });
  $(document.body).on('click', '.remove-file', function(event) {
      event.preventDefault();
      $(this).parent().remove();
  });
    $(document.body).on('mouseenter','.attach-file',function(){
        $(this).find('.remove-file').css("display","inline-block");
    });
    $(document.body).on('mouseleave','.attach-file',function(){
        $(this).find('.remove-file').css("display","none");
    });
  function initContact() {
      $('#message_form form input[name="subject"]').val('');
      $('#body').summernote("reset");
      //移除附件
      $('.attach-file').remove();
      $('#addFile').trigger('click');
  }
  function showMsg(isSuccess,msg) {
      var alertClass = isSuccess? 'alert-success':'alert-danger';
      $('<div class="alert '+alertClass+'">'+msg+'</div>').prependTo('#seller-contact')
          .fadeOut(5000,function(){
              $(this).remove();
          })
  }

function sendMail() {
      var formData = new FormData($('#message_form form')[0]);
      if(!formData.get('message')){
          formData.set('message',$('.note-editable').html());
      }
      var isSuccess = false;
      //发送站内信
      $.ajax({
          url : '{{action}}',
          data : formData,
          async:false,
          cache:false,
          contentType:false,
          processData:false,
          type: "post",
          dataType: 'json',
          success : function(json) {
              console.log('sendMessage success',json)
              if(json['error']) {
                  if(json['error'].length>0){
                      for(var i = 0 ;i<json['error'].length;i++) {
                          showMsg(false,json['error'][i]);
                      }
                  }else if(json['error_warning']){
                      showMsg(false,json['error_warning']);
                  }
              } else if(json['success']) {
                  isSuccess = true;
                  showMsg(true,json['success']);
                  initContact();
              }
          },
          error:function (data) {
              console.log('sendMessage error',data);
              var errorMsg = 'send message failed';
              try{
                  var error = data['responseText'].match(/\{"error.*}/ig);
                  error = JSON.parse(error);
                  errorMsg = error['error'][0];
              }catch (e) {}
              showMsg(false,errorMsg);
          }
      })
      //发送邮件
      if(isSuccess){
          $.ajax({
              url : '{{mail_action}}',
              data : formData,
              type: "post",
              cache:false,
              contentType:false,
              dataType: 'json',
              processData: false,
              success : function(json) {
                  console.log('sendMail success',json)
              },
              error:function (json) {
                  console.log('sendMail error',json)
              }
          });
      }
  }

function download(attachment_id){
     document.location = "index.php?route=communication/wk_communication/download&attachment_id="+attachment_id+"&user_token={{user_token}}";
}

    function sendFile(file, el) {
        data = new FormData();
        data.append("file", file);
        $.ajax({
            data: data,
            type: "POST",
            url: "index.php?route=communication/wk_communication/upload&user_token={{ user_token }}",
            cache: false,
            contentType: false,
            processData: false,
            success: function (url) {
                $(el).summernote('editor.insertImage', url);
            }
        });
    }

    function validate_fileupload(_this) {
        if(!validate(_this)){
            $(_this).parent().replaceWith('<label class="attach-file pointer attach"  style="margin-left: 5px; margin-right: 5px;"><i class="fa fa-upload"></i><input type="file" name="file[]"  class="files" style="display:none"  onchange="validate_fileupload(this);"><i class="fa fa-times remove-file pointer"></i></label>');
            return false;
        }else {
            var getImagePath = URL.createObjectURL(_this.files[0]);
            var file_extension = _this.value.split('.').pop();
            $(_this).parent().css('background-image', 'url(' + getImagePath + ')');
            $(_this).parent().find('.ex').remove();
            $(_this).parent().append('<span class="ex">' + file_extension + '</span>');
            return true;
        }
    }
    function validate(_this){
        if(!_this.value){
            return false;
        }
        var maxSize ={{size}};
        var allowed_extensions ={{ extension|json_encode() }};
        if (_this.type != 'file') {
            alert("{{ error_only_support_file_type }}" + allowed_extensions.join(','));
            return false;
        }
        var fileName = _this.value;
        var file_extension = fileName.split('.').pop();
        if (!allowed_extensions.includes(file_extension)) {
            alert("{{ error_only_support_file_type }}" + allowed_extensions.join(','));
            return false;
        }

        if ( _this.files[0].size > maxSize * 1024) {
            alert("{{ error_max_file_size }}{{ size_mb }}");
            return false;
        }
        return true;
    }
</script>

<style type="text/css">
  #message {
    background-color: #337AB7;
    color: white;
  }
  #message_body{
    margin-top: 8px;
    padding: 13px;
  }
  .panel-primary{
    margin-top: 65px;
  }
  p{
    word-spacing: 7px;
  }
  label.attach-file {
    display: inline-block;
    width: 65px;
    height: 65px;
    background: #F1F1F1;
    border: 1px dashed #DDD;
    border-radius: 5px;
    text-align: center;
    line-height: 50px;
    overflow: hidden;
    background-image:url('');
    background-size:cover;
    background-position: center;
}
.label-right {
    display: inline-block;
    text-align: center;
    vertical-align: top;
    margin: 22px 10px;
    color: #325896;
    font-weight: 600;
}
.fa-paperclip{
    font-size: 19px;
      cursor: pointer;
  }
  .remove-file{
  margin-left: 10px;
    position: absolute;
    display: none;
}
  #message_body{
    overflow: auto;
  }
</style>
