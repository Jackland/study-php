{{ header }}{{ column_left }}
{{ assetBundle('Common\\SummernoteAsset') }}
{{ jsOrigin('admin/view/javascript/information/information.js', 1) }}

<div id="content">
  <div class="page-header">
    <div class="container-fluid">
      <div class="pull-right">
        <button onclick="submitFunc(this)" id="submit-btn" data-toggle="tooltip" title="{{ button_save }}" class="btn btn-primary"><i class="fa fa-save"></i></button>
        <a href="{{ cancel }}" data-toggle="tooltip" title="{{ button_cancel }}" class="btn btn-default"><i class="fa fa-reply"></i></a></div>
      <h1>{{ heading_title }}</h1>
      <ul class="breadcrumb">
        {% for breadcrumb in breadcrumbs %}
        <li><a href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a></li>
        {% endfor %}
      </ul>
    </div>
  </div>
  <div class="container-fluid">{% if error_warning %}
    <div class="alert alert-danger alert-dismissible"><i class="fa fa-exclamation-circle"></i> {{ error_warning }}
      <button type="button" class="close" data-dismiss="alert">&times;</button>
    </div>
    {% endif %}
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title"><i class="fa fa-pencil"></i> {{ text_form }}</h3>
      </div>
      <div class="panel-body">
        <form action="{{ action }}" method="post" enctype="multipart/form-data" id="form-information" class="form-horizontal" onsubmit="return validateInformation()">
          <ul class="nav nav-tabs">
            <li class="active"><a href="#tab-general" data-toggle="tab">{{ tab_general }}</a></li>
            <li><a href="#tab-data" data-toggle="tab">{{ tab_data }}</a></li>
{#            <li><a href="#tab-seo" data-toggle="tab">{{ tab_seo }}</a></li>#}
{#            <li><a href="#tab-design" data-toggle="tab">{{ tab_design }}</a></li>#}
          </ul>
          <div class="tab-content">
            <div class="tab-pane active" id="tab-general">
              <ul class="nav nav-tabs" id="language">
                {% for language in languages %}
                <li><a href="#language{{ language.language_id }}" data-toggle="tab"><img src="language/{{ language.code }}/{{ language.code }}.png" title="{{ language.name }}" /> {{ language.name }}</a></li>
                {% endfor %}
              </ul>
              <div class="tab-content">{% for language in languages %}
                <div class="tab-pane" id="language{{ language.language_id }}">
                  <div class="form-group required">
                    <label class="col-sm-2 control-label" for="input-title{{ language.language_id }}">{{ entry_title }}</label>
                    <div class="col-sm-10">
                      <input type="text" name="information_description[{{ language.language_id }}][title]" value="{{ information_description[language.language_id] ? information_description[language.language_id].title }}" placeholder="{{ entry_title }}" id="input-title{{ language.language_id }}" class="form-control" />
                      {% if error_title[language.language_id] %}
                      <div class="text-danger">{{ error_title[language.language_id] }}</div>
                      {% endif %} </div>
                  </div>
                  <div class="form-group">
                    <label class="col-sm-2 control-label" for="input-description{{ language.language_id }}">{{ entry_description }}</label>
                    <div class="col-sm-10">
                      <div style="display: none" data-input-name="information_description[{{ language.language_id }}][description]" placeholder="{{ entry_description }}" id="input-description{{ language.language_id }}" data-toggle="summernote" data-lang="{{ summernote }}" class="form-control">{{ information_description[language.language_id] ? information_description[language.language_id].description }}</div>
                      <input type="hidden" name="information_description[{{ language.language_id }}][description]" value="">
                      {% if error_description[language.language_id] %}
                      <div class="text-danger">{{ error_description[language.language_id] }}</div>
                      {% endif %} </div>
                  </div>
                  <div class="form-group required">
                    <label class="col-sm-2 control-label" for="input-meta-title{{ language.language_id }}">{{ entry_meta_title }}</label>
                    <div class="col-sm-10">
                      <input type="text" name="information_description[{{ language.language_id }}][meta_title]" value="{{ information_description[language.language_id] ? information_description[language.language_id].meta_title }}" placeholder="{{ entry_meta_title }}" id="input-meta-title{{ language.language_id }}" class="form-control" />
                      {% if error_meta_title[language.language_id] %}
                      <div class="text-danger">{{ error_meta_title[language.language_id] }}</div>
                      {% endif %} </div>
                  </div>
                  <div class="form-group">
                    <label class="col-sm-2 control-label" for="input-meta-description{{ language.language_id }}">{{ entry_meta_description }}</label>
                    <div class="col-sm-10">
                      <textarea name="information_description[{{ language.language_id }}][meta_description]" rows="5" placeholder="{{ entry_meta_description }}" id="input-meta-description{{ language.language_id }}" class="form-control">{{ information_description[language.language_id] ? information_description[language.language_id].meta_description }}</textarea>
                      {% if error_meta_description[language.language_id] %}
                        <div class="text-danger">{{ error_meta_description[language.language_id] }}</div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="col-sm-2 control-label" for="input-meta-keyword{{ language.language_id }}">{{ entry_meta_keyword }}</label>
                    <div class="col-sm-10">
                      <textarea name="information_description[{{ language.language_id }}][meta_keyword]" rows="5" placeholder="{{ entry_meta_keyword }}" id="input-meta-keyword{{ language.language_id }}" class="form-control">{{ information_description[language.language_id] ? information_description[language.language_id].meta_keyword }}</textarea>
                      {% if error_meta_keyword[language.language_id] %}
                        <div class="text-danger">{{ error_meta_keyword[language.language_id] }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                {% endfor %}</div>
            </div>
            <div class="tab-pane" id="tab-data">

            {# parent #}
            <div class="form-group ">
              <label class="col-sm-2 control-label"  >{{ entry_parent }}</label>
              <div class="col-sm-10">
                <input id="searchInput"  type="text" name="parent_title" value="{{ parent_meta_title }}" placeholder="{{ entry_parent }}"   class="form-control" />
              </div>
            </div>
{#              是否有内容#}
            <div class="form-group ">
              <label class="col-sm-2 control-label"  >Is Link</label>
                <div class="col-sm-10">
                  <select name="is_link">
                    <option value="1" {% if is_link==1 %}selected{% endif %}>True</option>
                    <option value="0" {% if is_link is defined and is_link==0 %}selected{% endif %}>False</option>
                  </select>
                </div>
              </div>
{#              对谁可见#}
              <div class="form-group required">
                <label class="col-sm-2 control-label" for="input-country">Role</label>
                  <div class="col-sm-6" style="margin-top: 10px">
                    <input  name="roles[]"  value="BUYER"  {% if 'BUYER'   in roles %}checked{% endif %}  placeholder="Role" type="checkbox"/>  <label>Buyer</label>
                    <input  name="roles[]"  value="SELLER"  {% if 'SELLER'   in roles %}checked{% endif %}  placeholder="Seller" type="checkbox"/>  <label>Seller</label>
                    <input  name="roles[]"  value="VISITOR"  {% if 'VISITOR'   in roles %}checked{% endif %}  placeholder="Seller" type="checkbox"/>  <label>Visitor</label>
                    {% if error_roles!=''%}
                      <div class="text-danger">{{ error_roles }}</div>
                    {% endif %}
                  </div>
              </div>

              {# Information国别#}
              <div class="form-group">
                <label class="col-sm-2 control-label" for="input-country">{{ entry_country }}</label>
                {% for cty in countrys %}
                  <div class="col-sm-2" style="margin-top: 10px">
                    <input  name="country[]"   placeholder="{{ entry_country }}"     type="checkbox"
                            value="{{ cty.country_id }}"  {% if cty.country_id   in country %}checked{% endif %} />
                    <label>{{ cty.name }}</label>
                  </div>
                {% endfor %}
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label">{{ entry_store }}</label>
                <div class="col-sm-10">
                  <div class="well well-sm" style="height: 150px; overflow: auto;"> {% for store in stores %}
                    <div class="checkbox">
                      <label> {% if store.store_id in information_store %}
                        <input type="checkbox" name="information_store[]" value="{{ store.store_id }}" checked="checked" />
                        {{ store.name }}
                        {% else %}
                        <input type="checkbox" name="information_store[]" value="{{ store.store_id }}" />
                        {{ store.name }}
                        {% endif %}</label>
                    </div>
                    {% endfor %}</div>
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label" for="input-status">{{ entry_status }}</label>
                <div class="col-sm-10">
                  <select name="status" id="input-status" class="form-control">
                    {% if status %}
                    <option value="1" selected="selected">{{ text_enabled }}</option>
                    <option value="0">{{ text_disabled }}</option>
                    {% else %}
                    <option value="1">{{ text_enabled }}</option>
                    <option value="0" selected="selected">{{ text_disabled }}</option>
                    {% endif %}
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-2 control-label" for="input-sort-order">{{ entry_sort_order }}</label>
                <div class="col-sm-10">
                  <input type="number" step="1"   name="sort_order" value="{{ sort_order }}" placeholder="{{ entry_sort_order }}" id="input-sort-order" class="form-control" />
                  {% if error_sort_order!=''%}
                    <div class="text-danger">{{ error_sort_order }}</div>
                  {% endif %}
                </div>
              </div>
              <div id="information-file-group" class="form-group">
                <label class="col-sm-2 control-label">{{ column_file }}</label>
                <div id="informationFile" class="col-sm-10">
                  {% if file_name %}
                    {#有文件#}
                    <div class="no-border-form-control">
                      <span >{{ file_name }}</span>
                      <a onclick="deleteInformationFile('{{ information_id }}')"
                         style="margin-left: 15px;cursor: pointer;">
                        <i class="fa fa-minus-square" aria-hidden="true"></i>
                      </a>
                    </div>
                  {% else %}
                    {#没有文件#}
                    <input class="no-border-form-control" type="file" name="upload_file"/>
                  {% endif %}
                  {% if error_file %}
                    <div class="text-danger">{{ error_file }}</div>
                  {% endif %}
                  </div>
                </div>
              </div>
            </div>
        </form>
      </div>
    </div>
  </div>
  <link href="view/javascript/codemirror/lib/codemirror.css" rel="stylesheet" />
  <link href="view/javascript/codemirror/theme/monokai.css" rel="stylesheet" />
  <script type="text/javascript" src="view/javascript/codemirror/lib/codemirror.js"></script>
  <script type="text/javascript" src="view/javascript/codemirror/lib/xml.js"></script>
  <script type="text/javascript" src="view/javascript/codemirror/lib/formatting.js"></script>
  <script type="text/javascript"><!--

    var block = {
      'blockUI' : function () {
        var ele = $("#Modal-Mask-layer");
        if (!ele.length) {
          var html = "";
          html += '<div class="modal fade" id="Modal-Mask-layer" tabindex="-1" data-backdrop="static" role="dialog" aria-hidden="true" style="display: none;">';
          html += '    <div class="loader1" style="margin-top: 20%;margin-left: 50%">';
          html += '    <span></span>';
          html += '    <span></span>';
          html += '    <span></span>';
          html += '    <span></span>';
          html += '    <span></span>';
          html += '  </div>';
          html += '</div>';
          $('body').append(html);
        }
        $("#Modal-Mask-layer").modal('show');
      },
      'unBlockUI' : function () {
        $('#Modal-Mask-layer').modal('hide');
      }
    };

    function submitFunc() {
      $("#form-information").submit();
    }

    function deleteInformationFile(id) {
      if (confirm("{{ text_remove_file_confirm }}")) {
        block.blockUI();
        $.ajax({
          url: "index.php?route=catalog/information/deleteInformationFile&user_token={{ user_token }}" + "&informationId=" + id,
          type: 'get',
          dataType: 'json',
          success: function (json) {
            if (json.success) {
              var html = "<input class=\"no-border-form-control\" type=\"file\" name=\"upload_file" + "\"/>";
              $('#informationFile').empty();
              $('#informationFile').append(html);
              block.unBlockUI();
            }
          },
          error: function (xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
            block.unBlockUI();
          }
        });
      }
    }

    function validateInformation() {
      var file = $('input[name=upload_file]').val();
      var status = $('select[name=status]').val();
      if (file !== undefined && !file && status === '1') {
        alert("{{ error_file_necessary }}");
        return false;
      }
      $('#submit-btn').prop('disabled', true);
      return true
    }

    $('input[id=button-upload]').change(function() {
      var path = $(this).val();
      path = path.split('\\');
      path = path[path.length-1];
      var fileExtension = path.substring(path.lastIndexOf('.') + 1).toLowerCase();
      if(!fileExtension || fileExtension !== 'pdf'){
        $(this).val("");
        alert("{{ error_file_extension }}");
      }
    });

    $('#language a:first').tab('show');

    //自动联想
    $('#searchInput').change(function(){
        $('#searchInput').val('');
        $('[name="country[]"]').attr('disabled',false)
        $('[name="roles[]"]').attr('disabled',false)
    });
    $('#searchInput').autocomplete({
      delay: 0,
      source: function(request, response) {
        if(request==''){
          return;
        }
        $.ajax({
          url: '{{ search_action }}&search=' +  $('#searchInput').val()+'&information_id={{ information_id }}',
          dataType: 'json',
          // beforeSend: function() {
          //   $('#searchInput').val('');
          // },
          success: function(json) {
            response($.map(json, function(item) {
              return {
                label: item['meta_title'],
                value: item['meta_title'],
                country:item['country'],
                role:item['role'],
              }
            }));
          }
        });
      },
      'select': function(item) {
        $('#searchInput').val(item.label)
        changeCountryAndRole(item.country,item.role);
      }
    });

    function changeCountryAndRole(country,role) {
      var countrys = country.split(',');
      $('[name="country[]"]').each(function (i, e) {
          if(countrys.includes($(e).val())){
            $(e).attr('disabled',false);
          }else {
            //disable
            $(e).attr('disabled',true)
            $(e).attr('checked',false)
          }
      })
      var roles = role.split(',');
      $('[name="roles[]"]').each(function (i, e) {
          if(roles.includes($(e).val())){
            $(e).attr('disabled',false);
          }else {
            //disable
            $(e).attr('checked',false)
            $(e).attr('disabled',true)
          }
      })

    }
    $(function () {
      {% if focus_data_page %}
          $('[href="#tab-data"]').click();
      {% endif %}
      {% if parent_meta_title is defined %}
          changeCountryAndRole('{{ parent_country }}', '{{ parent_role }}');
      {% endif %}

    })
  //--></script></div>
{{ footer }}
<style>
  .no-border-form-control{
    width: 100%;
    height: 36px;
    padding: 8px 13px 8px 0;
    font-size: 13px;
  }
</style>
