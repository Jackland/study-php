{{ header }}
<link href="catalog/view/javascript/jquery/swiper/css/swiper.min.css?v={{ app_version }}" rel="stylesheet" type="text/css">
<script src="catalog/view/javascript/jquery/swiper/js/swiper.jquery.js?v={{ app_version }}" type="text/javascript"></script>
<link href="catalog/view/javascript/select2/css/select2.min.css?v={{ app_version }}" rel="stylesheet"/>
<script src="catalog/view/javascript/select2/js/select2.full.js?v={{ app_version }}"></script>
<script type="text/javascript" src="catalog/view/javascript/layui/layui.all.js?v={{ app_version }}"></script>
<script type="text/javascript" src="catalog/view/javascript/time-to/jquery.time-to.js?v={{ app_version }}"></script>
<script type="text/javascript" src="/public/js/common/mathematical.js?v={{ app_version }}"></script>
<link href="catalog/view/javascript/time-to/css/timeTo.css?v={{ app_version }}" rel="stylesheet" type="text/css"/>
<link href="catalog/view/javascript/customer/css/customer.css?v={{ app_version }}" rel="stylesheet" type="text/css"/>
<link href="storage/modification/catalog/view/theme/yzcTheme/stylesheet/product.css?v={{ app_version }}" rel="stylesheet" type="text/css"/>
<style>
  .jq-icon-warning span:first-child{
    top: calc(50% - 10px);
    background-size: 80%;
    background-repeat: no-repeat;
  }
</style>
{{ css(['css/common/common.css']) }}

<style>
    /* 解决bootstrap popover modal 不居中问题 */
    .modal-dialog.oris-modal{
        width: unset !important;
        max-width: 80%;
    }
    .oris-modal .modal-content {
        margin: auto !important;
    }
  .countdown-value{
    background: #FFE7E7;
    padding: 2px 14px;
    border-radius: 12px;
  }
  .deep-link{
    color: #183464;
  }
  a.deep-link:hover{
      text-decoration: underline;
  }
</style>
<div id="product-product">

    <div class="breadcrumb-wrapper clearfix">
        {% include 'giga/template/_parts/breadcrumb.twig' %}
    </div>

    <div id="content" class="pt-2">
        <div class="container" id="proDetailCon">
            <div class="" style="position: relative; min-height: 486px;">
                {# 图片 start#}
                <div class="left-content">
                    <div class=" large-img" style="width: 100%;overflow: hidden">
                        {% if unsee == 1 or seller_status==0 %}
                            <div class="con_img" style="width: 100%;">
                                <a class="bigthumbnail" style="border: none;display: inline-block;width: 100%;">
                                    <img src="{{ thumb }}" title="{{ heading_title }}" alt="{{ heading_title }}"/>
                                    {% if horn_mark == 'new' %}
                                        <div class="horn-mark-new detail-horn-mark-new"></div>{% endif %}
                                </a>
                                <div class="shadow_img"></div>
                                <div class="title_img">
                                    <span style="color:white;font-size: 40px;">Unavailable</span>
                                </div>
                            </div>
                        {% else %}
                            <a class="bigthumbnail" style="border: none;display: inline-block;width: 100%;">
                                <img src="{{ thumb }}" title="{{ heading_title }}" alt="{{ heading_title }}"/>
                                {% if horn_mark == 'new' %}
                                    <div class="horn-mark-new detail-horn-mark-new"></div>{% endif %}
                            </a>
                        {% endif %}
                    </div>


                    {% if seller_status==1 %}
                        <div class="additional-thumbnail-wrapper product-swiper-wrapper thumbnails carousel"
                             style="width: 100%;margin-top: 10px">
                            {% if images %}
                                <div class="swiper-container">
                                    <div class="swiper-wrapper">
                                        {% for image in images %}
                                            <li class="image-additional swiper-slide">
                                                <a class="thumbnail" href="{{ image.popup }}"
                                                   title="{{ heading_title }}">
                                                    <img src="{{ image.thumb }}" title="{{ heading_title }}"
                                                         alt="{{ heading_title }}"/>
                                                </a>
                                            </li>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="swiper-button-prev"><i class="giga icon-arrow-left"></i></div>
                                <div class="swiper-button-next" style="justify-content: flex-end;"><i
                                            class="giga icon-arrow-right-copy"></i></div>
                                <script>
                                    $(document).ready(function () {
                                        new Swiper('.additional-thumbnail-wrapper .swiper-container', {
                                            mode: 'horizontal',
                                            loop: false,
                                            slidesPerView: 5,
                                            spaceBetween: 20,
                                            autoplay: 2500,
                                            autoplayDisableOnInteraction: true,
                                            nextButton: '.additional-thumbnail-wrapper .swiper-button-next',
                                            prevButton: '.additional-thumbnail-wrapper .swiper-button-prev',
                                            navigation: {
                                                prevEl: '.additional-thumbnail-wrapper .swiper-button-prev',
                                                nextEl: '.additional-thumbnail-wrapper .swiper-button-next',
                                            },
                                            breakpoints: {
                                                768: {
                                                    slidesPerView: 2,
                                                    spaceBetween: 15
                                                },
                                                992: {
                                                    slidesPerView: 3,
                                                }
                                            }
                                        });
                                    });
                                </script>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
                {# 图片 END#}

                {# 右半侧 START#}
                <div class="center-content">
                    <div class="product-info-header-wrapper" style="margin-left: 10px;">
                        <div style="font-size: 20px;margin: 0;text-overflow: ellipsis;" >
                            {% if manufacturer %}
                                <a style="padding: 0 3px 0 6px;background-color: #D5EEF8;color: #2095C2;border: 1px solid #2095C2;font-size: 15px;margin-right: 5px;"
                                   href="{{ manufacturers }}">{{ manufacturer }}</a>
                            {% endif %}
                            <span title="{{ heading_title }}">{{ heading_title }}</span>
{#                            onsite标识#}
                          {% if is_giga_onsite %}
                            <div class="onsite-flag pop-down-new">
                                <span class="onsite-tag onsite-tag-top">On-Site</span>
                                <div class="pop-down top-25 small-triangle">
                                    <div class="popover-content">
                                        This product is shipped from Seller's own warehouse.
                                    </div>
                                </div>
                            </div>
                          {% endif %}
                            {% if originalProductImages %}
                            <span class="official-logo pop-down-new">
                                  <img id="originalFlag" style="margin-top: -6px;"src="{{ original_product_image_url }}"/>
                                   <div class="pop-down">
                                     <div class="placeholder-div"></div>
                                        <div class="popover-content">
                                            <div style="margin: 5px 0">
                                                     <span>This product is an original design.</span><br/>
                                                     <span>Click to view the relevant supporting files.</span><br/>
                                            </div>
                                        </div>
                                    </div>
                            </span>
                            {% endif %}
                        </div >


                        {# 不可售卖平台 #}
                        {% if non_sellable_on is not null and non_sellable_on|length > 0 %}
                        <div class="flex mt-octal1">
                            <div class="text-bold sellable-circle">Not available for sale on:</div>
                            <div class="flex1 p8-l">
                                {% for k,one in non_sellable_on %}
                                <span>{{one}}</span>
                                {% if k != non_sellable_on|length -1 %}
                                <span class="p8-lr">|</span>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        <p class="code" style="margin: 10px 0">
                            <span style="color: #FA6400">Item Code: {{ sku }}
                                {% if special_tags %}
                                    <span class="code-img">
                                    {% for sp_tag in special_tags %}
                                        {{ sp_tag }}
                                    {% endfor %}
                                    </span>
                                {% endif %}
                            </span>
                            <span>
                                <span class="text-muted"> Return Rate:</span>
                                {% if all_days_sale <= 10 %}
                                    <strong>N/A</strong>
                                {% else %}
                                    <strong>{{ return_rate_str }} </strong>
                                {% endif %}
                                {% if all_days_sale <= 10 %}
                                    <i class="giga icon-V10-wenhaotishi" aria-hidden="true" data-toggle="tooltip"
                                       style="cursor: pointer;"
                                       title="The volume of total units sold is not enough for judging return rate."></i>
                                {% endif %}
                            </span>
                            <span>
                                <span class="text-muted"> {{ text_downloads_p }}</span> <strong>{{ download_cnt }}</strong>
                                <i class="giga icon-V10-wenhaotishi" data-toggle="tooltip"
                                   data-original-title="Resource package download times"></i>
                            </span>
                        </p>
                    </div>
                    {# 超级复杂的价格显示#}
                    {% if seller_status == 0 %}
                        <div id="product" class="product-info-wrapper">
                            <span style="color:red;font-weight: bold;padding-top: 20px;padding-bottom: 20px;font-size: 30px;text-align: center;"> The product is unavailable.</span>
                        </div>
                    {% else %}
                        {% if isLogin %}
                            {#已登录 START#}
                            <div id="product" class="product-info-wrapper">
                                {% if unsee == 1 %}
                                    <span style="color:red;font-weight: bold;padding-top: 20px;padding-bottom: 20px;font-size: 30px;text-align: center;"> The product is unavailable, you can<br/>contact seller for details.</span>
                                {% else %}
                                    {# unsee=0  START#}

                                    {#改价 涨价 START#}{#这里只做隐藏#}
                                    {% if can_sell == 1 or loginId == seller_id or price_display == 1 %}
                                        {% if priceChangeDate and priceChangeText %}
                                            <div id="get_price_up"
                                                 style="display: none;font-size: 27px;background-color: #D5EEF8;height: 35px;line-height: 30px;margin-bottom: 12px;">
                                                <div>
                                                    <img style="height: 31px;padding:5px 5px 5px 5px;"
                                                         src="image/product/clock.svg"/>
                                                    <span style="font-size: 14px;color: #2095C2">{{ priceChangeText }}</span>
                                                    <span id="countdown"></span>
                                                </div>
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                    {#改价 涨价 END#}

                                    {% if can_sell == 1 or loginId == seller_id %}{#line 643#}
                                        {#can_sell=1 START#}
                                        {% include 'giga/template/product_detail/my_agreement.twig' %}
                                        {% if rawPrice is defined %}{#line 652#}
                                            <div class="price" style="overflow: visible;">
                                                <div class="col-sm-11" style="height: 100%">
                                                    <span class="text-muted col-sm-3">
                                                        <span name="price_value" id="price_value">
                                                            {% if 1 == product_type %}
                                                                Margin Advance Custom
                                                            {% elseif 2 == product_type %}
                                                                Future Goods Advance Custom
                                                            {% else %}
                                                                {{ text_custom_or_price }}
                                                            {% endif %}
                                                        </span>
                                                        {% if is_rebate %}
                                                            <i id='rebate_tips' class="giga icon-V10-wenhaotishi"
                                                               data-toggle="tooltip" title="" style="cursor: pointer"
                                                               data-original-title="{{ tips_rebate_price }}"></i>
                                                        {% endif %}
                                                        <i id='margin_tips' class="giga icon-V10-wenhaotishi"
                                                           data-toggle="tooltip" title=""
                                                           style="cursor: pointer;display: none"
                                                           data-original-title="Final unit price for the margin agreement ID %s that you have selected in the transaction type below. Only units purchased at this price will be included within this margin agreement."></i>
                                                    </span>
                                                    <span id="priceTypeDefault" class="col-sm-3 pcs handleCustomerClass handleProductPriceClass" style="height: 100%;display: flex;padding: 0;padding-left: 15px;align-items: center" onclick="handleProductPrice(this)"  data-value="price">
                                                        <span id="price_price_value">
                                                            <strong>{{ price }}</strong>
                                                            <span class="text-muted">/{{ text_unit }}</span><br class="br-no">
                                                            <span class="raw_price">{{ rawPrice }}/{{ text_unit }}</span>
                                                            {% if can_sell == 1 or loginId == seller_id or price_display == 1 %}
                                                                {% if priceChangeDate and priceChangeText %}{#改价 涨价#}
                                                                    <br>
                                                                    <span id="priceChangeArea">
                                                                        <span class="text-muted">{{ priceChangeAfterCurrency }}/{{ text_unit }}</span>&nbsp;
                                                                            <i class="giga icon-up-price freight0"
                                                                               title=""
                                                                               style="cursor: pointer;color: #FA6400;font-size: 12px;width: 30px"
                                                                               id="popover11" data-toggle="popover"></i>
                                                                        <div class="title1" ></div>
                                                                    </span>
                                                                {% endif %}
                                                            {% endif %}
                                                        </span>

                                                    </span>
                                                </div>
                                                <div class="col-sm-1" style="padding: 0">
                                                    {% if show_bid_on_title %}
                                                        <span id='bid_title_button' class="bid_title_span"
                                                            data-toggle="tooltip" title=""
                                                            data-original-title="Bid for a lower price">
                                                            <button class="btn bid_btn pull-right"
                                                                data-confirm="{{ product_pending }}" data-exc="1"
                                                                onclick="loadSpotModal(this)"
                                                                style="float: right;">{{ entry_btn_bid }}</button>
                                                        </span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        {% else %}{#line 668#}
                                            <div class="price" style="overflow: visible;">
                                                <div class="col-sm-11" style="height: 100%;">
                                                    <span class="text-muted col-sm-3">
                                                        <span name="price_value" id="price_value">
                                                            {% if 1 == product_type %}
                                                                Margin Advance {{ text_current_price }}
                                                            {% elseif 2 == product_type %}
                                                                Future Goods Advance {{ text_current_price }}
                                                            {% else %}
                                                                {{ text_custom_or_price }}
                                                            {% endif %}
                                                        </span>
                                                        {% if is_rebate %}
                                                            <i id='rebate_tips' class="giga icon-V10-wenhaotishi"
                                                               data-toggle="tooltip" title="" style="cursor: pointer"
                                                               data-original-title="{{ tips_rebate_price }}"></i>
                                                        {% endif %}
                                                        <i id='margin_tips' class="giga icon-V10-wenhaotishi"
                                                           data-toggle="tooltip" title=""
                                                           style="cursor: pointer;display: none"
                                                           data-original-title="Final unit price for the margin agreement ID %s that you have selected in the transaction type below. Only units purchased at this price will be included within this margin agreement."></i>
                                                    </span>
                                                    <span id="priceTypeDefault" class="col-sm-3 pcs handleCustomerClass handleProductPriceClass" style="height: 100%;display: flex;align-items: center;" onclick="handleProductPrice(this)"  data-value="price">
                                                        <span id="price_price_value">
                                                            <span>
                                                                <strong>{{ price }}</strong>
                                                                <span class="text-muted">/{{ text_unit }}</span>
                                                            </span>
                                                            {% if can_sell == 1 or loginId == seller_id or price_display == 1 %}
                                                                {% if priceChangeDate and priceChangeText %}{# 改价 涨价#}
                                                                    <span id="priceChangeArea">
                                                                        <br>
                                                                        <span class="text-muted">{{ priceChangeAfterCurrency }}/{{ text_unit }}</span>&nbsp;
                                                                            <i class="giga icon-up-price freight0"
                                                                               title=""
                                                                               style="cursor: pointer;color: #FA6400;font-size: 12px;width: 30px"
                                                                               id="popover11" data-toggle="popover"></i>
                                                                        <div class="title1"></div>
                                                                        </span>
                                                                {% endif %}
                                                            {% endif %}
                                                        </span>
                                                    </span>
                                                </div>
                                                <div class="col-sm-1" style="padding: 0">
                                                  {% if show_bid_on_title %}
                                                    <span id='bid_title_button' class="bid_title_span"
                                                          data-toggle="tooltip" title=""
                                                          data-original-title="Bid for a lower price">
                                                        <button class="btn bid_btn pull-right"
                                                                data-confirm="{{ product_pending }}"
                                                                onclick="loadSpotModal(this)"
                                                                style="float: right;">{{ entry_btn_bid }}</button>
                                                    </span>
                                                  {% endif %}
                                                </div>
                                            </div>
                                        {% endif %}

                                        {% include 'giga/template/product_detail/rebate.twig' %}
                                        {% include 'giga/template/product_detail/margin.twig' %}
                                        {% include 'giga/template/product_detail/future.twig' %}
                                        {% include 'giga/template/product_detail/spot.twig' %}

                                        {#促销活动 START#}
                                        {% include 'giga/template/product_detail/activity_promotion.twig' %}
                                        {#促销活动 END#}
                                        <!--#color-option 0001-->
                                        {% include 'giga/template/product_detail/option.twig' %}

                                        {#仓库 START#}
                                        {% include 'giga/template/product_detail/warehouse.twig' %}
                                        {#仓库 END#}

                                        {# Quantity START #}
                                        {% include 'giga/template/product_detail/quantity.twig' %}
                                        {# Quantity END #}

                                        {#Frieght START#}
                                        {% include 'giga/template/product_detail/freight.twig' %}
                                        {#Frieght END#}

                                        {#can_sell=1 END#}
                                    {% else %}{#line 747#}
                                        {# can_sell=0  START#}
                                        {% if quantity_display == 1 and price_display == 1 %}{#line 748#}

                                            {% include 'giga/template/product_detail/price_cannot_sell.twig' %}

                                            {#促销活动 START#}
                                            {% include 'giga/template/product_detail/activity_promotion.twig' %}
                                            {#促销活动 END#}
                                            <!--#color-option 0002-->
                                            {% include 'giga/template/product_detail/option.twig' %}

                                            {#仓库 START#}
                                            {% include 'giga/template/product_detail/warehouse.twig' %}
                                            {#仓库 END#}

                                            {# Quantity START #}
                                            {% include 'giga/template/product_detail/quantity_no_change.twig' %}
                                            {# Quantity END #}

                                            {#Frieght START#}
                                            {% include 'giga/template/product_detail/freight.twig' %}
                                            {#Frieght END#}

                                            {# quantity_display == 1 and price_display == 1 #}
                                        {% elseif quantity_display == 1 and price_display == 0 %}{#line 802#}
                                            {# quantity_display == 1 and price_display == 0  START#}

                                            {#促销活动 START#}
                                            {% include 'giga/template/product_detail/activity_promotion.twig' %}
                                            {#促销活动 END#}
                                            <!--#color-option 0003-->
                                            {% include 'giga/template/product_detail/option.twig' %}

                                            {#仓库 START#}
                                            {% include 'giga/template/product_detail/warehouse.twig' %}
                                            {#仓库 END#}

                                            {# Quantity START #}
                                            {% include 'giga/template/product_detail/quantity_no_change.twig' %}
                                            {# Quantity END #}
                                            {# quantity_display == 1 and price_display == 0  END#}
                                        {% elseif quantity_display == 0 and price_display == 1 %}{#line 844#}
                                            {# quantity_display == 0 and price_display == 1  START#}

                                            {% include 'giga/template/product_detail/price_cannot_sell.twig' %}

                                            {#促销活动 START#}
                                            {% include 'giga/template/product_detail/activity_promotion.twig' %}
                                            {#促销活动 END#}
                                            <!--#color-option 0004-->
                                            {% include 'giga/template/product_detail/option.twig' %}

                                            {#Frieght START#}
                                            {% include 'giga/template/product_detail/freight.twig' %}
                                            {#Frieght END#}

                                            {# quantity_display == 0 and price_display == 1  END#}
                                        {% else %}{#line 860#}
                                            {# quantity_display == 0 and price_display == 0  START#}

                                            {% include 'giga/template/product_detail/price_not_quantity_not_price.twig' %}

                                            {#促销活动 START#}
                                            {% include 'giga/template/product_detail/activity_promotion.twig' %}
                                            {#促销活动 END#}
                                            <!--#color-option 0005-->
                                            {% include 'giga/template/product_detail/option.twig' %}

                                            {# quantity_display == 0 and price_display == 0  END#}
                                        {% endif %}{#line 863#}
                                        {# can_sell=0  END#}
                                    {% endif %}{#line 864#}
                                    {# unsee=0  END#}
                                {% endif %}
                              {% if storage_fee_day and can_sell %}
                                <div>
                                  <label class="mr-2 key text-muted">Storage fee</label>
                                  <span>
                                    {{ storage_fee_day|formatPrice(currency) }}
                                    <span class="text-light"> / day(Estimated)</span>
                                    <a href="{{ url('information/information',{'information_id':storage_fee_description_id}) }}"
                                      class="deep-link ml-2" target="_blank">Learn More</a>
                                  </span>
                                </div>
                              {% endif %}
                            </div>
                            {#已登录 END#}
                        {% else %}
                            {#未登录 START #}
                            <div class="price" style="border: none">
                                <div class="col-sm-11">
                                    <span class="text-muted col-sm-3">
                                        Price
                                    </span>
                                    <span class="col-sm-9">
                                        <p style="color: #FA6400;"><a style="color: #FA6400;"
                                                                      href="{{ login_link }}">{{ text_login_to_see_price }}</a></p>
                                    </span>
                                </div>
                            </div>
                            {#促销活动 START#}
                            {% include 'giga/template/product_detail/activity_promotion.twig' %}
                            {#促销活动 END#}
                            <!--#color-option 0006-->
                            {% include 'giga/template/product_detail/option.twig' %}

                            {#未登录 END #}
                        {% endif %}
                    {% endif %}

                    {#操作按钮 START#}
                    {% if seller_status %}
                        {% if isLogin %}
                            {% if (can_sell == 1 or loginId == seller_id) and unsee == 0 %}
                                <div class="modal fade" id="oversizeMaterialCaution" tabindex="-1" role="dialog">
                                    <div class="modal-dialog" style="width: 75%">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <button type="button" class="close" data-dismiss="modal"
                                                        aria-hidden="true">×
                                                </button>
                                                <h4 class="modal-title" id="myModalLabel">Oversized item Cautions</h4>
                                            </div>
                                            <div class="modal-body">
                                                {{ oversize_material_policy }}
                                                <div>
                                                    Step 1:</br><img style="width: 100%"
                                                                     src="image/product/fill_oversize_order_1.png"/></br>
                                                    Step 2:</br><img style="width: 100%"
                                                                     src="image/product/fill_oversize_order_2.png"/></br>
                                                    Step 3:</br><img style="width: 100%"
                                                                     src="image/product/fill_oversize_order_3.png"/>
                                                </div>
                                            </div>
                                            <div class="modal-footer" style="text-align: center">
                                                <button id="materialConfirm" type="button"
                                                        class="btn btn-primary btn-submit" data-dismiss="modal"
                                                        disabled="true"
                                                        onclick="download_package({{ product_id }},{{ customer_id }})">I
                                                    Know ( 9 )
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            {% elseif unsee == 1 %}
                                {% if isSeller!=1 %}
                                    <div class="mt-2">
                                        <div class="row">
                                            <div class="col-md-12 do-action text-center">
                                                <a href="{{ contact_seller_link }}" class="btn btn-default btn-lg"><i
                                                            class="giga icon-chat-inactive"></i>{{ text_message_seller }}
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            {% endif %}
                        {% endif %}
                    {% endif %}
                    {#操作按钮 END#}


                    {# N-1064 将上方的判断路径抄一份 #}
                    {% if seller_status %}
                        {% if isLogin %}
                            {% if unsee == 1 %}
                            {% else %}
                                {% if can_sell == 1 or loginId == seller_id %}{#line 643#}
                                {% else %}{#line 747#}
                                    {% if quantity_display == 1 and price_display == 1 %}{#line 748#}
                                        <div class="mt-2">
                                            <div class="row">
                                                <div class="col-md-12 do-action text-center">
                                                    <a href="{{ contact_seller_link }}"
                                                       class="btn btn-default btn-lg btn-product-process"><i
                                                                class="giga icon-chat-inactive"></i>{{ text_message_seller }}
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    {% elseif quantity_display == 1 and price_display == 0 %}{#line 802#}
                                        <div class="mt-2">
                                            <div class="row">
                                                <div class="col-md-12 do-action text-center">
                                                    <a href="{{ contact_seller_link }}"
                                                       class="btn btn-default btn-lg btn-product-process"><i
                                                                class="giga icon-chat-inactive"></i>{{ text_contact_see_price }}
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    {% elseif quantity_display == 0 and price_display == 1 %}{#line 844#}
                                        <div class="mt-2">
                                            <div class="row">
                                                <div class="col-md-12 do-action text-center">
                                                    <a href="{{ contact_seller_link }}"
                                                       class="btn btn-default btn-lg btn-product-process"><i
                                                                class="giga icon-chat-inactive"></i>{{ text_contact_see_quantity }}
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    {% else %}{#line 860#}
                                        <div class="mt-2">
                                            <div class="row">
                                                <div class="col-md-12 do-action text-center">
                                                    <a href="{{ contact_seller_link }}"
                                                       class="btn btn-default btn-lg btn-product-process"><i
                                                                class="giga icon-chat-inactive"></i>{{ text_message_seller }}
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}{#line 863#}
                                {% endif %}{#line 864#}
                            {% endif %}
                        {% else %}
                            <div class="mt-2">
                                <div class="row">
                                    <div class="col-md-12 do-action text-center">
                                        <a href="{{ login_link }}"
                                           class="btn btn-default btn-lg btn-product-process">{{ text_login_to_see_price }}</a>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
                {# 右半侧 END#}

                {# 固定窗 start#}
                {% if seller_status %}
                    <div class="right-content">
                        {% if isLogin %}
                            {% if unsee == 1 %}
                            {% else %}
                                {% if can_sell == 1 or loginId == seller_id %}{#line 643#}
                                    {#全部显示#}
                                    <div class="operate">
                                        <p id="fixed_transaction">
                                            <span class="key">Transaction Type</span>
                                            <span class="value"></span>
                                        </p>
                                        <p id="fixed_agreement">
                                            <span class="key">Agreement ID</span>
                                            <span class="value"></span>
                                        </p>
                                        <p id="fixed_countdown">
                                            <span class="key">Countdown</span>
                                            <span class="value countdown-value text-danger">
                                              <i class="giga icon-naozhong text-size-normal" ></i>
                                              <span class="countdown-time"></span>
                                            </span>
                                        </p>
                                        <p id="fixed_piece">
                                            <span class="key">1 Piece</span>
                                            <span class="value"></span>
                                        </p>
                                      {# 大客户折扣 #}
                                      {% if big_client_discount > 0 %}
                                        <p id="fixed_piece_discount">
                                          <span class="pull-right">
                                            <span class="big-client-discount text-bold">
                                                {{100 - big_client_discount}}%OFF&nbsp;
                                            </span>
                                            <span class="value"></span>
                                          </span>
                                        </p>
                                        {% endif %}
                                        <p id="fixed_freight">
                                            <span class="key">Fulfillment</span>
                                            <span class="value"></span>
                                        </p>
                                        <hr>
                                        {# Total Cost #}
                                        <p class="total-group" id="product">
                                            <label class="text-muted">{{ entry_total_cost }}</label>
                                            <span style="float: right;text-align: right">
                                                <span id="price_total"
                                                      class="total">{{ total_cost_price.dropshop_or_homepick }}</span><br>
                                                <span class="text-muted"> <span
                                                            id="price_unit">{{ total_cost_price.dropshop_or_homepick }}</span> / {{ text_unit }} </span>
                                            </span>
                                        </p>
                                        {# #13779 产品预计发货时间 出库时效 #}
                                        {% if ship_max>0 or cloud_ship_max>0 %}
                                          <div class="deliver-time text-color-normal text-right mt-2">
                                            {% if isCollectionFromDomicile == 1 or is_seller_self == 1 %}
                                              {% if ship_max>0 %}
                                                {# 上门取货账号 #}
                                                <p class="mb-1">
                                                  <span class="text-muted">{% if is_seller_self == 1 %}Pickup {% endif %}Handling Time</span><br>
                                                  <span><span id="handlingTime" class="text-bold"> {{ ship_min }}-{{ ship_max }} </span> business days</span>
                                                </p>
                                              {% endif %}
                                            {% endif %}
                                            {% if isCollectionFromDomicile != 1 or is_seller_self == 1 %}
                                              {# 一件代发账号 #}
                                              {% if ship_max>0 %}
                                                <p class="mb-1">
                                                  <span class="text-muted">Drop Shipping Handling Time</span> <br>
                                                  <span><span id="handlingTime" class="text-bold"> {{ ship_min }}-{{ ship_max }} </span> business days</span>
                                                </p>
                                              {% endif %}
                                              {% if country_code =='USA' and cloud_ship_max>0 %}
                                                <p class="mb-1">
                                                  <span class="text-muted">CWF Handling Time</span><br>
                                                  <span><span id="handlingTime" class="text-bold"> {{ cloud_ship_min }}-{{ cloud_ship_max }} </span> business days</span>
                                                </p>
                                              {% endif %}
                                            {% endif %}
                                            {% if ship_remark %}
                                              <p class="flex text-left overflow break-word">
                                                <img class="mr-octal1" src="public/image/icons/tip.png" style="margin-top: 3px">
                                                <span>{{ ship_remark }}</span>
                                              </p>
                                            {% endif %}
                                          </div>
                                        {% endif %}
                                        {% if isSeller != 1 %}
                                            {% if unsupport_stock %}
                                            <p class="buy-now-btn">
                                              <button type="button" class="btn btn-buy disabled" data-toggle="tooltip"
                                                title="This Seller’s products cannot be directly purchased for stock up. You must first upload a sales order and pay for the items, then ship the items immediately.">
                                                BUY NOW
                                              </button>
                                            </p>
                                            <p class="buy-now-btn">
                                              <button type="button" class="btn btn-cart disabled btn-action-disabled" data-toggle="tooltip"
                                                title="This Seller’s products cannot be directly purchased for stock up. You must first upload a sales order and pay for the items, then ship the items immediately.">
                                                {{ text_add_cart }}
                                              </button>
                                            </p>
                                            {% else %}
                                            <p class="buy-now-btn">
                                                <button type="button" id="button-buy"
                                                        data-loading-text="{{ text_loading }}" onclick="buyNow(this)"
                                                        class="btn btn-buy" data-cnzz-event="详情页|Dt_buynow">BUY NOW
                                                </button>
                                            </p>
                                            <p class="buy-now-btn">
                                                <button type="button" id="button-cart"
                                                        data-loading-text="{{ text_loading }}" onclick="addCart()"
                                                        class="btn btn-cart">{{ text_add_cart }}</button>
                                            </p>
                                            {% endif %}
                                        {% endif %}
                                        {% if (can_sell == 1 or loginId == seller_id) and unsee == 0 %}
                                            <p class="center" style="margin: 0">
                                                <button type="button" class="btn btn-download" data-toggle="tooltip" id="downloadFile"
                                                        data-original-title="*Zip File Download containing product images, description, shipping details and more"
                                                        onclick="oversizeMaterial({{ is_oversize }},{{ product_id }},{{ customer_id }})" data-cnzz-event="详情页|Dt_Download">
                                                    <i class="gcl gclxiazai"></i> Resource Package
                                                </button>
                                            </p>
                                        {% endif %}
                                        {% if isSeller != 1 %}
                                            {% if unsee == 0 %}
                                                <p class="center" style="margin: 0">
                                                    {% if productWishList %}
                                                        <button type="button" data-toggle="tooltip"
                                                                class="btn btn-wistlist"
                                                                onclick="wishlist.remove('{{ product_id }}',this, 'product');" data-cnzz-event="详情页|Dt_SevedItem">
                                                            <i class="giga fa-heart"></i> {{ button_wishlist_remove }}
                                                        </button>
                                                    {% else %}
                                                        <button type="button" data-toggle="tooltip"
                                                                class="btn btn-wistlist"
                                                                onclick="wishlist.add('{{ product_id }}',this, 'product');" data-cnzz-event="详情页|Dt_SevedItem">
                                                            <i class="giga fa-heart-o"></i> {{ button_wishlist_add }}
                                                        </button>
                                                    {% endif %}
                                                </p>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                {% else %}{#line 747#}
                                    {% if quantity_display == 1 and price_display == 1 %}{#line 748#}

                                    {% elseif quantity_display == 1 and price_display == 0 %}{#line 802#}

                                    {% elseif quantity_display == 0 and price_display == 1 %}{#line 844#}

                                    {% else %}{#line 860#}

                                    {% endif %}{#line 863#}
                                {% endif %}{#line 864#}
                            {% endif %}
                        {% endif %}
                        <div class="shop">
                          <div style="display: flex">
                              <div class="" style="width: 25%">
                                  <a href="{{ partner['sellerHref'] }}">
                                      <img src="{{ partner['thumb'] }}" alt="{{ displayName }}" width="100%">
                                  </a>
                              </div>
                              <div class="" style="padding-left: 10px;font-size: 12px;width: 75%">
                                   <h5  class="no-bottom-top6">
                                       <a href="{{ partner['sellerHref'] }}" title="{{displayName}}"class="shopName shopLink store-code-m4-b" style="line-height: 20px;" >{{ displayName }}</a>
                                   </h5>
                                {% if store_code %}
                                   <div class="store-code-m4-b">Store Code: <span>{{ store_code }}</span></div>
                                {% endif %}
                                {% if comprehensive.seller_show==1 %}
                                  {% if new_seller_score %}
                                    <div class="store-score pop-down-new mb-octal1" style="cursor: default">
                                      <span class="score">New Seller</span>
                                    </div>
                                  {% else %}
                                    <div class="store-score pop-down-new mb-octal1 margin-right-4">
                                      <span
                                        class="score">{{ comprehensive.total }}</span>
                                      <div class="pop-down">
                                        <div class="popover-content text-small">
                                          <b>GIGA Index</b>
                                          <div style="margin: 5px 0">
                                            <span>The GIGA Index serves as a Seller Performance Index automatically calculated by the Giga Cloud MarketPlace with a maximum possible index score of 100.</span><br>
                                            <span>Click [Learn more] to learn how the GIGA Index is calculated.</span>
                                          </div>
                                          <a class="link" href="{{ comprehensive.url }}" target="_blank">Learn More</a>
                                        </div>
                                      </div>
                                    </div>
                                  {% endif %}
                                {% endif %}
{#                                  onsite标识#}
                                {% if is_giga_onsite %}
                                  <div class="onsite-flag store-onsite pop-down-new onsite-flag-special" >
                                      <span class="onsite-tag">On-Site</span>
                                      <div class="pop-down small-triangle">
                                          <div class="popover-content">
                                              This sign means that all the products in this store are shipped from the Seller's own warehouse.
                                          </div>
                                      </div>
                                  </div>
                                {% endif %}
                                  <div>
                                      <span class="text-muted">Return Rate:</span>
                                      {{ partner['store_return_rate_mark'] }}
                                      {% if partner['store_return_rate_mark'] == 'N/A' %}
                                          <i class="giga icon-V10-wenhaotishi" data-toggle="tooltip"
                                             title="The volume of total units sold is not enough for judging return rate."></i>
                                      {% endif %}
                                  </div>
                                  <div>
                                      <span>Return Approval Rate: </span>
                                      {% if partner['return_approval_rate'] == 0 %}
                                          N/A <i class="giga icon-V10-wenhaotishi" data-toggle="tooltip"
                                                 title="No RMA records."></i>
                                      {% elseif partner['return_approval_rate'] > 90 %}
                                          High
                                      {% elseif partner['return_approval_rate'] > 60 %}
                                          Moderate
                                      {% else %}
                                          Low
                                      {% endif %}
                                  </div>
                                  {% if partner['store_response_rate_mark'] %}
                                      <div>
                                          <span>Response Rate: </span>{{ partner['store_response_rate_mark'] }}
                                      </div>
                                  {% endif %}
                              </div>
                          </div>
                            {% if can_contact_mail %}
                                <div style="margin-top: 5px" class="center">
                                    {% if isLogin %}
                                        <button class="btn btn-message"
                                                onclick="window.location.href='{{ contact_seller_link }}'" data-cnzz-event="详情页|Dt_MessagetoSeller"><i
                                                    class="giga icon-email-messages"></i>{{ text_message_seller }}
                                        </button>
                                    {% else %}
                                        <button class="btn btn-message"
                                                onclick="window.location.href='{{ login_link }}'" data-cnzz-event="详情页|Dt_MessagetoSeller"><i
                                                    class="giga icon-email-messages"></i>{{ text_ask_seller_login }}
                                        </button>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
                {# 固定窗 END#}
            </div>

            {# 详情 start #}
            <div class="detail">
                <div class="product-tabs-wrapper mt-2 mb-3">
                    <ul class="nav nav-tabs nav-tab2">
                        <li class="active"><a href="#tabSpecification" data-toggle="tab">Specification</a></li>
                        {% if description %}
                        <li class=""><a href="#tabDescription" data-toggle="tab">Description</a></li>
                        {% endif %}
                        {% if material_manuals or certification_documents %}
                        <li class=""><a href="#tabDocuments" data-toggle="tab">Documents</a></li>
                        {% endif %}
                        {% if return_warranty_text %}
                        <li class=""><a href="#tabReturn" data-toggle="tab">Return & Warranty</a></li>
                        {% endif %}
                        {% if module_shipment_time_status %}
                        <li class=""><a href="#tabPolicy" data-toggle="tab">Marketplace Policy</a></li>
                        {% endif %}
                        {% if can_internaltion %}
                            <li><a href="#international-fulfillment-fee" data-toggle="tab">{{ tab_internation_fulfillment_fee }}</a> </li>
                        {% endif %}
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane active" id="tabSpecification">
                            <h3 class="mt-1">Product Information</h3>
                            <table class="module-specification table table-bordered">
                                <tr>
                                    <td>Item Code</td>
                                    <td>{{ sku }}</td>
                                </tr>
                                {% if upc %}
                                <tr>
                                    <td>UPC</td>
                                    <td>{{ upc }}</td>
                                </tr>
                                {% endif %}
                                <tr>
                                    <td>Product Type</td>
                                    <td>{{ page_product_type_name }}</td>
                                </tr>
                                <tr>
                                    <td>Product Name</td>
                                    <td>{{ name }}</td>
                                </tr>
                                {% if origin_place %}
                                <tr>
                                    <td>Place of Origin</td>
                                    <td>{{ origin_place }}</td>
                                </tr>
                                {% endif %}
                                {% if color_name %}
                                <tr>
                                    <td>{{ __('主要颜色', {}, 'catalog/view/pro/product/addproduct') }}</td>
                                    <td>{{ color_name }}</td>
                                </tr>
                                {% endif %}
                                {% if material_name %}
                                <tr>
                                    <td>{{ __('主要材质', {}, 'catalog/view/pro/product/addproduct') }}</td>
                                    <td>{{ material_name }}</td>
                                </tr>
                                {% endif %}
                                {% if filler %}
                                <tr>
                                    <td>Filler</td>
                                    <td>{{ filler }}</td>
                                </tr>
                                {% endif %}
                                <!-- 自定义字段 -->
                                {% for item in information_custom_field %}
                                <tr>
                                    <td>{{ item.name|e }}</td>
                                    <td>{{ item.value|e }}</td>
                                </tr>
                                {% endfor %}
                                {% if is_customize %}
                                <tr>
                                    <td>Customized</td>
                                    <td>Yes</td>
                                </tr>
                                {% endif %}
                                {% if danger_flag %}
                                <tr>
                                    <td>Lithium Battery Contained</td>
                                    <td>Yes</td>
                                </tr>
                                {% endif %}
                            </table>
                            {% if is_customize %}
                            <div>
                              * Customized means the seller provides customized services for this product. For more information, please contact seller.
                            </div>
                            {% endif %}

                            <h3 class="mt-3">Product Dimensions</h3>
                            <table class="module-specification table table-bordered">
                                <tr>
                                    <td>Assembled Length ({{unit_length}})</td>
                                    <td>{{ assemble_length }}</td>
                                </tr>
                                <tr>
                                    <td>Assembled Width ({{unit_length}})</td>
                                    <td>{{ assemble_width }}</td>
                                </tr>
                                <tr>
                                    <td>Assembled Height ({{unit_length}})</td>
                                    <td>{{ assemble_height }}</td>
                                </tr>
                                <tr>
                                    <td>Weight ({{unit_weight}})</td>
                                    <td>{{ assemble_weight }}</td>
                                </tr>
                                <!-- 自定义字段 -->
                                {% for item in dimensions_custom_field %}
                                <tr>
                                    <td>{{ item.name|e }}</td>
                                    <td>{{ item.value|e }}</td>
                                </tr>
                                {% endfor %}
                            </table>

                            <h3 class="mt-3">Package Size</h3>
                            <table class="module-specification table table-bordered">
                            {% if combo_flag %}
                              {% for key, item in page_package_size_list %}
                                <tr>
                                  <td>Sub-item {{ key+1 }}: {{ item.sku }}</td>
                                  <td>{{ item.msg }}</td>
                                </tr>
                              {% endfor %}
                            {% else %}
                              {% for key, item in page_package_size_list %}
                                <tr>
                                  <td>Length ({{unit_length}})</td>
                                  <td>{{ item.length }}</td>
                                </tr>
                                <tr>
                                  <td>Width ({{unit_length}})</td>
                                  <td>{{ item.width }}</td>
                                </tr>
                                <tr>
                                  <td>Height ({{unit_length}})</td>
                                  <td>{{ item.height }}</td>
                                </tr>
                                <tr>
                                  <td>Weight ({{unit_weight}})</td>
                                  <td>{{ item.weight }}</td>
                                </tr>
                              {% endfor %}
                            {% endif %}
                            </table>
                        </div>
                        <div class="tab-pane" id="tabDescription">
                            {{ description }}
                        </div>
                        <!-- #33309 新增文档tab页面 -->
                        <div class="tab-pane" id="tabDocuments">
                          {% if certification_documents %}
                          <h3 class="mt-1">Legal Documents</h3>
                          <table class="module-specification table table-bordered">
                            {% for item in certification_documents %}
                            <tr>
                              <td>{{item.type_name}}</td>
                              <td>
                                <a href="{{item.url}}" target="_blank">
                                  <i class="giga icon-attachment"></i>{{item.name}}
                                </a>
                              </td>
                            </tr>
                            {% endfor %}
                          </table>
                          {% endif %}

                          {% if material_manuals %}
                          <h3 class="mt-3">Material Document</h3>
                          <table class="module-specification table table-bordered">
                            {% for index,item in material_manuals %}
                            <tr>
                              <td>{{ index + 1 }}</td>
                              <td>
                                <a href="{{item.url}}">
                                  <i class="giga icon-attachment"></i>{{item.name}}
                                </a>
                              </td>
                            </tr>
                            {% endfor %}
                          </table>
                          {% endif %}
                        </div>
                        <div class="tab-pane" id="tabReturn">
                            {{ return_warranty_text }}
                        </div>
                        <div class="tab-pane" id="tabPolicy">
                            {% if module_shipment_time_status %}
                              <div>
                                {{ shipmentTimePage }}
                              </div>
                            {% endif %}
                        </div>
                      {#international Fulfillment Fee 新增tab页#}
                      <div class="tab-pane" id="international-fulfillment-fee">
                        <table class="table table-hover table-bordered table-weight">
                          <thead style="background-color: #f5f5f5">
                          <tr>
                            <th>{{ text_country }}</th>
                            <th>{{ text_country_code }}</th>
                            <th>{{ text_fulfillment_fee }}
                              <i class="giga icon-V10-wenhaotishi" aria-hidden="true" data-toggle="tooltip"
                                 style="cursor: pointer;"
                                 title="{{ tips_international_fulfillment_fee }}"></i>
                            </th>
                          </tr>
                          </thead>
                          <tbody class="fulfillment-tbody">
                          </tbody>
                        </table>
                      </div>
                    </div>
                </div>

                {#Related Products  START#}
                {% if latest is defined and latest %}
                    <div class="row mb-5">
                        <div class="col-ms-12">
                            <h3 class="ml-1">Related Products</h3>
                            <div class="" style="margin-right: 0">
                                {% for product in latest %}
                                    <div class="product-layout product-grid product-seller col-xs-12 col-lg-3 col-md-3 col-sm-6">
                                        <div class="swiper-slide">
                                            {% include 'giga/template/_parts/product_simple_grid.twig' %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                {% endif %}
                {#Related Products  END#}
            </div>
            {# 详情 end #}

            <div class="row">
            </div>

            <hr>
        </div>
    </div>


</div>
<!--模态对话框-->
<div class="modal fade" tabindex="-1" role="dialog" id="rebates_bid_modal">
    <div class="modal-dialog" style="width:90%;">
        <div class="modal-content" id="rebates_bid_modal_content">
            <div class="modal-header">
            </div>
        </div>
    </div>
</div>
<div class="modal fade" tabindex="-1" role="dialog" id="margin_bid_modal">
    <div class="modal-dialog oris-modal oris-buyer" id="margin_bid_modal_dialog">
        <div class="modal-content" id="margin_bid_modal_content" style="width: 640px">
            <div class="modal-header">
            </div>
        </div>
    </div>
</div>
<div class="modal fade " tabindex="-1" role="dialog" id="futures_bid_modal">
    <div class="modal-dialog modal-lg" role="document" >
        <div class="modal-content" id="futures_bid_modal_content">
            <div class="modal-header">
            </div>
        </div>
    </div>
</div>
{# Bid 阶梯价 #}
<div class="modal fade" tabindex="-1" role="dialog" id="quote_bid_modal">
  <div class="modal-dialog" id="quote_bid_modal_dialog">
    <div class="modal-content" id="quote_bid_modal_content">
      <div class="modal-header">
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="quoteAfterModal" tabindex="-1" role="dialog"  aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span
            aria-hidden="true">&times;</span><span class="sr-only">{{ text_close }} </span></button>
        <h3 class="modal-title">Attention</h3>
      </div>
      <div class="modal-body">
        <div>
          <div style="font-size: 16px;margin-left: 10px;">Successfully</div>
          <div>
            <ul class="show-progress">
              <li>
                <i class="giga icon-duigou" style="color: #FA6400;margin-left: -3px"></i>
                <span>Step1 Buyer places Bid</span>
              </li>
              <li class="timeline"></li>
              <li>
                <i class="circle"></i>
                <span>Step2 Seller processes the Bid Request, the agreement is signed upon Seller confirmation.</span>
              </li>
              <li class="timeline"></li>
              <li>
                <i class="circle"></i>
                <span>Step3 Buyer can select the signed agreement on the My Agreement page to purchase the products specified in the agreement. </span>
              </li>
            </ul>
          </div>
        </div>
        <div class="footer text-center">
          <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>
</div>
{#内部自动购买产销异体账号 防止囤货#}
<div class="modal fade buy-type"  id="InnerAutoBuycheckPurchaseAndSalesModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">Confirm</h4>
          </div>
          <div class="modal-body">
            <div class="flex">
              <i class="gcl gclkucunweb mr-1" style="color: #FA6400"></i>
              <div>
                <div>There are existing sales order(s) which contain this product. To make a product purchase that will automatically attach to the sales order(s) upon virtual payment, select 'Purchase Stock QTY for Sales Order'.</div>
                <div class="inventory-list mt-1">
                  <table class="table table-bordered table-header">
                    <thead>
                    <tr>
                      <td>Sales Order</td>
                      <td>QTY</td>
                    </tr>
                    </thead>
                  </table>
                  <table class="table table-bordered">
                    <tbody class="data-tbody">
                    <tr>
                      <td></td>
                    </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <div class="flex mt-2">
              <i class="gcl gclxiadan1 mr-1" style="color: #3A75DC"></i>
              <div>To complete a purchase by item cost, click ‘Purchase Stock Directly’. The stock will not be attached with any matching sales order after purchase.</div>
            </div>
            <div class="footer mt-2 text-center">
              <button id="btnInnerAutoBuySales" type="button" class="btn btn-primary mr-1" data-dismiss="modal" data-qty data-is_virtual_pay="1" onclick="buyNowAction(this)" data-text-remark="购买销售单库存">Purchase Stock QTY for Sales Order<span></span></button>
              <button id="btnInnerAutoBuyPurchase" type="button" class="btn btn-default" data-dismiss="modal" data-qty data-is_virtual_pay="0" onclick="buyNowAction(this)" data-text-remark="货值采购">Purchase Stock Directly<span></span></button>
            </div>
          </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

{#原创图片模态框#}
{% if originalProductImages %}
  {{ dynamicWidget('swapper_imgs' ,{ originalProductImages: originalProductImages }) }}
{% endif %}
<script>
  // trackingDetail订单状态详情页
  function openTrackStatusDialog(order_id, tracking_number, data_shipsku) {
    var trackingDetailUrl = 'index.php?route=account/sales_order/tracking_search/detail&order_id='
      + escape(order_id) + '&tracking_number=' + escape(tracking_number) + '&tracking_shipsku=' + escape(data_shipsku);
    layer.open(
      {
        type: 2,
        area: ['1000px', '600px'],
        fixed: false, //不固定Change
        maxmin: false,
        title: false,
        offset: "auto",
        shadeClose: true,
        skin: 'yzc_layer my_layer',
        scrollbar: false,
        resize:false,
        content: trackingDetailUrl,
        cancel: function (index, layer) {
        },
        success: function () {
        }
      }
    );
  }
</script>
<script>
    $(".handleCustomerClass").on('click', function () {
        $(".handleProductPriceClass").removeClass("active");
        $(".handleProductPriceClass").each(function(index, domEle){
          $(domEle).removeClass("active");
          $(domEle).removeClass("protocol-wrapper-slide-active");
          $(domEle).find(".protocol-price-active").removeClass("protocol-price-active");
        });
        $(".handleCustomerClass").removeClass("active");
        $(".handleSpotPriceClass").removeClass("active");
        $(".price .pcs").removeClass("active");
        $(this).addClass("active");
    });

    $(".contract-terms .application").bind("input propertychange change", function () {
        let len = $(this).val().length;
        $(this).parent().find(".val").text(len);
    });

    var is_delicacy_effected = "{{ is_delicacy_effected }}"; {# 是否在精细化生效期内 ""或 "1" #};
    var isPriceChange = 0; {# 0 或 1 #};
    var symbolLeft = "{{ symbolLeft }}";
    var symbolRight = "{{ symbolRight }}";
    var decimal_place = {{ decimal_place|default(2) }};{#小数位数#};
    var can_sell = "{{ can_sell }}"; {# "0"或"1" #};
    var loginId = "{{ loginId }}"; {# ""或"正整数" #};
    var seller_id = "{{ seller_id }}"; {# "正整数" #};
    var price_display = "{{ price_display }}"; {# "0"或"1" #};
    var priceChangeDate = "{{ priceChangeDate }}";
    var priceChangeText = "{{ priceChangeText }}";
    var onlyPriceString = "{{ price }}";{# Price价格 或 Customer精细化价格，带货币符号 #};
    var is_seller_self = "{{ is_seller_self }}"; {# ""或"1" #};
    var all_price ={{ total_cost_price|json_encode }};
    var isCollectionFromDomicile = "{{ isCollectionFromDomicile }}"; {# ""或"1" #};
    var cwf = "{{ cwf }}"; {# "整数" #};
    var show_bid_on_title = "{{ show_bid_on_title }}";{# ""或"1" #};
    var product_type={{ product_type }}; {# 整数 #};
    var text_num_not_change="The specified products and product quantities from the agreement may only be purchased once and cannot be adjusted.";
    var txtPleaseSelect = "{{ __('请选择', {}, 'common') }}";
    var isFlagTransation; //标记协议是否被激活
    var dicountType=null;//标记是否第一次加载
    //大客户折扣
    var is_delicacy_price = {{ is_delicacy_price }};
    var big_client_discount = {{ big_client_discount }};

    //店铺活动
    var xu_discount_info = {{ xu_store_discount|json_encode }};
    var current_discount_info = null;

    if(can_sell == '1' || loginId == seller_id || price_display =='1') {
      if (priceChangeDate && priceChangeText) {
        {#涨价#};
        {# Set timer countdown to specyfied date #};
        isPriceChange = 1;
        let currentDate = new Date();
        let browserTimezone = currentDate.getTimezoneOffset() / 60;
        let originalTimezone = {{ laTimezoneNum }};
        let offsetMillisecond = (originalTimezone - browserTimezone) * 60 * 60 * 1000;
        let currentTimestamp = new Date(priceChangeDate).getTime();
        let date = new Date(currentTimestamp + offsetMillisecond);
        let Days = parseInt(Math.abs(date - currentDate) / 1000 / 60 / 60 / 24);
        if (Days == 0) {
          $('#countdown').timeTo(date, function () {
            window.location.href = "{{ url('product/product', {'product_id':product_id}) }}";
          });
          $('#countdown').css("float", "right").css("padding-right", "3px");
        } else if (Days == 1) {
          $('#countdown').html("<b style='font-size: 14px;color:#2095C2'>" + Days + " day</b>");
        } else {
          $('#countdown').html("<b style='font-size: 14px;color:#2095C2'>" + Days + " days</b>");
        }

        let daystr = "";
        if (Days == 0) {
          let SysSecond = Number.parseInt("{{ prichChangeRemainSeconds }}") - 3; {#这里获取倒计时的起始时间#};
          let InterValObj = window.setInterval(SetRemainTime, 1000); {#间隔函数，1秒执行#};
          function SetRemainTime() {
            if (SysSecond > 0) {
              SysSecond = SysSecond - 1;
              let second = Math.floor(SysSecond % 60); {#计算秒#};
              let minite = Math.floor((SysSecond / 60) % 60); {#计算分#};
              let hour = Math.floor((SysSecond / 3600) % 24); {#计算小时#};
              daystr = ((hour < 10) ? ("0" + hour.toString()) : hour.toString())
                + ":"
                + ((minite < 10) ? ("0" + minite.toString()) : (minite.toString()))
                + ":"
                + ((second < 10) ? ("0" + second.toString()) : (second.toString()));
              $("#countday").html(daystr);
            } else {
              window.clearInterval(InterValObj);
            }
          }
        } else if (Days == 1) {
            daystr = Days + ' day';
        } else {
            daystr = Days + ' days';
        }
        let template = [
            '<div class="popover">',
            '<div class="arrow"></div>',
            '<div class="popover-title"></div>',
            '<div class="popover-content"></div>',
            '</div>'
        ].join("");
        let content = [
            '<div class="title1" style="width: 250px">' +
            priceChangeText + '<span id="countday">' + daystr + '</span>' +
            '</div>',
        ].join("");
        $('#popover11').popover({
            html: true,
            trigger: "hover",
            placement: 'bottom',
            // title: title,
            content: content,
            template: template
        });
      }
    }

    // 解决方案：右侧吸顶滚动时监测是否覆盖底部栏，计算top值
    function getRightContentFixed() {
      let fixTop = 0; // 默认top为0
      let $r = $('.right-content');
      if ($r.length > 0) {
        let rightDom = $r[0].getBoundingClientRect();
        let footerDom = $('footer')[0].getBoundingClientRect();
        // 计算fixed top
        if (footerDom.top < rightDom.height + 70) {
            fixTop = footerDom.top - rightDom.height - 70;
        }
      }
      fixTop = fixTop + 'px';
      return fixTop;
    }

    {#固定窗#}
    var $right = $('.right-content');
    var $left = $('.left-content');
    var fixedRight = '7%';
    var fixedWidth = '17.2%';
    var fixedLeft = '7%';
    var fixedLeftWidth = '25.8%';
    if ($right.length > 0) {
        fixedRight = ($(window).width() - $right.width() - $right.offset().left)/$(window).width() * 100 + '%';
        fixedWidth = $right.width() / $(window).width() * 100 + '%';
    }
    if ($left.length > 0) {
        fixedLeft = $left.offset().left / $(window).width() * 100 + '%';
        fixedLeftWidth = $left.width() / $(window).width() * 100 + '%'
    }
    // 1440*0.86为屏幕中心宽度的86%
    $(window).scroll(function (e) {
      let p = $("#product-product #content").css("padding-top");
      let a = $("#content").offset()['top'];
      let heightCoop = Number(a) + string2number(p);
      let proDetailConWidth = $("#proDetailCon").width();
      let heightImage = Number(a) + string2number(p);
      let fixRight = $('body').width()/$(window).width();
      let $el = $('.right-content');
      let isPositionFixed = ($el.css('position') == 'fixed');
      // Start 优化右侧吸顶是滚动覆盖底部栏
      let fixTop = getRightContentFixed();
      // End 优化右侧吸顶是滚动覆盖底部栏
      if ($(this).scrollTop() > heightCoop && proDetailConWidth > (1440*0.86)) {
        $el.css({'position': 'fixed', 'top': fixTop});
        $el.css({'position': 'fixed', 'right': fixedRight});
        $el.css({'width': fixedWidth});
      }
      if ($(this).scrollTop() < heightCoop && isPositionFixed) {
        $el.css({'position': 'absolute', 'top': '0px'});
        $el.css({'position': 'absolute', 'right': '0px'});
        $el.css({'width': '20%'});
      }

      const leftHeight = $left.outerHeight();
      const centerHeight = $('.center-content').outerHeight();
      let dif = (centerHeight - leftHeight);
      let scroll = Number(dif) + Number(heightImage);
      if ($(this).scrollTop() < heightImage) {
        $left.css({'position': 'absolute', 'left': '0px'});
        $left.css({'width': '30%'});
      }
      if ($(this).scrollTop() > heightImage) {
        if (($(this).scrollTop() < scroll) && proDetailConWidth > (1440*0.86)) {
          $left.css({'position': 'fixed', 'top': '0px'});
          $left.css({'position': 'fixed', 'left': fixedLeft});
          $left.css({'width': fixedLeftWidth});
        }
        if (($(this).scrollTop() > scroll) && proDetailConWidth > (1440*0.86)) {
          if (dif > 0) {
            $left.css({'position': 'absolute', 'top': dif + "px"});
          }
          $left.css({'position': 'absolute', 'left': '0'});
          $left.css({'width': '30%'});
        }
      }
    });

    $(window).resize(function () {
        let proDetailConWidth = $("#proDetailCon").width();
        let $el = $('.right-content');
        let $left = $('.left-content');
        // Start 优化右侧吸顶是滚动覆盖底部栏
          let fixTop = getRightContentFixed();
          // End 优化右侧吸顶是滚动覆盖底部栏
        if (proDetailConWidth <= (1440*0.86)) {
            $el.css({'position': 'absolute', 'top': fixTop});
            $el.css({'position': 'absolute', 'right': '0px'});
            $el.css({'width': '20%'});
            $left.css({'position': 'absolute', 'left': '0px', 'top': '0px'});
            $left.css({'width': '30%'});
        }
    })

    {#计数器#};
    $(".qty_reduce").click(function () {
        {#如果此时被选中 议价协议，则不允许调整计数器#};
        let v= $(".handleProductPriceClass.active").attr('data-value');
        let futures_version= $(".handleProductPriceClass.active").attr('futures_version');
        if(v != undefined) {
          let arr = v.split('_');
          if (arr[1] == '3') {
            if (futures_version == '3') {
              typeof showQtyDisableForFutures == "function" && showQtyDisableForFutures();
              return false;
            } else {
              typeof showQtyEnableForFutures == "function" && showQtyEnableForFutures();
            }
          }
          if (arr[1] == '4') {
            typeof showPriceOptimalTip == "function" && showPriceOptimalTip(text_num_not_change);
            return false;
          }
        }

        let input = $(this).parent().find("input");
        //#29414 仅有限时限量活动时，按钮禁用
        let otherQty=Number('{{other_stock_qty}}');
        let discountQty=Number('{{discount_stock_qty}}');
        if(otherQty == 0 && discountQty!=0){
          if(input.val()<=xu_discount_info.limit_discount.min_buy_num){
            typeof showPriceOptimalTip == "function" && showPriceOptimalTip(`Minimum Purchase QTY: ${xu_discount_info.limit_discount.min_buy_num}`);
            return false;
          }
        }

        if (input.val() <= 1) {
            input.val(1);
        } else {
            input.val(input.val() - 1);
        }
        input.change();
    });
    $(".qty_add").click(function () {
        {#如果此时被选中 议价协议，则不允许调整计数器#};
        let v= $(".handleProductPriceClass.active").attr('data-value');
        let futures_version= $(".handleProductPriceClass.active").attr('futures_version');
        if(v != undefined) {
          let arr = v.split('_');
          if (arr[1] == '3') {
            if (futures_version == '3') {
              typeof showQtyDisableForFutures == "function" && showQtyDisableForFutures();
              return false;
            } else {
              typeof showQtyEnableForFutures == "function" && showQtyEnableForFutures();
            }
          }
          if (arr[1] == '4') {
            typeof showPriceOptimalTip == "function" && showPriceOptimalTip(text_num_not_change);
            return false;
          }
        }
        let qty_available;
        qty_available = Number.parseInt($('#qty_available').text());
        let input = $(this).parent().find("input");
        if (input.val() == "" || input.val() == undefined || input.val() == null) {
            input.val(0);
        }
        if (input.val() >= qty_available) {
            return false;
        } else {
            input.val(parseInt(input.val()) + 1);
            input.change();
        }
    });
    function inputQtyChangeAfter(obj){
      {#如果此时被选中 议价协议，则不允许调整计数器#};
      let mean_val= $(".handleProductPriceClass.active").attr('mean');
      let v= $(".handleProductPriceClass.active").attr('data-value');
      let futures_version= $(".handleProductPriceClass.active").attr('futures_version');
      if(v != undefined) {
        let arr = v.split('_');
        if (arr[1] == '3' && futures_version == '3') {
          if (futures_version == '3') {
            typeof showQtyDisableForFutures == "function" && showQtyDisableForFutures();
          } else {
            typeof showQtyEnableForFutures == "function" && showQtyEnableForFutures();
          }
          mean = mean_val.split('_');
          obj.value = mean[3];
          return false;
        }
        if (arr[1] == '4') {
          typeof showPriceOptimalTip == "function" && showPriceOptimalTip(text_num_not_change);
          mean = mean_val.split('_');
          obj.value = mean[3];
          return false;
        }
      }

      obj.value=obj.value.replace(/\D/g,'');
    }

    function show_cwf_tips(obj) {
        window.open("{{ url('information/information', {'information_id':cwf_info_id}) }}", "_blank");
    }

    function close_cwf_tips() {
        layer.closeAll();
    }

    {#云送仓  --span描述切换#};
    $('input[name="freight_radio"]').change(function () {
        if ($(this).val() == 'cwf') {   {#云送仓#};
            $('#describe_for_drop').css('display', 'none');
            $('#describe_for_cwf').css('display', 'block');
            $('#label_for_drop').removeClass('radio_select');
            $('#label_for_cwf').addClass('radio_select');
        } else {   {#一件代发#};
            $('#describe_for_cwf').css('display', 'none');
            $('#describe_for_drop').css('display', 'block');
            $('#label_for_cwf').removeClass('radio_select');
            $('#label_for_drop').addClass('radio_select');
        }
    });

    /*N-1064*/
    if ($.trim($("#product-product #product").text()).length == 0) {
        $("#product-product #product").css({"padding": "0px"});
    }

    function establishContact(seller_id) {
        let postData = {
            'subject': 'Establish Contact',
            'message': 'The other party requests to establish contact with you, do you agree?',
            'seller_id': seller_id
        };
        //发送站内信
        $.ajax({
            url: "{{ url('customerpartner/profile/establishContact') }}",
            data: postData,
            async: false,
            type: 'POST',
            dataType: 'json',
            success: function (json) {
                if (json['error']) {
                    showMsg(false, json['error']);
                } else if (json['success']) {
                    showMsg(true, json['success']);
                }
            },
        })
    }

    function showMsg(isSuccess, msg) {
        layer.alert(msg, {
            title: 'Message',
            btn: 'OK',
            btnAlign:'c',
            skin: 'oris-layer' //样式类名
            , closeBtn: 0
        }, function (index) {
            layer.close(index);
        });
    }


    function checkProductInCart(delivery_type) {
        let check_in_cart = false;
        let product_id = '{{ product_id }}';
        $.ajax({
            url: "{{ url('product/product/checkProductInCart') }}",
            type: 'post',
            data: {"product_id": product_id,"delivery_type":delivery_type},
            async: false,
            success: function (res) {
                if (res.data.cart == 1) {
                    check_in_cart = true;
                }
            }
        });
        if (check_in_cart) {
            layer.alert('{{ cart_has }}', {
                title: 'Message',
                btn: 'OK',
                btnAlign: 'c',
                skin: 'oris-layer' //样式类名
                , closeBtn: 0
            }, function (index) {
                layer.close(index);
            });
        }
        return check_in_cart
    }

    function addCart() {
      let freight_radio = $('#product input[type=radio]:checked').val();
      let qty = Number.parseInt($('#product input[name="quantity"]').val());
      let delivery_type = freightRadio2DeliveryType(freight_radio);
      let product_volume = Number($('#product_volume').val());
      let volume_lower = Number($('#volume_lower').val());
      if (qty < 1) {
        return false;
      }
      if (window.CNZZ) {
        var type = 'Normal',
          transactionType = $('#transaction_type').val();
        if (transactionType && transactionType != 0) {
          type = $('#select2-transaction_type-container').text().split(':')[0].trim();
        }
        window.CNZZ.triggerEvent('详情页', 'Dt_AddtoCart', type)
      }

      let sendData = $('#product input[name="quantity"]' +
        ', #product input[type="number"]' +
        ', #product input[type="hidden"]' +
        ', #product input[type="radio"]:checked' +
        ', #product input[type="checkbox"]:checked' +
        ', #product select' +
        ', #product textarea').serializeArray();
      sendData.push({"name":"quantity", "value":qty});
      if ($(".handleCustomerClass.active").length) {
        sendData.push({"name": "add_cart_type", "value": 1});
      } else if ($(".handleSpotPriceClass.active").length) {
        sendData.push({"name": "add_cart_type", "value": 2});
      }


      $.ajax({
        url: "{{ url('checkout/cart/add') }}",
        type: 'post',
        data: sendData,
        dataType: 'json',
        beforeSend: function () {
          $('#button-cart').button('loading');
        },
        complete: function (e, xhr, settings) {
          if (e.status == 302) {
            window.location.reload();
          }
          $('#button-cart').button('reset');
        },
        success: function (json) {
          $('.alert-dismissible, .text-danger:not(".countdown-value")').remove();
          $('.form-group').removeClass('has-error');
          if (json['error']) {
            if (json['error']['option']) {
              for (let i in json['error']['option']) {
                let element = $('#input-option' + i.replace('_', '-'));
                if (element.parent().hasClass('input-group')) {
                  element.parent().after('<div class="text-danger">' + json['error']['option'][i] + '</div>');
                } else {
                  element.after('<div class="text-danger">' + json['error']['option'][i] + '</div>');
                }
              }
            }

            if (json['error']['transaction_type']) {
              if (json['error'].hasOwnProperty('cartExistFuturesAgreement') && json['error']['cartExistFuturesAgreement'] == '1') {
                layer.confirm(json['error']['transaction_type'], {
                  title: 'Message',
                  skin: 'oris-layer',
                  btn: ['Access', 'Cancel']
                }, function () {
                  window.location.href = "{{ url('checkout/cart') }}";
                });
              } else {
                $.toast({
                  heading: false,
                  text: json['error']['transaction_type'],
                  position: 'top-center',
                  showHideTransition: 'fade',
                  icon: 'error',
                  hideAfter: 5000,
                  allowToastClose: false,
                  loader: false,
                });
              }
              return false;
            }

            if (json['error']['seller']) {
              layer.alert(json['error']['seller'], {
                title: 'Message',
                btn: 'OK',
                btnAlign: 'c',
                skin: 'oris-layer' //样式类名
                , closeBtn: 0
              }, function (index) {
                layer.close(index);
              });
            }
          }

          if (json['success']) {
            $("#header-totalNum").text(json['totalNum']);
            $.toast({
              heading: false,
              text: json['success'],
              position: 'top-center',
              showHideTransition: 'fade',
              icon: 'success',
              hideAfter: 5000,
              allowToastClose: false,
              loader: false,
            });

            if (json.hasOwnProperty("totalNum")) {
              $("#header-totalNum").html(json["totalNum"]);
            }
            if (json.hasOwnProperty("totalMoney")) {
              $("#header-totalMoney").html(json["totalMoney"]);
            }

            $('#cart > ul').load('index.php?route=common/cart/info ul li');
            window.setTimeout(function () {
              $('[data-dismiss="alert"]').alert('close');
            }, 5000);
          }
        },
        error: function (xhr, ajaxOptions, thrownError) {
          if (xhr.status == 302) {
            window.location.reload();
            return ;
          }
          layer.alert(thrownError + "<br>" + xhr.statusText + "<br>" + xhr.responseText, {
            title: 'Message',
            btn: 'OK',
            btnAlign: 'c',
            skin: 'oris-layer' //样式类名
            , closeBtn: 0
          }, function (index) {
            layer.close(index);
          });
        }
      });
    }


    $('.date').datetimepicker({
        language: '{{ datepicker }}',
        pickTime: false
    });

    $('.datetime').datetimepicker({
        language: '{{ datepicker }}',
        pickDate: true,
        pickTime: true
    });

    $('.time').datetimepicker({
        language: '{{ datepicker }}',
        pickDate: false
    });

    let timerUpload = undefined;
    $('button[id^="button-upload"]').on('click', function () {
        let node = this;

        $('#form-upload').remove();

        $('body').prepend('<form enctype="multipart/form-data" id="form-upload" style="display: none;"><input type="file" name="file" /></form>');

        $('#form-upload input[name="file"]').trigger('click');

        if (typeof timerUpload != 'undefined') {
            clearInterval(timerUpload);
        }

        timerUpload = setInterval(function () {
            if ($('#form-upload input[name="file"]').val() != '') {
                clearInterval(timerUpload);

                $.ajax({
                    url: "{{ url('tool/upload') }}",
                    type: 'post',
                    dataType: 'json',
                    data: new FormData($('#form-upload')[0]),
                    cache: false,
                    contentType: false,
                    processData: false,
                    beforeSend: function () {
                        $(node).button('loading');
                    },
                    complete: function () {
                        $(node).button('reset');
                    },
                    success: function (json) {
                        $('.text-danger:not(".countdown-value")').remove();

                        if (json['error']) {
                            $(node).parent().find('input').after('<div class="text-danger">' + json['error'] + '</div>');
                        }

                        if (json['success']) {
                            layer.alert(json['success'], {
                                title: 'Message',
                                btn: 'OK',
                                btnAlign: 'c',
                                skin: 'oris-layer' //样式类名
                                , closeBtn: 0
                            }, function (index) {
                                layer.close(index);
                            });
                            $(node).parent().find('input').val(json['code']);
                        }
                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        layer.alert(thrownError + "<br>" + xhr.statusText + "<br>" + xhr.responseText, {
                            title: 'Message',
                            btn: 'OK',
                            btnAlign: 'c',
                            skin: 'oris-layer' //样式类名
                            , closeBtn: 0
                        }, function (index) {
                            layer.close(index);
                        });
                    }
                });
            }
        }, 500);
    });

    $(document).ready(function () {
        $('.large-img ').click(function () {
            $('.carousel  .swiper-wrapper > li:first-child a').trigger('click')
        });
        $('.thumbnails').magnificPopup({
            type: 'image',
            delegate: 'a',
            gallery: {
                enabled: true
            }
        });

        {#选择价格#};
        if (product_type != 1 && product_type != 2) {
          $('#price_price_value').parent().trigger("click", this);{#即调用handleProductPrice(obj)方法#};
        }
        if ($('#transaction_type').length > 0) {
          isFlagTransation=true; //防止为触发前做多余提示
          $('#transaction_type{{ transaction_info.first_get.id }}').trigger("click", this);{#即调用handleProductPrice(obj)方法#};
        }


        $(".select2_new").select2({
            //language: "zh-CN", //设置 提示语言
            width: "70%", //设置下拉框的宽度
            placeholder: `---${txtPleaseSelect}---`,
            //minimumInputLength: 10  {#最小需要输入多少个字符才进行查询#};
        });

        $('#select2-transaction_type-container').removeAttr('title');

        $(".label-more-on-the-way").mouseover(function () {
            $(this).next().show();
        });
        $(".label-more-on-the-way").mouseleave(function () {
            $(this).next().hide();
        });

        $(document).on("click", ".freight0", function () {
            $(".freight0").removeClass("select");
            $(this).addClass("select");
            $(".freight .freight_fee_show").css({"color": "#000000"});
            $(this).find(".freight_fee_show").css({"color": "#FA6400"});
            $(this).find('input[name="freight_radio"]').prop('checked', true).change();
        });


        if ($('input[id="input-quantity"][name="quantity"]').length) {
            calculateTotal($('input[id="input-quantity"][name="quantity"]')[0]);
        }
        if ($('select[id="transaction_type"][name="transaction_type"]').length) {
            // setProductPrice($('select[id="transaction_type"][name="transaction_type"]')[0]);
        } else {
            if ($('.freight0.select input[name="freight_radio"]:checked').length) {
                // setProductPrice($('.freight0.select input[name="freight_radio"]:checked')[0]);
            }
        }
    });

    function loadRebatesModal(plan_id) {
        let myModalSelector = $("#rebates_bid_modal");
        let str = '';
        if (plan_id) {
            str = '&plan_id=' + plan_id
        }
        {#请求后台获取详细信息#};
        myModalSelector.modal({
            remote: "{{ url('product/product/showRebatesBidModal', {'product_id':product_id, 'soldQty':quantity}) }}"+str,
            backdrop: 'static',
            keyboard: false
        });
        {#每次隐藏时，清除数据。确保点击时，重新加载#};
        myModalSelector.on("hidden.bs.modal", function () {
            $(this).removeData("bs.modal");
            $("#rebates_bid_modal_content").html("");
        });
    }

    /**
    * @param obj
    * @param int flag 1 quick view,  0 bid
    * @param int index 表示第几个合约的下标值 0 start
    */
    function loadMarginModal(obj,flag, index) {
        if ($('#btn_margin_bid').data('confirm')) {
            layer.confirm('{{ rebate_other_confirm }}', {
                title: ' Confirm',
                skin: 'oris-layer',
                btnAlign:"c",
                btn: ['Yes', 'No'] //按钮
            }, function () {
                layer.closeAll();
                showMarginModal(flag, index);
            });
        } else {
            showMarginModal(flag, index);
        }
    }

    function showMarginModal(flag, index) {
        let myModalSelector = $("#margin_bid_modal");
        {#请求后台获取详细信息#};
        myModalSelector.modal({
            remote: "{{ url('product/product/showMarginBidModal', {'product_id':product_id, 'sold_qty':quantity}) }}" + '&flag=' + flag + '&index=' + index,
            backdrop: 'static',
            keyboard: false
        });
        {#每次隐藏时，清除数据。确保点击时，重新加载#};
        myModalSelector.on("hidden.bs.modal", function () {
            $(this).removeData("bs.modal");
            $("#margin_bid_modal_content").html("");
        });
    }

    function loadSpotModal(obj) {
        let confirm_content = '{{ rebate_other_confirm }}';
        if ($(obj).data('exc') == 1) {
            confirm_content = '{{ rebate_other_confirm_exc }}';
        }
        if ($(obj).data('confirm')) {
            layer.confirm(confirm_content, {
                title: ' Confirm',
                skin: 'oris-layer',
                btnAlign:"c",
                btn: ['Yes', 'No'] //按钮
            }, function () {
                layer.closeAll();
                showSpotModal();
            });
        } else {
            showSpotModal();
        }
    }

    function showSpotModal() {
        //data-toggle="modal" data-target="#quote_bid_modal"
        let myModalSelector = $("#quote_bid_modal");
        {#请求后台获取详细信息#};
        myModalSelector.modal({
            remote: "{{ url('product/product/showQuoteBidModal', {'product_id':product_id}) }}",
            backdrop: 'static',
            keyboard: false
        });
        {#每次隐藏时，清除数据。确保点击时，重新加载#};
        myModalSelector.on("hidden.bs.modal", function () {
            $(this).removeData("bs.modal");
            $("#quote_bid_modal_content").html("");
        });
    }

    {#根据选择的交易类型来决定显示的价格，库存 ;obj:协议块、Price块、运费块 #};
    function handleProductPrice(obj) {
      $('#select2-transaction_type-container').removeAttr('title');
      let agreement_code = $(obj).attr('agreement_code') || $('input[name="agreement_code"]').val();
      let agreement_name = $(obj).attr('agreement_name') || $('input[name="agreement_name"]').val() || '';
      let mean_val = $(obj).attr('mean') || $('input[name="mean"]').val();
      let v = $(obj).attr('data-value') || $('input[name="transaction_type"]').val();
      let futures_version = $(obj).attr('futures_version') || $('#futures_version').val();
      if (agreement_code && v!='price') {
        $('input[name="agreement_code"]').val(agreement_code);
        $('input[name="mean"]').val(mean_val);
        $("#fixed_agreement").show().find(".value").text(agreement_code);
      } else {
        $("#fixed_agreement").hide().find(".value").text("");
        $('input[name="agreement_code"]').val('');
      }
      if (agreement_name && v!='price') {
        $('#futures_version').val(futures_version);
        $('input[name="agreement_name"]').val(agreement_name);
        $("#fixed_transaction").show().find(".value").text(agreement_name);
      } else {
        $('#futures_version').val('');
        $("#fixed_transaction").hide().find(".value").text("");
        $('input[name="agreement_name"]').val('');
      }

      if (v == 'price' || v== undefined) {
        calculateCurrentDiscount(0);
      }
      //大客户折扣，不这么写获取不到保证金头款，dom不同
      if (big_client_discount > 0 && !is_seller_self) {
        let deposit_per = $(obj).attr('deposit_per') || $('input[name="deposit_per"]').val();
        if (deposit_per && v != 'price') {
          $('input[name="deposit_per"]').val(deposit_per);
        }
      }

      if (v=='price'||v==undefined) {
        v = 0;
      }
      if (0 == v) {
        if (show_bid_on_title) {
          $('#bid_title_button').show();
        }
        {#设置货值库存和Total Cost#};
        $('#qty_available').text('{{ quantity }}');
        autoQuantityMax();
        let qty = $('input[name="quantity"]').val();
        (qty === undefined) ? (qty = 0) : "";
        let curr_freight = undefined;
        if (is_seller_self) {
          curr_freight = $('.freight0.select input[name="freight_radio"]:checked').data("freight");
        } else {
          if (isCollectionFromDomicile) {  {# 上门取货 #};
            curr_freight = $('#curr_freight').val() * 1;
          } else {
            if (cwf == "1") {  {# 有云送仓--美国#};
              curr_freight = $('input[name="freight_radio"]:checked').data('freight') * 1;
            } else {  {# 其他国别，没有云送仓 #};
              curr_freight = $('#curr_freight').val() * 1;
            }
          }
        }
        if (Number.isNaN(curr_freight)) {
          curr_freight = 0;
        }

        let only_price = string2number(onlyPriceString);
        if($(".handleSpotPriceClass.active").length){
          let price_calc = $(".handleSpotPriceClass.active").data("price_calc");
          only_price = price_calc;
        }

        let priceString = undefined;
        if (is_seller_self) {
          priceString = onlyPriceString;
          {# 未考虑到阶梯价格 特殊处理 #}
          if(agreement_name.toLowerCase() === 'spot price') {
            priceString = symbolLeft + operation(only_price, curr_freight, "add", decimal_place) + symbolRight;
          }
        } else {
          priceString = symbolLeft + operation(only_price, curr_freight, "add", decimal_place) + symbolRight;
        }
        if (priceString == undefined) {
          priceString = onlyPriceString;
        }
        if (isPriceChange) {
          $('.raw_price').hide();
          $('.br-no').hide();
        }else{
          $('.raw_price').show();
        }
        let price_unit_string = priceString;
        let price = string2number(priceString);
        if (is_seller_self) {
          price_unit_string = symbolLeft + formatThousands(Math.round((string2number(onlyPriceString) + curr_freight) * 100) / 100) + symbolRight;
          price = formatThousands(Math.round((string2number(onlyPriceString) + curr_freight) * 100) / 100);
          {# 未考虑到阶梯价格 特殊处理 #}
          if(agreement_name.toLowerCase() === 'spot price') {
            price_unit_string = symbolLeft + formatThousands(Math.round((string2number(only_price) + curr_freight) * 100) / 100) + symbolRight;
            price = formatThousands(Math.round((string2number(only_price) + curr_freight) * 100) / 100);
          }
        }
        //大客户折扣
        if (is_delicacy_price == 1) {
          $("#fixed_piece_discount").hide();
        } else if (big_client_discount > 0) {
          $("#fixed_piece_discount").show();
        }
        if (big_client_discount > 0 && is_delicacy_price == 0) { //&& !is_seller_self 取消此限制，seller能看到你自身折扣
          //折后价格
          let afterDiscountPrice = mathematical.MathToPrice(mathematical.accMul(big_client_discount / 100, only_price), decimal_place);
          let old_only_price = only_price;
          price = mathematical.accAdd(afterDiscountPrice, curr_freight, decimal_place);
          only_price = afterDiscountPrice;
          price_unit_string = symbolLeft + formatThousands(Math.round((string2number(afterDiscountPrice) + curr_freight) * 100) / 100) + symbolRight;
          let discount_info = symbolLeft + formatThousands(Math.round(old_only_price * qty * 100) / 100) + symbolRight;
          let show_info = "<span style=\"text-decoration:line-through\">" + discount_info + "</span>";
          $("#fixed_piece_discount").find('.value').html(show_info);
        }

        let price_total_string = symbolLeft + formatThousands(Math.round(price * qty * 100) / 100) + symbolRight;
        let fixed_piece_string = symbolLeft + formatThousands(Math.round(only_price * qty * 100) / 100) + symbolRight;
        let fixed_freight_string = symbolLeft + formatThousands(Math.round(curr_freight * qty * 100) / 100) + symbolRight;

        $('#price_total').text(price_total_string);
        $('#price_unit').text(price_unit_string);
        fixedPieceShow(fixed_piece_string, qty);
        fixedFreightShow(fixed_freight_string);

      } else {
        if (show_bid_on_title) {
          $('#bid_title_button').hide();
        }
        let mean = mean_val.split('_');
        let arr = v.split('_');
        if (arr[1] == '2' || arr[1] == '3') {
          $('#qty_available').text(mean[3]);
        } else if (arr[1] == '4') {
          if (string2number(mean[3]) <= string2number('{{ quantity }}')) {
            $('#qty_available').text(mean[3]);
          } else {
            $('#qty_available').text('{{ quantity }}');
          }
        } else {
          $('#qty_available').text('{{ quantity }}');
        }
        {# 如果选中议价协议，则购买输入框为议价协议的数量 #};
        if (arr[1] == '4') {
          $("#input-quantity").val(mean[3]);
          autoQuantityMax('spot');
        } else if (arr[1] == '3') {
          {# 如果选中现货协议三期，则购买输入框为议价协议的数量 #};
          if (futures_version == '3') {
            $("#input-quantity").val(mean[3]);
            autoQuantityMax('future');
          } else {
            autoQuantityMax();
          }
        }
        else {
          autoQuantityMax();
        }
        let qty = $('input[name="quantity"]').val();
        let curr_freight = 0;
        if (isCollectionFromDomicile) {  {# 上门取货 #};
          curr_freight = $('#curr_freight').val() * 1;
        } else {
          if (cwf == "1") {  {# 有云送仓--美国#};
            curr_freight = $('input[name="freight_radio"]:checked').data('freight') * 1;
          } else {  {# 其他国别，没有云送仓 #};
            curr_freight = $('#curr_freight').val() * 1;
          }
        }
        if (is_seller_self) {
          curr_freight = $('.freight0.select input[name="freight_radio"]:checked').data("freight");
        }
        let priceString = mean[0];   {# 云送仓处修改，使用货值+运费的方式计算总价 #};

        let price = string2number(priceString);

        $("#fixed_piece_discount").hide(); //协议都直接隐藏


        let price_freight = operation(price, curr_freight, 'add');
        let price_freight_string = symbolLeft + price_freight + symbolRight;
        let price_total_string = symbolLeft + formatThousands(Math.round(price_freight * qty * 100) / 100) + symbolRight;
        let fixed_piece_string = symbolLeft + formatThousands(Math.round(price * qty * 100) / 100) + symbolRight;
        let fixed_freight_string = symbolLeft + formatThousands(Math.round(curr_freight * qty * 100) / 100) + symbolRight;

        $('#price_total').text(price_total_string);
        $('#price_unit').text(price_freight_string);
        fixedPieceShow(fixed_piece_string, qty);
        fixedFreightShow(fixed_freight_string);
      }
      $('input[name="transaction_type"]').val(v);

      let objId = $(obj).attr("id");
      if (objId !== undefined && (objId.indexOf("transaction_type") > -1 || objId == "priceTypeDefault")) {
        if ($(obj).find(".protocol-count-down").length && $(obj).find(".protocol-count-down").text().length) {
          $("#fixed_countdown").show();
        } else {
          $("#fixed_countdown").hide();
        }
      }
      //判断是否点击返点tab #29414 
      let activeRebate=$('#wrapperBox').find('.rebate-li.protocol-wrapper-slide-active');
      let rebateQty=$('#input-quantity').val();
      if(activeRebate.length>0){ //#29414 默认选中有返点->其他库存
        let otherQty= Number('{{other_stock_qty | js_var}}');
        if(rebateQty>otherQty && current_discount_info){
          $('#input-quantity').val(otherQty);
          return
        }
      }
    }

    function calculateTotal(obj) {
        if ($('input[name="quantity"]').val() < 1) {
            $('input[name="quantity"]').val(1);
        }

        //region {# 议价协议 与 购买数量 #};
        let price_type='';
        let arr = [];
        if($(".handleProductPriceClass.active").length){
          let dv = $(".handleProductPriceClass.active").attr("data-value");
          arr = typeof dv =="string" ?dv.split("_"): [];
          if(arr[1] == '4'){
            price_type = 'spot'
          }
        }
        autoQuantityMax(price_type);
        //endregion

        let type = $('#transaction_type').val();
        if (typeof (type) == 'undefined') {
            type = 0;
        }
        let priceString = 0;
        if (0 == type) {
          if (is_seller_self) {
            priceString = onlyPriceString;
          } else {
            if (isCollectionFromDomicile) {  {# 上门取货 #};
              priceString = all_price['dropshop_or_homepick'];
            } else {
              if (cwf == "1") {  {# 有云送仓   --美国#};
                if ($('input[name="freight_radio"]:checked').length == 0) {  {# 没有云送仓radio按钮 #};
                  priceString = all_price['dropshop_or_homepick'];
                } else {
                  if ($('input[name="freight_radio"]:checked').val() == 'drop_shopping') {
                    priceString = all_price['dropshop_or_homepick'];
                  } else {
                    priceString = all_price['cwf'];
                  }
                }
              } else {  {# 没有云送仓---其他国家#};
                priceString = all_price['dropshop_or_homepick'];
              }
            }
          }
        } else {
            let mean = $('#mean').val().split('_');
            let arr = type.split('_');
            priceString = mean[0];
        }
        let qty = string2number($(obj).val());
        let qty_available = Number.parseInt($("#qty_available").text());
        if (qty > qty_available) {
          //#29414 限时限量折扣提示
          let otherQty= Number('{{other_stock_qty | js_var}}');
          let discountQty=Number('{{ discount_stock_qty | js_var}}');
          if(otherQty == 0 && discountQty !=0 && xu_discount_info.limit_discount.min_buy_num>discountQty){
            $(obj).val(xu_discount_info.limit_discount.min_buy_num);
            //qty = qty_available;
          }else if(arr[1] != '4') { {#  r如果选中议价协议，则 购买数量 填充为 协议内产品数量 #};
            $(obj).val(qty_available);
            qty = qty_available;
          }
        }
        let curr_freight = undefined;
        if (is_seller_self) {
            curr_freight = $('.freight0.select input[name="freight_radio"]:checked').data("freight");
        } else {
          if (isCollectionFromDomicile) {  {# 上门取货 #};
            curr_freight = $('#curr_freight').val() * 1;
          } else {
            if (cwf == "1") {   {# 有云送仓   --美国#};
              curr_freight = $('input[name="freight_radio"]:checked').data('freight') * 1;
            } else {
              curr_freight = $('#curr_freight').val() * 1;
            }
          }
        }
        if (Number.isNaN(curr_freight)) {
            curr_freight = 0;
        }


        let price = 0;
        let only_price = 0;
        let price_freight = 0;
        if (0 == type) {    {# 普通购买priceString是带运费的 #};
            price = string2number(priceString);
            only_price = string2number(onlyPriceString);
            price_freight = price;
            if(is_seller_self) {
              price_freight = only_price + curr_freight;
            }
        } else {   {# 协议购买priceString不带运费的 #};
            price = string2number(priceString);
            only_price = string2number(priceString);
            price_freight = price + curr_freight;
        }
        //大客户折扣
      if (type != 0) {
        $("#fixed_piece_discount").hide();
      }
      if (big_client_discount > 0 && !is_seller_self && type == 0) {
        $("#fixed_piece_discount").show();
        let isBzj = 0;
        let depositPer = 0;
        if (arr[1] == '2' || arr[1] == '3') {
          depositPer = string2number($(".handleProductPriceClass.active").attr('deposit_per'));
          if (depositPer > 0) {
            only_price = mathematical.accAdd(only_price, depositPer, decimal_place);
            isBzj = 1;
          }
        }
        let afterDiscountPrice = mathematical.MathToPrice(mathematical.accMul(big_client_discount / 100, only_price), decimal_place);
        let old_only_price = only_price;
        let discount = mathematical.accSub(only_price, afterDiscountPrice);
        if (isBzj === 1) {
          only_price = mathematical.accSub(afterDiscountPrice, depositPer, decimal_place);
        } else {
          only_price = afterDiscountPrice;
        }

        price_freight = mathematical.accSub(price_freight, discount, decimal_place);
        price_unit_string = symbolLeft + formatThousands(Math.round((afterDiscountPrice + curr_freight) * 100) / 100) + symbolRight;
        let discount_info = symbolLeft + formatThousands(Math.round(old_only_price * qty * 100) / 100) + symbolRight;
        let show_info = "<span style=\"text-decoration:line-through\">" + discount_info + "</span>";
        $("#fixed_piece_discount").find('.value').html(show_info);
      }

        let price_total_string = symbolLeft + formatThousands(Math.round(price_freight * qty * 100) / 100) + symbolRight;
        let fixed_piece_string = symbolLeft + formatThousands(Math.round(only_price * qty * 100) / 100) + symbolRight;
        let fixed_freight_string = symbolLeft + formatThousands(Math.round(curr_freight * qty * 100) / 100) + symbolRight;


        $('#price_total').text(price_total_string);
        fixedPieceShow(fixed_piece_string, qty);
        fixedFreightShow(fixed_freight_string);


        {# #3099 判断商品有无精细化价格#};
        {#//1.无精细化价格时，数量变化时选中阶梯价#};
        {#//2.有精细化价格时，数量变化时使用精细化价格，不选择阶梯价#};
        let priceSelectedModule = "";
        if ($(".handleProductPriceClass.active").hasClass("handleCustomerClass")){
          priceSelectedModule = "Price";{#被选中的是 Customer模块#};
        } else if($(".handleSpotPriceClass").hasClass("active")){
          priceSelectedModule = "Spot";{#被选中的是 阶梯价模块#};
        }
        if (priceSelectedModule) {
          let is_select_spot_price = false;
          $(".handleSpotPriceClass").each(function (index, domEle) {
            let min_quantity = string2number($(domEle).data("min_quantity"));
            let max_quantity = string2number($(domEle).data("max_quantity"));
            let price_calc = $(domEle).data("price_calc");
            if (min_quantity <= qty && qty <= max_quantity && string2number(price_calc) <= string2number(onlyPriceString)) {
              is_select_spot_price = true;
              $(domEle).addClass("active");
              handleSpotPrice(domEle);{#确认选中 阶梯价模块，即调用handleSpotPrice(obj)方法#};
            } else {
              $(domEle).removeClass("active");{#取消选中 阶梯价模块#};
            }
          });
          if (is_select_spot_price) {
            $(".handleCustomerClass").removeClass("active");{#取消选中 Customer模块#};
            if (priceSelectedModule == "Price") {
              typeof showPriceOptimalTip == "function" && showPriceOptimalTip("The Spot Price quote rate offers the lowest price in this quantity.");
            }
          } else {
            $(".handleCustomerClass").addClass("active").click();{#确认选中 Customer模块，即调用handleProductPrice(obj)方法#};
            if (priceSelectedModule == "Spot") {
              let content = "";
              if (is_delicacy_effected) {
                content = "The Exclusive Price quote rate offers the lowest price in this quantity.";
              } else {
                content = "The Regular Price quote rate offers the lowest price in this quantity.";
              }
              typeof showPriceOptimalTip == "function" && showPriceOptimalTip(content);
            }
          }
        }
        let activeRebate=$('#wrapperBox').find('.rebate-li.protocol-wrapper-slide-active');
        if(activeRebate.length>0){ //#29414 默认选中有返点->其他库存
          let otherQty= Number('{{other_stock_qty | js_var}}');
          if(qty>otherQty&&current_discount_info){
            $('#input-quantity').val(otherQty);
            return
          }
        }
    }

    function fixedPieceShow(fixed_piece_string, qty) {
        if (qty < 2) {
            $("#fixed_piece").find(".key").text(qty + " Piece");
        } else {
            $("#fixed_piece").find(".key").text(qty + " Pieces");
        }
        $("#fixed_piece").show().find(".value").text(fixed_piece_string);
    }

    function fixedFreightShow(fixed_freight) {
        if (fixed_freight.toString().length > 0) {
            $("#fixed_freight").show().find(".value").text(fixed_freight);
        } else {
            $("#fixed_freight").hide().find(".value").text("");
        }
    }

    function autoQuantityMax(price_type) {
      typeof showQtyEnableForFutures == "function" && showQtyEnableForFutures();
      if (price_type == 'spot' || price_type == 'future') {
        let qty_available;
        qty_available = Number.parseInt($('#qty_available').text());
        let qty_qty = Number.parseInt($('input[id="input-quantity"][name="quantity"]').val());

        {#产品数量为0，则不可点击#};
        if (qty_available < 1 || isNaN(qty_available)) {
          $("#button-cart").addClass("disabled").addClass("btn-gray").text("{{ text_sold_out }}");
          $('#button-buy').addClass("disabled");
        } else {
          $("#button-cart").removeClass("disabled").removeClass("btn-gray").text("{{ text_add_cart }}");
          $('#button-buy').removeClass("disabled");
        }

        if(price_type == 'future'){
          typeof showQtyDisableForFutures == "function" && showQtyDisableForFutures();
        } else {
          typeof showQtyEnableForFutures == "function" && showQtyEnableForFutures();
        }

        if (qty_qty > qty_available) {
          $('#button-buy').data("disabled", true).addClass("disabled");
        } else {
          $('#button-buy').removeClass("disabled");
          if (qty_qty < 1 && qty_available > 0) {
            $('input[id="input-quantity"][name="quantity"]').val(1);
          }
        }
      } else {
        let qty_available;
        let qty_qty = Number.parseInt($('input[id="input-quantity"][name="quantity"]').val());
        qty_available = Number.parseInt($('#qty_available').text());
        if (qty_available == 0) {
            $('input[id="input-quantity"][name="quantity"]').val(qty_available);
        } else {
            if (qty_qty > qty_available) {
               //#29414 其他库存 ==0， 限时活动库存!=0
                let otherQty=Number('{{other_stock_qty | js_var}}');
                let discountQty=Number('{{discount_stock_qty|js_var}}');
                if(otherQty == 0 && discountQty !=0 && xu_discount_info.limit_discount.min_buy_num>discountQty){
                  $('#input-quantity').val(xu_discount_info.limit_discount.min_buy_num);
                }else{
                  $('input[id="input-quantity"][name="quantity"]').val(qty_available);
                }
            } else {
                if (qty_qty < 1 && qty_available > 0) {
                    $('input[id="input-quantity"][name="quantity"]').val(1);
                }
            }
        }
        {#产品数量为0，则不可点击#};
        if (qty_available < 1 || isNaN(qty_available) || qty_qty >qty_available) {
            $("#button-cart").addClass("disabled").addClass("btn-gray").text("{{ text_sold_out }}");
            $('#button-buy').addClass("disabled")
        } else {
            $("#button-cart").removeClass("disabled").removeClass("btn-gray").text("{{ text_add_cart }}");
            $('#button-buy').removeClass("disabled")
        }
      }
    }

    function getQtyNumber(dicountType){
      let otherQty=Number('{{other_stock_qty | default(0)}}');
      let currentQty=$("#input-quantity").val();
      let discountQty=Number('{{discount_stock_qty | default(0)}}');
      //是否选中专享价
      let priceActive =$(".handleCustomerClass.active").length; 
      if(otherQty !=0 && discountQty !=0){
        if(dicountType){
          if(dicountType == 2){ //限时
            if(currentQty > discountQty){
              if(currentQty>otherQty){
                //数量将不可再增加，提示：购买数量超出折扣活动可购买的库存上限
                if(discountQty>otherQty){
                  $("#input-quantity").val(discountQty);
                }else{
                  $("#input-quantity").val(otherQty);
                } 
                priceActive >0 && is_delicacy_price ==1 ? null:typeof showPriceOptimalTip == "function" && showPriceOptimalTip('the purchase quantity exceeds the upper limit of inventory that is set for the promotion.');
              }else{
                //使用其他库存，价格无活动折扣,提示：购买数量超出折扣活动可购买的库存上限，您将不再享有折扣。
                priceActive >0 && is_delicacy_price ==1 ? null:typeof showPriceOptimalTip == "function" && showPriceOptimalTip('The purchase quantity exceeds the upper limit of inventory that is set for the promotion, and you will no longer enjoy the discount');
              }
            }
            if(currentQty<=xu_discount_info.limit_discount.min_buy_num){
              if(currentQty > otherQty){
                //数量调整至非活动库存的上限，无提示
                $('#input-quantity').val(otherQty);
              }else{
                //正常操作无提示
              }
            }
          }else if(discount_type = 1){ //全店
            if(currentQty>otherQty && currentQty<xu_discount_info.limit_discount.min_buy_num){
              //数量调整至限时活动的起购量，提示：购买数量超出活动外可购买的库存上限，您将以限时活动最低起购量购买
              $('#input-quantity').val(xu_discount_info.limit_discount.min_buy_num);
              priceActive >0 && is_delicacy_price ==1 ? null:typeof showPriceOptimalTip == "function" && showPriceOptimalTip('The purchase quantity exceeds the upper limit of non-inventory. You will purchase at the minimum quantity of the limited sales promotion');
            }else{
              if(currentQty>discountQty&& discountQty>otherQty){ //currentQty>otherQty && currentQty >discountQty
                //购买数量超出折扣活动可购买的库存上限。若以活动方式购买，当数量超过活动库存且活动库存大于其他库存时的提示
                $('#input-quantity').val(otherQty);
                priceActive >0 && is_delicacy_price ==1 ? null:typeof showPriceOptimalTip == "function" && showPriceOptimalTip('The purchase quantity exceeds the upper limit of inventory that is set for the promotion.')
              }
              if(currentQty>otherQty){//购买数量超出活动外可购买的库存上限 
                if(otherQty>discountQty){
                  $('#input-quantity').val(otherQty);
                  priceActive >0 && is_delicacy_price ==1 ? null:typeof showPriceOptimalTip == "function" && showPriceOptimalTip('The purchase quantity exceeds the upper limit of non-promotion inventory');
                }
              }
            }
          }
        }else{ //第一次默认加载
          $('#input-quantity').val(1);
        }
      }else if(otherQty ==0 && discountQty !=0){
        if(dicountType){
          if(currentQty>=discountQty){
            if(xu_discount_info.limit_discount.min_buy_num>discountQty){ //起购量是否大于活动库存上限
              $('#input-quantity').val(xu_discount_info.limit_discount.min_buy_num);
            }else{
              //禁用按钮，currentQty ==活动库存上限
              $('#input-quantity').val(discountQty);
            }
          }
          if(currentQty <=xu_discount_info.limit_discount.min_buy_num){
            //减少按钮禁用
            $('#input-quantity').val(xu_discount_info.limit_discount.min_buy_num);
          }
        }else{ //第一次默认加载
          //默认起够量，减少按钮禁用
          $('#input-quantity').val(xu_discount_info.limit_discount.min_buy_num);
        }
      }
      //重新设置
      if(currentQty !=$('#input-quantity').val()){
          calculateTotal($('input[id="input-quantity"][name="quantity"]')[0]);
      }
    }
    
    function calculateCurrentDiscount(transaction_type) {
      var winUrl=window.location.href;//增加日志打印，方便定位线上问题
      winUrl.indexOf('is_log')>-1? console.log(xu_discount_info):null;
      let otherQty=Number('{{other_stock_qty | default(0)}}');
      let discountQty=Number('{{discount_stock_qty | default(0)}}');
      if(xu_discount_info.current_selected){
        current_discount_info = xu_discount_info.current_selected;
      }else{
        big_client_discount = 0;
        current_discount_info = null;
      }
      if(current_discount_info){
        //筛选符合限时折扣的交易类型
        getQtyNumber(dicountType);
        let transaction_type_str = current_discount_info.transaction_type;
        let currentQty = $("#input-quantity").val();
        dicountType=-1,big_client_discount =0;
        if(transaction_type_str == '-1' || transaction_type_str.indexOf(transaction_type) != -1){
          if(otherQty !=0 && discountQty !=0){
            if(currentQty >=xu_discount_info.limit_discount.min_buy_num && currentQty<=discountQty){
              if(xu_discount_info.store_discount){
                if((xu_discount_info.store_discount.discount)<(xu_discount_info.limit_discount.discount)&&currentQty<=otherQty){//全店优惠大于限时
                  current_discount_info=xu_discount_info.store_discount;
                  dicountType=1; //全店
                }else{
                  current_discount_info=xu_discount_info.limit_discount;
                  dicountType=2;
                }
              }else{
                current_discount_info=xu_discount_info.limit_discount;
                dicountType=2; //限时
              }
            }else{
              if(currentQty <=otherQty){
                current_discount_info=xu_discount_info.store_discount;
                dicountType=1;
              }
            }
          }else if(otherQty == 0 && discountQty!=0){
            current_discount_info=xu_discount_info.limit_discount;
            dicountType=2;
          }
        }else{
          if(xu_discount_info.store_discount){
            //走全店折扣
            current_discount_info=xu_discount_info.store_discount;
            dicountType=1;
          }else{
            //无折扣
            current_discount_info = null;
            big_client_discount = 0;
          }
        }
      }
      //算折扣值
      if (current_discount_info) {
        big_client_discount = current_discount_info.discount;
      } else {
        big_client_discount = 0;
      }
      if (big_client_discount > 0) {
        $("#fixed_piece_discount").find('.big-client-discount').html((100 - big_client_discount) + '%OFF');
      } else {
        $("#fixed_piece_discount").hide();
      }
    }

    function string2number(s) {
      if (typeof s == "string") {
        return Number(s.replace(/[^\d.]/ig, ""));
      } else if (typeof s == "number") {
        return s;
      } else if (typeof s == "undefined") {
        return 0;
      }
      return s;
    }

    /*添加千分位 author:zhousuyang*/
    function formatThousands(n) {
        let num = Number(n).toFixed(decimal_place);//number to string
        return num;
    }


    var flag = true;
    function download_package(product_id, customer_id) {
      $("#downloadFile").attr('disabled','disabled');
      $.ajax({
        url:"{{ url('product/product/download') }}",
        method:"post",
        data : {
          product_id:product_id,
          customer_id: customer_id,
        },
        success: function(res) {
          if (res.code==300){
            if (flag){
              $.toast({
                heading: false,
                text: "Download in process, please wait a moment",
                position: 'top-center',
                showHideTransition: 'fade',
                icon: 'warning',
                hideAfter: 5000,
                allowToastClose: true,
                loader: false,
                afterHidden:function () {
                  flag = false
                }
              })
            }
            $("#downloadFile").tooltip('destroy');
            var download =window.setTimeout(function () {
              download_package(product_id, customer_id)
            },3000);
          }
          if (res.code!=300) {
            window.clearTimeout(download);
            $("#downloadFile").removeAttr('disabled');
            if (res.code==0){
              layer.msg('Failed to download the resource package. Please try again.')
            }
            if (res.code==200){
              var downloadHref ="{{ url('product/product/downloadZip') }}&product_id=" + product_id;
              window.location.href = downloadHref;
            }
          }
        }
      })




        {#let $eleForm = $("<form method='post'></form>");#}

        {#$eleForm.attr("action", "{{ url('product/product/download') }}"+"&product_id=" + product_id + "&customer_id=" + customer_id);#}

        {#$(document.body).append($eleForm);#}
        {#$eleForm.submit();#}
    };


    let timerOversize = undefined;
    function oversizeMaterial(is_oversize, product_id, customer_id) {
        if (is_oversize) {
            if (typeof timerOversize != 'undefined') {
                clearInterval(timerOversize);
            }
            let $wait_time = 8;
            timerOversize = setInterval(function () {
                if ($wait_time >= 0) {
                    $('#materialConfirm').text('I Know ( ' + $wait_time + ' )');
                    $('#materialConfirm').attr("disabled", true);
                    $wait_time--;
                } else {
                    $('#materialConfirm').text('I Know');
                    $('#materialConfirm').attr("disabled", false);
                    clearInterval(timerOversize);
                }
            }, 1000);

            let myModal = $("#oversizeMaterialCaution");
            myModal.modal();
            myModal.on("hidden.bs.modal", function () {
                $('#materialConfirm').text('I Know ( 9 )');
                $('#materialConfirm').attr("disabled", true);
                clearInterval(timerOversize);
                $(this).removeData("bs.modal");
            })
        } else {
            download_package(product_id, customer_id);
        }
    }


    function showLayerTip(tipType, content, option, fun) {
        switch (tipType) {
            case 'msg':
                layer.msg(
                    content,
                    option,
                    fun
                );
                break;
            case 'alert':
                layer.alert(
                    content,
                    option,
                    fun
                );
                break;
            default:
                return
        }
    }


    /*判断obj是否为一个整数*/
    function isInteger(obj) {
        return Math.floor(obj) === obj;
    }

    /**
     * 将一个浮点数转换成整数，返回整数和倍数
     * 如 3.14 》》314  倍数是100
     */
    function toInteger(floatNum) {
        let ret = {times: 1, num: 0};

        //是整数
        if (isInteger(floatNum)) {
            ret.num = floatNum;
            return ret;
        }

        let strfi = floatNum + '';
        //查找小数点的下标
        let dotPos = strfi.indexOf('.');
        //获取小数的位数
        let len = strfi.substr(dotPos + 1).length;
        //Math.pow(10,len)指定10的len次幂。
        let time = Math.pow(10, len);

        //将浮点数转化为整数
        let intNum = parseInt(floatNum * time + 0.5, 10);
        ret.times = time;
        ret.num = intNum;
        return ret;
    }

    /**
     *进行运算
     *三个参数分别是要运算的两个数和运算符
     */
    function operation(a, b, op, precision) {
        let o1 = toInteger(a);
        let o2 = toInteger(b);
        let n1 = o1.num;
        let n2 = o2.num;
        let t1 = o1.times;
        let t2 = o2.times;
        let max = t1 > t2 ? t1 : t2;
        let result = null;
        switch (op) {
            case 'add':
                if (t1 === t2) {
                    result = n1 + n2;
                } else if (t1 > t2) {
                    result = n1 + n2 * (t1 / t2);
                } else {
                    result = n1 * (t2 / t1) + n2;
                }
                result = result / max;
                break;
            case 'subtract':
                if (t1 === t2) {
                    result = n1 - n2;
                } else if (t1 > t2) {
                    result = n1 - n2 * (t1 / t2);
                } else {
                    result = n1 * (t2 / t1) - n2;
                }
                result = result / max;
                break;
            case 'multiply':
                result = (n1 * n2) / (t1 * t2);
                break;
            case 'divide':
                result = (n1 / n2) / (t2 / t1);
                break;
        }
        if (isInteger(precision) && precision >= 0) {
            result = result + "";
            let len = result.length;
            let dotIndex = result.indexOf(".");
            if (dotIndex === -1) {
                result = Number(result).toFixed(precision);
            } else {
                let dotIndexBefore = dotIndex + precision;
                let dotIndexAfter = dotIndexBefore + 1;
                if (dotIndexAfter < len) {
                    let n = result.substr(dotIndexAfter, 1);
                    if (precision === 0) {
                        //为0时dotIndexBefore用的是小数点，所以要减一
                        dotIndexBefore--;
                    }
                    let m = result.substr(dotIndexBefore, 1);
                    result = result.slice(0, dotIndexBefore);
                    if (n > 4) {
                        if (m === '9') {
                            //防止进位
                            if (precision === 0) {
                                m = m + '.9';
                            } else {
                                m = m + '9';
                            }
                        } else {
                            m = Number(m) + 1;
                        }
                    }
                    result = Number(result + m).toFixed(precision);
                }
            }
        }
        return result;
    }
</script>

<script>
  function view() {
    if ($(".pcs .quick-box").html() == "") {
      let contract = "<span class='quick-view' data-target='.modal-view'> Quick View </span>";
      // $(".pcs .quick-box").empty();
      $(".pcs .quick-box").html(contract)
    }
  }

  {#点击阶梯价模块#}
  function handleSpotPrice(obj) {
    // if (big_client_discount > 0) {
    //   $("#fixed_piece_discount").show();
    // } else {
    //   $("#fixed_piece_discount").hide();
    // }
    let min_quantity = $(obj).data('min_quantity') * 1;
    let max_quantity = $(obj).data('max_quantity') * 1;
    let price_calc = $(obj).data('price_calc') * 1;
    let agreement_code = "";
    let agreement_name = "Spot Price";
    if (agreement_code) {
      $('input[name="agreement_code"]').val(agreement_code);
      $('input[name="mean"]').val(mean_val);
      $("#fixed_agreement").show().find(".value").text(agreement_code);
    } else {
      $('input[name="agreement_code"]').val('');
      $('input[name="mean"]').val('');
      $("#fixed_agreement").hide().find(".value").text("");
    }
    if (agreement_name) {
      $('input[name="agreement_name"]').val(agreement_name);
      $("#fixed_transaction").show().find(".value").text(agreement_name);
    } else {
      $('input[name="agreement_name"]').val('');
      $("#fixed_transaction").hide().find(".value").text("");
    }


    if (show_bid_on_title) {
      $('#bid_title_button').show();
    }
    {#设置货值库存和Total Cost#};
    let qty_old = $("#input-quantity").val();
    if(min_quantity<= qty_old && qty_old<=max_quantity){
      {#计数器数量不变#};
    } else {
      {#计数器数量被填充为 阶梯价最小购买量#};
      $("#input-quantity").val(min_quantity);
    }

    $('#qty_available').text('{{ quantity }}');
    autoQuantityMax('spot');
    let qty = $('input[name="quantity"]').val();
    (qty === undefined) ? (qty = 0) : "";
    let curr_freight = undefined;
    if (is_seller_self) {
      curr_freight = $('.freight0.select input[name="freight_radio"]:checked').data("freight") * 1;
    } else {
      if (isCollectionFromDomicile) {  {# 上门取货 #};
        curr_freight = $('#curr_freight').val() * 1;
      } else {
        if (cwf == "1") {  {# 有云送仓--美国#};
          curr_freight = $('input[name="freight_radio"]:checked').data('freight') * 1;
        } else {  {# 其他国别，没有云送仓 #};
          curr_freight = $('#curr_freight').val() * 1;
        }
      }
    }
    if (Number.isNaN(curr_freight)) {
      curr_freight = 0;
    }
    let priceString = undefined;
    if (is_seller_self) {
      priceString = symbolLeft + price_calc + symbolRight;
    } else {
      priceString = symbolLeft + operation(price_calc, curr_freight, 'add', decimal_place) + symbolRight;
    }
    if (priceString == undefined) {
      priceString = symbolLeft + price_calc + symbolRight;
    }

    if (isPriceChange) {
      $('.raw_price').hide();
      $('.br-no').hide();
    } else {
      $('.raw_price').show();
    }

    {#右侧固定窗的内容#};
    let price_unit_string = priceString;
    let price = string2number(priceString);
    if (is_seller_self) {
      price_unit_string = symbolLeft + formatThousands(Math.round((price_calc + curr_freight) * 100) / 100) + symbolRight;
      price = formatThousands(Math.round((price_calc + curr_freight) * 100) / 100);
    }

    calculateCurrentDiscount(4); // 4:spot
    if(qty!=$('#input-quantity').val()){ // 重新设置购买量
      return;
    }
    if (big_client_discount > 0) {
      $("#fixed_piece_discount").show();
    } else {
      $("#fixed_piece_discount").hide();
    }
    //大客户折扣
    if (big_client_discount > 0) {
      let afterDiscountPrice = mathematical.MathToPrice(mathematical.accMul(big_client_discount / 100, price_calc), decimal_place);
      let discount = mathematical.accSub(price_calc, afterDiscountPrice, decimal_place);
      let old_only_price = price_calc;
      price_calc = afterDiscountPrice;
      price = mathematical.accSub(price, discount, decimal_place);
      price_unit_string = symbolLeft + formatThousands(Math.round((string2number(price_calc) + curr_freight) * 100) / 100) + symbolRight;
      let discount_info = symbolLeft + formatThousands(Math.round(old_only_price * qty * 100) / 100) + symbolRight;
      let show_info = "<span style=\"text-decoration:line-through\">" + discount_info + "</span>";
      $("#fixed_piece_discount").find('.value').html(show_info);
    }

    let price_total_string = symbolLeft + formatThousands(Math.round(price * qty * 100) / 100) + symbolRight;
    let only_price = price_calc;
    let fixed_piece_string = symbolLeft + formatThousands(Math.round(only_price * qty * 100) / 100) + symbolRight;
    let fixed_freight_string = symbolLeft + formatThousands(Math.round(curr_freight * qty * 100) / 100) + symbolRight;
    $('#price_total').text(price_total_string);
    $('#price_unit').text(price_unit_string);
    fixedPieceShow(fixed_piece_string, qty);
    fixedFreightShow(fixed_freight_string);

    {#价格模块的选中效果#};
    $(".handleProductPriceClass").removeClass("active");
    $(".handleProductPriceClass").removeClass('protocol-wrapper-slide-active'); //解决历史bug
    $(".handleSpotPriceClass").removeClass("active");
    $(obj).addClass("active");

    {#如果有其他协议，则设置隐藏域#};
    $('input[name="transaction_type"]').val(0);
    $('input[name="agreement_code"]').val("");
    $('input[name="agreement_name"]').val("Spot Price");

    //从协议切换阶梯价时取消选中的协议并隐藏协议倒计时
    $("#fixed_countdown").hide();
    $(".protocol-wrapper-slide-active").removeClass("protocol-wrapper-slide-active");
  }

  {#参考addCart()方法#};
  function buyNow(obj) {
    if ($(obj).hasClass("disabled")) {
      {#Buy Now 按钮被禁用#};
      return false;
    }

    let ret = false;

    {# 38976 取消buy now是效验销售单，直接采购，不能虚拟支付 #}
    {#if("{{ isInnerAutoBuy }}" == "1") {#}
    {#  ret = checkInnerAutoBuy();#}
    {#  if (!ret) {#}
    {#    return false;#}
    {#  }#}
    {#}#}

    let freight_radio = $('#product input[type=radio]:checked').val();
    let delivery_type = freightRadio2DeliveryType(freight_radio);
    let qty = Number.parseInt($('#product input[name="quantity"]').val());
    if (window.isNaN(qty) || qty < 1) {
      return false;
    }

    ret = checkProductVolume(freight_radio, qty);{#如果是运送仓,判断体积够不够#};
    if(!ret){
      return false;
    }

    buyNowAction(undefined);
  }


  function buyNowAction(obj){
    let product_id = '{{ product_id }}';
    let qty = Number.parseInt($('#product input[name="quantity"]').val());
    let freight_radio = $('#product input[type=radio]:checked').val();
    let delivery_type = freightRadio2DeliveryType(freight_radio);
    let is_virtual_pay= undefined;

    if (obj != undefined) {
      qty = Number.parseInt($(obj).attr('data-qty'));
      if (window.isNaN(qty) || qty < 1) {
        return false;
      }
      if($(obj).attr("id") == "btnInnerAutoBuySales"){
        if($(".handleSpotPriceClass.active").length) {
          $("#input-quantity").val(qty);
          $('input[id="input-quantity"][name="quantity"]').length && calculateTotal($('input[id="input-quantity"][name="quantity"]')[0]);
        }
      }
      is_virtual_pay = $(obj).attr("data-is_virtual_pay");
    }

    {# 38976 取消buy now是效验销售单，直接采购，不能虚拟支付 #}
    is_virtual_pay = 0;

    ret = checkProductVolume(freight_radio, qty);{#如果是运送仓,判断体积够不够#};
    if(!ret){
      return false;
    }


    let sendData = [];
    sendData = $(
      '#product input[type="number"]' +
      ', #product input[type="hidden"]' +
      ', #product input[type="radio"]:checked' +
      ', #product input[type="checkbox"]:checked' +
      ', #product select' +
      ', #product textarea').serializeArray();
    sendData.push({"name":"quantity", "value":qty});
    if ($(".handleCustomerClass.active").length) {
      sendData.push({"name":"add_cart_type", "value":1});
    } else if ($(".handleSpotPriceClass.active").length) {
      sendData.push({"name":"add_cart_type", "value":2});
    }
    if (typeof is_virtual_pay != 'undefined') {
      sendData.push({"name": "is_virtual_pay", "value": is_virtual_pay});
    }
    $.ajax({
      url: "{{ url('checkout/cart/buyNow') }}",
      async: false,
      type: 'post',
      data: sendData,
      dataType: 'json',
      beforeSend: function () {
        $('#button-buy').button('loading');
      },
      complete: function (e, xhr, settings) {
        if (e.status == 302) {
          window.location.reload();
        }
        $('#button-buy').button('reset');
      },
      success: function (json) {
        $('.alert-dismissible, .text-danger:not(".countdown-value")').remove();
        $('.form-group').removeClass('has-error');
        if (json['error']) {
          if (json['error']['option']) {
            for (let i in json['error']['option']) {
              let element = $('#input-option' + i.replace('_', '-'));

              if (element.parent().hasClass('input-group')) {
                element.parent().after('<div class="text-danger">' + json['error']['option'][i] + '</div>');
              } else {
                element.after('<div class="text-danger">' + json['error']['option'][i] + '</div>');
              }
            }
          }

          if (json['error']['transaction_type']) {
            layer.alert(json['error']['transaction_type'], {
              title: 'Message',
              btn: 'OK',
              btnAlign: 'c',
              skin: 'oris-layer' //样式类名
              , closeBtn: 0
            }, function (index) {
              layer.close(index);
            });
          }

          if (json['error']['seller']) {
            layer.alert(json['error']['seller'], {
              title: 'Message',
              btn: 'OK',
              btnAlign: 'c',
              skin: 'oris-layer' //样式类名
              , closeBtn: 0
            }, function (index) {
              layer.close(index);
            });
          }
        }

        if (json['success']) {
          //drop shipping 0,home pick 1,cwf 2
          if (freight_radio == 'cwf') {
            window.open("{{ url('checkout/cwf_info') }}" + '&buy_now_data=' + json['buy_now_data'], "_blank");
            return;
          }
          window.open("{{ url('checkout/pre_order') }}" + '&delivery_type=' + delivery_type + '&buy_now_data=' + json['buy_now_data'], "_blank");
          return;
        }
      },
      error: function (xhr, ajaxOptions, thrownError) {
        if (xhr.status == 302) {
          window.location.reload();
          return;
        }
        layer.alert(thrownError + "<br>" + xhr.statusText + "<br>" + xhr.responseText, {
          title: 'Message',
          btn: 'OK',
          btnAlign: 'c',
          skin: 'oris-layer' //样式类名
          , closeBtn: 0
        }, function (index) {
          layer.close(index);
        });
      }
    });
  }

  {# 校验是否有销售单 38976 取消buy now是效验销售单，直接采购，不能虚拟支付 #};
  function checkInnerAutoBuy(){
    let product_id = '{{ product_id }}';
    let freight_radio = $('#product input[type=radio]:checked').val();
    let qty = Number.parseInt($('#product input[name="quantity"]').val());
    let delivery_type = freightRadio2DeliveryType(freight_radio);
    if (window.isNaN(qty) || qty < 1) {
      return false;
    }

    let flag = true;
    $.ajax({
      url: "{{ url('checkout/cart/checkInnerAutoBuy') }}",
      async: false,
      type: 'Post',
      dataType: "json",
      data: {"delivery_type": delivery_type, "from_page":"product", "product_id":product_id, "quantity":qty},
      complete: function(e, xhr, settings){
        if (e.status == 302) {
          window.location.reload();
        }
      },
      success: function (json) {
        if (json['data']['flag']) {

          let salesQty = 0;
          let html = '';
          for (let i in json['data']['tobePaid']) {
            let item = json['data']['tobePaid'][i];
            html += ('<tr><td>' + item['order_id'] + '</td><td>' + item['qty'] + '</td></tr>');
            salesQty += item['qty'];
          }


          $("#btnInnerAutoBuySales").attr("data-qty",salesQty);
          $("#btnInnerAutoBuyPurchase").attr("data-qty",qty);
          if( qty <= salesQty){
            $("#btnInnerAutoBuySales").find("span").text('');
            $("#btnInnerAutoBuyPurchase").find("span").text('');
          } else {
            $("#btnInnerAutoBuySales").find("span").text('(QTY:'+salesQty+')');
            $("#btnInnerAutoBuyPurchase").find("span").text('(QTY:'+qty+')');
          }


          let myModalSelector = $("#InnerAutoBuycheckPurchaseAndSalesModal");
          myModalSelector.find(".data-tbody").html(html);
          myModalSelector.modal({
            backdrop: 'static',
            keyboard: false
          });
          {#每次隐藏时，清除数据。确保点击时，重新加载#};
          myModalSelector.on("hidden.bs.modal", function () {
            $(this).removeData("bs.modal");
            myModalSelector.find(".data-tbody").html("");
          });
          myModalSelector.modal();


          flag = false;
          return false;
        }
      }
    });
    return flag;
  }

  {#如果是运送仓,判断体积够不够#};
  function checkProductVolume(freight_radio, qty){
    let product_volume = Number($('#product_volume').val());
    let volume_lower = Number($('#volume_lower').val());
    let flag = true;
    if (freight_radio == 'cwf' && product_volume * qty < volume_lower) {
      layer.alert('{{ volume_require_msg }}', {
        title: 'Message',
        btn: 'OK',
        btnAlign: 'c',
        skin: 'oris-layer' //样式类名
        , closeBtn: 0
      }, function (index) {
        layer.close(index);
      });
      flag = false;
      return flag;
    }
    return flag;
  }

  function freightRadio2DeliveryType(freight_radio){
    let delivery_type = 0;
    {# drop shipping 0,home pick 1,cwf 2 #};
    if (freight_radio == 'home_pickup') {
      delivery_type = 1
    } else if (freight_radio == 'cwf') {
      delivery_type = 2
    }
    if(isCollectionFromDomicile){  {# 上门取货 #};
      delivery_type = 1;
    }
    return delivery_type;
  }
  //新增tab页
  $(function(){
    let product_id = '{{ product_id }}';
    let can_internaltion = '{{ can_internaltion }}';
    if(can_internaltion){
      $('.fulfillment-tbody').innerHTML=''
      $.ajax({
        url: "{{ url('product/product/getEuropeFreight') }}",
        type: 'Post',
        dataType: "json",
        data: {"product_id": product_id},
        success: function (data) {
            var list = data.data.list
            var innerHTML = ""
            if (list.length > 0) {
                for (var i = 0; i < list.length; i++) {
                    innerHTML += `<tr>
            <td>${list[i].country_en}</td>
            <td>${list[i].country_code}</td>
            <td>${list[i].freight}</td>
            </tr>
          `
                }
            } else {
                inner=`
                <div  class="new-tab-message">
                          {{ text_product_not_international_error }}
                        </div>`
                innerHTML = `<tr class="new-tr"><td colspan="3" style="text-align:center">{{text_no_data}}</td><tr>`
              $('#international-fulfillment-fee').prepend(inner)
            }


          $('.fulfillment-tbody').html(innerHTML)
        },
        error: function () {
          var innerHTML=`<tr class="new-tr"><td colspan="3" style="text-align:center">{{text_no_data}}</td><tr>`
          $('.fulfillment-tbody').html(innerHTML)
          inner=`
                <div class="new-tab-message">
                         {{ text_get_product_international_error }}
                        </div>`
          $('#international-fulfillment-fee').prepend(inner)
        }
      })
    }
  });

  $("#originalFlag").on("click",function () {
    $("#myModalSwapperImgModal").modal('show');
  })

</script>
{{ footer }}
