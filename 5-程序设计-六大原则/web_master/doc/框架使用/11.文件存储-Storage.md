# 文件存储-Storage

## 配置

- 添加新的目录，在 `src/Components/Storage/StorageCloud.php` 和 `src/Components/Storage/StorageLocal.php` 下添加对应的注释即可

## 说明

1. `StorageCloud` 和 `StorageLocal` 的区别

`StorageCloud` 和 `StorageLocal` 的主要区别在于 `adapter` 不同，详见 `config/_storage.php`

1. 类似`StorageCloud::test()` 指向的目录说明：

`StorageLocal` 定义默认指向 `@root/storage` 根目录（见 `config/_storage.php` 配置）；
`StorageCloud` 在不开启 oss 时指向 `@root/storage/cloud` 根目录（见 `config/_storage.php` 配置），
当开启 oss 时指向 oss 根目录；
`test()` 使得目录指向指向为 `根目录/test`，如 `StorageCloud::test()` 在不开启 oss 时指向 `@root/storage/cloud/test`，
当开启 oss 时指向 `oss 根目录/test`

*！！特殊情况：为兼容旧的目录存储（image和storage），当存储的目录开头是 `image` 或 `storage` 时，Local Adapter 的根目录
将指向 `@root`（见 `App\Components\Storage\Traits\LocalAdapterFixOldPathTrait`）*

## API 使用

以下以 StorageCloud 为例，其他类似：

```php
use App\Components\Storage\StorageCloud;

$storage = StorageCloud::test();
// 基本操作
$path = 'bbb.txt';
$imagePath = 'abc.png';
// 读
$content = $storage->read($path);
$stream = $storage->readStream($path);
$list = $storage->listContents('aaa'); // 列出目录下所有文件和目录 
// 写
$storage->write($path, 'aaa');
/** @var string $file 本地存在的一个文件 */
$storage->writeStream($path, fopen($file, 'r'));
/** @var \Symfony\Component\HttpFoundation\File\UploadedFile $file 上传的文件 */
$fullPath = $storage->writeFile($file); // 将一个上传的文件保存: storage/cloud/test/jqlwjejqiuiuqwejasd.png
$fullPath = $storage->writeFile($file, 'aaa'); // 将一个上传的文件保存，指定存储路径: storage/cloud/test/aaa/123jjskdjlqw09e9123.png
$fullPath = $storage->writeFile($file, '', 'bbb.png'); // 将一个上传的文件保存，指定保存名称: storage/cloud/test/bbb.png
// 删除
$storage->delete($path); // 删除文件
$storage->deleteDirectory('aaa'); // 删除目录，将删除目录下所有文件
// 移动复制
$storage->move($path, 'bb/aa.txt');
$storage->copy($path, 'bb/aa.txt');
// 判断
$bool = $storage->fileExists($path);
$bool = $storage->isImage($path); // 是否是图片
// 文件信息
$size = $storage->fileSize($path);
$mimeType = $storage->mimeType($path);
// 路径相关
$fullPath = $storage->getFullPath($path); // 获取全路径：storage/cloud/test/bbb.txt
$relativePath = $storage->getRelativePath('storage/cloud/test/bbb.txt'); // 获取相对路径：bbb.txt
$path = $storage->buildPath(['/aaa', 'vvv/', '/xxx.png']); // 构建路径：aaa/vvv/xxx.png 
// url 相关
$url = $storage->getUrl($imagePath); // /storage/cloud/test/abc.png 或 http://OSS_DOMAIN/test/abc.png
$url = $storage->getUrl($imagePath, ['w' => 40]); // /public/assets/test/abc-40x40.png 或 http://OSS_DOMAIN/test/abc.png?x-oss-process=image%2Fresize%2Cw_40%2Ch_40%2Cm_pad"
$url = $storage->getUrl($imagePath, ['check-exist' => false]); // 关闭检查文件是否存在
$url = $storage->getUrl($imagePath, ['no-image' => 'placeholder.png']); // 修改默认的文件不存在的文件路径
// 触发浏览器下载
$response = $storage->browserDownload($path);
$response = $storage->browserDownload($path, 'newFileName.txt'); // 指定名字
```
