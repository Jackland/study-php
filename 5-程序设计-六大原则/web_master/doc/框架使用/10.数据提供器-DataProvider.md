# DataProvider 数据提供器

用于对列表页数据进行整合，处理一般列表页需要的数据（列表数据，分页，排序，查询）

减少原 model 的负担

## 使用

### Sort 排序

```php
use Framework\DataProvider\Sort;
use Illuminate\Database\Query\Expression;

$sort = new Sort([
    'rules' => [
        'created_time',
        'created_time2' => 'c.created_time',
        'count' => new Expression('(a.count - a.count_left)'),
        'created_time3' => [
            'asc' => ['c.created_time' => SORT_ASC, 'b.id' => SORT_ASC],
            'desc' => ['c.created_time' => SORT_DESC, 'b.id' => SORT_DESC],
        ],
    ],
    'defaultOrder' => ['created_time' => SORT_ASC, 'created_time2' => SORT_DESC],
]);

var_dump($sort->canSort('created_time')); // true
var_dump($sort->canSort('no_defined')); // false
echo $sort->createUrl('created_time'); // http://localhost/index.php?route=account/order/feeOrder&sort=-created_time
echo $sort->createUrl('created_time', 'asc'); // http://localhost/index.php?route=account/order/feeOrder&sort=created_time
echo $sort->getAttributeSortDirection('created_time'); // asc
echo $sort->getAttributeSortDirection('no_defined'); // null
echo $sort->getAttributeSort('created_time'); // SORT_ASC
echo $sort->getAttributeSort('no_defined'); // null
print_r($sort->getCurrentSort()); // ['created_time' => SORT_ASC], 
print_r($sort->getCurrentSortWithAttribute()); // ['attribute' => 'created_time', 'sort' => SORT_ASC, 'direction' => 'asc'], 
```

排序器默认参数见 Sort::config 字段

### Paginator 分页

```php
use Framework\DataProvider\Paginator;

$paginator = new Paginator();
$paginator->setTotalCount(100);

echo $paginator->getPage(); // 1
echo $paginator->getPageSize(); // 15
echo $paginator->getTotalCount(); // 100
echo $paginator->getTotalCount(); // 7
```

分页器默认参数见 Paginator::config 字段

### DataProvider 数据提供器

```php
use App\Models\FeeOrder\FeeOrder;
use Framework\DataProvider\QueryDataProvider;

$query = FeeOrder::query()->where('buyer_id', 111);
$dataProvider = new QueryDataProvider($query);
// 定义排序规则
$dataProvider->setSort([
    // sort 参数，见上方
]);
// 定义分页规则
$dataProvider->setPaginator([
    // paginator 参数，见上方
]);

print_r($dataProvider->getList()); // Collection
echo get_class($dataProvider->getPaginator()); // Framework\DataProvider\Paginator
echo get_class($dataProvider->getSort()); // Framework\DataProvider\Sort
```

现在支持的 DataProvider

- 数组：`Framework\DataProvider\ArrayDataProvider`

- 集合：`Framework\DataProvider\CollectionDataProvider`

- SQL: `Framework\DataProvider\SqlDataProvider`

- Eloquent Model: `Framework\DataProvider\QueryDataProvider`

- Orm Query Builder: `Framework\DataProvider\QueryBuilderDataProvider`

## SearchModel 查询构造器

定义 Search 模型

```php
<?php

namespace Demo;

use App\Models\FeeOrder\FeeOrder;
use Framework\DataProvider\QueryDataProvider;
use Framework\DataProvider\SearchModelTrait;
use Framework\DataProvider\Sort;

class DemoFeeOrderSearch
{
    use SearchModelTrait;

    private $customerId;
    private $searchAttributes = [
        'feePurchaseOrderId' => '',
        'feeType' => '',
    ];

    public function __construct($customerId)
    {
        $this->customerId = $customerId;
    }

    public function search($params)
    {
        $this->loadAttributes($params);

        $query = FeeOrder::query()
            ->where('buyer_id', $this->customerId)
            ->filterWhere([
                ['fo.order_no', 'like', "%{$this->searchAttributes['feePurchaseOrderId']}%"],
                ['fo.fee_type', '=', $this->searchAttributes['feeType']],
            ]);
        $dataProvider = new QueryDataProvider($query);
        $dataProvider->setSort(new Sort([
            'defaultOrder' => ['create_time' => SORT_DESC],
            'rules' => [
                'create_time' => 'fo.created_at',
                'status' => 'fo.status',
                'checkout_time' => 'fo.paid_at',
            ],
        ]));

        return $dataProvider;
    }
}
```

在控制器中使用

```php
$search = new DemoFeeOrderSearch($this->customer->getId());
$dataProvider = $search->search($this->request->query->all());

$data['list'] = $dataProvider->getList(); // 列表数据
$data['search'] = $search->getSerachData(); // 查询数据
$data['sort'] = $dataProvider->getSort(); // 排序组件，前端可以通过 {{ sort.createUrl('created_time', 'asc') }} 等形式调用方法
$data['paginator'] = $dataProvider->getPaginator(); // 分页组件，前端可以通过 {{ paginator.getTotalCount() }} 等形式调用方法
```

结合 RequestForm 使用

见 `App\Catalog\Search\Test\TestWithRequestFormSearch`

## 例子参考

`catalog/controller/common/test.php` 下的 `testSearch` 和 `testSearchWithRequestForm`
