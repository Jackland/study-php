# 文件存储(Storage)的使用规范

## 规范说明

1. 该规范仅适用于本项目，是大家需要互相遵守的约定，为了解决目前文件存储混乱，导致迁移到 oss 等比较困难的问题

2. 基本准则：

  - 所有本地使用（即项目中必须要有的文件，如用于下载的模版文件），应该使用 `StorageLocal` 相关 api
  
  - 所有新上传的（如产品图片、csv文件等），应该使用 `StorageCloud` 相关 api
  
3. 约定（针对所有新业务）：
 
  - 通过非 `root` 写入文件：即按照业务在 `StorageCloud` 上增加对应注释后通过 `StorageCloud::name()->writeXxx` 写入文件
  
  - 数据库保存全路径：即数据库保存 `name/filename.txt`
  
  - 通过 `root` 获取文件：即通过 `StorageCloud::root()` 获取文件相关信息
  
  - 无特殊情况，不应该使用 php 原生的文件相关函数，包括但不限于 `is_file`、`file_exists`、`is_dir`、`move_uploaded_file`、`mkdir`、`getimagesize` 等
  
  - 不要再调用 `model/tool/image` 下的 `resize` 方法，用 `getUrl()` 代替
  
  - 对临时的，不需要保存的上传文件的处理，直接使用 `$file = request()->file('file')` 获取文件后进行后续处理，不需要调用 Storage 进行存储
  
4. 前端相关：

  - 前端图片等静态资源全都放在 `@root/public` 目录下，twig 中使用 `asset('image/xxx.png')` 的形式调用
  
  - 前端用的资源（图片等），正常情况不允许从控制器中返回给前端（例如不进行 resize，拼接 url 地址等），必须由前端直接使用
  
  - `StoragePublic` 为暂时代替前端资源处理器使用，后期将移除，正常情况请勿直接使用
  
## 案例举例

*注意：以下案例均针对新业务，旧业务因为情况混乱，因此不能完全适用，存在一些出入，也请开发在看到时不要照抄原来的代码*

1. 上传文件，获取路径，保存到数据库

```php
use App\Components\Storage\StorageCloud;

// 获取上传文件
$file = request()->file('file');
// 保存文件到 test 目录
$fullPath = StorageCloud::test()->writeFile($file); // 第二个参数可以指定相对路径，第三个参数可以指定存储的文件名
// 保存文件路径到数据库
//DB update 或 insert，存储 $fullPath 路径
```

2. 读取数据库的文件地址，获取url

```php
use App\Components\Storage\StorageCloud;

// 从数据库获取存储路径
$path = ''; // DB find
// 获取 url 地址
$url = StorageCloud::root()->getUrl($path);
// 如果是图片可以进行裁剪
$url = StorageCloud::root()->getUrl($path, ['w' => 40]); // 宽高40
// 如果是附件触发浏览器下载
$response = StorageCloud::root()->browserDownload($path, 'filename.txt');
```

注意：getUrl 默认会进行文件是否存在判断，所以不需要前置判断文件是否存在

## 其他 API

详见 [框架使用/11.文件存储-Storage]

## 例子参考

`catalog/controller/common/test.php` 下的 `testStorageGetSet` 和 `testStorageDownload`
