# 前端视图(Twig)中js中的变量使用规范

## 起因

php 渲染内容（字符串）到 js 中会导致 js 错误，比如常规的操作：

```twig
<script>
  var jsVar = '{{ twig_var }}';
</script>
```

当 `twig_var` 是常规字符串时该语句正常，但是当 `twig_var` 中包含单引号或换行符时，js 就报错了，同理当 `twig_var` 为 json 字符串时同样存在该问题

## 解决办法

使用以下方案处理此类字符串：

### 字符串

```twig
<script>
  var bool = {{ false|js_var }}; // bool = false;
  var string = {{ 'true'|js_var }}; // string = 'true';
  var string = {{ 'aaaa'|js_var }}; // string = 'aaaa';
  var string = {{ 'aa\'aa'|js_var }}; // string = 'aa\'aa';
  var string = {{ "aaa\nb\rcc"|js_var }}; // string = 'aaa\\nb\\rcc';
  var number = {{ 1234|js_var }}; // number = 1234;
  var string = {{ '1234'|js_var }}; // string = 1234;
</script>
```

注意：

- 使用 `js_var` 外层不需要用单引号包裹

- `js_var` 同样适用于 url 等结果为字符串的值的处理，比如 `url = {{ url('common/home')|js_var }}`

### php 数组与 js json

```twig
<script>
  // php 数组通过 json_encode 后转成 json 字符串，然后通过 js 的 JSON.parse 转成 json 对象
  var jsonStr = '{{ {xx: "y\'y\nxx"}|json_encode }}'; // jsonStr = '{"xx": "y\'y\\nxx"}'
  var jsonObj = JSON.parse('{{ {xx: "y\'y\nxx"}|json_encode }}'); // jsonObj = {xx: "y\'y\nxx"}
  
  // php 中是 json 字符串，直接转成 json 对象
  var jsonObj = {{ '{"xx":"y\'y\nxx"}'|js_json }}; // jsonObj = {"xx": "y\'y\nxx"}
  
  // php 数组或json字符串 直接转成 json 对象，如果原值不能转成json对象，则将按照 js_var 的处理进行返回【建议使用】
  var jsonObj = {{ {xx: "y\'y\nxx"}|js_json }}; // jsonObj = {"xx": "y'y\nxx"}
  var jsonObj = {{ '{"xx":"y\'y\nxx"}'|js_json }}; // jsonObj = {"xx": "y'y\nxx"}
  var jsonObj = {{ '字符串'|js_json }}; // jsonObj = '字符串'
  var jsonObj = {{ null|js_json }}; // jsonObj = null
  var jsonObj = {{ true|js_json }}; // jsonObj = true
</script>
```