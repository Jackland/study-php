# 模型(Model)仓库(Repository)业务(Service)的使用规范

## 规范说明

1. 该规范仅适用于本项目，是大家需要互相遵守的约定，为了解决目前 controller 和 model 过于肥大的问题

2. 基本准则：

    - Model 仅允许定义与模型相关的信息，如字段注释、关联关系、访问器(getXxxAttribute)、修改器(setXxxAttribute) 等 Eloquent Model 相关的配置

    - Repository 仅允许定义查询相关的方法，且命名必须以动词开头，建议如下：

      - getXx、findXx 表示获取数据
  
      - isXx、checkXx、hasXx 表示结果为 bool 类型的
  
      - filterXx 表示过滤数据
  
    - Service 仅允许定义增删改相关的方法，且命名必须以动词开头

3. Model 与数据库表是一一对应，但 Repository 和 Service 不一定，根据实际情况，后者是会存在跨表的操作，因此不一定需要一一对应

4. 控制器(Controller)中，可以调用 Repository 和 Service 获取和处理业务，允许使用 Model 的简单查询（复杂的建议写到 Repository 中），如 `User::find(1)`

5. Repository 和 Service 不要使用 new 创建，使用 `app(OrderRepository::class)` 的形式创建（或者直接依赖注入）

6. 本项目已经将 Model 加入系统，不建议将 get() 得到的数据进行 toArray() 然后通过数组进行操作，建议使用对象操作的方式处理

7. Model 使用注意 with 的使用，了解什么是 N+1 问题 [参考](https://learnku.com/laravel/t/15077/what-is-the-n1-problem-and-how-to-solve-the-n1-problem-in-laravel)

8. 可以使用 `console` 自动创建相关文件，详见【框架使用/命令脚本-Command】

9. 原则上原 catalog 或 admin 下的 model 不应该再增加相关方法

## 模型使用注意点

1. 当 with 和 join（leftJoin 或 leftJoinRelations等）联合使用时，尤其在主键一致时，注意手动指定主键（建议将join表的id指定为其他名称）
，否则 with 的关联数据将不正确，建议如下操作：

```php
$model = TestModel::query()->alias('a')
    ->leftJoinRelations(['testRelation as b'])
    ->with(['testWith'])
    ->where('b.status', 1)
    ->select('b.id as bid', 'a.*')
    ->get();
echo $model->id;
echo $model['bid'];
echo $model->testWith->xxx;
```

## 参考

[Eloquent Model](https://learnku.com/docs/laravel/5.8/eloquent/3931)
